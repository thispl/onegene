[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order Schedule Settings",
  "enabled": 0,
  "modified": "2025-12-17 16:35:45.613753",
  "module": "ONEGENE",
  "name": "Order Schedule Settings",
  "script": "frappe.ui.form.on('Sales Order Schedule Settings', {\n\trefresh(frm) {\n        frm.disable_save()\n        if(frm.doc.attach) {\n            frappe.call({\n                method: 'onegene.onegene.doctype.sales_order_schedule_settings.sales_order_schedule_settings.get_data',\n                args: {\n                    'file': frm.doc.attach,\n                },\n                callback(r) {\n                    if (r.message) {\n        \t\t\t\tfrm.fields_dict.html.$wrapper.empty().append(r.message)\n\n                    }\n                }\n            })\n            \n        }\n//         frm.call('get_data').then(r => {\n// \t\t\tif (r.message) {\n\t\t\t\t// frm.fields_dict.html.$wrapper.empty().append(r.message)\n// \t\t\t}\n//         })\n\t},\n\tupload(frm) {\n        if (frm.doc.attach) {\n            frappe.call({\n                method: 'onegene.onegene.doctype.sales_order_schedule_settings.sales_order_schedule_settings.enqueue_upload',\n                args: {\n                    'file': frm.doc.attach,\n                },\n                freeze: true,\n                freeze_message: 'Updating Order Schedule Data....',\n                callback(r) {\n                    if (r.message) {\n                        frappe.show_alert({\n                            message: __('Order Schedule Updated Successfully'),\n                            indicator: 'green'\n                        }, 5);\n                    }\n                }\n            })\n        }\n        else {\n            frappe.msgprint('Please Attach the Excel File')\n        }\n        \n    },\n    \n    download(frm){\n        var path = \"onegene.onegene.doctype.sales_order_schedule_settings.sales_order_schedule_settings.template_sheet\"\n\t\tvar args = 'name=%(name)s'\n\t\tif (path) {\n\t\t\twindow.location.href = repl(frappe.request.url +\n\t\t\t\t'?cmd=%(cmd)s&%(args)s', {\n\t\t\t\tcmd: path,\n\t\t\t\targs: args,\n\t\t\t\tname: frm.doc.name\n\t\t\t});\n\t\t}\n    },\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order Schedule",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.132317",
  "module": "ONEGENE",
  "name": "Order Schedule",
  "script": "frappe.ui.form.on('Sales Order Schedule', {\n    qty(frm){\n        frappe.call({\n            method:\"onegene.onegene.custom.qty_check\",\n            args:{\n                \"sales\":frm.doc.sales_order_number,\n                \"item\":frm.doc.item_code,\n                \"qty\":frm.doc.qty,\n                \"customer\":frm.doc.customer_code,\n            },\n        })\n        if(frm.doc.qty){\n            var value1 = frm.doc.qty \n            var value2 = frm.doc.delivered_qty || 0\n            var value = value1 - value2\n            frm.set_value(\"pending_qty\",value)\n        }\n        if(frm.doc.qty && frm.doc.order_rate > 0){\n            var val1 = frm.doc.qty * frm.doc.order_rate\n            frm.set_value(\"schedule_amount\",val1)\n        }\n        if(frm.doc.pending_qty && frm.doc.order_rate > 0){\n            var value = frm.doc.pending_qty * frm.doc.order_rate;\n            frm.set_value(\"pending_amount\",value)\n        }\n        if(frm.doc.delivered_qty && frm.doc.order_rate > 0){\n            var value = frm.doc.delivered_qty * frm.doc.order_rate;\n            frm.set_value(\"delivered_amount\",value)\n        }\n        \n    },\n    pending_qty(frm){\n        var value = frm.doc.pending_qty * frm.doc.order_rate;\n        frm.set_value(\"pending_amount\",value)\n    },\n    delivered_qty(frm){\n        if(frm.doc.delivered_qty && frm.doc.order_rate > 0){\n            var value = frm.doc.delivered_qty * frm.doc.order_rate;\n            frm.set_value(\"delivered_amount\",value)\n        }\n    },\n    refresh(frm){\n        if(frm.doc.sales_order_number && frm.doc.item_code){\n            frappe.call({\n                method:\"onegene.onegene.doctype.sales_order_schedule.sales_order_schedule.schedule_list\",\n                args:{\n                    \"sales\":frm.doc.sales_order_number,\n                    \"item\":frm.doc.item_code,\n                    // \"qty\":frm.doc.qty,\n                    // \"customer\":frm.doc.customer_code,\n                },\n                callback(r){\n    \t\t        if(r){\n\t\t                frm.get_field(\"custom_schedule_list\").$wrapper.html(r.message);\n\t                }\n    \t\t    }\n            })\n        }\n    },\n    item_code(frm){\n        if(frm.doc.sales_order_number && frm.doc.item_code){\n            frappe.call({\n                method:\"onegene.onegene.doctype.sales_order_schedule.sales_order_schedule.get_qty_rate_so\",\n                args:{\n                    item : frm.doc.item_code,\n                    sales : frm.doc.sales_order_number\n                },\n                callback(r){\n                    if(r.message){\n                        frm.set_value(\"order_rate\",r.message)\n                    }\n                }\n            })\n        }\n    },\n    validate(frm){\n        // if (frm.doc.__islocal) {\n            \n        //     frappe.db.get_value(\"Sales Order Schedule\",{\"item_code\":frm.doc.item_code, \"customer_name\":frm.doc.customer_name,\"schedule_month\":frm.doc.schedule_month,\"schedule_year\":frm.doc.schedule_year},\"name\",\"item_code\",\"schedule_month\").then(r=>{\n                \n        //         if(i && i.message.name){\n                    \n        //             frappe.throw(`There is already an Sales Order Schedule ${name} for the item ${item_code} for the month ${\"schedule_month\"}is available.`)\n        //         }\n        //     })\n        // }\n    }\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.495266",
  "module": "ONEGENE",
  "name": "Sales Order",
  "script": "frappe.ui.form.on('Sales Order', {\n    customer_order_type: function(frm) {\n        if (frm.doc.customer_order_type == \"Open\") {\n            frappe.call({\n               method: \"onegene.onegene.custom.get_last_date_of_fiscal\",\n               callback: function(r) {\n                   if (r.message) {\n                       frm.set_value(\"delivery_date\", r.message)\n                   }\n               }\n            })\n        }\n        else {\n            frm.set_value(\"delivery_date\", \"\")\n        }\n        // toggle_qty_field(frm);\n        frm.fields_dict['items'].grid.update_docfield_property('open_qty', 'read_only', frm.doc.customer_order_type === 'Open');\n    },\n    validate(frm) {\n        if (frm.doc.__islocal) {\n            frm.set_value(\"custom_docname\", frm.doc.po_no)\n        }\n        \n        // frm.doc.items.forEach((item, idx) => {\n        //     if (item.gst_hsn_code && frm.doc.customer && frm.doc.company) {\n        //         frappe.call({\n        //             method: \"onegene.utils.get_item_tax_and_sales_template\",\n        //             args: {\n        //                 hsn_code: item.gst_hsn_code,\n        //                 customer: frm.doc.customer,\n        //                 company: frm.doc.company\n        //             },\n        //             freeze: true,\n        //             freeze_message: __(\"Fetching Tax...\"),\n        //             callback: function(r) {\n        //                 if (r.message) {\n        //                     // Set tax template for the item\n        //                     frm.get_field('items').grid.grid_rows_by_docname[item.name].cells['item_tax_template'].html(r.message.item_tax_template);\n        //                     frm.set_value(\"taxes_and_charges\", r.message.sales_taxes_and_charges_template);\n        //                     frm.refresh_field('items');\n        //                 }\n        //             }\n        //         });\n        //     }\n        // });\n        \n    },\n    set_query(frm) {\n        frm.set_query(\"item_code\", 'items', function(doc, cdt, cdn) {\n            let d = locals[cdt][cdn];\n            return {\n                filters: [\n                    ['Item', 'item_billing_type', '=', 'Billing']\n                ]\n            };\n        });\n    },\n    customer(frm) {\n        frm.trigger('set_query')\n        \n        setTimeout(()=>{\n            \n            if(frm.doc.currency){\n                \n                frappe.db.get_value(\"Currency Conversion\",{\"currency\":frm.doc.currency},\"exchange_rate\").then(r=>{\n                    \n                    if(r.message && r.message.exchange_rate){\n                        \n                        frm.set_value(\"conversion_rate\",r.message.exchange_rate)\n                    }\n                })\n                \n            }\n            \n        },2000)\n    },\n    onload(frm) {\n        frm.trigger('set_query');\n        // toggle_qty_field(frm);\n    },\n    delivery_date(frm) {\n        if (frm.doc.delivery_date) {\n            frm.doc.items.forEach(row => {\n                row.delivery_date = frm.doc.delivery_date;\n            });\n            frm.refresh_field('items');\n        }\n    },\n    \n    refresh(frm) {\n        \n        setTimeout(() => {\n            frm.remove_custom_button('Update Items');\n            if (!(frappe.user.has_role(\"System Manager\") || frappe.user.has_role(\"Administrator\"))) {\n                frm.remove_custom_button('Pick List', 'Create');\n                frm.remove_custom_button('Delivery Note', 'Create');\n                frm.remove_custom_button('Work Order', 'Create');\n                frm.remove_custom_button('Sales Invoice', 'Create');\n                frm.remove_custom_button('Material Request', 'Create');\n                frm.remove_custom_button('Request for Raw Materials', 'Create');\n                frm.remove_custom_button('Purchase Order', 'Create');\n                frm.remove_custom_button('Project', 'Create');\n                frm.remove_custom_button('Payment Request', 'Create');\n                frm.remove_custom_button('Payment', 'Create');\n                frm.remove_custom_button('Reserve', 'Stock Reservation');\n            }\n        }, 500);\n        \n        \n        if ((frappe.user.has_role(\"System Manager\") || frappe.has_role(\"Administrator\")) && frm.doc.docstatus == 1) {\n            frm.add_custom_button(\"Update Item\", () => {\n                let d = new frappe.ui.Dialog({\n                    title: 'Update Items',\n                    size: 'extra-large',\n                    fields: [{\n                        fieldname: 'items_table',\n                        fieldtype: 'Table',\n                        label: 'Items',\n                        cannot_add_rows: false,\n                        in_place_edit: false,\n                        data: [],\n                        get_data: function() {\n                            return this.data;\n                        },\n                        fields: [{\n                                fieldtype: 'Link',\n                                fieldname: 'item_code',\n                                label: 'Item Code',\n                                options: 'Item',\n                                in_list_view: 1,\n                                columns: 5,\n                                onchange: function() {\n                                    const current_item_code = this.value;\n                                    const docname = this.doc.docname;\n\n                                    const table = d.fields_dict.items_table;\n                                    const existing_items = table.df.data;\n\n                                    const grid = table.grid;\n\n                                    // ---------------------------------------------------\n                                    // 1️⃣ DUPLICATE CHECK\n                                    // ---------------------------------------------------\n                                    const duplicate = existing_items.some(\n                                        row => row.item_code === current_item_code && row.docname !== docname\n                                    );\n\n                                    if (duplicate) {\n                                        frappe.msgprint({\n                                            title: __('Duplicate Item'),\n                                            message: __('Item Code <b>{0}</b> already exists in the list.', [current_item_code]),\n                                            indicator: 'red'\n                                        });\n\n                                        const row_idx = grid.data.findIndex(row => row.docname === docname);\n\n                                        if (row_idx !== -1) {\n                                            grid.data.splice(row_idx, 1);\n                                            grid.refresh();\n                                        }\n                                        return;\n                                    }\n\n                                    // ---------------------------------------------------\n                                    // 2️⃣ FETCH ITEM NAME + HSN CODE\n                                    // ---------------------------------------------------\n                                    if (current_item_code) {\n                                        frappe.db.get_value(\n                                            'Item',\n                                            current_item_code,\n                                            ['item_name', 'gst_hsn_code']\n                                        ).then(r => {\n                                            if (r.message) {\n\n                                                const {\n                                                    item_name,\n                                                    gst_hsn_code\n                                                } = r.message;\n                                                const new_hsn = gst_hsn_code || \"\";\n\n                                                // Find this row\n                                                const row = grid.data.find(r => r.docname === docname);\n\n                                                if (!row) return;\n\n                                                // ---------------------------------------------------\n                                                // 3️⃣ CHECK HSN MATCH WITH EXISTING ROWS\n                                                // ---------------------------------------------------\n                                                const hsn_mismatch = existing_items.some(item =>\n                                                    item.hsn && item.hsn !== new_hsn\n                                                );\n\n                                                if (hsn_mismatch) {\n                                                    frappe.msgprint({\n                                                        title: __('HSN Mismatch'),\n                                                        message: __('HSN Code <b>{0}</b> does not match with other items.', [new_hsn]),\n                                                        indicator: 'red'\n                                                    });\n\n                                                    // Remove only this row\n                                                    const idx = grid.data.findIndex(r => r.docname === docname);\n                                                    if (idx !== -1) {\n                                                        grid.data.splice(idx, 1);\n                                                        grid.refresh();\n                                                    }\n\n                                                    return; // stop processing\n                                                }\n\n                                                // ---------------------------------------------------\n                                                // 4️⃣ SAFE TO UPDATE THE ROW\n                                                // ---------------------------------------------------\n                                                row.item_name = item_name || \"\";\n                                                row.hsn = new_hsn;\n\n                                                grid.refresh();\n                                            }\n                                        });\n                                    }\n                                },\n\n\n                            },\n                            {\n                                fieldtype: 'Data',\n                                fieldname: 'item_name',\n                                label: 'Item Name',\n                                // in_list_view: 1,\n                                read_only: 1,\n                                columns: 4,\n                            },\n                            {\n                                fieldtype: 'Date',\n                                fieldname: 'delivery_date',\n                                label: 'Delivery Date',\n                                in_list_view: 1,\n                                reqd: 1,\n                                // read_only: 1,\n                                columns: 2\n                            },\n                            {\n                                fieldtype: 'Float',\n                                fieldname: 'qty',\n                                label: 'Qty',\n                                in_list_view: 1,\n                                // read_only: 1,\n                                reqd: 1,\n                                columns: 1\n                            },\n                            {\n                                fieldtype: 'Currency',\n                                fieldname: 'rate',\n                                label: 'Rate',\n                                in_list_view: 1,\n                                reqd: 1,\n                                columns: 1\n                            },\n                            {\n                                fieldtype: 'Data',\n                                fieldname: 'docname',\n                                label: 'Docname',\n                                read_only: 1\n                            },\n                            {\n                                fieldtype: 'Data',\n                                fieldname: 'hsn',\n                                label: 'HSN',\n                                read_only: 1\n                            }\n                        ]\n                    }],\n                    primary_action_label: 'Update',\n                    primary_action(values) {\n                        frappe.call({\n                            method: \"onegene.onegene.custom.custom_update_items\",\n                            args: {\n                                data: values,\n                                sales_order: frm.doc.name\n                            },\n                            freeze: true,\n                            freeze_message: \"Updating Items ...\",\n                            callback(r) {\n                                if (r.message) {\n                                    frm.reload_doc();\n                                    d.hide();\n                                }\n                            }\n                        });\n                    }\n                });\n\n                // Populate existing SO items\n                let table_field = d.get_field('items_table');\n\n                table_field.df.data = frm.doc.items.map(item => ({\n                    item_code: item.item_code,\n                    item_name: item.item_name,\n                    delivery_date: item.delivery_date,\n                    qty: item.qty,\n                    rate: item.rate,\n                    docname: item.name,\n                    hsn: item.gst_hsn_code\n                }));\n\n                table_field.refresh();\n\n                d.show();\n\n            });\n        }\n        \n    },    \n         \n    \n    //  save(frm) {\n    //     // Trigger the tax calculation when saving the document\n        \n    // },\n    custom_add_schedule(frm) {\n        frm.clear_table(\"custom_schedule_table\")\n        $.each(frm.doc.items, function(i, j) {\n            frm.add_child(\"custom_schedule_table\", {\n                'item_code': j.item_code,\n                'schedule_date': frappe.datetime.get_today(),\n                'schedule_qty': j.qty,\n                'delivered_qty': 0,\n                'pending_qty': j.qty,\n            })\n            frm.refresh_field(\"custom_schedule_table\")\n        })\n    },\n    \n    \n    custom_add_schedule(frm) {\n        frm.clear_table(\"custom_schedule_table\")\n        $.each(frm.doc.items, function(i, j) {\n            frm.add_child(\"custom_schedule_table\", {\n                'item_code': j.item_code,\n                'schedule_date': frappe.datetime.get_today(),\n                'schedule_qty': j.qty,\n                'delivered_qty': 0,\n                'pending_qty': j.qty,\n            })\n            frm.refresh_field(\"custom_schedule_table\")\n        })\n    },\n\n})\n\nfrappe.ui.form.on('Sales Order Schedule', {\n    schedule_qty(frm, cdt, cdn) {\n        var child = locals[cdt][cdn]\n        child.pending_qty = child.schedule_qty\n        frm.refresh_field(\"custom_schedule_table\")\n    },\n})\nfrappe.ui.form.on('Sales Order Item', {\n    item_code(frm, cdt, cdn) {\n        let current_row = locals[cdt][cdn];\n        let duplicate_found = false;\n\n        frm.doc.items.forEach(row => {\n            if (row.item_code === current_row.item_code && row.name !== current_row.name) {\n                duplicate_found = true;\n            }\n        });\n\n        if (duplicate_found) {\n            let d = frappe.msgprint({\n                title: __(\"Removing Duplicate Entry\"),\n                message: __(\"Item Code <b>{0}</b> is already added.\", [current_row.item_code]),\n                indicator: 'red'\n            });\n            frm.get_field('items').grid.grid_rows_by_docname[cdn].remove();\n            frm.refresh_field('items');\n            setTimeout(() => {\n                if (d && d.hide) d.hide();\n            }, 1500);\n        }\n      if (current_row.item_code) {\n        frappe.db.get_value('Item', current_row.item_code, 'gst_hsn_code')\n            .then(r => {\n                const hsn_code = r.message.gst_hsn_code;\n                current_row.gst_hsn_code = hsn_code;\n                frm.refresh_field('items');\n\n                // Find index of current row\n                let current_index = frm.doc.items.findIndex(row => row.name === current_row.name);\n                \n                // get taxes based on template\n                if (current_index == 0){\n                    if (current_row.gst_hsn_code && frm.doc.customer && frm.doc.company) {\n            frappe.call({\n                method: \"onegene.utils.get_item_tax_and_sales_template\",\n                args: {\n                    hsn_code: current_row.gst_hsn_code,\n                    customer: frm.doc.customer,\n                    company: frm.doc.company\n                },\n                freeze:true,\n                freeze_message: __(\"Fetching Tax...\"),\n                callback: function(r) {\n                    if (r.message) {\n                        frappe.model.set_value(cdt, cdn, \"item_tax_template\", r.message.item_tax_template);\n                        frm.set_value(\"taxes_and_charges\", r.message.sales_taxes_and_charges_template);\n                    }\n                }\n            });\n        }\n                \n                }\n                if (current_index > 0) {\n                    let previous_row = frm.doc.items[current_index - 1];\n\n                    if (previous_row.gst_hsn_code && previous_row.gst_hsn_code !== hsn_code) {\n                        let msg = frappe.msgprint({\n                            title: __(\"Removing Current Row\"),\n                            message: __(\"HSN Code mismatch: <b>{0}</b> (Previous) vs <b>{1}</b> (Current)\", \n                                      [previous_row.gst_hsn_code, hsn_code]),\n                            indicator: 'orange'\n                        });\n\n                        frm.get_field('items').grid.grid_rows_by_docname[cdn].remove();\n                        frm.refresh_field('items');\n                        setTimeout(() => {\n                            if (msg && msg.hide) msg.hide();\n                        }, 1500);\n                    }\n                    \n                }\n                \n                 \n            })\n    }\n    },\n    \n    open_qty(frm, cdt, cdn) {\n        var child = locals[cdt][cdn];\n        if (frm.doc.customer_order_type == \"Fixed\") {\n            child.qty = child.open_qty;\n        }\n    },\n    custom_schedule_button(frm, cdt, cdn) {\n        var child = locals[cdt][cdn];\n\n        if (frm.doc.customer_order_type == \"Fixed\") {\n            let row_data = get_schedule_table_data_for_fixed(frm, child.item_code, child.qty);\n            let dialog1 = new frappe.ui.Dialog({\n                title: __('Select the Schedule'),\n                fields: [{\n                    fieldname: \"items\",\n                    fieldtype: \"Table\",\n                    label: __(\"Select the Schedule\"),\n                    data: row_data,\n                    fields: [{\n                            fieldname: \"item_code\",\n                            fieldtype: \"Link\",\n                            label: __(\"Item Code\"),\n                            options: \"Item\",\n                            read_only: 1\n                        },\n                        {\n                            fieldname: \"schedule_date\",\n                            fieldtype: \"Select\",\n                            options: [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"],\n                            label: __(\"Schedule Period\"),\n                            reqd: 1,\n                            in_list_view: 1\n                        },\n                        {\n                            fieldname: \"schedule_qty\",\n                            fieldtype: \"Float\",\n                            label: __(\"Schedule Qty\"),\n                            reqd: 1,\n                            in_list_view: 1\n                        }\n                    ],\n                }, ],\n                primary_action_label: __('Add'),\n                primary_action: () => {\n                    let values = dialog1.get_values();\n                    if (values && values.items) {\n                        let total_qty = 0;\n\n                        values.items.forEach(row => {\n                            total_qty += row.schedule_qty;\n                        });\n                        let is_item_present_in_schedule = false;\n                        frm.doc.custom_schedule_table.forEach(row => {\n                            if (row.item_code === child.item_code) {\n                                is_item_present_in_schedule = true;\n                            } else {\n                                is_item_present_in_schedule = false;\n                            }\n                        });\n                        if (total_qty === child.qty) {\n                            if (!is_item_present_in_schedule) {\n                                values.items.forEach(row => {\n                                    const monthMap = {\n                                        Jan: 0,\n                                        Feb: 1,\n                                        Mar: 2,\n                                        Apr: 3,\n                                        May: 4,\n                                        Jun: 5,\n                                        Jul: 6,\n                                        Aug: 7,\n                                        Sep: 8,\n                                        Oct: 9,\n                                        Nov: 10,\n                                        Dec: 11\n                                    };\n\n                                    const monthStr = row.schedule_date; // e.g., \"Jan\"\n                                    const currentYear = new Date().getFullYear();\n\n                                    const startDate = new Date(currentYear, monthMap[monthStr], 1); // Month is 0-indexed\n\n                                    const day = String(startDate.getDate()).padStart(2, '0');\n                                    const month = String(startDate.getMonth() + 1).padStart(2, '0');\n                                    const year = startDate.getFullYear();\n\n                                    const formattedDate = `${year}-${month}-${day}`; // e.g., \"2025-01-01\"\n\n                                    frm.add_child(\"custom_schedule_table\", {\n                                        'item_code': child.item_code,\n                                        'schedule_date': formattedDate,\n                                        'schedule_qty': row.schedule_qty,\n                                        'schedule_month': row.schedule_date.toUpperCase(),\n                                        'delivered_qty': 0,\n                                        'pending_qty': row.schedule_qty,\n                                    });\n                                });\n                                frm.refresh_field(\"custom_schedule_table\");\n                                frm.save();\n                            } else {\n                                frappe.msgprint({\n                                    title: \"Duplicate Item\",\n                                    message: `Item <b>${child.item_code}</b> is already updated in the Schedule Table`,\n                                    indicator: 'red'\n                                });\n                                frappe.msgprint({\n                                    title: \"Duplicate Item\",\n                                    message: `Item <b>${child.item_code}</b> ஏற்கனவே Schedule Table-ல் update செய்யப்பட்டுள்ளது.`,\n                                    indicator: 'red'\n                                });\n\n                            }\n                            dialog1.hide();\n                        }\n\n                        if (total_qty > child.qty) {\n                            frappe.msgprint({\n                                title: \"Qty Doesn't Match\",\n                                message: `Schedule Qty <b>${total_qty}</b> is greater than <b>${child.qty}</b> for <b>${child.item_code}</b>.`,\n                                indicator: 'red',\n                            });\n                            frappe.msgprint({\n                                title: \"Qty Doesn't Match\",\n                                message: `Schedule Qty <b>${total_qty}</b>, <b>${child.item_code}</b> க்கான Qty <b>${child.qty}</b> வை விட அதிகமாக உள்ளது.`,\n                                indicator: 'red',\n                            });\n\n                        }\n                        if (total_qty < child.qty) {\n                            frappe.msgprint({\n                                title: \"Qty Doesn't Match\",\n                                message: `Schedule Qty <b>${total_qty}</b> is less than <b>${child.qty}</b> for <b>${child.item_code}</b>.`,\n                                indicator: 'red',\n                            });\n                            frappe.msgprint({\n                                title: \"Qty Doesn't Match\",\n                                message: `Schedule Qty <b>${total_qty}</b>, <b>${child.item_code}</b> க்கான Qty <b>${child.qty}</b> வை விட குறைவாக உள்ளது.`,\n                                indicator: 'red',\n                            });\n\n                        }\n\n                    }\n                }\n            });\n            dialog1.show();\n        }\n        if (frm.doc.customer_order_type == \"Open\") {\n            let row_data = get_schedule_table_data_for_open(frm, child.item_code, child.qty);\n            let dialog2 = new frappe.ui.Dialog({\n                title: __('Select the Schedule'),\n                fields: [{\n                    fieldname: \"items\",\n                    fieldtype: \"Table\",\n                    label: __(\"Select the Schedule\"),\n                    data: row_data,\n                    fields: [{\n                            fieldname: \"item_code\",\n                            fieldtype: \"Link\",\n                            label: __(\"Item Code\"),\n                            options: \"Item\",\n                            read_only: 1\n                        },\n                        {\n                            fieldname: \"schedule_date\",\n                            fieldtype: \"Select\",\n                            options: [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"],\n                            label: __(\"Schedule Period\"),\n                            reqd: 1,\n                            in_list_view: 1\n                        },\n                        {\n                            fieldname: \"schedule_qty\",\n                            fieldtype: \"Float\",\n                            label: __(\"Schedule Qty\"),\n                            reqd: 1,\n                            in_list_view: 1\n                        }\n                    ],\n                }, ],\n                primary_action_label: __('Add'),\n                primary_action: () => {\n                    let values = dialog2.get_values();\n                    if (values) {\n                        values.items.forEach(row => {\n                            const monthStr = row.schedule_date; // Example: \"July\" or \"Jul\"\n                            const currentYear = new Date().getFullYear();\n\n                            // Create date\n                            const monthNumber = new Date(`${monthStr} 1, ${currentYear}`).getMonth() + 1; // 1-indexed\n                            const month = String(monthNumber).padStart(2, '0');\n\n                            // Always 01 for day (first day of the month)\n                            const formattedDate = `${currentYear}-${month}-01`;\n\n\n\n\n                            frappe.run_serially([\n                                () => {\n                                    if (frm.doc.docstatus == 1) {\n                                        return frappe.call({\n                                            method: \"onegene.onegene.custom.create_order_schedule_from_so_for_open\",\n                                            args: {\n                                                'item_code': child.item_code,\n                                                'schedule_date': formattedDate,\n                                                'schedule_qty': row.schedule_qty,\n                                                'customer_code': frm.doc.custom_customer_code,\n                                                'name': frm.doc.name,\n                                                'rate': child.rate,\n                                                'month': row.schedule_date,\n                                            },\n                                            callback: function(r) {\n                                                if (r.message) {\n                                                    frm.reload_doc()\n                                                }\n                                            }\n                                        });\n                                    } else {\n                                        frm.add_child(\"custom_schedule_table\", {\n                                            'item_code': child.item_code,\n                                            'schedule_date': formattedDate,\n                                            'schedule_qty': row.schedule_qty,\n                                            'schedule_month': row.schedule_date.toUpperCase(),\n                                            'delivered_qty': 0,\n                                            'pending_qty': row.schedule_qty,\n                                        });\n                                        frm.save()\n                                    }\n                                },\n                            ]);\n\n                        });\n                        frm.refresh_field(\"custom_schedule_table\");\n                    }\n                    dialog2.hide();\n                },\n            });\n            dialog2.show();\n        }\n    }\n});\n\n\nfunction get_schedule_table_data_for_fixed(frm, item_code, qty) {\n    let matching_rows = [];\n\n    frm.doc.custom_schedule_table.forEach(row => {\n        if (row.item_code === item_code) {\n            matching_rows.push({\n                \"item_code\": row.item_code,\n                \"schedule_date\": frappe.datetime.str_to_obj(row.schedule_date).toLocaleString('en-us', {\n                    month: 'short'\n                }),\n                \"schedule_qty\": row.schedule_qty\n            });\n        }\n    });\n\n    if (matching_rows.length === 0) {\n        matching_rows.push({\n            \"item_code\": item_code,\n            \"schedule_date\": frappe.datetime.str_to_obj(frappe.datetime.nowdate()).toLocaleString('en-us', {\n                month: 'short'\n            }),\n            \"schedule_qty\": qty\n        });\n    }\n\n    return matching_rows;\n}\n\nfunction get_schedule_table_data_for_open(frm, item_code, qty) {\n    let matching_rows = [];\n\n    if (matching_rows.length === 0) {\n        matching_rows.push({\n            \"item_code\": item_code,\n            \"schedule_date\": frappe.datetime.str_to_obj(frappe.datetime.nowdate()).toLocaleString('en-us', {\n                month: 'short'\n            }),\n            \"schedule_qty\": 0\n        });\n    }\n\n    return matching_rows;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Production Plan",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.890981",
  "module": "ONEGENE",
  "name": "Production Plan",
  "script": "frappe.ui.form.on('Production Plan', {\n    onload(frm) {\n        if(!frm.doc.custom_planned_month){\n        month = frappe.datetime.str_to_obj(frappe.datetime.get_today()).toLocaleString('en-us', {\n            month: 'short'\n        })\n        frm.set_value(\"custom_planned_month\", month.toUpperCase())\n        }\n    },\n    get_items(frm) {\n        let promises = [];\n        $.each(frm.doc.po_items, function(i, j) {\n            const promise = frappe.db.get_value('Sales Order Schedule', {\n                'sales_order_number': j.sales_order,\n                'item_code': j.item_code,\n                'schedule_month': frm.doc.custom_planned_month\n            }, 'qty').then(r => {\n                if (r.message && r.message.qty) {\n                    j.planned_qty = r.message.qty;\n                } else {\n                    j.planned_qty = 0;\n                    frappe.msgprint(__(\"There is no Sales Order Schedule for the item {0} for month {1}\", [j.item_code, frm.doc.custom_planned_month]));\n                }\n\n                return frappe.db.get_value(\"Item\", {\n                    \"item_code\": j.item_code\n                }, [\"rejection_allowance\", \"item_group\"]);\n\n            }).then(r => {\n                j.custom_rejection_allowance = r.message.rejection_allowance || 0;\n                j.custom_item_group = r.message.item_group\n                return frappe.call({\n                    method: \"onegene.onegene.custom.get_assembly_items_update\",\n                    args: {\n                        item_code: j.item_code,\n                        qty: j.planned_qty,\n                        rej_allowance: j.custom_rejection_allowance,\n                        month: frm.doc.custom_planned_month\n                    }\n                });\n\n            }).then(r => {\n                if (r && r.message) {\n                    j.custom_per_day_plan = r.message.per_day;\n                    j.custom_delivered_qty = r.message.del_qty;\n                }\n            });\n\n            promises.push(promise);\n        });\n\n        // Once all items are processed\n        Promise.all(promises).then(() => {\n            frm.refresh_field(\"po_items\");\n        });\n    },\n    get_sub_assembly_items(frm) {\n        $.each(frm.doc.sub_assembly_items, function(i, j) {\n            j.fg_warehouse = \"Work In Progress - WAIP\"\n\n            frappe.db.get_value(\"Item\", {\n                    \"item_code\": j.production_item\n                }, \"rejection_allowance\")\n                .then(r => {\n                    j.custom_rejection_allowance = r.message.rejection_allowance\n                })\n                .then(r => {\n                    frappe.call({\n                        method: \"onegene.onegene.custom.get_sub_assembly_items_update\",\n                        args: {\n                            \"item_code\": j.production_item,\n                            \"qty\": j.qty,\n                            \"rej_allowance\": j.custom_rejection_allowance\n                        },\n                        callback: function(r) {\n                            j.custom_per_day_plan = r.message.per_day\n                            j.custom_delivered_qty = r.message.del_qty\n                        }\n                    })\n                })\n        })\n        frm.refresh_field(\"sub_assembly_items\")\n    },\n    custom_upload_kanban_qty(frm) {\n        frm.save()\n        var d = new frappe.ui.Dialog({\n            title: __(\"Upload Kanban Qty\"),\n            fields: [{\n                    label: \"\",\n                    fieldname: \"a_download\",\n                    fieldtype: \"HTML\",\n                    options: \"<p style='font-size: 15px;'>A) Download the template of kanban qty</p>\"\n\n                },\n                {\n                    label: \"\",\n                    fieldname: \"b_attach\",\n                    fieldtype: \"HTML\",\n                    options: \"<p style='font-size: 15px; margin-top: 25px;'>B) Attach the file to be uploaded</p>\"\n\n                },\n                {\n                    label: \"\",\n                    fieldname: \"col1\",\n                    fieldtype: \"Column Break\",\n\n\n                },\n                {\n                    label: \"Download\",\n                    fieldname: \"download\",\n                    fieldtype: \"Button\",\n\n                },\n                {\n                    label: \"\",\n                    fieldname: \"attach\",\n                    fieldtype: \"Attach\",\n\n                },\n            ],\n\n            primary_action: function() {\n                var data = d.get_values();\n                if (data.attach) {\n\n                    frappe.call({\n                        method: 'onegene.onegene.custom.upload_kanban_qty',\n                        args: {\n                            'file': data.attach,\n                            'production_plan': frm.doc.name,\n                        },\n                        freeze: true,\n                        freeze_message: 'Updating Kanban Quantity Data....',\n                        callback(r) {\n                            if (r.message) {\n                                frappe.show_alert({\n                                    message: __('Kanban Quantity Updated Successfully'),\n                                    indicator: 'green'\n                                }, 5);\n                                d.hide();\n                            }\n                        }\n                    })\n                } else {\n                    frappe.msgprint('Please Attach the Excel File')\n                }\n\n\n\n            },\n            primary_action_label: __(\"Upload\"),\n        });\n\n        d.show();\n        d.fields_dict.download.$wrapper.find('button').click(() => {\n            const rows = frm.doc.po_items;\n\n            fetch(\"/api/method/onegene.onegene.custom.download_kqty_template\", {\n                    method: \"POST\",\n                    headers: {\n                        \"Content-Type\": \"application/json\",\n                        \"Accept\": \"application/octet-stream\",\n                        \"X-Frappe-CSRF-Token\": frappe.csrf_token\n                    },\n                    body: JSON.stringify({\n                        data: JSON.stringify(rows)\n                    })\n                })\n                .then(response => {\n                    if (!response.ok) {\n                        throw new Error(\"Failed to download\");\n                    }\n                    return response.blob();\n                })\n                .then(blob => {\n                    const url = window.URL.createObjectURL(blob);\n                    const a = document.createElement(\"a\");\n                    a.href = url;\n                    a.download = \"kanban_qty_template.csv\";\n                    document.body.appendChild(a);\n                    a.click();\n                    a.remove();\n                })\n                .catch(err => {\n                    frappe.msgprint(\"Download failed: \" + err.message);\n                });\n        });\n    }\n})\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.567169",
  "module": "ONEGENE",
  "name": "Material Request",
  "script": "frappe.ui.form.on('Material Request', {\r\n    custom_bom(frm) {\r\n        \r\n         if(frm.doc.custom_bom){\r\n            if(!frm.doc.set_from_warehouse){\r\n                frm.set_value(\"custom_bom\",\"\").then(r=>{\r\n                    \r\n                    frappe.throw(\"Set the Source Warehouse before adding BOM\")\r\n                    frappe.throw(\"BOM சேர்க்குமுன் Source Warehouse-ஐ அமைக்கவும்\") \r\n                frm.refresh_field(\"custom_bom\");\r\n                    \r\n                })\r\n                \r\n                \r\n            }\r\n        }\r\n        \r\n         if (frm.doc.custom_bom) {\r\n            frappe.call({\r\n               method: \"onegene.utils.mr_required_from_pmr\",\r\n               args: {\r\n                   \"bom\": frm.doc.custom_bom\r\n               },\r\n               callback: function(r) {\r\n                   if (r.message) {\r\n                       frm.set_value(\"custom_mr_required\", r.message);\r\n                   }\r\n               }\r\n            });\r\n        } \r\n        \r\n        \r\n        if (frm.doc.custom_bom) {\r\n            \r\n            frappe.call({\r\n                method: \"onegene.onegene.custom.validate_bom_warehouse\",\r\n                args: {\r\n                    \"bom\": frm.doc.custom_bom,\r\n                    \"warehouse\": frm.doc.set_from_warehouse\r\n                },\r\n                callback: function(r) {\r\n                    \r\n                    if (!r.message.is_valid) {\r\n                        frm.set_value(\"custom_bom\", \"\");\r\n                        frappe.msgprint(__(\"The selected BOM is not valid for the selected warehouse.\"));\r\n                        frappe.msgprint(__(\"தேர்ந்தெடுக்கப்பட்ட BOM, தேர்ந்தெடுக்கப்பட்ட warehouse -ல் செல்லாதது.\")); \r\n                    }\r\n                }\r\n            });\r\n        }\r\n        \r\n       \r\n        \r\n        \r\n    },\r\n    custom_update_items(frm) {\r\n        if (!frm.doc.custom_bom || !frm.doc.set_from_warehouse) {\r\n            frappe.msgprint(\"BOM or Set From Warehouse should not be empty\");\r\n            frappe.msgprint(\"BOM அல்லது அனுப்பும் கோவை காலியாக இருக்கக் கூடாது\");\r\n\r\n        }\r\n        else {\r\n            frappe.call({\r\n                method: \"onegene.utils.explode_and_update_bom_in_mri\",\r\n                args: {\r\n                    \"bom\": frm.doc.custom_bom,\r\n                    \"source_warehouse\": frm.doc.set_from_warehouse,\r\n                },\r\n                freeze: true,\r\n                freeze_message: \"Fetching Data ...\",\r\n                callback: function(r) {\r\n                    if (r.message && Array.isArray(r.message)) {\r\n                        \r\n                        \r\n                        frm.doc.items.forEach((row, index) => {\r\n                            if (!row.item_code || row.item_code.trim() === \"\") {\r\n                                frm.get_field(\"items\").grid.grid_rows_by_docname[row.name].remove();\r\n                            }\r\n                        });\r\n                        \r\n    \r\n                        r.message.forEach(row => {\r\n                            // ✅ Check if this item_code already exists in child table\r\n                            let exists = frm.doc.items.some(d => d.item_code === row.item_code);\r\n    \r\n                            if (!exists) {\r\n                                let child = frm.add_child(\"items\");\r\n                                frappe.model.set_value(child.doctype, child.name, \"item_code\", row.item_code);\r\n                                frappe.model.set_value(child.doctype, child.name, \"from_warehouse\", frm.doc.set_from_warehouse);\r\n                                frappe.model.set_value(child.doctype, child.name, \"warehouse\", frm.doc.set_target_warehouse);\r\n                            }\r\n                        });\r\n    \r\n                        frm.refresh_field(\"items\");\r\n    \r\n                    } else {\r\n                        frappe.msgprint(\"No items found in BOM.\");\r\n                        frappe.msgprint(\"BOM-இல் எந்த பொருட்களும் இல்லை.\");\r\n\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    },\r\n    setup(frm){\r\n        // frappe.call({\r\n        //     method: \"onegene.onegene.custom.get_user_permitted_department\",\r\n        //     callback: function(r) {\r\n        //         let permitted_departments = r.message || [];\r\n                \r\n        //         // Set query after fetching departments\r\n        //         frm.set_query(\"custom_requested_by\", function() {\r\n        //             return {\r\n        //                 filters: {\r\n        //                     \"department\": [\"in\", permitted_departments]\r\n        //                 }\r\n        //             };\r\n        //         });\r\n        //     }\r\n        // });\r\n        frappe.call({\r\n    method: \"onegene.onegene.custom.get_user_permitted_department\",\r\n    callback: function(r) {\r\n        let permitted_departments = r.message || [];\r\n        \r\n        if (permitted_departments.length === 0) {\r\n                frm.set_query(\"custom_requested_by\", function() {\r\n                    return {}; // no filter → all employees visible\r\n                });\r\n                return;\r\n            }\r\n        if (permitted_departments.length === 1 && permitted_departments.includes(\"All Departments\")) {\r\n                    frm.set_query(\"custom_requested_by\", function() {\r\n                            return {}; \r\n                        });\r\n                        return;\r\n                }\r\n\r\n        // Get all child departments for the permitted departments\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Department\",\r\n                filters: {\r\n                    \"parent_department\": [\"in\", permitted_departments]\r\n                },\r\n                fields: [\"name\"]\r\n            },\r\n            callback: function(child_r) {\r\n                let child_departments = child_r.message.map(d => d.name) || [];\r\n                \r\n                // Combine parent and child departments\r\n                let departments_to_filter = permitted_departments.concat(child_departments);\r\n\r\n                // Set query for employee field\r\n                frm.set_query(\"custom_requested_by\", function() {\r\n                    return {\r\n                        filters: {\r\n                            \"department\": [\"in\", departments_to_filter]\r\n                        }\r\n                    };\r\n                });\r\n            }\r\n        });\r\n    }\r\n}); \r\n\r\n        \r\n    },\r\n\r\n    onload: function(frm) {\r\n        \r\n        \r\n\r\n        \r\n        // frm.fields_dict['custom_requested_by'].get_query = async function(doc, cdt, cdn) {\r\n        //     let result = await frappe.call({\r\n        //         method: \"onegene.onegene.custom.get_user_permitted_department\"\r\n        //     });\r\n        \r\n        //     let departments = result.message;\r\n        //     console.log(departments)\r\n        \r\n        //     return {\r\n        //         query: \"frappe.desk.search.search_link\",\r\n        //         filters: {\r\n        //             'doctype':\"Employee\",\r\n        //             'department': [\"in\", departments]\r\n        //         }\r\n        //     }\r\n        // }\r\n\r\n        \r\n      \r\n if(frm.doc.set_from_warehouse) {\r\n            frm.set_query(\"custom_bom\", () => {\r\n                return {\r\n                    query: \"onegene.onegene.custom.get_custom_bom_pmr\",\r\n                    filters: {\r\n                        warehouse: frm.doc.set_from_warehouse\r\n                    }\r\n                };\r\n            });\r\n        }\r\n       \r\n        \r\n        \r\n        \r\n        var user = frappe.session.user;\r\n        if (frm.doc.material_request_type == \"Material Transfer\" && !frappe.user.has_role(\"System Manager\")) {\r\n            if (frm.doc.creation) {\r\n            let creationDateTime = new Date(frm.doc.creation);\r\n            let now = new Date();\r\n            let today830 = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 30, 0);\r\n            let isAfter830 = now > today830;\r\n            let isCreatedBefore830 = creationDateTime <= today830;\r\n            if (isAfter830 && isCreatedBefore830) {\r\n                // ✅ Both conditions true → make form read-only and hide buttons\r\n                frm.set_read_only();\r\n                frm.disable_save(); // optional\r\n                $(frm.page.wrapper).find('.page-actions').hide();\r\n            } else {\r\n                // Allow editing\r\n                frm.set_read_only(false);\r\n                $(frm.page.wrapper).find('.page-actions').show();\r\n\r\n            }\r\n        }\r\n        if (user == \"cutting@onegeneindia.in\") {\r\n            frm.set_query(\"custom_requested_by\", function() {\r\n            return {\r\n                filters: {\r\n                    department: \"Cutting Store (Tube) - WAIP\"\r\n                }\r\n            };\r\n        });\r\n        }\r\n        }\r\n            setTimeout(() => {\r\n        if (frm.doc.material_request_type == \"Material Transfer\") {\r\n                frm.fields_dict.items.grid.get_field('item_code').get_query = function(doc, cdt, cdn) {\r\n                    const row = locals[cdt][cdn];\r\n    \r\n                    if (!frm.doc.set_from_warehouse) {\r\n                        return;\r\n                    }\r\n                    return {\r\n                        query: \"onegene.onegene.custom.get_items_from_production_material_request\",\r\n                        filters: {\r\n                            source_warehouse: frm.doc.set_from_warehouse\r\n                        }\r\n                    };\r\n                };\r\n                \r\n                // frm.set_query('custom_bom', () => {\r\n                //     return {\r\n                //         filters: {\r\n                //             \"is_default\": 1,\r\n                //         }\r\n                //     }\r\n                \r\n                // });\r\n                \r\n                \r\n                \r\n            }\r\n            }, 300);\r\n        \r\n        if (frm.doc.__islocal) {\r\n            frm.set_value(\"material_request_type\", \"Material Transfer\");\r\n            const today = new Date().toISOString().split(\"T\")[0];\r\n            frm.set_value(\"schedule_date\", today);\r\n            frm.set_value(\"set_warehouse\", \"Shop Floor - WAIP\");\r\n            \r\n            //  frappe.db.get_value(\"Employee\",{\"user_id\":frappe.session.user},\"name\").then(r=>{\r\n            \r\n            // if (r && r.message) {\r\n\r\n            //      frm.set_value(\"custom_requested_by\",r.message.name )\r\n                 \r\n            // }\r\n                 \r\n            //  })\r\n             \r\n       \r\n        }\r\n        \r\n    if(frm.doc.material_request_type == \"Material Transfer\"){    \r\n    frm.set_query('set_from_warehouse', () => {\r\n        if (frm.doc.custom_department == \"Cutting - WAIP\") {\r\n            return {\r\n                filters: {\r\n                            \"warehouse_name\": [\"in\", [\"Raw Material\"]]\r\n        \r\n                }\r\n            }\r\n        }\r\n        else {\r\n            return {\r\n                filters: {\r\n                            \"warehouse_name\": [\"in\", [\"Cutting Store (Tube)\",\"Consumables\",\"PPS Store\"]]\r\n        \r\n                }\r\n            }\r\n        }\r\n        if (frappe.session.user.has_role(\"System Manager\")) {\r\n            return {\r\n                filters: {\r\n                            \"warehouse_name\": [\"in\", [\"Cutting Store (Tube)\",\"Consumables\",\"PPS Store\"]]\r\n        \r\n                }\r\n            }\r\n        }\r\n    })\r\n    }\r\n    \r\n   \r\n    \r\n    \r\n    if (frm.doc.__islocal) {\r\n        \r\n    let today_str = frappe.datetime.get_today();           \r\n    let user_format = frappe.datetime.str_to_user(today_str);  \r\n    \r\n    \r\n    \r\n    frappe.db.get_value(\r\n        \"Production Material Request\",\r\n        { \"date\": today_str },\r\n        \"last_updated_on\"                    \r\n    ).then(r => {\r\n        if (r && r.message) {\r\n               \r\n        frm.set_value(\"custom_mr_posted_on\", r.message.last_updated_on);\r\n    }\r\n});\r\n\r\n}\r\n    \r\n    \r\n    \r\n \r\n  \r\n      \r\n      \r\n      \r\n        \r\n    },\r\n    \r\n    \r\n    \r\n    set_from_warehouse: function (frm) {\r\n    const allowed = [\"Raw Material - WAIP\", \"Cutting Store (Ext) - WAIP\", \"Cutting Store (Tube) - WAIP\", \"Consumables - WAIP\", \"PPS Store - WAIP\"];\r\n    if (!allowed.includes(frm.doc.set_from_warehouse)) {\r\n        frm.set_value(\"set_from_warehouse\", \"\");\r\n    }\r\n    \r\n    \r\n    if (frm.doc.set_from_warehouse) {\r\n            frm.set_query(\"custom_bom\", function() {\r\n                return {\r\n                    query: \"onegene.onegene.custom.get_custom_bom_pmr\",\r\n                    filters: {\r\n                        warehouse: frm.doc.set_from_warehouse\r\n                    }\r\n                };\r\n            });\r\n        }\r\n    \r\n},\r\n// before_workflow_action: async function(frm) {\r\n//         // Check if workflow is moving to Pending For HOD\r\n//         if (frm.doc.workflow_state === \"Pending For HOD\") {\r\n//             // Set custom_hod field to logged-in user\r\n//             frm.set_value('custom_hod', frappe.session.user);\r\n//             // await frm.save();  // Save immediately\r\n//         }\r\n//         if (frm.doc.workflow_state === \"Peding for ERP Team\") {\r\n//             frm.set_value('custom_erp_team', frappe.session.user);\r\n//         }\r\n//     },\r\n// before_workflow_action: async (frm) => {\r\n//         if (frm.doc.workflow_state == \"Pending For HOD\" && frm.selected_workflow_action == \"Approve\") {\r\n//              await new Promise((resolve, reject) => {\r\n//                 frappe.call({\r\n//                     method: \"onegene.onegene.custom.update_hod\",\r\n//                     args: {\r\n//                         name: frm.doc.name,\r\n//                     },\r\n//                     callback: function(r) {\r\n//                         resolve();\r\n//                     },\r\n//                     error: function(err) {\r\n//                         reject(err);\r\n//                     }\r\n//                 });\r\n//             }).catch(error => frappe.throw(error));\r\n//         }\r\n//     },\r\n\r\n    \r\n    refresh(frm){\r\n        \r\n        \r\n         if(frappe.user.has_role(\"Stock User\")){\r\n        frm.set_df_property(\"custom_requested_by\",\"ignore_permission\",1)\r\n        frm.set_df_property(\"custom_department\",\"ignore_permission\",1)\r\n    }\r\n    else{\r\n        \r\n        frm.set_df_property(\"custom_requested_by\",\"ignore_permission\",0)\r\n        frm.set_df_property(\"custom_department\",\"ignore_permission\",0)\r\n        \r\n    }\r\n       \r\n        \r\n         \r\n        setTimeout(() => {\r\n            frm.remove_custom_button('Pick List', 'Create');\r\n            frm.remove_custom_button('Material Transfer', 'Create');\r\n            frm.remove_custom_button('Material Transfer (In Transit)', 'Create');\r\n            frm.remove_custom_button('Bill of Materials', 'Get Items From');\r\n            frm.remove_custom_button('Sales Order', 'Get Items From');\r\n            frm.remove_custom_button('Product Bundle', 'Get Items From');\r\n            \r\n        }, 100);\r\n        \r\n        if (frm.doc.material_request_type == \"Material Transfer\") {\r\n            setTimeout(() => {\r\n                frm.remove_custom_button('Stop');\r\n            }, 50);\r\n        }\r\n        \r\n        // if (frm.doc.material_request_type == \"Material Transfer\") {\r\n        //     frm.add_custom_button(__('New Material Transfer'), () => {\r\n        //         frappe.call({\r\n        //             method: \"onegene.onegene.doctype.material_transfer.material_transfer.make_material_transfer\",\r\n        //             args: {\r\n        //                 material_request: frm.doc.name\r\n        //             },\r\n        //             callback: function(r) {\r\n        //                 if (!r.exc && r.message) {\r\n        //                     let doc = frappe.model.sync(r.message)[0];\r\n        //                     frappe.set_route(\"Form\", doc.doctype, doc.name);\r\n        //                 }\r\n        //             }\r\n        //         });\r\n        //     }, __('Create'));\r\n        // }\r\n        if (frm.doc.material_request_type == \"Material Transfer\") {\r\n          if (\r\n            !frm.doc.__islocal && frm.doc.docstatus == 1 && (frm.doc.owner != frappe.session.user || frappe.user.has_role(\"System Manager\")) &&\r\n            (frappe.user.has_role(\"Stock User\") ||\r\n             frappe.user.has_role(\"System Manager\") ||\r\n             frappe.user.has_role(\"Administrator\"))\r\n        )  {\r\n            frappe.call({\r\n                method: \"onegene.onegene.doctype.material_transfer.material_transfer.check_material_request_status\",\r\n                args: {\r\n                    material_request: frm.doc.name\r\n                },\r\n                callback: function(r) {\r\n                    if (!r.exc && r.message === false) {\r\n                        frm.add_custom_button(__('Material Transfer'), () => {\r\n                            frappe.call({\r\n                                method: \"onegene.onegene.doctype.material_transfer.material_transfer.make_material_transfer\",\r\n                                args: {\r\n                                    material_request: frm.doc.name\r\n                                },\r\n                                callback: function(r) {\r\n                                    if (!r.exc && r.message) {\r\n                                        let doc = frappe.model.sync(r.message)[0];\r\n                                        frappe.set_route(\"Form\", doc.doctype, doc.name);\r\n                                    }\r\n                                }\r\n                            });\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n          }\r\n        }\r\n        if (frm.doc.docstatus != 2 && !frm.doc.__islocal) {\r\n            frm.add_custom_button(__(\"Report View\"), function () {\r\n            frappe.call({\r\n                method: \"onegene.onegene.custom.create_html_mr\",\r\n                args: {\r\n                    doc: JSON.stringify(frm.doc)  \r\n                },\r\n                callback: function (r) {\r\n                    if (r.message && r.message.html) {\r\n                        // Create dialog\r\n                        let d = new frappe.ui.Dialog({\r\n                            size: \"large\",\r\n                            primary_action_label: __(\"Close\"),\r\n                            primary_action: function () {\r\n                                d.hide();\r\n                            }\r\n                        });\r\n        \r\n                        // Set the HTML content\r\n                        d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\"); // optional: wider dialog\r\n                        d.$body.html(r.message.html);\r\n                        d.show();\r\n                    } else {\r\n                        frappe.msgprint(__(\"Unable to load preview\"));\r\n                        frappe.msgprint(__(\"முன்னோட்டத்தை ஏற்ற முடியவில்லை\"));\r\n\r\n                    }\r\n                }\r\n            });\r\n        });\r\n        }\r\n        \r\n            \r\n    if (!frappe.user.has_role(\"System Manager\")) {\r\n            frm.set_df_property(\"material_request_type\", \"read_only\", 1);\r\n        }\r\n        \r\n    \r\n    if(frappe.user.has_role(\"Stock User\")){\r\n        frm.set_df_property(\"custom_requested_by\",\"ignore_permission\",1)\r\n        frm.set_df_property(\"custom_department\",\"ignore_permission\",1)\r\n    }\r\n    else{\r\n        \r\n        frm.set_df_property(\"custom_requested_by\",\"ignore_permission\",0)\r\n        frm.set_df_property(\"custom_department\",\"ignore_permission\",0)\r\n        \r\n    }\r\n    \r\n\r\n        \r\n        \r\n        \r\n        if (!frm.doc.__islocal) {\r\n            \r\n            if(frm.doc.docstatus == 1){\r\n            frm.add_custom_button(__('Print MR'), function () {\r\n                const docname = frm.doc.name;\r\n                const print_format = \"MR Print\";\r\n                const letter_head = frappe.defaults.get_default(\"letter_head\") || \"\";\r\n\r\n                const pdf_url = `/api/method/frappe.utils.print_format.download_pdf?doctype=Material Request`\r\n                    + `&name=${encodeURIComponent(docname)}`\r\n                    + `&format=${encodeURIComponent(print_format)}`\r\n                    + `&no_letterhead=0`\r\n                    + `&letterhead=${encodeURIComponent(letter_head)}`\r\n                    + `&trigger_print=1`;\r\n\r\n                window.open(frappe.urllib.get_full_url(pdf_url));\r\n            });\r\n            }\r\n        }\r\n        // frm.fields_dict.custom_html.$wrapper.html(`\r\n        //     <table class=\"w-100 mb-3\">\r\n        //         <tr>\r\n        //             <td style=\"padding-left: 10px;\"><b>IOT -</b> Item Order Type</td>\r\n        //             <td style=\"padding-left: 10px;\"><b>PPSQ -</b>PPS (Open) Quantity</td>\r\n        //             <td style=\"padding-left: 10px;\"><b>RSQ -</b> Required vs Short Quantity</td>\r\n        //         </tr>\r\n        //         <tr>\r\n        //             <td style=\"padding-left: 10px;\"><b>TRQ -</b> Total Required Quantity</td>\r\n        //             <td style=\"padding-left: 10px;\"><b>SFQ -</b> Shop Floor Quantity</td>\r\n        //         </tr>\r\n        //     </table>\r\n        // `);\r\n        frm.fields_dict['items'].grid.update_docfield_property('custom_item_order_type', 'reqd', frm.doc.material_request_type == 'Purchase');\r\n       \r\n        if (frm.doc.material_request_type === \"Purchase\" && frm.doc.docstatus==1 && frm.doc.custom_order_type == \"Open\") {\r\n\t\t\tfrm.add_custom_button(__('MR Scheduling'),() => {\r\n\t\t\t    frappe.model.with_doctype('MR Scheduling', function () {\r\n                    let doc = frappe.model.get_new_doc('MR Scheduling');\r\n                    doc.material_request = frm.doc.name;\r\n                    \r\n                    frappe.set_route('Form', 'MR Scheduling', doc.name);\r\n                });\r\n\t\t\t}, __('Create'));\r\n\t\t}\r\n    },\r\n   \r\n    \r\n    before_save: function(frm) {\r\n        if (frm.doc.__islocal) {\r\n            $.each(frm.doc.items, function(i, k) {\r\n                if (k.item_code) {\r\n                    frappe.call({\r\n                        method: \"onegene.onegene.custom.get_previous_purchase_rate\",\r\n                        args: {\r\n                            item_code: k.item_code\r\n                        },\r\n                        callback: function(r) {\r\n                            if (r.message) {\r\n                                frappe.model.set_value(k.doctype, k.name, 'custom_previous_po_rate', r.message);\r\n                                k.custom_previous_po_rate = r.message;\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    validate: function(frm) {\r\n        // $.each(frm.doc.items, function(i, j) {\r\n        //     if (j.qty > j.custom_mr_qty) {\r\n        //         frappe.throw(\"Not allowed to transfer more quantity than the Generated Plan\");\r\n        //     }\r\n        // });\r\n    },\r\n    \r\n    get_mri_data_from_item_code: function(frm) {\r\n        frm.fields_dict['items'].grid.get_field('item_code').get_query = function(doc, cdt, cdn) {\r\n            const row = locals[cdt][cdn];\r\n            const source_warehouse = frm.doc.set_from_warehouse;\r\n\r\n            if (!item_code) return;\r\n            \r\n            frappe.call({\r\n                method: \"onegene.onegene.custom.get_items_from_production_material_request\",\r\n                args: {\r\n                    doctype: \"Production Material Request\",\r\n                    txt: \"\",\r\n                    searchfield: \"name\",\r\n                    start: 0,\r\n                    page_len: 10,\r\n                    filters: {\r\n                        item_code: item_code\r\n                    }\r\n                },\r\n            });\r\n\r\n            return {\r\n                query: \"onegene.onegene.custom.get_items_from_production_material_request\",\r\n                filters: {\r\n                    item_code: item_code\r\n                }\r\n            };\r\n        };\r\n\r\n        frm.fields_dict.items.grid.get_field('custom_supplier').get_query = function(doc, cdt, cdn) {\r\n            let row = locals[cdt][cdn];  \r\n            return {\r\n                filters: {\r\n                    \"name\": [\"in\", get_supplier_names(row.item_code)]\r\n                }\r\n            };\r\n        };\r\n    }\r\n});\r\n\r\nfunction get_supplier_names(item_code) {\r\n    let supplier_names = [];\r\n    \r\n    // Fetch the item document to get the list of supplier names from Supplier Item child table\r\n    frappe.call({\r\n        method: \"frappe.client.get\",\r\n        args: {\r\n            doctype: \"Item\",\r\n            name: item_code\r\n        },\r\n        async: false,  // Ensure the call completes before proceeding\r\n        callback: function(response) {\r\n            let item_doc = response.message;\r\n            if (item_doc && item_doc.supplier_items) {\r\n                supplier_names = item_doc.supplier_items.map(supplier_item => supplier_item.supplier);\r\n            }\r\n        }\r\n    });\r\n    \r\n    return supplier_names;\r\n}\r\n\r\nfrappe.ui.form.on('Material Request Item', {\r\n    item_code: function(frm, cdt, cdn) {\r\n        \r\n            \r\n            let child = locals[cdt][cdn]\r\n            \r\n            let sys_date = frappe.datetime.user_to_str(frm.doc.transaction_date);\r\n            frappe.call({\r\n                method:\"onegene.onegene.custom.today_req_qty_update\",\r\n                args:{\r\n                    \"item_code\":child.item_code,\r\n                    \"date\":frm.doc.transaction_date\r\n                },\r\n                freeze: true,\r\n                freeze_message: \"Fetching Data ...\",\r\n                callback:function(r){\r\n                    if(r.message != null){\r\n                        console.log(r.message)\r\n                        frappe.model.set_value(cdt, cdn, \"custom_today_req_qty\", r.message);\r\n                        frm.refresh_field('custom_today_req_qty');\r\n                    }\r\n                    else{\r\n                        console.log(\"No\")\r\n                        console.log(sys_date)\r\n                    }\r\n                }\r\n            })\r\n            \r\n            if(!frm.doc.set_from_warehouse){\r\n            frappe.model.clear_doc(cdt, cdn);\r\n                frm.refresh_field('items')\r\n                frappe.throw(__(\"Set the Source Warehouse before adding Item\"));\r\n                frappe.throw(\"Item சேர்க்குமுன் Source Warehouse-ஐ அமைக்கவும்\") \r\n            }\r\n            // if (frm.doc.material_request_type == \"Material Transfer\") {\r\n                if (!child.item_code) return;\r\n                if (!child.from_warehouse) return;\r\n                frappe.call({\r\n                    method: \"onegene.onegene.custom.get_pmr_data\",\r\n                    args: {\r\n                        \"item_code\": child.item_code,\r\n                        \"name\": frm.doc.name,\r\n                        \"warehouse\": child.from_warehouse,\r\n                    },\r\n                    freeze: true,\r\n                    freeze_message: \"Fetching Data ...\",\r\n                    callback: function(r) {\r\n                        if (!r.message) return;\r\n                        if (r.message == \"item not found\") {\r\n                            frappe.msgprint(`Item ${child.item_code} not found in Plan`, title=\"Plan Not Found\")\r\n                            frappe.msgprint(`Plan-இல் Item ${child.item_code} காணப்படவில்லை` , title=\"Plan Not Found\")\r\n                            frappe.model.set_value(cdt, cdn, \"item_code\", \"\");\r\n                        }\r\n                        r.message.forEach(item => {\r\n                            if (item.total_required_qty <= 0 && item.item_code) {\r\n                                frappe.msgprint({\r\n                                    title: __(\"Exceeded Planned Quantity\"),\r\n                                    message: __(\"You can't make request more than today plan for the item - {0}\", [item.item_code]),\r\n                                    indicator: 'red'\r\n                                });\r\n                                frappe.msgprint({\r\n                                    title: __(\"திட்டமிடப்பட்ட அளவுக்கு மீறியது\"),\r\n                                    message: __(\"இந்த Item- {0} இற்கான இன்றைய திட்டத்தைவிட அதிகமாக கோர முடியாது\", [item.item_code]), \r\n                                    indicator: 'red'\r\n                                });\r\n\r\n                                frm.get_field(\"items\").grid.grid_rows_by_docname[child.name].remove();\r\n                                frm.refresh_field(\"items\");\r\n                                return;\r\n                            }\r\n                            frappe.model.set_value(cdt, cdn, \"item_code\", item.item_code);\r\n                            frappe.model.set_value(cdt, cdn, \"item_name\", item.item_name);\r\n                            frappe.model.set_value(cdt, cdn, \"uom\", item.uom);\r\n                            frappe.model.set_value(cdt, cdn, \"actual_qty\", item.actual_qty);\r\n                            frappe.model.set_value(cdt, cdn, \"custom_pack_size\", item.pack_size);\r\n                            frappe.model.set_value(cdt, cdn, \"custom_shop_floor_stock\", item.shop_floor_qty);\r\n                            frappe.model.set_value(cdt, cdn, \"custom_total_req_qty\", item.total_required_qty);\r\n                            frm.refresh_field('items');\r\n                        });\r\n                    }\r\n                });\r\n                // Duplicate Items Valdiation\r\n                setTimeout(() => {\r\n                let duplicate_found = frm.doc.items.some(\r\n                    item => item.item_code === child.item_code && item.name !== child.name\r\n                );\r\n        \r\n                if (duplicate_found) {\r\n                    let d = frappe.msgprint({\r\n                        title: __(\"Removing Duplicate Entry\"),\r\n                        message: __(\"Item Code <b>{0}</b> is already added.\", [child.item_code]),\r\n                        indicator: 'red'\r\n                    });\r\n        \r\n                    frm.get_field('items').grid.grid_rows_by_docname[cdn].remove();\r\n                    frm.refresh_field('items');\r\n        \r\n                    setTimeout(() => {\r\n                        if (d && d.hide) d.hide();\r\n                    }, 1000);\r\n                }\r\n            }, 500);\r\n        // }\r\n    },\r\n    custom_supplier: function(frm, cdt, cdn) {\r\n        let child = locals[cdt][cdn];\r\n        frappe.call({\r\n            method: 'onegene.onegene.custom.set_lead_time',\r\n            args: {\r\n                'item': child.item_code,\r\n                'supplier':child.custom_supplier\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    child.custom_lead_time = r.message\r\n                }\r\n                 frm.refresh_field(\"items\");\r\n            }\r\n        });\r\n    },\r\n    // qty: function(frm, cdt, cdn) {\r\n    //     let child = locals[cdt][cdn];\r\n    //     if (child.qty > child.custom_mr_qty) {\r\n    //         frappe.throw(\"Not allowed to transfer more quantity than the Generated Plan\");\r\n    //     }\r\n    //     frm.refresh_field(\"items\");\r\n    // },\r\n    \r\n    custom_forecast: function(frm, cdt, cdn) {\r\n        let child = locals[cdt][cdn];\r\n        frappe.call({\r\n            method: 'onegene.onegene.utils.mat_req_item',\r\n            args: {\r\n                'item': child.item_code\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    let d = new frappe.ui.Dialog({\r\n                        size: \"extra-large\",\r\n                        fields: [\r\n                            {\r\n                                label: 'Supplier Details',\r\n                                fieldname: 'stock_details',\r\n                                fieldtype: 'HTML'\r\n                            }\r\n                        ]\r\n                    });\r\n                    d.fields_dict.stock_details.$wrapper.html(r.message);\r\n                    d.show();\r\n                }\r\n            }\r\n        });\r\n    },\r\n    custom_supplier: function(frm, cdt, cdn) {\r\n        let child = locals[cdt][cdn];\r\n        frappe.call({\r\n            method: 'onegene.onegene.utils.mat_req_item_expt',\r\n            args: {\r\n                'items': child.item_code,\r\n                'suppliers':child.custom_supplier,\r\n                \"transaction_date\":frm.doc.transaction_date\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    child.date = r.message\r\n                }\r\n                frm.refresh_field(\"items\");\r\n            }\r\n        });\r\n    },\r\n    custom_requesting_qty: function(frm, cdt, cdn) {\r\n        let child = locals[cdt][cdn];\r\n        \r\n\r\n        \r\n        frappe.model.set_value(cdt, cdn, \"qty\", child.custom_requesting_qty);\r\n        if (child.custom_pack_size > 0) {\r\n            \r\n            if (child.custom_requesting_qty < child.custom_pack_size && child.custom_requesting_qty !=0) {\r\n            \r\n                frappe.model.set_value(cdt, cdn, \"custom_requesting_qty\", child.custom_pack_size);\r\n                frappe.model.set_value(cdt, cdn, \"qty\", child.custom_pack_size);\r\n                     \r\n                 }\r\n            \r\n            \r\n            if (child.custom_requesting_qty > child.custom_pack_size) {\r\n                \r\n                rem = child.custom_requesting_qty % child.custom_pack_size\r\n                \r\n                if(rem > 0){\r\n                     \r\n                      frappe.model.set_value(cdt, cdn, \"custom_requesting_qty\", 0 );\r\n                      frm.refresh_field('items');\r\n                      frappe.msgprint(\"Requesting Qty must be multiple of Pack Size\")\r\n                      frappe.msgprint(\"கோரப்பட்ட அளவு, Pack Size-ன் பன்மடிக்காக இருக்க வேண்டும்\");\r\n                      \r\n                }\r\n                else{\r\n                    \r\n                    \r\n                    if (child.custom_requesting_qty > child.custom_total_req_qty) {\r\n                    frappe.msgprint(\"You can't request qty greater than today plan\")\r\n                    frappe.msgprint(\"நீங்கள் இன்று திட்டத்தைவிட அதிகமான அளவை கோர முடியாது\");\r\n                    frappe.model.set_value(cdt, cdn, \"custom_requesting_qty\", child.custom_pack_size);\r\n                    frappe.model.set_value(cdt, cdn, \"qty\", child.custom_pack_size);\r\n                }\r\n                    \r\n                }\r\n            }\r\n        }\r\n        else {\r\n            if (child.custom_requesting_qty > child.custom_total_req_qty) {\r\n                frappe.msgprint(\"You can't request qty greater than today plan\")\r\n                frappe.msgprint(\"நீங்கள் இன்று திட்டத்திலிருந்து அதிகமான அளவை கோர முடியாது\");\r\n                frappe.model.set_value(cdt, cdn, \"custom_requesting_qty\", child.custom_total_req_qty);\r\n                frappe.model.set_value(cdt, cdn, \"qty\", child.custom_total_req_qty);\r\n            }\r\n        }\r\n        \r\n        \r\n        \r\n        // if (child.custom_requesting_qty > child.custom_total_req_qty) {\r\n        //     if (child.custom_pack_size > 0) {\r\n        //         if (child.custom_pack_size > child.custom_total_req_qty) {\r\n        //             frappe.model.set_value(cdt, cdn, \"custom_requesting_qty\", child.custom_pack_size);\r\n        //         }\r\n        //         if (child.custom_pack_size > child.custom_requesting_qty) {\r\n        //             frappe.model.set_value(cdt, cdn, \"custom_requesting_qty\", child.custom_pack_size);\r\n        //         }\r\n        //     }\r\n        //     else {\r\n        //         frappe.model.set_value(cdt, cdn, \"custom_requesting_qty\", child.custom_total_req_qty);\r\n        //         frappe.msgprint(`<b>Row ${child.idx}:</b> Requesting Qty should not exceed Total Required Quantity of ${child.custom_total_req_qty}`);\r\n        //     }\r\n        // }\r\n        // else {\r\n        //     if (child.custom_pack_size > 0) {\r\n        //         if (child.custom_pack_size > child.custom_total_req_qty) {\r\n        //             frappe.model.set_value(cdt, cdn, \"custom_requesting_qty\", child.custom_pack_size);\r\n        //         }\r\n        //         if (child.custom_pack_size > child.custom_requesting_qty) {\r\n        //             frappe.model.set_value(cdt, cdn, \"custom_requesting_qty\", child.custom_pack_size);\r\n        //         }\r\n        //     }\r\n        //     else {\r\n        //         frappe.model.set_value(cdt, cdn, \"custom_requesting_qty\", child.custom_total_req_qty);\r\n        //     }\r\n        //     if (child.actual_qty > child.custom_requesting_qty) {\r\n        //         frappe.model.set_value(cdt, cdn, \"custom_required_vs_short_qty\", 0);\r\n        //     }\r\n        //     else {\r\n        //         frappe.model.set_value(cdt, cdn, \"custom_required_vs_short_qty\", child.custom_requesting_qty);\r\n        //     }\r\n        // }\r\n        // frappe.model.set_value(cdt, cdn, \"qty\", child.custom_requesting_qty);\r\n    },\r\n    // custom_total_req_qty: function(frm, cdt, cdn) {\r\n    //     let child = locals[cdt][cdn];\r\n    //     if (child.custom_current_req_qty > child.custom_total_req_qty) {\r\n    //         frappe.msgprint(`<b>Row ${child.idx}:</b> Required Qty should not exceed Total Required Quantity of ${child.custom_total_req_qty}`);\r\n    //         frappe.model.set_value(cdt, cdn, \"custom_current_req_qty\", 0);\r\n    //     }\r\n    //     else {\r\n    //         if (child.custom_pps > child.custom_current_req_qty) {\r\n    //             frappe.model.set_value(cdt, cdn, \"custom_required_vs_short_qty\", 0);\r\n    //         }\r\n    //         else {\r\n    //             frappe.model.set_value(cdt, cdn, \"custom_required_vs_short_qty\", child.custom_current_req_qty);\r\n    //         }\r\n    //     }\r\n    // },\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.237970",
  "module": "ONEGENE",
  "name": "Purchase Receipt",
  "script": "frappe.ui.form.on('Purchase Receipt', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\t\n\tsupplier(frm){\n\t    \n\t    if(frm.doc.currency){\n\t        \n\t        setTimeout(()=>{\n\t            \n\t            frappe.db.get_value(\"Currency Conversion\",{\"currency\":frm.doc.currency},\"exchange_rate\").then(r=>{\n\t                \n\t                if(r.message && r.message.exchange_rate){\n\t                    \n\t                    frm.set_value(\"conversion_rate\",r.message.exchange_rate)\n\t                }\n\t            })\n\t            \n\t        },2000)\n\t    }\n\t},\n\t\n\t\n\tasync validate(frm) {\n        for (let row of frm.doc.items) {\n            if (row.item_code) {\n                let r = await frappe.db.get_value(\"Item\", row.item_code, \"custom_warehouse\");\n                if (r.message && r.message.custom_warehouse) {\n                    let warehouse = r.message.custom_warehouse;\n                    await frappe.model.set_value(row.doctype, row.name, \"warehouse\", warehouse);\n                }\n            }\n        }\n    frm.refresh_field(\"items\");\n    }\n})\n\nfrappe.ui.form.on('Purchase Receipt Item', {\n    qty(frm,cdt,cdn) {\n\t\tvar child = locals[cdt][cdn];\n\t\tif (child.qty > child.custom_dispatched_quantity) {\n\t\t    frappe.msgprint(`<b>Row ${child.idx}:</b> Received Quantity should not exceed Dispatched Quantity of ${child.custom_dispatched_quantity}`);\n\t\t    frappe.model.set_value(cdt, cdn, \"qty\", 0);\n\t\t}\n\t\telse {\n\t\t    frappe.model.set_value(cdt, cdn, \"custom_sr_qty\", child.qty);\n\t\t}\n    },\n\tcustom_inspect(frm,cdt,cdn){\n\t    var child = locals [cdt][cdn]\n        var ip = frappe.model.make_new_doc_and_get_name('Item Inspection');\n        ip = locals['Item Inspection'][ip];\n        ip.purchase_receipt_number = frm.doc.name\n        ip.company_name = frm.doc.company\n        ip.item_code = child.item_code\n        ip.received_qty = child.qty\n        ip.warehouse = frm.doc.set_warehouse\n        ip.id = child.name\n        frappe.set_route(\"Form\", \"Item Inspection\",ip.name)\n    },\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item Inspection",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.805477",
  "module": "ONEGENE",
  "name": "Item Inspection",
  "script": "frappe.ui.form.on('Item Inspection', {\n\trefresh(frm) {\n\t    if (frm.doc.__islocal) {\n           frm.set_value(\"inspected_by\",frappe.session.user)\n            frm.set_value(\"inspection_date\",frappe.datetime.get_today())\n        } \n\t},\n\tvalidate(frm){\n\t    if(frm.doc.no_of_samples <= 0){\n\t        frappe.throw('Enter the Sample Count')\n\t    }\n\t},\n\tno_of_samples(frm){\n        if(frm.doc.no_of_samples > frm.doc.received_qty){\n            frappe.throw('Number of Samples must be less than Received Qty ')\n        }\n\t},\n\tsample_reference(frm){\n\t    if(frm.doc.sample_reference > frm.doc.no_of_samples){\n            frappe.throw('Sample Reference must be less than Sample')\n\t    }\n\t    if(frm.doc.accepted_qty){\n\t        frm.trigger('calculate')\n\t    }\n\t},\n\tcalculate:function(frm){\n\t    if(frm.doc.sample_reference && frm.doc.accepted_qty){\n            var value1 = frm.doc.received_qty\n            var value2 = frm.doc.sample_reference\n            var value4 = frm.doc.accepted_qty\n            var reject = value1 - (value2 + value4)\n            frm.set_value(\"rejected_qty\",reject)\n        }\n\t},\n\taccepted_qty(frm){\n\t    if(frm.doc.received_qty < frm.doc.accepted_qty){\n            frappe.throw('Accepted Qty must be less than Received Qty')\n\t    }\n\t    if(frm.doc.sample_reference){\n\t        frm.trigger('calculate')\n\t    }\n\t},\n\trejected_qty(frm){\n\t    if(frm.doc.sample_reference && frm.doc.rejected_qty && frm.doc.received_qty){\n\t        var value1 = frm.doc.received_qty\n            var value2 = frm.doc.sample_reference\n            var value4 = frm.doc.rejected_qty\n            var reject = value1 - (value2 + value4)\n            frm.set_value(\"accepted_qty\",reject)\n\t    }\n\t},\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.942768",
  "module": "ONEGENE",
  "name": "Delivery Note",
  "script": "frappe.ui.form.on('Delivery Note', {\n    refresh(frm){\n        if(!frm.doc.__islocal){\n        frm.add_custom_button(__(\"Print\"), function () {\n\t\t\tvar f_name = frm.doc.name;\n\t\t\tvar print_format = \"Delivery Note\";\n\t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n\t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Delivery Note\")\n\t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n\t\t\t\t+ \"&trigger_print=1\"\n\t\t\t\t+ \"&format=\" + print_format\n\t\t\t\t+ \"&no_letterhead=0\"\n\t\t\t));\n\t\t}).css({ 'color': 'white', 'background-color': \"#b81a0f\" });\n        }\n    },\n\tvalidate(frm) {\n\t    if(frm.doc.__islocal){\n    \t    var item_details_list = []\n    \t\tvar item_details = {}\n    \t\t$.each(frm.doc.items, function (i, d) {\n    \t\t\titem_details = {}\n    \t\t\titem_details['item_code'] = d.item_code\n    \t\t\titem_details['qty'] = d.qty\n    \t\t\titem_details['sales_order'] = d.against_sales_order\n    \t\t\titem_details['count'] = d.idx\n    \t\t\titem_details['date'] = frm.doc.posting_date\n    \t\t\titem_details_list.push(item_details)\n    \t\t})\n    \t    $.each(frm.doc.items,function(i,j){\n        \t    frappe.call({\n        \t        method:\"onegene.onegene.utils.return_sales_order_qty\",\n        \t        args:{\n        \t            item:item_details_list,\n        \t            posting_date:frm.doc.posting_date\n        \t        },\n        \t        callback(r){\n        \t            if(r){\n        \t                $.each(r.message,function(i,k){\n        \t                    if(j.item_code == k.item_code){\n        \t                        j.custom_against_order_schedule = k.name\n        \t                        j.qty = k.qty\n        \t                    }\n        \t                    frm.refresh_field('items')\n        \t                })\n        \t            }\n        \t        }\n        \t    })\n        \t})\n\t    }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Planning Details",
  "enabled": 1,
  "modified": "2025-12-17 16:35:46.439234",
  "module": "ONEGENE",
  "name": "Material Planning Details",
  "script": "frappe.ui.form.on('Material Planning Details', {\n\trefresh(frm) {\n\t\tfrm.disable_save()\n        if(frm.doc.item_code){\n            frappe.call({\n                method:\"onegene.onegene.custom.stock_details_mpd\",\n                args:{\n                    \"item\":frm.doc.item_code,\n                    \"quantity\":frm.doc.name,\n                },\n                callback(r){\n    \t\t        if(r){\n\t\t                frm.get_field(\"html\").$wrapper.html(r.message);\n\t                }\n    \t\t    }\n            })\n            \n            frappe.call({\n                method:\"onegene.onegene.utils.supplier_mpd\",\n                args:{\n                    \"item\":frm.doc.item_code,\n                },\n                callback(r){\n    \t\t        if(r){\n\t\t                frm.get_field(\"supplier_html\").$wrapper.html(r.message);\n\t                }\n    \t\t    }\n            })\n        }\n\t}\n\t\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.643180",
  "module": "ONEGENE",
  "name": "Purchase Order",
  "script": "frappe.ui.form.on('Purchase Order', {\n    onload(frm) {\n        setTimeout(() => {\n            frm.remove_custom_button('Update Items');\n            if (frappe.user.has_role(\"Supplier\") & !frappe.user.has_role(\"System Manager\")) {\n                frm.remove_custom_button('Purchase Receipt', 'Create');\n                frm.remove_custom_button('Purchase Invoice', 'Create');\n                frm.remove_custom_button('Subcontracting Order', 'Create');\n                frm.remove_custom_button('Payment', 'Create');\n                frm.remove_custom_button('Payment Request', 'Create');\n                frm.remove_custom_button('Logistics Request', 'Create');\n            }\n        }, 300);\n        if (frm.doc.__islocal) {\n            if (!frm.doc.title) {\n                frappe.db.get_value('Supplier', frm.doc.supplier, 'supplier_name')\n                    .then(res => {\n                        frm.set_value('supplier_name', res.message ? res.message.supplier_name : '');\n                        frm.set_value('title', res.message ? res.message.supplier_name : '');\n                    });\n            }\n            // Empty the price list\n            frm.set_value(\"buying_price_list\", \"\")\n            \n            // If open type rxpiry date will be updated to last fiscal date\n            if (frm.doc.custom_order_type == \"Open\") {\n                frappe.call({\n                   method: \"onegene.onegene.custom.get_last_date_of_fiscal\",\n                   callback: function(r) {\n                       if (r.message) {\n                           frm.set_value(\"schedule_date\", r.message)\n                       }\n                   }\n                })\n            }\n            else {\n                frm.set_value(\"schedule_date\", \"\")\n            }\n            \n            const today = new Date();\n            let currentYear = today.getFullYear() % 100;\n            let nextYear = (currentYear + 1) % 100;\n            let year_format = `${currentYear}-${nextYear}`;\n            frm.set_value('custom_fiscal_year', year_format);\n            \n            if (frm.doc.custom_po_type == \"Job Order\") {\n                frm.set_value(\"naming_series\", \"JO/.####./.{custom_fiscal_year}.\")\n                // frm.set_value('naming_series', frm.doc.custom_docname)\n            }\n            else {\n                frm.set_value(\"naming_series\", \"PO/.####./.{custom_fiscal_year}.\")\n            }\n        }\n    },\n    schedule_date(frm) {\n        if (frm.doc.schedule_date) {\n            frm.doc.items.forEach(row => {\n                row.schedule_date = frm.doc.schedule_date;\n            });\n            frm.refresh_field('items');\n        }\n    },\n    custom_po_type(frm) {\n        if (frm.doc.__islocal) {\n            const today = new Date();\n            let currentYear = today.getFullYear() % 100;\n            let nextYear = (currentYear + 1) % 100;\n            let year_format = `${currentYear}-${nextYear}`;\n            frm.set_value('custom_fiscal_year', year_format);\n            \n            if (frm.doc.custom_po_type == \"Job Order\") {\n                frm.set_value(\"naming_series\", \"JO/.####./.{custom_fiscal_year}.\")\n                // frm.set_value('naming_series', frm.doc.custom_docname)\n            }\n            else {\n                frm.set_value(\"naming_series\", \"PO/.####./.{custom_fiscal_year}.\")\n            }\n        }\n    },\n    custom_order_type(frm) {\n        frm.fields_dict['items'].grid.update_docfield_property('open_qty', 'read_only', frm.doc.custom_order_type === 'Open');\n        if (frm.doc.custom_order_type == \"Open\") {\n            frappe.call({\n               method: \"onegene.onegene.custom.get_last_date_of_fiscal\",\n               callback: function(r) {\n                   if (r.message) {\n                       frm.set_value(\"schedule_date\", r.message)\n                   }\n               }\n            })\n        }\n        else {\n            frm.set_value(\"schedule_date\", \"\")\n        }\n    },\n    onload_post_render(frm) {\n        if (frm.doc.__islocal) {\n            frm.doc._was_inserted = true;\n        }\n    },\n    after_save(frm) {\n        if (frm.doc.custom_po_type == \"Job Order\") {\n            frappe.call({\n                method: \"onegene.onegene.custom.set_naming_series_po\",\n                args: {\n                    name: frm.doc.name,\n                    new_name: frm.doc.custom_docname\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        frappe.set_route(\"Form\", \"Purchase Order\", r.message);\n                    }\n                }\n            });\n            }\n    },\n    refresh(frm) {\n        \n         if(!frm.doc.__islocal && frm.doc.custom_po_type && frm.doc.custom_po_type==\"Job Order\"){\n            \n            frm.add_custom_button(__(\"Print\"), function() {\n                var letter_head = frm.doc.letter_head;\n                var f_name = frm.doc.name;\n                var print_format = \"Purchase Order(Job Order)\";\n                window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                    \"doctype=\" + encodeURIComponent(\"Purchase Order\") +\n                    \"&name=\" + encodeURIComponent(f_name) +\n                    \"&trigger_print=1\" +\n                    \"&format=\" + print_format +\n                    \"&no_letterhead=0\" +\n                    \"&letterhead=\" + encodeURIComponent(letter_head)\n                ));\n            }).css({\n                'color': 'white',\n                'background-color': \"#000000\"\n            });\n            \n            \n        }\n        \n        setTimeout(() => {\n            frm.remove_custom_button('Update Items');\n            if (frappe.user.has_role(\"Supplier\") & !frappe.user.has_role(\"System Manager\")) {\n                frm.remove_custom_button('Purchase Receipt', 'Create');\n                frm.remove_custom_button('Purchase Invoice', 'Create');\n                frm.remove_custom_button('Subcontracting Order', 'Create');\n                frm.remove_custom_button('Payment', 'Create');\n                frm.remove_custom_button('Payment Request', 'Create');\n                frm.remove_custom_button('Logistics Request', 'Create');\n            }\n        }, 300);\n        if (frm.doc.__islocal) {\n            \n            frm.set_value(\"buying_price_list\", \"\")\n        }\n        if (flt(frm.doc.per_received, 2) < 100 && frm.doc.docstatus == 1) {\n            if (frm.doc.custom_schedule_table.length > 0) {\n        frm.add_custom_button('Advance Shipping Note(ASN)', () => {\n            frappe.model.with_doctype('Advance Shipping Note', function () {\n                let doc = frappe.model.get_new_doc('Advance Shipping Note');\n                doc.supplier = frm.doc.supplier;\n                doc.purchase_order = frm.doc.name;\n                // doc.purchase_orders = [];\n                // doc.purchase_orders.push({\n                //     purchase_order: frm.doc.name\n                // });\n\n                frappe.set_route('Form', 'Advance Shipping Note', doc.name);\n            });\n        }, __('Create'));\n    }\n        }\n\n\n\n        frm.fields_dict['items'].grid.update_docfield_property('open_qty', 'read_only', frm.doc.custom_order_type === 'Open');\n\n        var input = 'input[data-fieldname=\"item_code\"][data-doctype=\"Purchase Order Item\"]';\n        var isFocus = false;\n        frm.fields_dict.items.grid.wrapper.on('click', input, function(e) {\n            if (!isFocus) {\n                const item_code = e.currentTarget.value;\n                frappe.call({\n                    method: 'onegene.onegene.custom.previous_po_html',\n                    args: {\n                        'item_code': item_code,\n                    },\n                    callback(d) {\n                        if (d.message) {\n                            if (d.message == \"Item not found\") {\n                                frm.get_field(\"items\").grid.grid_rows_by_docname[child.name].remove();\n                                frm.refresh_field(\"items\");\n                            }\n                            else {\n                                frm.get_field(\"custom_html\").$wrapper.html(d.message);\n                            }\n                        }\n                    }\n                })\n            }\n            isFocus = false;\n        });\n        \n        \n        if(frm.doc.docstatus == 1){\n            \n            \n            frm.add_custom_button('Logistics Request', () => {\n            frappe.model.with_doctype('Logistics Request', function () {\n                let doc = frappe.model.get_new_doc('Logistics Request');\n                doc.order_no = frm.doc.name;\n                doc.logistic_type = \"Import\";\n                doc.po_so = \"Purchase Order\";\n                \n                \n               \n\n                frappe.set_route('Form', 'Logistics Request',doc.name);\n            });\n\n        }, __('Create'));\n        \n        \n        \n        }\n        \n        \n        // Custom Update Items\n        if (frappe.user.has_role(\"System Manager\") || frappe.has_role(\"Administrator\") && frm.doc.docstatus == 1) {\n            frm.add_custom_button(\"Update Item\", () => {\n                let d = new frappe.ui.Dialog({\n                    title: 'Update Items',\n                    size: 'extra-large',\n                    fields: [{\n                        fieldname: 'items_table',\n                        fieldtype: 'Table',\n                        label: 'Items',\n                        cannot_add_rows: false,\n                        in_place_edit: false,\n                        data: [],\n                        get_data: function() {\n                            return this.data;\n                        },\n                        fields: [{\n                                fieldtype: 'Link',\n                                fieldname: 'item_code',\n                                label: 'Item Code',\n                                options: 'Item',\n                                in_list_view: 1,\n                                columns: 5,\n                                onchange: function() {\n                                    const current_item_code = this.value;\n                                    const docname = this.doc.docname;\n\n                                    const table = d.fields_dict.items_table;\n                                    const existing_items = table.df.data;\n\n                                    const grid = table.grid;\n\n                                    // ---------------------------------------------------\n                                    // 1️⃣ DUPLICATE CHECK (kept as requested)\n                                    // ---------------------------------------------------\n                                    const duplicate = existing_items.some(\n                                        row => row.item_code === current_item_code && row.docname !== docname\n                                    );\n\n                                    if (duplicate) {\n                                        frappe.msgprint({\n                                            title: __('Duplicate Item'),\n                                            message: __('Item Code <b>{0}</b> already exists in the list.', [current_item_code]),\n                                            indicator: 'red'\n                                        });\n\n                                        const row_idx = grid.data.findIndex(row => row.docname === docname);\n\n                                        if (row_idx !== -1) {\n                                            grid.data.splice(row_idx, 1);\n                                            grid.refresh();\n                                        }\n                                        return;\n                                    }\n\n                                    // ---------------------------------------------------\n                                    // 2️⃣ FETCH ITEM NAME + HSN (HSN is no longer validated)\n                                    // ---------------------------------------------------\n                                    if (current_item_code) {\n                                        frappe.db.get_value(\n                                            'Item',\n                                            current_item_code,\n                                            ['item_name', 'gst_hsn_code']\n                                        ).then(r => {\n                                            if (r.message) {\n\n                                                const {\n                                                    item_name,\n                                                    gst_hsn_code\n                                                } = r.message;\n                                                const new_hsn = gst_hsn_code || \"\";\n\n                                                // Find this row\n                                                const row = grid.data.find(r => r.docname === docname);\n                                                if (!row) return;\n\n                                                // ---------------------------------------------------\n                                                // 3️⃣ UPDATE THE ROW DIRECTLY (no HSN mismatch check)\n                                                // ---------------------------------------------------\n                                                row.item_name = item_name || \"\";\n                                                row.hsn = new_hsn;\n\n                                                grid.refresh();\n                                            }\n                                        });\n                                    }\n                                }\n\n\n\n                            },\n                            {\n                                fieldtype: 'Data',\n                                fieldname: 'item_name',\n                                label: 'Item Name',\n                                // in_list_view: 1,\n                                read_only: 1,\n                                columns: 4,\n                            },\n                            {\n                                fieldtype: 'Date',\n                                fieldname: 'reqd_by_date',\n                                label: 'Reqd By Date',\n                                in_list_view: 1,\n                                reqd: 1,\n                                // read_only: 1,\n                                columns: 2\n                            },\n                            {\n                                fieldtype: 'Float',\n                                fieldname: 'qty',\n                                label: 'Qty',\n                                in_list_view: 1,\n                                // read_only: 1,\n                                reqd: 1,\n                                columns: 1\n                            },\n                            {\n                                fieldtype: 'Currency',\n                                fieldname: 'rate',\n                                label: 'Rate',\n                                in_list_view: 1,\n                                reqd: 1,\n                                columns: 1\n                            },\n                            {\n                                fieldtype: 'Data',\n                                fieldname: 'docname',\n                                label: 'Docname',\n                                read_only: 1\n                            },\n                            {\n                                fieldtype: 'Data',\n                                fieldname: 'hsn',\n                                label: 'HSN',\n                                read_only: 1\n                            }\n                        ]\n                    }],\n                    primary_action_label: 'Update',\n                    primary_action(values) {\n                        frappe.call({\n                            method: \"onegene.onegene.custom.custom_update_items\",\n                            args: {\n                                data: values,\n                                purchase_order: frm.doc.name\n                            },\n                            freeze: true,\n                            freeze_message: \"Updating Items ...\",\n                            callback(r) {\n                                if (r.message) {\n                                    frm.reload_doc();\n                                    d.hide();\n                                }\n                            }\n                        });\n                    }\n                });\n\n                // Populate existing PO items\n                let table_field = d.get_field('items_table');\n\n                table_field.df.data = frm.doc.items.map(item => ({\n                    item_code: item.item_code,\n                    item_name: item.item_name,\n                    reqd_by_date: item.schedule_date,\n                    qty: item.qty,\n                    rate: item.rate,\n                    docname: item.name,\n                    hsn: item.gst_hsn_code\n                }));\n\n                table_field.refresh();\n\n                d.show();\n\n            });\n\n        }  \n        \n        \n        \n        \n        \n    },\n    \n    supplier(frm){\n        if(frm.doc.currency){\n            \n            setTimeout(()=>{\n                \n                frappe.db.get_value(\"Currency Conversion\",{\"currency\":frm.doc.currency},\"exchange_rate\").then(r=>{\n                    if(r.message && r.message.exchange_rate){\n                        frm.set_value(\"conversion_rate\",r.message.exchange_rate)\n                    }\n                })\n                \n            },2000)\n        }\n    }\n})\n\n\n\nfrappe.ui.form.on('Purchase Order Item', {\n    item_code(frm, cdt, cdn) {\n        let current_row = locals[cdt][cdn];\n        let duplicate_found = false;\n\n        // Check for duplicate item_code\n        frm.doc.items.forEach(row => {\n            if (row.item_code === current_row.item_code && row.name !== current_row.name) {\n                duplicate_found = true;\n            }\n        });\n\n        if (duplicate_found) {\n            let d = frappe.msgprint({\n                title: __(\"Removing Duplicate Entry\"),\n                message: __(\"Item Code <b>{0}</b> is already added.\", [current_row.item_code]),\n                indicator: 'red'\n            });\n            frm.get_field('items').grid.grid_rows_by_docname[cdn].remove();\n            frm.refresh_field('items');\n            setTimeout(() => {\n                if (d && d.hide) d.hide();\n            }, 1000);\n        }\n        \n        var child = locals[cdt][cdn]\n        frappe.call({\n            method: 'onegene.onegene.custom.previous_po_html',\n            args: {\n                'item_code': child.item_code,\n            },\n            callback(d) {\n                if (d.message) {\n                    if (d.message == \"Item not found\") {\n                        frm.get_field(\"items\").grid.grid_rows_by_docname[child.name].remove();\n                        frm.refresh_field(\"items\");\n                    }\n                    else {\n                        frm.get_field(\"custom_html\").$wrapper.html(d.message);\n                    }\n                }\n            }\n        })\n    },\n    open_qty(frm, cdt, cdn) {\n        var child = locals[cdt][cdn];\n        if (frm.doc.custom_order_type == \"Fixed\") {\n            child.qty = child.open_qty;\n        }\n    },\n    schedule(frm, cdt, cdn) {\n        var child = locals[cdt][cdn];\n        if (frm.doc.custom_order_type == \"Fixed\") {\n            let row_data = get_schedule_table_data_for_fixed(frm, child.item_code, child.qty);\n            let dialog1 = new frappe.ui.Dialog({\n                title: __('Select the Schedule'),\n                fields: [{\n                    fieldname: \"items\",\n                    fieldtype: \"Table\",\n                    label: __(\"Select the Schedule\"),\n                    data: row_data,\n                    fields: [{\n                            fieldname: \"item_code\",\n                            fieldtype: \"Link\",\n                            label: __(\"Item Code\"),\n                            options: \"Item\",\n                            read_only: 1\n                        },\n                        {\n                            fieldname: \"schedule_date\",\n                            fieldtype: \"Select\",\n                            options: [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"],\n                            label: __(\"Schedule Period\"),\n                            reqd: 1,\n                            in_list_view: 1\n                        },\n                        {\n                            fieldname: \"schedule_qty\",\n                            fieldtype: \"Float\",\n                            label: __(\"Schedule Qty\"),\n                            reqd: 1,\n                            in_list_view: 1\n                        }\n                    ],\n                }, ],\n                primary_action_label: __('Add'),\n                primary_action: () => {\n                    let values = dialog1.get_values();\n                    if (values && values.items) {\n                        let total_qty = 0;\n\n                        values.items.forEach(row => {\n                            total_qty += row.schedule_qty;\n                        });\n                        let is_item_present_in_schedule = false;\n                        frm.doc.custom_schedule_table.forEach(row => {\n                            if (row.item_code === child.item_code) {\n                                is_item_present_in_schedule = true;\n                            } else {\n                                is_item_present_in_schedule = false;\n                            }\n                        });\n                        if (total_qty === child.qty) {\n                            if (!is_item_present_in_schedule) {\n                                values.items.forEach(row => {\n                                    const monthMap = {\n    Jan: 0, Feb: 1, Mar: 2, Apr: 3,\n    May: 4, Jun: 5, Jul: 6, Aug: 7,\n    Sep: 8, Oct: 9, Nov: 10, Dec: 11\n};\n\nconst monthStr = row.schedule_date; // e.g., \"Jan\"\nconst currentYear = new Date().getFullYear();\n\nconst startDate = new Date(currentYear, monthMap[monthStr], 1);  // Month is 0-indexed\n\nconst day = String(startDate.getDate()).padStart(2, '0');\nconst month = String(startDate.getMonth() + 1).padStart(2, '0');\nconst year = startDate.getFullYear();\n\nconst formattedDate = `${year}-${month}-${day}`; // e.g., \"2025-01-01\"\n\n                                    frm.add_child(\"custom_schedule_table\", {\n                                        'item_code': child.item_code,\n                                        'schedule_date': formattedDate,\n                                        'schedule_qty': row.schedule_qty,\n                                        'schedule_month': row.schedule_date.toUpperCase(),\n                                        'delivered_qty': 0,\n                                        'pending_qty': row.schedule_qty,\n                                    });\n                                });\n                                frm.refresh_field(\"custom_schedule_table\");\n                                frm.save();\n                            } else {\n                                frappe.msgprint({\n                                    title: \"Duplicate Item\",\n                                    message: `Item <b>${child.item_code}</b> is already updated in the Schedule Table`,\n                                    indicator: 'red'\n                                });\n                                frappe.msgprint({\n                                    title: \"Duplicate Item\",\n                                    message: `Item <b>${child.item_code}</b> ஏற்கனவே Schedule Table-ல் update செய்யப்பட்டிருக்கிறது`,\n                                    indicator: 'red'\n                                });\n\n                            }\n                            dialog1.hide();\n                        }\n\n                        if (total_qty > child.qty) {\n                            frappe.msgprint({\n                                title: \"Qty Doesn't Match\",\n                                message: `Schedule Qty <b>${total_qty}</b> is greater than <b>${child.qty}</b> for <b>${child.item_code}</b>.`,\n                                indicator: 'red',\n                            });\n                            frappe.msgprint({\n                                title: \"Qty பொருந்தவில்லை\", \n                                message: `Schedule Qty <b>${total_qty}</b> <b>${child.qty}</b> ஐ விட அதிகமாக உள்ளது <b>${child.item_code}</b> க்கான.`,\n                                indicator: 'red',\n                            });\n\n                        }\n                        if (total_qty < child.qty) {\n                            frappe.msgprint({\n                                title: \"Qty Doesn't Match\",\n                                message: `Schedule Qty <b>${total_qty}</b> is less than <b>${child.qty}</b> for <b>${child.item_code}</b>.`,\n                                indicator: 'red',\n                            });\n                            frappe.msgprint({\n                                title: \"Qty பொருந்தவில்லை\", \n                                message: `Schedule Qty <b>${total_qty}</b> <b>${child.qty}</b> க்கிடையே குறைவாக உள்ளது <b>${child.item_code}</b> க்கான.`,\n                                indicator: 'red',\n                            });\n\n\n                        }\n                    \n                    }\n                }\n            });\n            dialog1.show();\n        }\n        if (frm.doc.custom_order_type == \"Open\") {\n            let row_data = get_schedule_table_data_for_open(frm, child.item_code, child.qty);\n            let dialog2 = new frappe.ui.Dialog({\n                title: __('Select the Schedule'),\n                fields: [{\n                    fieldname: \"items\",\n                    fieldtype: \"Table\",\n                    label: __(\"Select the Schedule\"),\n                    data: row_data,\n                    fields: [{\n                            fieldname: \"item_code\",\n                            fieldtype: \"Link\",\n                            label: __(\"Item Code\"),\n                            options: \"Item\",\n                            read_only: 1\n                        },\n                        {\n                            fieldname: \"schedule_date\",\n                            fieldtype: \"Select\",\n                            options: [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"],\n                            label: __(\"Schedule Period\"),\n                            reqd: 1,\n                            in_list_view: 1\n                        },\n                        {\n                            fieldname: \"schedule_qty\",\n                            fieldtype: \"Float\",\n                            label: __(\"Schedule Qty\"),\n                            reqd: 1,\n                            in_list_view: 1\n                        }\n                    ],\n                }, ],\n                primary_action_label: __('Add'),\n                primary_action: () => {\n                    let values = dialog2.get_values();\n                    if (values) {\n                        values.items.forEach(row => {\n                            const monthStr = row.schedule_date; // Example: \"July\" or \"Jul\"\nconst currentYear = new Date().getFullYear();\n\n// Create date\nconst monthNumber = new Date(`${monthStr} 1, ${currentYear}`).getMonth() + 1; // 1-indexed\nconst month = String(monthNumber).padStart(2, '0');\n\n// Always 01 for day (first day of the month)\nconst formattedDate = `${currentYear}-${month}-01`;\n\n\n\n\n                            frappe.run_serially([\n                                () => {\n                                    if (frm.doc.docstatus == 1) {\n                                        return frappe.call({\n                                        method: \"onegene.onegene.custom.create_order_schedule_from_po_for_open\",\n                                        args: {\n                                            'item_code': child.item_code,\n                                            'schedule_date': formattedDate,\n                                            'schedule_qty': row.schedule_qty,\n                                            'supplier_code': frm.doc.supplier_code,\n                                            'name': frm.doc.name,\n                                            'rate': child.rate,\n                                            'month': row.schedule_date,\n                                        },\n                                        callback:function (r) {\n                                            if (r.message) {\n                                                frm.reload_doc()\n                                                }\n                                            }\n                                        });\n                                    }\n                                    else {\n                                        frm.add_child(\"custom_schedule_table\", {\n                                            'item_code': child.item_code,\n                                            'schedule_date': formattedDate,\n                                            'schedule_qty': row.schedule_qty,\n                                            'schedule_month': row.schedule_date.toUpperCase(),\n                                            'delivered_qty': 0,\n                                            'pending_qty': row.schedule_qty,\n                                        });\n                                        frm.save()\n                                    }\n                                },\n                            ]);\n\n                        });\n                        frm.refresh_field(\"custom_schedule_table\");\n                    }\n                    dialog2.hide();\n                },\n            });\n            dialog2.show();\n        }\n    }\n});\n\nfunction get_schedule_table_data_for_fixed(frm, item_code, qty) {\n    let matching_rows = [];\n\n    frm.doc.custom_schedule_table.forEach(row => {\n        if (row.item_code === item_code) {\n            matching_rows.push({\n                \"item_code\": row.item_code,\n                \"schedule_date\": frappe.datetime.str_to_obj(row.schedule_date).toLocaleString('en-us', {\n                    month: 'short'\n                }),\n                \"schedule_qty\": row.schedule_qty\n            });\n        }\n    });\n\n    if (matching_rows.length === 0) {\n        matching_rows.push({\n            \"item_code\": item_code,\n            \"schedule_date\": frappe.datetime.str_to_obj(frappe.datetime.nowdate()).toLocaleString('en-us', {\n                month: 'short'\n            }),\n            \"schedule_qty\": qty\n        });\n    }\n\n    return matching_rows;\n}\n\nfunction get_schedule_table_data_for_open(frm, item_code, qty) {\n    let matching_rows = [];\n\n    if (matching_rows.length === 0) {\n        matching_rows.push({\n            \"item_code\": item_code,\n            \"schedule_date\": frappe.datetime.str_to_obj(frappe.datetime.nowdate()).toLocaleString('en-us', {\n                month: 'short'\n            }),\n            \"schedule_qty\": qty\n        });\n    }\n\n    return matching_rows;\n}\n\nfunction toggle_qty_field(frm) {\n    // Update field visibility based on custom_order_type\n    if (frm.doc.custom_order_type === \"Open\") {\n        frm.fields_dict.items.grid.update_docfield_property('qty', 'hidden', true);\n        frm.fields_dict.items.grid.update_docfield_property('open_qty', 'hidden', false);\n    } else {\n        frm.fields_dict.items.grid.update_docfield_property('qty', 'hidden', false);\n        frm.fields_dict.items.grid.update_docfield_property('open_qty', 'hidden', true);\n    }\n\n    // Refresh the grid\n    // frm.fields_dict.items.grid.refresh();\n    frm.refresh_field(\"items\");\n\n    // Force a manual DOM manipulation to ensure fields are visible as needed\n    $(frm.fields_dict.items.grid.wrapper).find('.grid-row').each(function() {\n        let row = $(this);\n        if (frm.doc.custom_order_type === \"Open\") {\n            // Hide 'qty' field and show 'open_qty'\n            row.find('.qty').hide();\n            row.find('.open_qty').show();\n        } else {\n            // Show 'qty' field and hide 'open_qty'\n            row.find('.qty').show();\n            row.find('.open_qty').hide();\n        }\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.284578",
  "module": "ONEGENE",
  "name": "Item",
  "script": "frappe.ui.form.on('Item', {\n\trefresh(frm) {\n\t    const user = frappe.session.user;\n        if (frappe.user.has_role(\"Supplier\") && !frappe.user.has_role('System Manager')) {\n            window.history.back();\n        }\n    },\n\tonload(frm) {\n\t    \n\t     if (!frm.doc.__islocal){\n        \tfrm.fields_dict['custom_racks'].grid.get_field('rack').get_query = function(doc, cdt, cdn) {\n            return {\n                query: \"onegene.onegene.custom.set_query_for_custom_racks\",\n                filters: {\n                    name: doc.name,\n                    warehouse:frm.doc.custom_warehouse,\n                    \n                }\n            };\n        };\n        }\n        \n\t     if (!frm.doc.__islocal){\n        \tfrm.fields_dict['custom_locations'].grid.get_field('location').get_query = function(doc, cdt, cdn) {\n            return {\n                query: \"onegene.onegene.custom.set_query_for_custom_locations\",\n                filters: {\n                    name: doc.name,\n                    warehouse:frm.doc.custom_warehouse,\n                    \n                }\n            };\n        };\n        }\n\t    \n\t    \n\t    \n\t    const user = frappe.session.user;\n        if (frappe.user.has_role(\"Supplier\") && !frappe.user.has_role('System Manager')) {\n            window.history.back();\n        }\n        \n        // if (!frappe.user.has_role(\"Administrator\") && !frappe.user.has_role(\"System Manager\") && !frappe.user.has_role(\"Sales User\")) {\n        //     $(frm.page.wrapper).find(\".page-actions\").hide();\n        // } else {\n        //     $(frm.page.wrapper).find(\".page-actions\").show();\n        // }\n        \n        \n        // frm.fields_dict['custom_racks'].grid.get_field('rack').get_query = function(doc, cdt, cdn) {\n        //     const row = locals[cdt][cdn];\n        //     const warehouse = row.custom_warehouse;\n\n        //     if (!warehouse) return;\n\n        //     frappe.call({\n        //         method: \"onegene.onegene.custom.get_rack_for_items\",\n        //         args: {\n        //             doctype: \"Rack\",\n        //             txt: \"\",\n        //             searchfield: \"name\",\n        //             start: 0,\n        //             page_len: 10,\n        //             filters: {\n        //                 warehouse: warehouse,\n        //             }\n        //         },\n        //         callback: function(r) {\n        //             if (r.message && r.message.length === 1) {\n        //                 frappe.model.set_value(cdt, cdn, \"rack\", r.message[0][0]);\n        //             }\n        //         }\n        //     });\n\n        //     return {\n        //         query: \"onegene.onegene.custom.get_rack_for_items\",\n        //         filters: {\n        //             warehouse: warehouse,\n        //         }\n        //     };\n        // };\n\t}\n\t\n});\n\nfrappe.ui.form.on('Item Supplier', {\n\tcustom_lead_time_in_days(frm,cdt,cdn){\n        var child = locals[cdt][cdn]\n        $.each(frm.doc.supplier_items,function(i,d){\n            percent = d.custom_lead_time_in_days\n            frm.set_value(\"lead_time_days\",percent)\n        })\n        frm.refresh_field('supplier_items')\n\n\t}\n})\n\nfrappe.ui.form.on('Item Rack', {\n\n\track:function(frm,cdt,cdn){\n\t    let row = locals[cdt][cdn];\n\t    \n\t    if (!frm.doc.__islocal){\n\t          frappe.call({\n                method: \"onegene.onegene.custom.check_rack_in_custom_racks\",\n                args: {\n                    filters: {\n                        name: frm.doc.name,\n                        warehouse: frm.doc.custom_warehouse,\n                        rack: row.rack\n                    }\n                },\n                callback: function(r) {\n                    if (!r.message || r.message.length === 0) {\n                        if (row.rack || row.rack==null) {\n                            frappe.msgprint(`Rack  is not set in warehouse`);\n                            frm.fields_dict.custom_racks.grid.grid_rows_by_docname[cdn].remove();\n                            frm.refresh_field(\"custom_racks\");\n                        }\n                    }\n                }\n            });\n\n\t    }\n\t},\n\n});\n\nfrappe.ui.form.on('Item Rack Location', {\n\n\t\n\tlocation:function(frm,cdt,cdn){\n\t    let row = locals[cdt][cdn];\n\t    \n\t    console.log(row)\n\t    if (!frm.doc.__islocal){\n\t          frappe.call({\n                method: \"onegene.onegene.custom.check_location_in_custom_locations\",\n                args: {\n                    filters: {\n                        name: frm.doc.name,\n                        warehouse: frm.doc.custom_warehouse,\n                        location: row.location\n                    }\n                },\n                callback: function(r) {\n                    if (!r.message || r.message.length === 0) {\n                        \n                        if (row.location || row.location== null) {\n                            frappe.msgprint(`Location  is not set in warehouse`);\n                            frm.fields_dict.custom_locations.grid.grid_rows_by_docname[cdn].remove();\n                            frm.refresh_field(\"custom_locations\");\n                        }\n                    }\n                }\n            });\n\n\t    }\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Schedule Settings",
  "enabled": 1,
  "modified": "2025-12-17 16:35:46.378886",
  "module": "ONEGENE",
  "name": "Schedule Settings",
  "script": "frappe.ui.form.on('Schedule Settings', {\n\tdownload(frm){\n        var path = \"onegene.onegene.doctype.schedule_settings.schedule_settings.template_sheet\"\n\t\tvar args = 'name=%(name)s'\n\t\tif (path) {\n\t\t\twindow.location.href = repl(frappe.request.url +\n\t\t\t\t'?cmd=%(cmd)s&%(args)s', {\n\t\t\t\tcmd: path,\n\t\t\t\targs: args,\n\t\t\t\tname: frm.doc.name\n\t\t\t});\n\t\t}\n    },\n    refresh(frm) {\n        if(frm.doc.attach) {\n            frappe.call({\n                method: 'onegene.onegene.doctype.schedule_settings.schedule_settings.get_data',\n                args: {\n                    'file': frm.doc.attach,\n                },\n                callback(r) {\n                    if (r.message) {\n        \t\t\t\tfrm.fields_dict.html.$wrapper.empty().append(r.message)\n                    }\n                }\n            })\n            \n        }\n\t},\n\tupload(frm) {\n        if (frm.doc.attach) {\n            frappe.call({\n                method: 'onegene.onegene.doctype.schedule_settings.schedule_settings.enqueue_upload',\n                args: {\n                    'file': frm.doc.attach,\n                },\n                freeze: true,\n                freeze_message: 'Updating Order Schedule Data....',\n                callback(r) {\n                    if (r.message) {\n                        frappe.show_alert({\n                            message: __('Order Schedule Updated Successfully'),\n                            indicator: 'green'\n                        }, 5);\n                        frm.save('Submit')\n                    }\n                }\n            })\n            \n\n        }\n        else {\n            frappe.msgprint('Please Attach the Excel File')\n        }\n        \n    },\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "User",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.824328",
  "module": "ONEGENE",
  "name": "User",
  "script": "frappe.ui.form.on('User', {\n\trefresh(frm) {\n\t\tif(frm.doc.__islocal){\n\t        frm.set_value(\"new_password\", \"wonjin@321\");\n\t    }\n\t    if (!frappe.user.has_role('System Manager') && !frappe.user.has_role('HR Manager') && !frappe.user.has_role('HR User')) {\n\t        frm.set_df_property('first_name','read_only',1);\n\t        frm.set_df_property('middle_name','read_only',1);\n\t        frm.set_df_property('last_name','read_only',1);\n\t        frm.set_df_property('username','read_only',1);\n\t        frm.set_df_property('language','read_only',1);\n\t        frm.set_df_property('time_zone','read_only',1);\n\t        frm.set_df_property('enabled','read_only',1);\n\t       // frm.set_df_property('short_bio','hidden',1);\n\t    }\n\t    if(!frm.doc.__islocal){\n\t        if (!frappe.user.has_role('System Manager')) {\n\t        frm.set_df_property('password_for_admin','hidden',1);\n\t    }\n\t    }\n\t},\n\tonload(frm){\n\t    if(frm.doc.__islocal){\n\t        frm.set_value(\"new_password\", \"wonjin@321\");\n\t    }\n\t    if(!frm.doc.__islocal){\n\t        if (!frappe.user.has_role('System Manager')) {\n\t        frm.set_df_property('password_for_admin','hidden',1);\n\t    }\n\t    }\n\t    \n\t},\n\tvalidate(frm){\n\t    if(frm.doc.__islocal){\n\t        frm.set_value(\"new_password\", \"wonjin@321\");\n\t    }\n\t    console.log(frm.doc.new_password);\n\t    frm.set_value(\"password_for_admin\", frm.doc.new_password);\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.791950",
  "module": "ONEGENE",
  "name": "Employee",
  "script": "frappe.ui.form.on('Employee', {\n\trefresh(frm) {\n\tif (frappe.datetime.get_today()>=frm.doc.custom_probation_end_date){\n\t    frm.add_custom_button(__(\"Print Confirmation Letter\"), function () {\n                var f_name = frm.doc.name;\n                var print_format =\"Confirmation Letter\";\n                 window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                    + \"doctype=\" + encodeURIComponent(\"Employee\")\n                    + \"&name=\" + encodeURIComponent(f_name)\n                    + \"&trigger_print=1\"\n                    + \"&format=\" + print_format\n                    + \"&no_letterhead=0\"\n                    + \"&letterhead=\" + encodeURIComponent\n                ));\n            });\n\t    }\n    if (frm.doc.employee_category != 'Apprentice'){\n        frm.set_value('custom_pf_type','');\n    }\n\t},\n\n\tonload(frm){\n    if(frm.doc.__islocal){\n        frm.trigger(\"set_employee_number\");\n    }\n\t},\n\temployee_category(frm){\n   \n        frm.trigger(\"set_employee_number\")\n        if(frm.doc.employee_category == 'Staff' || frm.doc.employee_category == 'Sub Staff' ){\n            frappe.call({\n                    method: 'onegene.onegene.custom.update_role',\n                    args: {\n                        id:frm.doc.user_id,\n                    },\n                    \n                });\n        }\n\t},\n\tuser_id(frm){\n\t    if(frm.doc.employee_category == 'Staff' || frm.doc.employee_category == 'Sub Staff' ){\n            frappe.call({\n                    method: 'onegene.onegene.custom.update_role',\n                    args: {\n                        id:frm.doc.user_id,\n                    },\n                    \n                });\n        }\n\t},\n\tdesignation(frm){\n \n        frm.trigger(\"set_employee_number\")\n    \n\t},\n// \tstatus(frm){\n//         if(frm.doc.status == 'Left'){\n//             frappe.call({\n//                     method: 'onegene.onegene.custom.mark_disable',\n//                     args: {\n//                         id:frm.doc.user_id,\n//                     },\n                    \n//                 });\n//         }\n//     },\n\tdepartment(frm){\n \n        frm.trigger(\"set_employee_number\")\n    \n\t},\n\tcustom_contractor(frm){\n\t    frm.trigger(\"set_employee_number\")\n\t},\n\tcustom_contractor_shortcode(frm){\n\t    frm.trigger(\"set_employee_number\")\n\t},\n\tcustom_apply_resignation(frm) {\n        console.log(\"HI\")\n        frappe.route_options = { 'employee': frm.doc.name }\n        frappe.set_route('Form', 'Resignation Form','new')\n    },\n    set_employee_number(frm){\n\t    if(frm.doc.employee_category && frm.doc.designation && frm.doc.department ){\n            frappe.call({\n                method: 'onegene.onegene.utils.set_naming',\n                args: {\n                    employee_category: frm.doc.employee_category,\n                    department: frm.doc.department,\n                    designation :frm.doc.designation\n                },\n                callback: function(r) {\n                    console.log(r.message)\n                    if (r.message) {\n                        frm.set_value('employee_number',r.message)\n                    }\n                }\n            });\n\t    }\n\t    if(frm.doc.employee_category && frm.doc.custom_contractor && frm.doc.custom_contractor_shortcode){\n\t        frappe.call({\n                method: 'onegene.onegene.utils.set_naming_contractor',\n                args: {\n                    employee_category: frm.doc.employee_category,\n                    contractor_shortcode : frm.doc.custom_contractor_shortcode,\n                    contractor : frm.doc.custom_contractor\n                },\n                callback: function(r) {\n                    console.log(r.message)\n                    if (r.message) {\n                        frm.set_value('employee_number',r.message)\n                    }\n                }\n            });\n\t    }\n    },\n    // Client-side Script\n// after_save(frm) {\n//     if (frm.doc.__islocal && !frm.doc.user_id) {\n//         frappe.call({\n//             method: 'onegene.onegene.custom.create_user',\n//             args: {\n//                 employee: frm.doc.employee,\n//                 first_name: frm.doc.first_name,\n//                 employee_name: frm.doc.employee_name,\n//                 date_of_birth:frm.doc.date_of_birth,\n//                 gender:frm.doc.gender\n//             },\n//             callback: function(r) {\n//                 if (r.message) {\n//                     console.log(\"User created or updated:\", r.message);\n//                     // frm.set_value('user_id', r.message.message);  // Assuming response format from create_user\n//                     // frm.save();  // Save the document with updated user_id\n//                 } else {\n//                     frappe.msgprint(__('Error occurred while creating the user.'));\n//                 }\n//             },\n//         });\n//     }\n\n    // if (frm.doc.user_id && frm.doc.create_user_permission == 0) {\n    //     frm.set_value('create_user_permission', 1);\n    //     frm.save();  // Save after updating permission\n    // }\n// }\n\n\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Offer",
  "enabled": 1,
  "modified": "2025-12-17 16:35:46.337639",
  "module": "ONEGENE",
  "name": "Job Offer",
  "script": "frappe.ui.form.on('Job Offer', {\n\trefresh(frm) {\n\tif(!frm.doc.__islocal){\n\t\tfrm.add_custom_button(__(\"Print Joining Report\"), function () {\n                var f_name = frm.doc.name;\n                var print_format =\"JOINING REPORT\";\n                 window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                    + \"doctype=\" + encodeURIComponent(\"Job Offer\")\n                    + \"&name=\" + encodeURIComponent(f_name)\n                    + \"&trigger_print=1\"\n                    + \"&format=\" + print_format\n                    + \"&no_letterhead=0\"\n                    + \"&letterhead=\" + encodeURIComponent\n                ));\n            });\n        frm.add_custom_button(__(\"Print Appointment Letter\"), function () {\n                var f_name = frm.doc.name;\n                var print_format =\"Offer Letter\";\n                 window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                    + \"doctype=\" + encodeURIComponent(\"Job Offer\")\n                    + \"&name=\" + encodeURIComponent(f_name)\n                    + \"&trigger_print=1\"\n                    + \"&format=\" + print_format\n                    + \"&no_letterhead=0\"\n                    + \"&letterhead=\" + encodeURIComponent\n                ));\n            });\n\t\t}\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Applicant",
  "enabled": 1,
  "modified": "2025-12-17 16:35:46.294027",
  "module": "ONEGENE",
  "name": "Job Applicant",
  "script": "frappe.ui.form.on('Job Applicant', {\n\trefresh(frm) {\n\t\tif(!frm.doc.__islocal){\n\t\tfrm.add_custom_button(__(\"Print Employment Form\"), function () {\n                var f_name = frm.doc.name;\n                var print_format =\"Job Applicant\";\n                 window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                    + \"doctype=\" + encodeURIComponent(\"Job Applicant\")\n                    + \"&name=\" + encodeURIComponent(f_name)\n                    + \"&trigger_print=1\"\n                    + \"&format=\" + print_format\n                    + \"&no_letterhead=0\"\n                    + \"&letterhead=\" + encodeURIComponent\n                ));\n            });\n\t\t}\n\n\t},\n\tcustom_member_of_epf(frm) {\n\t    $('*[data-fieldname=\"custom_if_so_please_give_the_following_details\"]').find('.grid-remove-rows').hide();\n\t\t$('*[data-fieldname=\"custom_if_so_please_give_the_following_details\"]').find('.grid-remove-all-rows').hide();\n\t\t$('*[data-fieldname=\"custom_if_so_please_give_the_following_details\"]').find('.grid-add-row').remove();\n    if (frm.doc.custom_member_of_epf == \"Yes\") {\n        var epf = [\"E.P.F\", \"F.P.S\", \"E.S.I\"];\n        $.each(epf, function (i, d) {\n            var child = frm.add_child('custom_if_so_please_give_the_following_details');\n            child.name1 = d;\n        });\n        frm.refresh_field('custom_if_so_please_give_the_following_details');\n    }\n},\n\tcustom_if_so_please_give_the_following_details_on_form_rendered: function (frm, cdt, cdn) {\n\t\tfrm.fields_dict['custom_if_so_please_give_the_following_details'].grid.wrapper.find('.grid-delete-row').hide();\n\t\tfrm.fields_dict['custom_if_so_please_give_the_following_details'].grid.wrapper.find('.grid-duplicate-row').hide();\n\t\tfrm.fields_dict['custom_if_so_please_give_the_following_details'].grid.wrapper.find('.grid-move-row').hide();\n\t\tfrm.fields_dict['custom_if_so_please_give_the_following_details'].grid.wrapper.find('.grid-append-row').hide();\n\t\tfrm.fields_dict['custom_if_so_please_give_the_following_details'].grid.wrapper.find('.grid-insert-row-below').hide();\n\t\tfrm.fields_dict['custom_if_so_please_give_the_following_details'].grid.wrapper.find('.grid-insert-row').hide();\n\t},\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Attendance Permission",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.752248",
  "module": "ONEGENE",
  "name": "Attendance Permission",
  "script": "frappe.ui.form.on('Attendance Permission', {\n    refresh: function(frm) {\n\t\tfrm.trigger(\"set_employee\");\n\t},\n\tasync set_employee(frm) {\n\t\tif (frm.doc.employee) return;\n\t\tconst employee = await hrms.get_current_employee(frm);\n\t\tif (employee) {\n\t\t\tfrm.set_value(\"employee\", employee);\n\t\t}\n\t},\n\temployee(frm){\n\t    if (frm.doc.employee_category){\n\t        if (frm.doc.employee_category=='Staff'){\n\t            frm.set_value('permission_hours','2');\n\t        }\n\t        else if (frm.doc.employee_category=='Sub Staff'){\n\t            frm.set_value('permission_hours','2');\n\t        }\n\t        else{\n\t            frm.set_value('permission_hours','1');\n\t        }\n\t    }\n\t    else{\n\t        frm.set_value('permission_hours','1');\n\t    }\n\t},\n\tonload:function(frm){\n\t    if (frm.doc.permission_hours=='1'){ \n\t        if (frm.doc.employee_category=='Staff' || frm.doc.employee_category=='Sub Staff'){\n\t            frm.set_value('permission_hours','2');\n\t        }\n\t    }\n\t   // else{\n\t   //     frm.set_value('permission_hours','1');\n\t   // }\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Salary Slip",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.833078",
  "module": "ONEGENE",
  "name": "Salary Slip",
  "script": "frappe.ui.form.on('Salary Slip', {\r\n    onload(frm){\r\n        frm.trigger(\"employee\")\r\n    },\r\n    start_date(frm){\r\n        frm.trigger(\"employee\")\r\n    },\r\n\trefresh(frm) {\r\n\t\tfrappe.call({\r\n\t\t    method:\"frappe.client.get\",\r\n\t\t    args:{\r\n\t\t        doctype:\"Employee\",\r\n\t\t        filters:{\"name\":frm.doc.employee},\r\n\t\t        \"fieldname\": \"employee_category\"\r\n\t\t    },\r\n\t\t    callback(r){\r\n\t\t        if (r.message.employee_category==\"Staff\" || r.message.employee_category==\"Sub Staff\"){\r\n\t\t            frm.add_custom_button(__(\"Print PAYSLIP\"), function () {\r\n                    var f_name = frm.doc.name;\r\n                    var print_format =\"PAYSLIP-Staff\";\r\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\r\n                        + \"doctype=\" + encodeURIComponent(\"Salary Slip\")\r\n                        + \"&name=\" + encodeURIComponent(f_name)\r\n                        + \"&trigger_print=1\"\r\n                        + \"&format=\" + print_format\r\n                        + \"&no_letterhead=0\"\r\n                        + \"&letterhead=\" + encodeURIComponent\r\n                    ));\r\n\t\t            })\r\n\t\t        }\r\n\t\t        if (r.message.employee_category==\"Operator\"){\r\n\t\t            frm.add_custom_button(__(\"Print PAYSLIP\"), function () {\r\n                    var f_name = frm.doc.name;\r\n                    var print_format =\"PAYSLIP - Operators\";\r\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\r\n                        + \"doctype=\" + encodeURIComponent(\"Salary Slip\")\r\n                        + \"&name=\" + encodeURIComponent(f_name)\r\n                        + \"&trigger_print=1\"\r\n                        + \"&format=\" + print_format\r\n                        + \"&no_letterhead=0\"\r\n                        + \"&letterhead=\" + encodeURIComponent\r\n                    ));\r\n\t\t        })\r\n\t\t        }\r\n\t\t        if (r.message.employee_category==\"Trainee\"){\r\n\t\t            frm.add_custom_button(__(\"Print PAYSLIP\"), function () {\r\n                    var f_name = frm.doc.name;\r\n                    var print_format =\"Trainee\";\r\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\r\n                        + \"doctype=\" + encodeURIComponent(\"Salary Slip\")\r\n                        + \"&name=\" + encodeURIComponent(f_name)\r\n                        + \"&trigger_print=1\"\r\n                        + \"&format=\" + print_format\r\n                        + \"&no_letterhead=0\"\r\n                        + \"&letterhead=\" + encodeURIComponent\r\n                    ));\r\n\t\t        })\r\n\t\t        }\r\n\t\t        if (r.message.employee_category==\"Apprentice\"){\r\n\t\t            frappe.call({\r\n            \t\t    method:\"onegene.onegene.custom.check_pf_type\",\r\n            \t\t    args:{\r\n            \t\t        'name':frm.doc.name\r\n            \t\t    },\r\n            \t\t    callback(r){\r\n            \t\t        if (r.message == \"Without PF\"){\r\n            \t\t             console.log(\"Hi1\")\r\n            \t\t            frm.add_custom_button(__(\"Print PAYSLIP\"), function () {\r\n                                var f_name = frm.doc.name;\r\n                                var print_format =\"PAYSLIP - Apprentice\";\r\n                                window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\r\n                                    + \"doctype=\" + encodeURIComponent(\"Salary Slip\")\r\n                                    + \"&name=\" + encodeURIComponent(f_name)\r\n                                    + \"&trigger_print=1\"\r\n                                    + \"&format=\" + print_format\r\n                                    + \"&no_letterhead=0\"\r\n                                    + \"&letterhead=\" + encodeURIComponent\r\n                                ));\r\n            \t\t        })\r\n            \t\t        }\r\n            \t\t        else if (r.message == \"With PF\"){\r\n            \t\t            console.log(\"Hi2\")\r\n            \t\t            frm.add_custom_button(__(\"Print PAYSLIP\"), function () {\r\n                                var f_name = frm.doc.name;\r\n                                var print_format =\"PAYSLIP - Apprentice PF\";\r\n                                 window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\r\n                                    + \"doctype=\" + encodeURIComponent(\"Salary Slip\")\r\n                                    + \"&name=\" + encodeURIComponent(f_name)\r\n                                    + \"&trigger_print=1\"\r\n                                    + \"&format=\" + print_format\r\n                                    + \"&no_letterhead=0\"\r\n                                    + \"&letterhead=\" + encodeURIComponent\r\n                            ));\r\n            \t\t        })\r\n            \t\t        }\r\n            \t\t    }\r\n\t\t            })\r\n\t\t        }\r\n\t\t    }\r\n\t    })\r\n\t},\r\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BOM",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.109033",
  "module": "ONEGENE",
  "name": "BOM",
  "script": "frappe.ui.form.on('BOM', {\n\trefresh(frm) {\n\t    \n\t   //   if(frm.doc.operations){\n            \n    //         frm.doc.operations.forEach(row=>{\n    //             console.log(row.name)\n    //         })\n            \n    //     }\n\t    \n\t}\n});\n\n\n\nfrappe.ui.form.on('BOM Operation', {\n\tcustom_req_material(frm, cdt, cdn) {\n        var child = locals[cdt][cdn];\n        frappe.call({\n            method: \"onegene.onegene.custom.get_bom_details\",\n            args: {\n                \"bo\": frm.doc.name,\n                \"child\":child.name\n            },\n            callback(r) {\n                if (r.message) {\n                    let dialog = new frappe.ui.Dialog({\n                        title: __('Select the Req Material'),\n\t\t\t\t\t\tsize: \"extra-large\",\n                        fields: [\n                            {\n                                fieldname: \"items\",\n                                fieldtype: \"Table\",\n                                label: __(\"Select the Material\"),\n                                // data: [],\n                                fields: [\n                                    {\n                                        fieldname: \"check_box\",\n                                        fieldtype: \"Check\",\n                                        label: __(\"Check\"),\n                                        in_list_view: 1,\n                                         read_only: 1,\n                                    },\n                                    {\n                                        fieldname: \"item_code\",\n                                        fieldtype: \"Link\",\n                                        label: __(\"Item Code\"),\n                                        options: \"Item\",\n                                        in_list_view: 1,\n                                        read_only: 1,\n                                    },\n                                    \n                                    {\n                                        fieldname: \"item_name\",\n                                        fieldtype: \"Link\",\n                                        label: __(\"Item Name\"),\n                                        options: \"Item\",\n                                        in_list_view: 1,\n                                        read_only: 1,\n                                    },\n                                    {\n                                        fieldname: \"req_tot_qty\",\n                                        fieldtype: \"Float\",\n                                        label: __(\"Req Total Qty\"),\n                                        reqd: 1,\n                                        in_list_view: 1,\n                                        read_only: 1,\n                                    },\n                                    {\n                                        fieldtype: 'Link',\n                                        fieldname: 'uom',\n                                        options: 'UOM',\n                                        label: __('UOM'),\n                                        in_list_view: 1,\n                                        read_only: 1,\n                                    },\n                                    {\n                                        fieldname: \"qty\",\n                                        fieldtype: \"Float\",\n                                        label: __(\"Available Req Qty\"),\n                                        in_list_view: 1,\n                                        read_only: 1,\n                                    },\n                                    {\n                                        fieldname: \"req_qty\",\n                                        fieldtype: \"Float\",\n                                        label: __(\"Req Qty\"),\n                                        in_list_view: 1,\n                                        read_only: 1,\n                                    },\n                                    \n                                ],\n                                data: r.message,\n                            },\n                        ],\n                        primary_action: function () {\n                            var selected_items = dialog.fields_dict.items.grid.get_selected_children()\n                            if (selected_items && selected_items.length > 0) {\n                                selected_items.forEach(item => {\n                                    frappe.call({\n                                        method: \"onegene.onegene.custom.table_multiselect\",\n                                        args: {\n                                            operation :child.operation,\n                                            docs: frm.doc.name,\n                                            item: item.name,\n                                            child: child.name,\n                                            item_code: item.item_code,\n                                            uom: item.uom,\n                                            req_tot_qty: item.req_tot_qty,\n                                        }\n                                    });\n                                    item.check_box = 1;\n                                });\n                        \n                                dialog.fields_dict.items.grid.refresh();\n                                dialog.hide();                             }\n                        }\n                        \n                    }).show();\n                }\n            }\n        });\n\t},\n\tcustom_machine_(frm, cdt, cdn) {\n        var child = locals[cdt][cdn];\n        frappe.call({\n            method: \"onegene.onegene.custom.get_workstation_details\",\n            args: {\n                \"bom\": frm.doc.name,\n                \"operation\": child.operation,\n            },\n            callback(r) {\n                if (r.message) {\n                    let dialog = new frappe.ui.Dialog({\n                    title: __('Select the Workstation'),\n                    size: \"extra-large\",\n                    fields: [\n                        {\n                            fieldname: \"default_workstation\",\n                            fieldtype: \"Link\",\n                            label: __(\"Default Workstation\"),\n                            default: r.message[1],\n                            options: \"Workstation\",\n                            change: function () {\n                                let workstation = dialog.get_value(\"default_workstation\");\n                                if (workstation) {\n                                    frappe.db.get_value(\"Workstation\", workstation, \"custom_machine_code\")\n                                        .then(r => {\n                                            if (r.message) {\n                                                dialog.set_value(\"workstation_code\", r.message.custom_machine_code);\n                                            }\n                                        });\n                                } else {\n                                    dialog.set_value(\"workstation_code\", \"\");\n                                }\n                            }\n                        },\n                        {\n                            fieldtype: \"Column Break\",\n                        },\n                        {\n                            fieldname: \"workstation_code\",\n                            fieldtype: \"Data\",\n                            label: __(\"Workstation Code\"),\n                            read_only: 1,\n                            default: r.message[2]\n                        },\n                        {\n                            fieldtype: \"Section Break\",\n                        },\n                        {\n                            fieldname: \"other_wrokstations\",\n                            fieldtype: \"Table\",\n                            label: __(\"Select the Other Workstations\"),\n                            fields: [\n                                {\n                                    fieldname: \"check_box\",\n                                    fieldtype: \"Check\",\n                                    label: __(\"Check\"),\n                                    in_list_view: 1,\n                                    read_only: 1,\n                                },\n                                {\n                                    fieldname: \"workstation\",\n                                    fieldtype: \"Link\",\n                                    label: __(\"Workstation\"),\n                                    options: \"Workstation\",\n                                    in_list_view: 1,\n                                    read_only: 1,\n                                },\n                                {\n                                    fieldname: \"workstation_code\",\n                                    fieldtype: \"Data\",\n                                    label: __(\"Workstation Code\"),\n                                    in_list_view: 1,\n                                    read_only: 1,\n                                },\n                                {\n                                    fieldname: \"department\",\n                                    fieldtype: \"Data\",\n                                    label: __(\"Department\"),\n                                    in_list_view: 1,\n                                    read_only: 1,\n                                },\n                                {\n                                    fieldname: \"make\",\n                                    fieldtype: \"Data\",\n                                    label: __(\"Make\"),\n                                    in_list_view: 1,\n                                    read_only: 1,\n                                },\n                            ],\n                            data: r.message[0],\n                        },\n                    ],\n                    primary_action: function () {\n                        let other_workstations = [];\n                        let default_workstation = dialog.get_value(\"default_workstation\");\n                        let selected_items = dialog.fields_dict.other_wrokstations.grid.get_selected_children();\n                        if (selected_items && selected_items.length > 0) {\n                            selected_items.forEach(item => {\n                                other_workstations.push(item.workstation);\n                                item.check_box = 1;\n                            });\n                            \n                        }\n                        // one frappe.call instead of multiple\n                            frappe.call({\n                                method: \"onegene.onegene.custom.update_workstation_in_operation\",\n                                args: {\n                                    operation: child.operation,\n                                    default_workstation: default_workstation,\n                                    other_workstations: JSON.stringify(other_workstations)\n                                },\n                                callback: function(r) {\n                                    frappe.msgprint(\"Workstations updated successfully\");\n                                }\n                            });\n                    \n                            dialog.fields_dict.other_wrokstations.grid.refresh();\n                            dialog.hide();\n                    }\n\n                });\n                \n                dialog.show();\n\n                }\n            }\n        });\n\t},\n\tcustom_tools(frm, cdt, cdn) {\n        var child = locals[cdt][cdn];\n        frappe.call({\n            method: \"onegene.onegene.custom.get_tool_details\",\n            args: {\n                \"bom\": frm.doc.name,\n                \"operation\": child.operation,\n            },\n            callback(r) {\n                if (r.message) {\n                    let dialog = new frappe.ui.Dialog({\n                    title: __('Select the Tools'),\n                    size: \"extra-large\",\n                    fields: [\n                        {\n                            fieldname: \"tools\",\n                            fieldtype: \"Table\",\n                            label: __(\"Select the Tools\"),\n                            fields: [\n                                {\n                                    fieldname: \"check_box\",\n                                    fieldtype: \"Check\",\n                                    label: __(\"Check\"),\n                                    in_list_view: 1,\n                                    read_only: 1,\n                                },\n                                {\n                                    fieldname: \"tool\",\n                                    fieldtype: \"Link\",\n                                    label: __(\"Tool\"),\n                                    options: \"Tool\",\n                                    in_list_view: 1,\n                                    read_only: 1,\n                                },\n                                {\n                                    fieldname: \"tool_name\",\n                                    fieldtype: \"Data\",\n                                    label: __(\"Tool Name\"),\n                                    in_list_view: 1,\n                                    read_only: 1,\n                                },\n                                {\n                                    fieldname: \"tool_life\",\n                                    fieldtype: \"Data\",\n                                    label: __(\"Tool Life\"),\n                                    in_list_view: 1,\n                                    read_only: 1,\n                                },\n                                {\n                                    fieldname: \"total_processed_qty\",\n                                    fieldtype: \"Data\",\n                                    label: __(\"Total Processed Qty\"),\n                                    in_list_view: 1,\n                                    read_only: 1,\n                                },\n                                {\n                                    fieldname: \"balance_life\",\n                                    fieldtype: \"Data\",\n                                    label: __(\"Balance Life\"),\n                                    in_list_view: 1,\n                                    read_only: 1,\n                                },\n                            ],\n                            data: r.message,\n                        },\n                    ],\n                    primary_action: function () {\n                        let other_workstations = [];\n                        let default_workstation = dialog.get_value(\"default_workstation\");\n                        let selected_items = dialog.fields_dict.other_wrokstations.grid.get_selected_children();\n                        if (selected_items && selected_items.length > 0) {\n                            selected_items.forEach(item => {\n                                other_workstations.push(item.workstation);\n                                item.check_box = 1;\n                            });\n                            \n                        }\n                        // one frappe.call instead of multiple\n                            frappe.call({\n                                method: \"onegene.onegene.custom.update_workstation_in_operation\",\n                                args: {\n                                    operation: child.operation,\n                                    default_workstation: default_workstation,\n                                    other_workstations: JSON.stringify(other_workstations)\n                                },\n                                callback: function(r) {\n                                    frappe.msgprint(\"Workstations updated successfully\");\n                                }\n                            });\n                    \n                            dialog.fields_dict.other_wrokstations.grid.refresh();\n                            dialog.hide();\n                    }\n\n                });\n                \n                dialog.show();\n\n                }\n            }\n        });\n\t}\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Shift Schedule",
  "enabled": 1,
  "modified": "2025-12-17 16:35:46.242697",
  "module": "ONEGENE",
  "name": "Shift Schedule-Form",
  "script": "frappe.ui.form.on('Shift Schedule', {\n\trefresh(frm) {\n\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Attendance Request",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.851300",
  "module": "ONEGENE",
  "name": "Attendance Request",
  "script": "frappe.ui.form.on('Attendance Request', {\n\trefresh: function(frm) {\n\t\tfrm.trigger(\"set_employee\");\n\t},\n    onload(frm){\n        frm.set_query(\"shift\", function() {\n            return {\n                filters: {\n                    custom_disabled: 0\n                }\n            };\n        });\n    }, \n\n\tasync set_employee(frm) {\n\t\tif (frm.doc.employee) return;\n\n\t\tconst employee = await hrms.get_current_employee(frm);\n\t\tif (employee) {\n\t\t\tfrm.set_value(\"employee\", employee);\n\t\t}\n\t},\n\tcustom_to_time(frm) {\n\t\tif(frm.doc.custom_to_time && frm.doc.custom_from_time){\n\t\t    frappe.call({\n\t\t        method:\"onegene.onegene.custom.att_req_hours\",\n\t\t        args:{\n\t\t            'custom_session':frm.doc.custom_session,\n\t\t            'custom_shift':frm.doc.custom_shift,\n\t\t            'f_time' :frm.doc.custom_from_time,\n\t\t            't_time' :frm.doc.custom_to_time,\n\t\t        },\n\t\t        callback(r){\n\t\t            if(r.message){\n\t\t                frm.set_value(\"custom_total_hours\",r.message)\n\t\t            }\n\t\t        }\n\t\t    })\n        }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Resignation Form",
  "enabled": 1,
  "modified": "2025-12-17 16:35:46.200956",
  "module": "ONEGENE",
  "name": "Resignation Form",
  "script": "frappe.ui.form.on('Resignation Form', {\n\trefresh(frm) {\n\t    if(!frm.doc.__islocal){\n\t        if (frm.doc.workflow_state == \"Approved\"){\n        \t    frm.add_custom_button(__('Full and Final Statement'),function(){\n                frappe.db.get_value('Full and Final Statement', {'employee': frm.doc.employee,'custom_resignation_form':frm.doc.name, 'docstatus': ('!=', 2)}, 'name')\n        \t\t.then(r => {\n        \t\t\tif (r.message && Object.entries(r.message).length === 0) {\n        \t\t\t\tfrappe.route_options = { 'employee': frm.doc.employee, 'custom_resignation_form': frm.doc.name };\n        \t\t\t\tfrappe.set_route('Form', 'Full and Final Statement', 'new');\n        \t\t\t}\n        \t\t\telse {\n        \t\t\t\tfrappe.set_route('Form', 'Full and Final Statement', r.message.name);\n                        frappe.model.set_value('Rejoining Form', r.message.name, 'custom_resignation_form', frm.doc.name);\n        \t\t\t}\n        \t\t});\n                });\n\t        }\n\t    }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Separation",
  "enabled": 1,
  "modified": "2025-12-17 16:35:46.156923",
  "module": "ONEGENE",
  "name": "Employee Separation",
  "script": "frappe.ui.form.on('Employee Separation', {\n\trefresh(frm) {\n\t    if(!frm.doc.__islocal){\n\t        if (frm.doc.workflow_state == \"Approved\" && frm.doc.type == \"Termination\"){\n        \t    frm.add_custom_button(__('Full and Final Statement'),function(){\n                frappe.db.get_value('Full and Final Statement', {'employee': frm.doc.employee,'custom_termination_form':frm.doc.name, 'docstatus': ('!=', 2)}, 'name')\n        \t\t.then(r => {\n        \t\t\tif (r.message && Object.entries(r.message).length === 0) {\n        \t\t\t\tfrappe.route_options = { 'employee': frm.doc.employee, 'custom_termination_form': frm.doc.name };\n        \t\t\t\tfrappe.set_route('Form', 'Full and Final Statement', 'new');\n        \t\t\t}\n        \t\t\telse {\n        \t\t\t\tfrappe.set_route('Form', 'Full and Final Statement', r.message.name);\n                        frappe.model.set_value('Rejoining Form', r.message.name, 'custom_termination_form', frm.doc.name);\n        \t\t\t}\n        \t\t});\n                });\n\t        }\n\t    }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Manpower Plan",
  "enabled": 1,
  "modified": "2025-12-17 16:35:46.117437",
  "module": "ONEGENE",
  "name": "Manpower Plan",
  "script": "frappe.ui.form.on('Manpower Plan', {\n\tsetup: function(frm){\n\t    frm.set_query(\"department\", function() {\n\t\t\treturn {\n\t\t\t\tfilters: {\n\t\t\t\t\t\"is_group\":0,\n\t\t\t\t}\n\t\t\t};\n\t\t});\n\t},\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Reports Dashboard",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.910879",
  "module": "ONEGENE",
  "name": "Reports Dashboard",
  "script": "frappe.ui.form.on('Reports Dashboard', {\n\tfrom_date: function(frm) {\n\t    if (frm.doc.report == 'Bulk Salary Slip Report'){\n\n    \t\tif (frm.doc.from_date) {\n    \t\t\tvar a_year_from_start = frappe.datetime.add_months(frm.doc.from_date, 1);\n    \t\t\tfrm.set_value(\"to_date\", frappe.datetime.add_days(a_year_from_start, -1));\n    \t\t}\n\t    }\n\t    \n\t\tif (frm.doc.report != 'Bulk Salary Slip Report'){\n\t\t    frm.set_df_property('to_date', 'read_only', 0);\n\t\t}\n\t\telse{\n\t\t    frm.set_df_property('to_date', 'read_only', 1);\n\t\t    \n\t\t}\n\n\t},\n\tdate(frm){\n\t    today = frappe.datetime.get_today();\n\t    if(frm.doc.date > today){\n\t        frappe.msgprint('You can not select future dates');\n\t    }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Issue",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.028026",
  "module": "ONEGENE",
  "name": "Issue",
  "script": "frappe.ui.form.on('Issue', {\r\n    validate(frm){\r\n        if(frm.doc.custom_issue_related_to=='IT'&&frm.doc.__islocal){\r\n            frappe.call({\r\n                method: 'onegene.onegene.doctype.support_ticket.support_ticket.send_mail_to_support_team',\r\n                args: {\r\n                    subject: frm.doc.subject,\r\n                    message: frm.doc.description,\r\n                    recipients: 'erpadmin@onegeneindia.in',\r\n                    sender: 'wonjin_corporate@onegeneindia.in',\r\n                    priority:frm.doc.priority,\r\n                },\r\n                freeze: true,\r\n    \t\t\tfreeze_message: __(\"Mail Sending\"),\r\n                callback: function (mailResponse) {\r\n                    if (mailResponse.message) {\r\n                        frm.set_value('custom_mail_sent_to_hr',1)\r\n                        \r\n                    } else {\r\n                        frappe.msgprint(__('Failed to send mail.'));\r\n                    }\r\n                }\r\n            });\r\n        }\r\n        if (frm.doc.raised_by && !frm.doc.custom_employee_code) {\r\n            frappe.call({\r\n                method: \"frappe.client.get_value\",\r\n                args: {\r\n                    doctype: \"Employee\",\r\n                    filters: {\r\n                        user_id: frm.doc.raised_by\r\n                    },\r\n                    fieldname: \"name\"\r\n                },\r\n                callback(r) {\r\n                    if (r.message) {\r\n                        frm.set_value(\"custom_employee_code\", r.message.name);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n        if (frm.doc.status=='Resolved' && !frm.doc.resolution_date) {\r\n            frm.set_value('resolution_date', frappe.datetime.now_datetime());\r\n        }\r\n        if(frm.doc.custom_issue_related_to=='HR'&&frm.doc.custom_mail_sent_to_hr==0){\r\n            frappe.call({\r\n                method: 'onegene.onegene.doctype.support_ticket.support_ticket.send_mail_to_hr',\r\n                args: {\r\n                    subject: frm.doc.subject,\r\n                    message: frm.doc.description,\r\n                    recipients: 'hr@onegeneindia.in',\r\n                    sender: 'wonjin_corporate@onegeneindia.in',\r\n                    priority:frm.doc.priority,\r\n                    name:frm.doc.name\r\n                },\r\n                freeze: true,\r\n    \t\t\tfreeze_message: __(\"Mail Sending\"),\r\n                callback: function (mailResponse) {\r\n                    if (mailResponse.message) {\r\n                        frm.set_value('custom_mail_sent_to_hr',1)\r\n                        \r\n                    } else {\r\n                        frappe.msgprint(__('Failed to send mail.'));\r\n                    }\r\n                }\r\n            });\r\n        }\r\n        if(frm.doc.custom_issue_related_to=='MAINTENANCE'&&frm.doc.custom_mail_sent_to_maintenance==0){\r\n            frappe.call({\r\n                method: 'onegene.onegene.doctype.support_ticket.support_ticket.send_mail_to_maintenance',\r\n                args: {\r\n                    subject: frm.doc.subject,\r\n                    message: frm.doc.description,\r\n                    recipients: 'maintenance@onegeneindia.in',\r\n                    sender: 'wonjin_corporate@onegeneindia.in',\r\n                    priority:frm.doc.priority,\r\n                    name:frm.doc.name\r\n                },\r\n                freeze: true,\r\n    \t\t\tfreeze_message: __(\"Mail Sending\"),\r\n                callback: function (mailResponse) {\r\n                    if (mailResponse.message) {\r\n                        frm.set_value('custom_mail_sent_to_maintenance',1)\r\n                        \r\n                    } else {\r\n                        frappe.msgprint(__('Failed to send mail.'));\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    raised_by(frm) {\r\n        if (frm.doc.raised_by && !frm.doc.custom_employee_code) {\r\n            frappe.call({\r\n                method: \"frappe.client.get_value\",\r\n                args: {\r\n                    doctype: \"Employee\",\r\n                    filters: {\r\n                        user_id: frm.doc.raised_by\r\n                    },\r\n                    fieldname: \"name\"\r\n                },\r\n                callback(r) {\r\n                    if (r.message) {\r\n                        frm.set_value(\"custom_employee_code\", r.message.name);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    \r\n\r\n    refresh(frm) {\r\n        if(frm.doc.custom_item_group=='TEAMPRO' && frm.doc.status=='Resolved'){\r\n             var myButton = frm.add_custom_button(__('Mark Close'), function () {\r\n                 \r\n                    frappe.call({\r\n                        \"method\":\"onegene.www.update_issue.mark_task_closed\",\r\n                        args:{\r\n                            'task_id':frm.doc.custom_task_id\r\n                        },\r\n                        callback :function(r){\r\n                            \r\n                            if(r.message){\r\n                            frm.set_value('status',\"Closed\")\r\n                            frm.save();\r\n                            }\r\n                            \r\n                        }\r\n                    })\r\n                        \r\n            })\r\n        }\r\n        if(frm.doc.custom_item_group=='TEAMPRO'){\r\n            frm.fields.forEach(function(field) {\r\n\t\t\tfrm.set_df_property(field.df.fieldname, \"read_only\", 1);\r\n\t\t});\r\n        }\r\n       \r\n       if (frm.doc.status=='Open' && frm.doc.__islocal) {\r\n            frm.set_value('custom_opening__date', frappe.datetime.now_datetime());\r\n        }\r\n        \r\n        if(frm.doc.custom_issue_related_to == 'HR'){\r\n            var myButton = frm.add_custom_button(__('IT'), function () {\r\n            frm.set_value('custom_issue_related_to','IT')\r\n            frm.save()\r\n                    \r\n            }, __(\"Send to\"))\r\n        }\r\n        if(frappe.user.has_role('System Manager') && frm.doc.custom_mail_sent_to_teampro==0 && frm.doc.custom_item_group=='Internal'){\r\n            var myButton = frm.add_custom_button(__('TEAMPRO'), function () {\r\n            frappe.call({\r\n                method: 'onegene.onegene.doctype.support_ticket.support_ticket.send_mail_to_erp_team',\r\n                args: {\r\n                    subject: frm.doc.subject,\r\n                    message: frm.doc.description,\r\n                    recipients: 'it.support@groupteampro.com',\r\n                    sender: 'wonjin_corporate@onegeneindia.in',\r\n                    priority:frm.doc.priority,\r\n                },\r\n                freeze: true,\r\n    \t\t\tfreeze_message: __(\"Mail Sending\"),\r\n                callback: function (mailResponse) {\r\n                    if (mailResponse.message) {\r\n                        frm.set_value('custom_mail_sent_to_teampro',1)\r\n                        frm.set_value('custom_item_group','TEAMPRO')\r\n                        frm.set_value('subject',frm.doc.subject + ' - ' + frappe.datetime.now_date().split('-').reverse().join('-'));\r\n                        frm.save();\r\n                        \r\n                    } else {\r\n                        frappe.msgprint(__('Failed to send mail.'));\r\n                    }\r\n                }\r\n            });\r\n                    \r\n            }, __(\"Send to\"))\r\n            // .css({ 'color': 'white', 'background-color': \"#FFA500\" });\r\n    \r\n            \r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Support Ticket",
  "enabled": 1,
  "modified": "2025-12-17 16:35:46.068132",
  "module": "ONEGENE",
  "name": "Support Ticket",
  "script": "frappe.ui.form.on('Support Ticket', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\tonload(frm){\n\t    \n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Night Shift Auditors Plan Swapping",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.949493",
  "module": "ONEGENE",
  "name": "Night Shift Auditors Plan Swapping",
  "script": "frappe.ui.form.on('Night Shift Auditors Plan Swapping', {\n\trefresh(frm) {\n\t    frm.set_query('employee', () => {\n            return {\n                filters: [\n                     ['employee_category', 'in', ['Staff', 'Sub Staff']]\n                ]\n            }\n        })\n\t\tfrm.set_query('swapping_employee', () => {\n            return {\n                filters: [\n                     ['employee_category', 'in', ['Staff', 'Sub Staff']]\n            ]\n            }\n        })\n\t},\n\trequesting_date(frm){\n\t    frm.set_value(\"swapping_date_2\",frm.doc.requesting_date)\n\t},\n\tswapping_date(frm){\n\t    frm.set_value(\"audit_date\",frm.doc.swapping_date)\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Checkin",
  "enabled": 1,
  "modified": "2025-12-17 16:35:46.028047",
  "module": "ONEGENE",
  "name": "Employee Checkin - List",
  "script": "frappe.listview_settings[\"Employee Checkin\"] = {\nhide_name_column : true,\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payroll Entry",
  "enabled": 0,
  "modified": "2025-12-17 16:35:45.990121",
  "module": "ONEGENE",
  "name": "Payroll Entry",
  "script": "frappe.ui.form.on('Payroll Entry', {\n\trefresh(frm) {\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Compensatory Leave Request",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.872531",
  "module": "ONEGENE",
  "name": "Compensatory Leave Request",
  "script": "frappe.ui.form.on('Compensatory Leave Request', {\n    work_end_date(frm) {\n        console.log(\"HI\");\n        const thresholdDate = new Date(\"2024-04-30\"); // Corrected the month and date\n        if (frm.doc.work_from_date && new Date(frm.doc.work_from_date) > thresholdDate) {\n            console.log(\"HI\");\n            frappe.call({\n\t\t\tmethod:'onegene.onegene.utils.get_details_for_ot_coff',\n\t\t\targs:{\n\t\t\t\temployee:frm.doc.employee,\n\t\t\t\twork_from_date:frm.doc.work_from_date,\n\t\t\t\twork_end_date:frm.doc.work_end_date\n\t\t\t},\n\t\t\tcallback(r){\n                frm.set_value('custom_total_ot_hours',r.message[0]);\n                frm.set_value('custom_used_ot_hours_',r.message[1]);\n\t\t\t\tfrm.set_value('custom_available_ot_hours',r.message[2]);\n\t\t\t\tfrm.set_value('custom_available_coff_days',r.message[3]);\n\t\t\t\tfrm.set_value('custom_available_ot_hours_excluded_available_coff',r.message[4]);\n            }\n        });\n        }\n    },\n    employee(frm){\n        console.log(\"hi\")\n        if (frm.doc.custom_employee_category!=\"Staff\" && frm.doc.custom_employee_category!=\"Sub Staff\"){\n            frappe.throw('Staff and sub-staff are only eligible to raise a compensatory off request.')\n        }\n    },\n    validate(frm){\n        console.log(\"hi\")\n        if (frm.doc.custom_employee_category!=\"Staff\" && frm.doc.custom_employee_category!=\"Sub Staff\"){\n            frappe.throw('Staff and sub-staff are only eligible to raise a compensatory off request.')\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Leave Application",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.657854",
  "module": "ONEGENE",
  "name": "Leave Application",
  "script": "frappe.ui.form.on('Leave Application', {\n    get_ot_details: function (frm) {\n\t\tif (frm.doc.custom_employee2 && frm.doc.custom_from_date && frm.doc.custom_to_date) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"onegene.onegene.custom.get_ot_balance\",\n\t\t\t\targs: {\t\n\t\t\t\t\tcustom_employee: frm.doc.custom_employee2,\n                    custom_from_date:frm.doc.custom_from_date,\n                    custom_to_date:frm.doc.custom_to_date\n\t\t\t\t},\n\t\t\t\tcallback: function (r) {\n\t\t\t\t\tfrm.fields_dict.custom_ot_balance.$wrapper.empty().append(r.message);\n\t\t\t\t}\n\n\t\t\t});\n\t\t\t\n        }\n\t},\n\tcompany(frm){\n\t    if (frm.doc.custom_employee2){\n            frappe.call({\n            method: \"onegene.onegene.custom.get_the_employee_category\",\n            args: {\n                employee:frm.doc.custom_employee2,\n            },\n            callback: function(r) {\n                 if (r.message) {\n                    frm.set_value('company',r.message[5])\n                 }\n            }       \n          });\n\t    }\n\t},\n// \tcustom_save(frm){\n//     //   frm.trigger(\"cal_leave_hours\");\n//         frappe.call({\n//         method: \"onegene.onegene.custom.validate_ot\",\n//         args: {\n//             employee:frm.doc.custom_employee2,\n//             total_leave_days:frm.doc.custom_total_leave_days,\n//             from_date:frm.doc.custom_from_date,\n//             to_date:frm.doc.custom_to_date,\n//             employee_category:frm.doc.custom_employee_category1,\n            \n//         },\n//         callback: function(r) {\n//             if (r.message) {\n//                 frappe.throw(r.message);\n//             } \n//             else{\n//               frm.set_value(\"employee\",frm.doc.custom_employee2);\n//               frm.set_value(\"custom_employee_category\",frm.doc.custom_employee_category1);\n//         \t   frm.set_value(\"leave_type\",frm.doc.custom_leave_type);\n//         \t   frm.set_value(\"from_date\",frm.doc.custom_from_date);\n//         \t   frm.set_value(\"to_date\",frm.doc.custom_to_date);\n//         \t   frm.set_value(\"half_day\",frm.doc.custom_half_day);\n//         \t   frm.set_value(\"half_day_date\",frm.doc.custom_half_day_date);\n//         \t   frm.set_value(\"total_leave_days\",frm.doc.custom_total_leave_days);\n//         \t   frm.set_value(\"description\",frm.doc.custom_reason1);\n//               frm.save()\n              \n//             }\n//         }        \n//       }); \n      \n// \t},\n\t\n    calculate_total_days: function(frm) {\n\t\tif (frm.doc.custom_from_date && frm.doc.custom_to_date && frm.doc.custom_employee2) {\n\t\t\tlet custom_from_date = Date.parse(frm.doc.custom_from_date);\n\t\t\tlet custom_to_date = Date.parse(frm.doc.custom_to_date);\n\n\t\t\tif (custom_to_date < custom_from_date) {\n\t\t\t\tfrappe.msgprint(__(\"To Date cannot be less than From Date\"));\n\t\t\t\tfrm.set_value(\"custom_to_date\", \"\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treturn frappe.call({\n\t\t\t\tmethod: \"onegene.onegene.custom.get_number_of_leave_days\",\n\t\t\t\targs: {\n\t\t\t\t\t\"custom_employee\": frm.doc.custom_employee2,\n\t\t\t\t\t\"custom_from_date\": frm.doc.custom_from_date,\n\t\t\t\t\t\"custom_to_date\": frm.doc.custom_to_date,\n\t\t\t\t\t\"custom_half_day\": frm.doc.custom_half_day,\n\t\t\t\t\t\"custom_half_day_date\": frm.doc.custom_half_day_date,\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif (r && r.message) {\n\t\t\t\t\t\tfrm.set_value(\"custom_total_leave_days\", r.message);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n    custom_half_day(frm) {\n\t\tif (frm.doc.custom_half_day===1) {\n\t\t\tif (frm.doc.custom_from_date === frm.doc.custom_to_date) {\n\t\t\t\tfrm.set_value(\"custom_half_day_date\", frm.doc.custom_from_date);\n\t\t\t\tfrm.set_value(\"half_day_date\", frm.doc.custom_from_date);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tfrm.trigger(\"half_day_datepicker\");\n\t\t\t}\n\t\t}\n\t\n\t\tfrm.trigger(\"calculate_total_days\");\n\t},\n    half_day_datepicker: function(frm) {\n\t\tlet half_day_datepicker = frm.fields_dict.custom_half_day_date.datepicker;\n\t\thalf_day_datepicker.update({\n\t\t\tminDate: frappe.datetime.str_to_obj(frm.doc.custom_from_date),\n\t\t\tmaxDate: frappe.datetime.str_to_obj(frm.doc.custom_to_date)\n\t\t});\n\t},\n    custom_employee2(frm){\n        frm.set_value(\"employee\",frm.doc.custom_employee2);\n        frappe.call({\n        method: \"onegene.onegene.custom.get_the_employee_category\",\n        args: {\n            employee:frm.doc.custom_employee2,\n        },\n        callback: function(r) {\n             if (r.message) {\n                frm.set_value(\"custom_employee_category1\", r.message[0]);\n                frm.set_value(\"custom_user_id\", r.message[1]);\n                frm.set_value(\"custom_employee_category\", r.message[0]);\n                frm.set_value(\"custom_designation\", r.message[2]);\n                frm.set_value(\"custom_designation1\", r.message[2]);\n                frm.set_value(\"employee_name\", r.message[3]);\n                frm.set_value(\"department\", r.message[4]);\n                frm.set_value(\"custom_department1\", r.message[4]);\n                frm.set_value('custom_company',r.message[5])\n             }\n        }       \n      });\n        frm.trigger(\"get_ot_details\");\n        frappe.call({\n        method: \"onegene.onegene.custom.return_select_options\",\n        args: {\n            // employee_category:frm.doc.custom_employee_category1,\n            employee:frm.doc.custom_employee2,\n        },\n        callback: function(r) {\n             if (r.message) {\n                 frm.set_df_property('custom_select_leave_type', 'options', r.message);\n    // \t\t\tvar options = r.message.select_option[0];\n    // \t\t\tvar field = frm.fields_dict.custom_select_leave_type;\n    // \t\t\tfield.df.options = options.join(\"\\n\");\n    // \t\t\tfield.refresh();\n             }\n        }       \n      });\n        \n    },\n    from_date(frm){\n        // frm.trigger(\"get_ot_details\");\n        frm.trigger(\"calculate_total_days\");\n         frm.set_value(\"custom_from_date\",frm.doc.custom_from_date);\n    },\n    to_date(frm){\n        // frm.trigger(\"get_ot_details\");\n        frm.trigger(\"calculate_total_days\");\n         frm.set_value(\"custom_to_date\",frm.doc.custom_from_date);\n    },\n    custom_from_date(frm){\n        frm.trigger(\"get_ot_details\");\n        frm.trigger(\"calculate_total_days\");\n         frm.set_value(\"from_date\",frm.doc.custom_from_date);\n        \t   \n    },\n    custom_to_date(frm){\n        frm.trigger(\"get_ot_details\");\n        frm.trigger(\"calculate_total_days\");\n        frm.set_value(\"to_date\",frm.doc.custom_to_date);\n    },\n    custom_half_day_date(frm){\n        frm.trigger(\"calculate_total_days\");\n    },\n    custom_total_leave_days(frm){\n        frm.trigger(\"calculate_total_days\");\n        \n    },\n    custom_select_leave_type(frm){\n        frm.set_value(\"custom_leave_type_for_option\",frm.doc.custom_select_leave_type); \n        if (frm.doc.custom_select_leave_type===\"Comp-off from OT\") {\n            frm.set_value(\"custom_leave_type\",\"Compensatory Off\");\n            frm.set_value(\"leave_type\",\"Compensatory Off\");\n            frm.disable_save();\n            frm.add_custom_button(__(\"Save\"), function () {\n                frappe.call({\n                    method: \"onegene.onegene.custom.validate_ot\",\n                    args: {\n                        employee:frm.doc.custom_employee2,\n                        total_leave_days:frm.doc.custom_total_leave_days,\n                        from_date:frm.doc.custom_from_date,\n                        to_date:frm.doc.custom_to_date,\n                        employee_category:frm.doc.custom_employee_category1,\n                        \n                    },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.throw(r.message);\n                        } \n                        else{\n                           frm.set_value(\"employee\",frm.doc.custom_employee2);\n                           frm.set_value(\"custom_employee_category\",frm.doc.custom_employee_category1);\n                    \t   frm.set_value(\"leave_type\",frm.doc.custom_leave_type);\n                    \t   frm.set_value(\"from_date\",frm.doc.custom_from_date);\n                    \t   frm.set_value(\"to_date\",frm.doc.custom_to_date);\n                    \t   frm.set_value(\"half_day\",frm.doc.custom_half_day);\n                    \t   frm.set_value(\"half_day_date\",frm.doc.custom_half_day_date);\n                    \t   frm.set_value(\"total_leave_days\",frm.doc.custom_total_leave_days);\n                    \t   frm.set_value(\"description\",frm.doc.custom_reason1);\n                           frm.save()\n                          \n                        }\n                    }        \n                  }); \n            }).css({ 'color': 'white', 'background-color': \"#000000\" });\n        }\n        else{\n           frm.set_value(\"custom_leave_type\",frm.doc.custom_select_leave_type); \n           frm.set_value(\"leave_type\",frm.doc.custom_select_leave_type);\n        }\n        \n    },\n    \n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.022458",
  "module": "ONEGENE",
  "name": "Purchase Order List",
  "script": "frappe.listview_settings['Purchase Order'] = {\r\n    onload: function(listview) {\r\n        if (frappe.user.has_role(\"Purchase Manager\") || frappe.user.has_role(\"System Manager\")) {\r\n            listview.page.add_inner_button(\"Import Schedule\", function() {\r\n                frappe.set_route('purchase-order-schedule-settings')\r\n            });\r\n        }\r\n        if (frappe.user.has_role(\"Supplier\")) {\r\n             if (!frappe.user.has_role(\"System Manager\")) {\r\n                listview.filter_area.add([[ \r\n                                        \"Purchase Order\", \"docstatus\", \"=\", 1\r\n                                    ]]);\r\n                frappe.after_ajax(() => {\r\n                    $('.filter-selector').hide();\r\n    \r\n                    $('.btn-filter-add').hide();\r\n                    $('.btn-remove').hide();\r\n                })\r\n             }\r\n        }\r\n        else {\r\n            if (!frappe.user.has_role(\"System Manager\")) {\r\n                frappe.after_ajax(() => {\r\n                    // Hide the filter selector\r\n                    $('.filter-selector').show();\r\n    \r\n                    // show the 'Add Filter' and 'Remove' buttons\r\n                    $('.btn-filter-add').show();\r\n                    $('.btn-remove').show();\r\n                });\r\n            }\r\n        }\r\n    },\r\n    // refresh: function(listview) {\r\n    //     $(`.list-row-col:contains(Grand Total)`).hide();\r\n    // }\r\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order Schedule",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.774881",
  "module": "ONEGENE",
  "name": "Purchase Order Schedule List",
  "script": "let core_settings = frappe.listview_settings['Purchase Order Schedule'] || {};\r\nfrappe.listview_settings['Purchase Order Schedule'] = {\r\n    ...core_settings,\r\n    onload: function(listview) {\r\n        \r\n        listview.filter_area.clear().then(r=>{\r\n            \r\n            const currentMonth = new Date().toLocaleString('default', { month: 'short' }).toUpperCase();\r\n        \r\n        \r\n        listview.filter_area.add([[\r\n            \"Purchase Order Schedule\",\"schedule_month\" ,\"=\",currentMonth ]]);\r\n            \r\n             if (frappe.user.has_role(\"Administrator\") || frappe.user.has_role(\"System Manager\")) {\r\n            listview.page.add_inner_button(\"Import Schedule\", function() {\r\n                frappe.set_route('purchase-order-schedule-settings')\r\n            });\r\n        }\r\n        \r\n        \r\n       \r\n        if (frappe.user.has_role(\"Supplier\")) {\r\n             if (!frappe.user.has_role(\"System Manager\")) {\r\n                 listview.filter_area.clear();\r\n                  listview.filter_area.add([[ \r\n                                    \"Purchase Order Schedule\", \"docstatus\", \"=\", 1\r\n                                ]]);\r\n                    \r\n                frappe.after_ajax(() => {\r\n                    \r\n                    \r\n                    \r\n                    const allowed_filters = [\"docstatus\"];  \r\n\r\n                // Remove any existing filters that are not allowed\r\n                listview.filter_area.filter_list.get_filters().forEach(f => {\r\n                    const fieldname = f[1];   \r\n                    const operator  = f[2];   \r\n                    const value     = f[3];   \r\n                \r\n                    if (!allowed_filters.includes(fieldname)) {\r\n                        listview.filter_area.remove(fieldname, operator, value);\r\n                    }\r\n                });\r\n                \r\n                \r\n                \r\n               \r\n                    \r\n                    \r\n                    \r\n                    // Hide the filter selector\r\n                    $('.filter-selector').hide();\r\n    \r\n                    // Hide the 'Add Filter' and 'Remove' buttons\r\n                    $('.btn-filter-add').hide();\r\n                    $('.btn-remove').hide();\r\n                });\r\n            }\r\n        }\r\n            \r\n            \r\n        })\r\n        \r\n        \r\n       \r\n    },\r\n    \r\n    refresh: function(listview) {\r\n        if (frappe.user.has_role(\"Supplier\")) {\r\n            if (!frappe.user.has_role(\"System Manager\")) {\r\n                //  listview.filter_area.clear();\r\n                //   listview.filter_area.add([[ \r\n                //                     \"Purchase Order Schedule\", \"docstatus\", \"=\", 1\r\n                //                 ]]);\r\n\r\n\r\n                frappe.after_ajax(() => {\r\n\r\n\r\n\r\n                    const allowed_filters = [\"name\", \"docstatus\"];\r\n\r\n                    // Remove any existing filters that are not allowed\r\n\r\n                    listview.filter_area.filter_list.get_filters().forEach(f => {\r\n                        const fieldname = f[1];\r\n                        const operator = f[2];\r\n                        const value = f[3];\r\n\r\n                        if (!allowed_filters.includes(fieldname)) {\r\n                            listview.filter_area.remove(fieldname, operator, value);\r\n                        }\r\n                    });\r\n\r\n\r\n\r\n\r\n\r\n\r\n                    // Hide the filter selector\r\n                    $('.filter-selector').hide();\r\n\r\n                    // Hide the 'Add Filter' and 'Remove' buttons\r\n                    $('.btn-filter-add').hide();\r\n                    $('.btn-remove').hide();\r\n                });\r\n            }\r\n        }\r\n        \r\n        listview.page.add_inner_button(__('Supplier Wise'), function() {\r\n            const filters = listview.filter_area.get();\r\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\r\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\r\n\r\n            const year = new Date().getFullYear().toString().slice(-2);\r\n\r\n            if (!mon) {\r\n                mon = new Date().toLocaleString('default', {\r\n                    month: 'short'\r\n                }).toUpperCase();\r\n            }\r\n\r\n            frappe.call({\r\n                method: \"onegene.onegene.custom.supplier_wise_plan_summary\",\r\n                args: {\r\n                    month: mon,\r\n                    year: year\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message) {\r\n                        tableHTML = r.message\r\n                        let dialog = new frappe.ui.Dialog({\r\n                            title: __(\"Supplier Wise Purchase Plan\"),\r\n                            size: \"extra-large\", // Correct usage\r\n                            fields: [{\r\n                                fieldtype: \"HTML\",\r\n                                fieldname: \"department_wise_table\",\r\n                                options: tableHTML\r\n                            }]\r\n                        });\r\n\r\n                        dialog.show();\r\n                    }\r\n                }\r\n            });\r\n        }, __('Summary Value'));\r\n        \r\n        listview.page.add_inner_button(__('Department Wise'), function() {\r\n            const filters = listview.filter_area.get();\r\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\r\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\r\n\r\n            const year = new Date().getFullYear().toString().slice(-2);\r\n\r\n            if (!mon) {\r\n                mon = new Date().toLocaleString('default', {\r\n                    month: 'short'\r\n                }).toUpperCase();\r\n            }\r\n\r\n            frappe.call({\r\n                method: \"onegene.onegene.custom.department_wise_plan_pos\",\r\n                args: {\r\n                    month: mon\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message) {\r\n                        const groupedData = r.message;\r\n                        const departments = Object.keys(groupedData) // sorted for clarity\r\n                        let grandTotal = 0;\r\n\r\n                        let tableHTML = `\r\n                    <style>\r\n                        table {\r\n                            width: 100%;\r\n                            border-collapse: collapse;\r\n                            font-size: 13px;\r\n                        }\r\n                        th, td {\r\n                            border: 1px solid #000;\r\n                            padding: 8px;\r\n                            text-align: left;\r\n                        }\r\n                        th {\r\n                            background-color: #ffc000;\r\n                            color: black;\r\n                            text-align: center;\r\n                        }\r\n                        .title-row td {\r\n                            font-size: 18px;\r\n                            font-weight: bold;\r\n                            text-align: center;\r\n                            border: none;\r\n                            padding: 12px 0;\r\n                        }\r\n                        .total-row {\r\n                            background-color: #ffff00;\r\n                            font-weight: bold;\r\n                        }\r\n                        .right-align {\r\n                            text-align: right;\r\n                        }\r\n                    </style>\r\n\r\n                    <table>\r\n                        \r\n                        <thead>\r\n                        <tr >\r\n                            <td colspan=\"2\" style=\"text-align:center; font-size:20px; font-weight:bold; color:black;\">Department Wise Purchase Plan - ${mon}'${year}</td>\r\n                        </tr>\r\n                            <tr>\r\n                                <th style=\"color:black;\">Department</th>\r\n                                <th style=\"color:#2206f6;\">Schedule Value</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                `;\r\n\r\n                        departments.forEach(dep => {\r\n                            let amount = groupedData[dep] || 0;\r\n                            amount = Math.round(amount);\r\n                            grandTotal += amount;\r\n\r\n                            tableHTML += `\r\n                        <tr>\r\n                            <td style=\"color:black;\">${dep}</td>\r\n                            <td class=\"right-align\" style=\"color:black;\">${amount === 0 ? \"-\" : \"₹ \" + amount.toLocaleString()}</td>\r\n                        </tr>\r\n                    `;\r\n                        });\r\n\r\n                        // Add TOTAL row\r\n                        tableHTML += `\r\n                    <tr class=\"total-row\">\r\n                        <td style=\"color:black;\">TOTAL</td>\r\n                        <td class=\"right-align;\" style=\" text-align:right; color:black;\">₹ ${grandTotal.toLocaleString()}</td>\r\n                    </tr>\r\n                `;\r\n\r\n                        tableHTML += `</tbody></table>`;\r\n\r\n                        let dialog = new frappe.ui.Dialog({\r\n                            title: __(\"Department Wise Purchase Plan\"),\r\n                            fields: [{\r\n                                fieldtype: \"HTML\",\r\n                                fieldname: \"department_wise_table\",\r\n                                options: tableHTML\r\n                            }],\r\n                            size: 'medium'\r\n                        });\r\n\r\n                        dialog.show();\r\n                    }\r\n                }\r\n            });\r\n        }, __('Summary Value'));\r\n\r\n        listview.page.add_inner_button(__('Supplier Group Wise'), function() {\r\n            const filters = listview.filter_area.get();\r\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\r\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\r\n\r\n            const year = new Date().getFullYear().toString().slice(-2);\r\n\r\n            if (!mon) {\r\n                mon = new Date().toLocaleString('default', {\r\n                    month: 'short'\r\n                }).toUpperCase();\r\n            }\r\n\r\n            frappe.call({\r\n                method: \"onegene.onegene.custom.supplier_group_wise\",\r\n                args: {\r\n                    month: mon\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message) {\r\n                        const groupedData = r.message;\r\n                        const departments = Object.keys(groupedData) // sorted for clarity\r\n                        let grandTotal = 0;\r\n\r\n                        let tableHTML = `\r\n                    <style>\r\n                        table {\r\n                            width: 100%;\r\n                            border-collapse: collapse;\r\n                            font-size: 13px;\r\n                        }\r\n                        th, td {\r\n                            border: 1px solid #000;\r\n                            padding: 8px;\r\n                            text-align: left;\r\n                        }\r\n                        th {\r\n                            background-color: #ffc000;\r\n                            color: black;\r\n                            text-align: center;\r\n                        }\r\n                        .title-row td {\r\n                            font-size: 18px;\r\n                            font-weight: bold;\r\n                            text-align: center;\r\n                            border: none;\r\n                            padding: 12px 0;\r\n                        }\r\n                        .total-row {\r\n                            background-color: #ffff00;\r\n                            font-weight: bold;\r\n                        }\r\n                        .right-align {\r\n                            text-align: right;\r\n                        }\r\n                    </style>\r\n\r\n                    <table>\r\n                        \r\n                        <thead>\r\n                        <tr >\r\n                            <td colspan=\"2\" style=\"text-align:center; font-size:20px; font-weight:bold; color:black;\">Supplier Group Wise Purchase Plan - ${mon}'${year}</td>\r\n                        </tr>\r\n                            <tr>\r\n                                <th style=\"color:black;\">Supplier Group</th>\r\n                                <th style=\"color:#2206f6;\">Schedule Value</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                `;\r\n\r\n                        departments.forEach(dep => {\r\n                            let amount = groupedData[dep] || 0;\r\n                            amount = Math.round(amount);\r\n                            grandTotal += amount;\r\n\r\n                            tableHTML += `\r\n                        <tr>\r\n                            <td style=\"color:black;\">${dep}</td>\r\n                            <td class=\"right-align\" style=\"color:black;\">${amount === 0 ? \"-\" : \"₹ \" + amount.toLocaleString()}</td>\r\n                        </tr>\r\n                    `;\r\n                        });\r\n\r\n                        // Add TOTAL row\r\n                        tableHTML += `\r\n                    <tr class=\"total-row\">\r\n                        <td style=\"color:black;\">TOTAL</td>\r\n                        <td class=\"right-align;\" style=\" text-align:right; color:black;\">₹ ${grandTotal.toLocaleString()}</td>\r\n                    </tr>\r\n                `;\r\n\r\n                        tableHTML += `</tbody></table>`;\r\n\r\n                        let dialog = new frappe.ui.Dialog({\r\n                            title: __(\"Supplier Group Wise Purchase Plan\"),\r\n                            fields: [{\r\n                                fieldtype: \"HTML\",\r\n                                fieldname: \"department_wise_table\",\r\n                                options: tableHTML\r\n                            }],\r\n                            size: 'medium'\r\n                        });\r\n\r\n                        dialog.show();\r\n                    }\r\n                }\r\n            });\r\n        }, __('Summary Value'));\r\n\r\n        \r\n\r\n\r\n\r\n\r\n\r\n\r\n    }\r\n};\r\n\r\n\r\n// function generateTableHTML(group, customers) {\r\n//     const keys = Object.keys(customers);\r\n//     let subtotal = 0;\r\n    \r\n//     keys.sort((a, b) => {\r\n//         const aIsHanon = a.trim().toLowerCase().startsWith(\"hanon\");\r\n//         const bIsHanon = b.trim().toLowerCase().startsWith(\"hanon\");\r\n\r\n//         if (aIsHanon && !bIsHanon) return -1; // a first\r\n//         if (!aIsHanon && bIsHanon) return 1;  // b first\r\n//         return 0; // otherwise keep original order\r\n//     });\r\n\r\n\r\n//     let html = `\r\n//         <table border=\"1\" style=\"border-collapse:collapse;\">\r\n//             <thead>\r\n//                 <tr>\r\n//                     <th style=\"width: 100px;border-top:hidden;\">Type</th>\r\n//                     <th style=\"border-top:hidden;\">Customer</th>\r\n//                     <th style=\"color:#2206f6;border-top:hidden;\">Schedule Value</th>\r\n//                 </tr>\r\n//             </thead>\r\n//             <tbody>\r\n//     `;\r\n\r\n//     keys.forEach((cust, index) => {\r\n//         const value = customers[cust] || 0;\r\n//         subtotal += value;\r\n\r\n//         html += `<tr>`;\r\n\r\n//         // For the \"Type\" column, show group name only once (rowspan)\r\n//         if(index === 0) {\r\n//             const borderStyle = group === \"Domestic\" ? \"border-left: hidden;\" : \"\";\r\n//             const borderStyle_EXPORT = group === \"Export\" ? \"border-bottom: hidden;\" : \"\";\r\n//             html += `<td rowspan=\"${keys.length +1}\" class=\"type-text\" style=\"vertical-align: middle; text-align: center; font-weight: bold; color: #b00d0a;${borderStyle}${borderStyle_EXPORT}\">${group ==\"Domestic\" ? \"DOMESTIC\" : \"EXPORT\"}</td>`;\r\n//         }\r\n//         const borderStyle_new = group === \"Export\" ? \"border-right: hidden;\" : \"\";\r\n//         html += `\r\n//                 <td style=\"font-weight:bold;color:black;\">${cust}</td>\r\n//                 <td style=\"text-align:right; font-weight:bold; color:black;${borderStyle_new}\">${value ? \"₹ \" + value.toLocaleString() : \"-\"}</td>\r\n//             </tr>`;\r\n//     });\r\n\r\n//     if(keys.length === 0) {\r\n        \r\n//         html += `\r\n//             <tr>\r\n//                 <td class=\"type-text\" style=\"vertical-align: middle; text-align: center; font-weight: bold; color: #b00d0a;\">${group}</td>\r\n//                 <td colspan=\"2\" style=\"text-align:center;\">No Data</td>\r\n//             </tr>`;\r\n//     }\r\n//     const borderStyle_EXPORT = group === \"Export\" ? \"border-bottom: hidden !important;\" : \"\";\r\n//     // Only subtotal row remains\r\n//     html += `\r\n//         <tr>\r\n            \r\n//             <td colspan=\"1\" style=\"background-color: #00ffff; color:black;${borderStyle_EXPORT} \">SUB TOTAL</td>\r\n//             <td style=\"text-align:right; background-color: #00ffff; color:black;${borderStyle_EXPORT} \">₹ ${subtotal.toLocaleString()}</td>\r\n//         </tr>\r\n//     </tbody></table>`;\r\n\r\n//     return { html, subtotal };\r\n// }\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Advance Shipping Note",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.667004",
  "module": "ONEGENE",
  "name": "Supplier Delivery Note List",
  "script": "frappe.listview_settings['Advance Shipping Note'] = {\r\n    onload: function(listview) {\r\n        \r\n        var currentMonth = new Date().toLocaleString('default', { month: 'short' }).toUpperCase();\r\n        var currentUrl = new URL(window.location.href);\r\n        const user = frappe.session.user;\r\n        if (frappe.user.has_role(\"Security\")) {\r\n            if (!frappe.user.has_role(\"System Manager\")) {\r\n                listview.filter_area.clear();\r\n                // listview.filter_area.add([\r\n                //     [\"Supplier Delivery Note\", \"workflow_state\", \"not in\", [\"Draft\", \"Cancelled\"]],\r\n                // ]);\r\n                var targetUrl = `https://erp.onegeneindia.in/app/advance-shipping-note?workflow_state=%5B%22not+in%22%2C%5B%22Draft%22%2C%22Cancelled%22%5D%5D&month=${currentMonth}`;\r\n                if (currentUrl.href != targetUrl) {\r\n                    window.location.href = targetUrl;\r\n                }\r\n                frappe.after_ajax(() => {\r\n                    $('.filter-selector').hide();\r\n                });\r\n            }\r\n        }\r\n        \r\n         if (frappe.user.has_role(\"SDN User\")) {\r\n             if (!frappe.user.has_role(\"System Manager\")) {\r\n                if (listview.page.fields_dict.workflow_state) {\r\n        \t\t\tlistview.page.fields_dict.workflow_state.get_query = function() {\r\n        \t\t\t\treturn {\r\n        \t\t\t\t\t\"filters\": {\r\n        \t\t\t\t\t\t\"name\": [\"in\", [\"Gate Received\", \"Material Received\"]],\r\n        \t\t\t\t\t}\r\n        \t\t\t\t};\r\n        \t\t\t};\r\n        \t\t}\r\n             }\r\n        }\r\n        if (frappe.user.has_role(\"Security\")) {\r\n             if (!frappe.user.has_role(\"System Manager\")) {\r\n                if (listview.page.fields_dict.workflow_state) {\r\n        \t\t\tlistview.page.fields_dict.workflow_state.get_query = function() {\r\n        \t\t\t\treturn {\r\n        \t\t\t\t\t\"filters\": {\r\n        \t\t\t\t\t\t\"name\": [\"in\", [\"In Transit\"]],\r\n        \t\t\t\t\t}\r\n        \t\t\t\t};\r\n        \t\t\t};\r\n        \t\t}\r\n             }\r\n        }\r\n        else {\r\n            \r\n            targetUrl = `https://erp.onegeneindia.in/app/advance-shipping-note?month=${currentMonth}`;\r\n            if (currentUrl.href != targetUrl) {\r\n                window.location.href = targetUrl;\r\n            }\r\n            if (listview.page.fields_dict.workflow_state) {\r\n    \t\t\tlistview.page.fields_dict.workflow_state.get_query = function() {\r\n    \t\t\t\treturn {\r\n    \t\t\t\t\t\"filters\": {\r\n    \t\t\t\t\t\t\"name\": [\"in\", [\"Draft\", \"In Transit\", \"Gate Received\", \"Material Received\"]],\r\n    \t\t\t\t\t}\r\n    \t\t\t\t};\r\n    \t\t\t};\r\n    \t\t}\r\n        }\r\n        \r\n    },\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Advance Shipping Note",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.030063",
  "module": "ONEGENE",
  "name": "Supplier Delivery Note",
  "script": "frappe.ui.form.on('Advance Shipping Note', {\n    // onload: function(frm) {\n    //     if (!frappe.user.has_role('Security')) {\n    //         const grid = frm.get_field('item_table').grid;\n    //         if (grid && grid.fields_map['received_qty']) {\n    //             grid.fields_map['received_qty'].df.hidden = true;\n    //             grid.refresh();\n    //         }\n    //     }\n\n    // },\n    refresh(frm) {\n        frm.fields_dict['item_table'].grid.update_docfield_property('received_qty', 'read_only', frm.doc.workflow_state === 'Received');\n        frm.refresh_fields();\n\n        if (frm.doc.workflow_state == \"In Transit\" && ((!frappe.user.has_role(\"Security\") && !frappe.user.has_role(\"SDN User\"))|| frappe.user.has_role(\"System Manager\"))) {\n            frm.add_custom_button(__(\"View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.custom.create_html_supplier_delivery\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            frm.add_custom_button(__(\"Print DN\"), function() {\n                var f_name = frm.doc.name;\n                var print_format = \"Supplier Delivery Note\";\n\n                window.open(`https://erp.onegeneindia.in/printview?doctype=Advance Shipping Note&name=${f_name}&format=Supplier%20Delivery%20Note&no_letterhead=1&letterhead=No%20Letterhead&settings=%7B%7D&_lang=en`, \"_blank\");\n            });\n        }\n        if (frm.doc.workflow_state == \"Gate Received\" && (frappe.user.has_role(\"SDN User\") || frappe.user.has_role(\"System Manager\"))) {\n    let btn = frm.add_custom_button(__('Receive Materials'), async function () {\n        if (frm.doc.purchase_receipt) {\n            frappe.set_route('Form', 'Purchase Receipt', frm.doc.purchase_receipt);\n        }\n        else {\n            let pr = frappe.model.get_new_doc('Purchase Receipt');\n            pr.supplier = frm.doc.supplier;\n            pr.posting_date = frappe.datetime.get_today();\n            pr.posting_time = frappe.datetime.now_time();\n            pr.company = frm.doc.company;\n            pr.supplier_delivery_note = frm.doc.name;\n            pr.naming_series = \"MAT-PRE-.YYYY.-\"\n    \n            for (let item of frm.doc.item_table || []) {\n                let pr_item = frappe.model.add_child(pr, 'Purchase Receipt Item', 'items');\n                pr_item.item_code = item.item_code;\n                pr_item.item_name = item.item_name;\n                pr_item.custom_dispatched_quantity = item.dis_qty;\n                pr_item.qty = 0;\n                pr_item.rejected_qty = 0;\n                pr_item.uom = item.uom;\n                pr_item.stock_uom = item.uom;\n                pr_item.rate = item.rate;\n                pr_item.received_qty = item.qty;\n            \n                // Await works now because this is inside an async function\n                // const r = await frappe.db.get_value('Item', item.item_code, 'stock_uom');\n                // if (r.message) {\n                //     pr_item.stock_uom = r.message.stock_uom;\n                // }\n            }\n            frappe.set_route('Form', 'Purchase Receipt', pr.name);\n        }\n    });\n\n    // Style the button (optional)\n    $(btn).css({\n        'color': 'white',\n        'background-color': '#e4f5e9',\n        'border-color': '#e4f5e9'\n    });\n}\n\n\n\n    },\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BOM",
  "enabled": 0,
  "modified": "2025-12-17 16:35:45.716235",
  "module": "ONEGENE",
  "name": "BOM - List",
  "script": "\nfrappe.listview_settings['BOM'] = {\n    onload: function(listview) {\n        listview.page.add_action_item(__(\"Next Action\"), () => {\n            const docnames = listview.get_checked_items(true);\n\t\t\t\t\tif (docnames.length > 0) {\n\t\t\t\t\t\tfrappe.confirm(\n\t\t\t\t\t\t\t__(\n\t\t\t\t\t\t\t\t\"Submit {0} documents?\",\n\t\t\t\t\t\t\t\t[docnames.length],\n\t\t\t\t\t\t\t\t\"Title of confirmation dialog\"\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t    frappe.call({\n                    \t\t\t\tmethod: \"onegene.onegene.custom.submit_cancel_or_update_docs\",\n                    \t\t\t\targs: {\n                    \t\t\t\t\tdoctype: 'BOM',\n                    \t\t\t\t\taction: 'submit',\n                    \t\t\t\t\tdocnames: docnames,\n                    \t\t\t\t},\n                    \t\t\t})\n                    \t\t\t.then((r) => {\n                    \t\t\t\tlet failed = r.message;\n                    \t\t\t\tif (!failed) failed = [];\n                    \n                    \t\t\t\tif (failed.length && !r._server_messages) {\n                    \t\t\t\t\tfrappe.throw(\n                    \t\t\t\t\t\t__(\"Cannot {0} {1}\", [action, failed.map((f) => f.bold()).join(\", \")])\n                    \t\t\t\t\t);\n                    \t\t\t\t}\n                    \t\t\t\tif (failed.length < docnames.length) {\n                    \t\t\t\t\tfrappe.utils.play_sound(action);\n                    \t\t\t\t\tif (done) done();\n                    \t\t\t\t}\n                    \t\t\t});\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n        })\n    }\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.326391",
  "module": "ONEGENE",
  "name": "Sales Invoice",
  "script": "frappe.ui.form.on('Sales Invoice', {\n    validate(frm) {\n        if (frm.doc.custom_tentative_production_completion_date && (frm.doc.custom_tentative_production_completion_date <= frm.doc.posting_date)) {\n            frappe.msgprint(\"Tentative Production Completion Date cannot be less than the Invoice Date\")\n            frappe.msgprint(\"Tentative Production Completion Date, Invoice Date-ஐவிட குறைவாக இருக்க முடியாது\")\n            frappe.validated = false\n        }\n        frm.trigger('calculate_total_cbm');\n        // frm.trigger('calculate_container_occupancy');\n\n    },\n    custom_transport_receipt_number(frm){\n        if(frm.doc.custom_transport_receipt_number){\n            frm.set_value(\"lr_no\",frm.doc.custom_transport_receipt_number);\n        }\n        \n    },\n    \n    customer(frm){\n        \n        if(frm.doc.currency){\n            \n            setTimeout(()=>{\n                \n                frappe.db.get_value(\"Currency Conversion\",{\"currency\":frm.doc.currency},\"exchange_rate\").then(r=>{\n                    \n                    if(r.message && r.message.exchange_rate){\n                        \n                        frm.set_value(\"conversion_rate\",r.message.exchange_rate)\n                    }\n                })\n                \n            },2000)\n        }\n        \n    },\n    \n    custom_tentative_production_completion_date(frm) {\n        if (frm.doc.custom_tentative_production_completion_date && (frm.doc.custom_tentative_production_completion_date <= frm.doc.posting_date)) {\n            frappe.msgprint(\"Tentative Production Completion Date cannot be less than the Invoice Date\")\n            frappe.msgprint(\"Tentative Production Completion Date, Invoice Date-ஐவிட குறைவாக இருக்க முடியாது\")\n\n        }\n    },\n    refresh(frm) {\n        let max_boxes_per_pallet = 0;\n        let min_boxes_per_pallet = Infinity;   \n        \n        (frm.doc.items || []).forEach(row => {\n            let pallets = row.custom_no_of_pallets || 1;\n            let boxes = row.custom_no_of_boxes || 1;\n        \n            let boxes_per_pallet = Math.ceil(boxes / pallets);\n        \n            if (boxes_per_pallet > max_boxes_per_pallet) {\n                max_boxes_per_pallet = boxes_per_pallet;\n            }\n        \n            if (boxes_per_pallet < min_boxes_per_pallet) {\n                min_boxes_per_pallet = boxes_per_pallet;\n            }\n        });\n\n\n\n\n\n        // correct condition\n        if (min_boxes_per_pallet <= 20 && max_boxes_per_pallet > 20) {\n\n            frm.add_custom_button(\"Pallet Landscape\", function () {\n\n                let url = \"/api/method/frappe.utils.print_format.download_pdf?\" +\n                    \"doctype=Sales%20Invoice\" +\n                    \"&name=\" + encodeURIComponent(frm.doc.name) +\n                    \"&trigger_print=1\" +\n                    \"&format=Pallet%20Landscape\" +\n                    \"&no_letterhead=0\";\n\n                window.open(frappe.urllib.get_full_url(url));\n            }, __(\"Print\"));\n\n        }\n        if (max_boxes_per_pallet > 20) {\n\n            frm.add_custom_button(\"Pallet Portrait\", function () {\n\n                let url = \"/api/method/frappe.utils.print_format.download_pdf?\" +\n                    \"doctype=Sales%20Invoice\" +\n                    \"&name=\" + encodeURIComponent(frm.doc.name) +\n                    \"&trigger_print=1\" +\n                    \"&format=Pallet%20Portrait\" +\n                    \"&no_letterhead=0\";\n\n                window.open(frappe.urllib.get_full_url(url));\n            }, __(\"Print\"));\n\n        }\n        let max_boxes_per_pallet_1 = 0;\n        let min_boxes_per_pallet_1 = Infinity;   \n        \n        (frm.doc.items || []).forEach(row => {\n            let pallets_1 = row.custom_no_of_pallets || 1;\n            let boxes_1 = row.custom_no_of_boxes || 1;\n        \n            let boxes_per_pallet_1 = Math.ceil(pallets_1);\n            if ((boxes_1 % pallets_1) >0 ){\n                boxes_per_pallet_1 = boxes_per_pallet_1 +1\n            }\n        \n            if (boxes_per_pallet_1 > max_boxes_per_pallet_1) {\n                max_boxes_per_pallet_1 = boxes_per_pallet_1;\n            }\n            if (boxes_per_pallet_1 < min_boxes_per_pallet_1) {\n                min_boxes_per_pallet_1 = boxes_per_pallet_1;\n            }\n        \n           \n        });\n        if (min_boxes_per_pallet_1 >= 20 && max_boxes_per_pallet_1 < 20) {\n\n            frm.add_custom_button(\"Annexure Landscape\", function () {\n\n                let url = \"/api/method/frappe.utils.print_format.download_pdf?\" +\n                    \"doctype=Sales%20Invoice\" +\n                    \"&name=\" + encodeURIComponent(frm.doc.name) +\n                    \"&trigger_print=1\" +\n                    \"&format=Annexure%20Landscape\" +\n                    \"&no_letterhead=0\";\n\n                window.open(frappe.urllib.get_full_url(url));\n            }, __(\"Print\"));\n\n        }\n        if (max_boxes_per_pallet_1 > 20 && min_boxes_per_pallet_1 >= 20) {\n\n            frm.add_custom_button(\"Annexure Portrait\", function () {\n\n                let url = \"/api/method/frappe.utils.print_format.download_pdf?\" +\n                    \"doctype=Sales%20Invoice\" +\n                    \"&name=\" + encodeURIComponent(frm.doc.name) +\n                    \"&trigger_print=1\" +\n                    \"&format=Annexure%20Portrait\" +\n                    \"&no_letterhead=0\";\n\n                window.open(frappe.urllib.get_full_url(url));\n            }, __(\"Print\"));\n\n        }\n        \n        // QID data will be loaded from the Quality Inspection which are went to Store Receipt\n        if (frm.fields_dict['custom_scan_qid']) {\n            frm.fields_dict['custom_scan_qid'].input.onfocus = function() {\n                const exclude_qids = (frm.doc.items || []).map(row => row.custom_qid).filter(Boolean);\n                // Fetch options excluding those QIDs\n                let result = exclude_qids\n                    .flatMap(item => item.split(',')); \n                frappe.call({\n                    method: \"onegene.onegene.custom.get_inspection_ids\",\n                    args: {\n                        \"exclude_qids\": result,\n                        \"customer\": frm.doc.customer,\n                    },\n                    callback: function(r) {\n                        if (r.message) {\n                            frm.fields_dict.custom_scan_qid.set_data(r.message);\n                        }\n                    }\n                });\n            }\n        }\n        set_required_fields(frm)\n        refresh_stock_pick_list(frm);\n        setTimeout(() => {\n            frm.remove_custom_button('Quality Inspection(s)', 'Create');\n        }, 50);\n\n        if (!frm.doc.__islocal && frm.doc.docstatus == 1 && frm.doc.custom_invoice_type == \"Tax Invoice\") {\n            var f_name = frm.doc.name;\n            frm.add_custom_button(__(\"Tax Invoice\"), function() {\n                var print_format = \"Tax Invoice Print format\";\n                window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                    \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                    \"&name=\" + encodeURIComponent(f_name) +\n                    \"&trigger_print=1\" +\n                    \"&format=\" + print_format +\n                    \"&no_letterhead=0\"\n                ));\n            }, __('Print'));\n        }\n        if (!frm.doc.__islocal && frm.doc.docstatus != 2 && frm.doc.custom_invoice_type == \"Tax Invoice\") {\n            frm.add_custom_button(__(\"Tax Invoice\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_view_tax\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n        }\n\n        // frm.page.clear_primary_action(); \n        frm.remove_custom_button('Fetch Timesheet');\n        if (frm.doc.workflow_state !== 'Approved' || frm.doc.workflow_state != 'Dispatched') {\n            $(\"button[data-original-title='Print']\").hide();\n\n        }\n\n\n\n        update_fields_based_on_items(frm);\n        if (frm.doc.custom_invoice_type != \"Tax Invoice\") {\n            frm.add_custom_button(__(\"Export Invoice\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_EI\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n            frm.add_custom_button(__(\"Annexure\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_annexure\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n            frm.add_custom_button(__(\"Pallet\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_pallet\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n            frm.add_custom_button(__(\"Address\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_address\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"80%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n        }\n\n        if (frm.doc.docstatus == 0 && frappe.user.has_role(\"System Manager\")) {\n            frm.set_df_property(\"set_posting_time\", \"hidden\", 0)\n        } else {\n            frm.set_df_property(\"set_posting_time\", \"hidden\", 1)\n        }\n\n        // $( \".transactions .document-link .icon-btn  \" ).hide();\n        frm.trigger('container_occupancy_html')\n        if (frm.doc.custom_scope_of_delivery) {\n            frm.set_query(\"incoterm\", function() {\n                return {\n                    filters: {\n                        \"custom_type\": frm.doc.custom_scope_of_delivery\n                    }\n                }\n            })\n        }\n        if (frm.doc.custom_total_cbm > 76.4) {\n            frm.set_df_property('seacontainertype', 'read_only', 0)\n            frm.set_df_property('custom_no_of_containers', 'hidden', 0)\n        } else {\n            frm.set_df_property('custom_no_of_containers', 'hidden', 1)\n        }\n        if (!frm.doc.__islocal && frm.doc.docstatus == 0 && frm.doc.custom_invoice_type == \"Export Invoice\" && frm.doc.workflow_state == 'Waiting for LR Request') {\n            if (frappe.user.has_role(\"Sales User\") || frappe.user.has_role(\"Sales Manager\") || frappe.user.has_role(\"Administrator\") || frappe.user.has_role(\"System manager\")) {\n\n                frm.add_custom_button(__('Logistics Request'), function() {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.logistics_request.logistics_request.get_box_summary\",\n                        args: {\n                            sales_invoice: frm.doc.name\n                        },\n                        callback: function(r) {\n                            if (r.message) {\n\n                                frappe.db.get_value(\"Logistics Request\", {\n                                    \"order_no\": frm.doc.name\n                                }, \"name\").then(i => {\n                                    if (i && i.message.name) {\n                                        frappe.msgprint(__('Logistic Request already created <b>{0}</b>', [i.message.name]));\n                                        frappe.msgprint(__('Logistic Request <b>{0}</b> ஏற்கனவே உருவாக்கப்பட்டுள்ளது', [i.message.name]));\n                                    } else {\n\n\n\n                                        const [box_data, pallet_data] = r.message;\n                                        frappe.model.with_doctype('Logistics Request', function() {\n                                            let doc = frappe.model.get_new_doc('Logistics Request');\n                                            doc.logistic_type = \"Export\";\n                                            doc.po_so = \"Sales Invoice\";\n                                            doc.cargo_type = frm.doc.custom_cargo_mode;\n                                            doc.shipping_line = frm.doc.custom_cargo_mode;\n                                            doc.order_no = frm.doc.name;\n                                            doc.customer = frm.doc.customer;\n                                            doc.tentative_production_completion = frm.doc.custom_tentative_production_completion_date;\n                                            doc.gross_wt = frm.doc.custom_total_gross_weight;\n                                            doc.net_wt = frm.doc.total_net_weight;\n                                            doc.seacontainertype = frm.doc.seacontainertype;\n                                            doc.scope_of_delivery = frm.doc.custom_scope_of_delivery;\n                                            doc.cbm = frm.doc.custom_total_cbm;\n                                            doc.inventory_destination = \"Direct to Customer\";\n                                            (frm.doc.items || []).forEach(item => {\n                                                let child = frappe.model.add_child(doc, \"product_description_so\");\n\n                                                Object.keys(item).forEach(field => {\n                                                    if (![\"doctype\", \"name\", \"parent\", \"parentfield\", \"parenttype\", \"__unsaved\", \"idx\"].includes(field)) {\n                                                        child[field] = item[field];\n                                                    }\n                                                });\n                                            });\n\n                                            (box_data || []).forEach(row => {\n                                                let child = frappe.model.add_child(doc, \"box_summary_table\");\n                                                child.box = row.box;\n                                                child.total_no_of_box = row.total_no_of_box;\n                                                child.weight_per_unit = row.weight_per_unit;\n                                                child.total_weight = row.total_weight;\n                                                child.total_length = row.total_length;\n                                                child.total_breadth = row.total_breadth;\n                                                child.total_height = row.total_height;\n                                            });\n                                            (pallet_data || []).forEach(pal => {\n                                                let child = frappe.model.add_child(doc, \"pallet_summary\");\n                                                child.pallet = pal.box;\n                                                child.total_no_of_pallet = pal.total_no_of_box;\n                                                child.weight_per_unit = pal.weight_per_unit;\n                                                child.total_weight = pal.total_weight;\n                                                child.total_length = pal.total_length;\n                                                child.total_breadth = pal.total_breadth;\n                                                child.total_height = pal.total_height;\n                                            });\n\n                                            // frappe.set_route(\"Form\", \"Logistics Request\", doc.name);\n                                            frappe.db.insert(doc).then(new_doc => {\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} is created`);\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} உருவாக்கப்பட்டுள்ளது`);\n                                                frm.reload_doc()\n                                            });\n                                        });\n\n\n\n                                    }\n                                })\n\n\n                            } else {\n\n\n\n                                frappe.db.get_value(\"Logistics Request\", {\n                                    \"order_no\": frm.doc.name\n                                }, \"name\").then(i => {\n                                    if (i && i.message.name) {\n\n\n                                        frappe.set_route(\"Form\", \"Logistics Request\", i.message.name);\n                                    } else {\n\n\n\n                                        frappe.model.with_doctype('Logistics Request', function() {\n                                            let doc = frappe.model.get_new_doc('Logistics Request');\n                                            doc.logistic_type = \"Export\";\n                                            doc.po_so = \"Sales Invoice\";\n                                            doc.cargo_type = frm.doc.custom_cargo_mode;\n                                            doc.shipping_line = frm.doc.custom_cargo_mode;\n                                            doc.order_no = frm.doc.name;\n                                            doc.gross_wt = frm.doc.custom_total_gross_weight;\n                                            doc.net_wt = frm.doc.total_net_weight;\n                                            doc.seacontainertype = frm.doc.seacontainertype;\n                                            doc.cbm = frm.doc.custom_total_cbm;\n                                            doc.tentative_production_completion = frm.doc.custom_tentative_production_completion_date;\n                                            doc.scope_of_delivery = frm.doc.custom_scope_of_delivery;\n                                            doc.inventory_destination = \"Direct to Customer\";\n\n                                            // frappe.set_route(\"Form\", \"Logistics Request\", doc.name);\n\n                                            frappe.db.insert(doc).then(new_doc => {\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} is created`);\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} உருவாக்கப்பட்டுள்ளது`);\n                                            });\n                                        });\n\n                                    }\n                                })\n                            }\n                        }\n                    });\n\n\n                }, __('Create'))\n\n            }\n        }\n\n\n\n        if (frm.doc.docstatus != 2 && frm.doc.custom_invoice_type == \"Export Invoice\") {\n            var f_name = frm.doc.name;\n            frappe.db.get_value(\"Logistics Request\", {\n                \"order_no\": frm.doc.name\n            }, \"name\").then(r => {\n                if (frm.doc.docstatus == 1) {\n                    frm.add_custom_button(__(\"Export Invoice\"), function() {\n                        var print_format = \"Export Invoice Print New\";\n                        window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                            \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                            \"&name=\" + encodeURIComponent(f_name) +\n                            \"&trigger_print=1\" +\n                            \"&format=\" + print_format +\n                            \"&no_letterhead=0\"\n                        ));\n                    }, __('Print'));\n                }\n\n                if (r.message && r.message.name) {\n                    frm.add_custom_button(__(\"Packing List\"), function() {\n                        var print_format = \"Packing List\";\n                        window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                            \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                            \"&name=\" + encodeURIComponent(f_name) +\n                            \"&trigger_print=1\" +\n                            \"&format=\" + print_format +\n                            \"&no_letterhead=0\"\n                        ));\n                    }, __('Print'));\n                    frm.add_custom_button(__(\"Packing List\"), function() {\n                        frappe.call({\n                            method: \"onegene.onegene.custom.create_html_packing\",\n                            args: {\n                                doc: frm.doc\n                            },\n                            callback: function(r) {\n                                if (r.message && r.message.html) {\n                                    let d = new frappe.ui.Dialog({\n\n                                        size: \"large\",\n                                        primary_action_label: __(\"Close\"),\n                                        primary_action: function() {\n                                            d.hide();\n                                        }\n                                    });\n                                    d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                                    d.$body.html(r.message.html);\n                                    d.show();\n                                } else {\n                                    frappe.msgprint(__(\"Unable to load preview\"));\n                                    frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                                }\n                            }\n                        });\n                    }, __(\"Report View\"));\n\n                }\n\n                frm.add_custom_button(__(\"Annexure\"), function() {\n                    var print_format = \"Annexure Print\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                }, __('Print'));\n\n                frm.add_custom_button(__(\"Pallet\"), function() {\n                    var print_format = \"Pallet\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                }, __('Print'));\n\n                frm.add_custom_button(__(\"Address\"), function() {\n                    var print_format = \"Address Print\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                }, __('Print'));\n            });\n        }\n\n\n\n\n\n\n\n\n\n        // frm.add_custom_button(__(\"Packing List\"), function() {\n        //     var f_name = frm.doc.name\n        //     var print_format = \"Packing List\";\n        //     window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n        //         \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n        //         \"&name=\" + encodeURIComponent(f_name) +\n        //         \"&trigger_print=1\" +\n        //         \"&format=\" + print_format +\n        //         \"&no_letterhead=0\"\n        //     ));\n        // });\n        frm.fields_dict.items.grid.get_field('custom_box').get_query = function(doc, cdt, cdn) {\n            let row = locals[cdt][cdn];\n            return {\n                filters: {\n                    \"name\": [\"in\", get_boxes(row.item_code)]\n                }\n            };\n        };\n        frm.fields_dict.items.grid.get_field('custom_pallet').get_query = function(doc, cdt, cdn) {\n            let row = locals[cdt][cdn];\n            return {\n                filters: {\n                    \"name\": [\"in\", get_pallets(row.item_code)]\n                }\n            };\n        };\n        // if (frm.doc.docstatus == 1 && frm.doc.custom_invoice_type == \"Export Invoice\") {\n        //     frm.add_custom_button(__('Logistics Request'), function() {\n        //         frappe.call({\n        //             method: \"onegene.onegene.doctype.logistics_request.logistics_request.get_box_summary\",\n        //             args: {\n        //                 sales_invoice: frm.doc.name\n        //             },\n        //             callback: function(r) {\n        //                 if (r.message) {\n\n\n        //                     frappe.db.get_value(\"Logistics Request\",{\"order_no\":frm.doc.name},\"name\").then(i=>{\n        //                         if (i && i.message.name) {\n\n\n        //                             frappe.set_route(\"Form\", \"Logistics Request\", i.message.name);\n        //                         }\n\n        //                         else{\n\n\n        //                     const [box_data, pallet_data] = r.message;\n        //                     frappe.model.with_doctype('Logistics Request', function() {\n        //                         let doc = frappe.model.get_new_doc('Logistics Request');\n        //                         doc.logistic_type = \"Export\";\n        //                         doc.po_so = \"Sales Invoice\";\n        //                         doc.cargo_type = frm.doc.custom_cargo_mode;\n        //                         doc.order_no = frm.doc.name;\n        //                         doc.gross_wt = frm.doc.custom_total_gross_weight;\n        //                         doc.net_wt = frm.doc.total_net_weight;\n        //                         doc.seacontainertype = frm.doc.seacontainertype;\n        //                         doc.cbm = frm.doc.custom_total_cbm;\n        //                         (box_data || []).forEach(row => {\n        //                             let child = frappe.model.add_child(doc, \"box_summary_table\");\n        //                             child.box = row.box;\n        //                             child.total_no_of_box = row.total_no_of_box;\n        //                             child.weight_per_unit = row.weight_per_unit;\n        //                             child.total_weight = row.total_weight;\n        //                             child.total_length = row.total_length;\n        //                             child.total_breadth = row.total_breadth;\n        //                             child.total_height = row.total_height;\n        //                         });\n        //                         (pallet_data || []).forEach(pal => {\n        //                             let child = frappe.model.add_child(doc, \"pallet_summary\");\n        //                             child.pallet = pal.box;\n        //                             child.total_no_of_pallet = pal.total_no_of_box;\n        //                             child.weight_per_unit = pal.weight_per_unit;\n        //                             child.total_weight = pal.total_weight;\n        //                             child.total_length = pal.total_length;\n        //                             child.total_breadth = pal.total_breadth;\n        //                             child.total_height = pal.total_height;\n        //                         });\n\n        //                         frappe.set_route(\"Form\", \"Logistics Request\", doc.name);\n        //                     });\n\n        //                         }\n        //                     })\n\n        //                 } else {\n\n\n        //                     frappe.db.get_value(\"Logistics Request\",{\"order_no\":frm.doc.name},\"name\").then(i=>{\n        //                         if (i && i.message.name) {\n\n\n        //                             frappe.set_route(\"Form\", \"Logistics Request\", i.message.name);\n        //                         }\n        //                         else{\n\n\n\n        //                     frappe.model.with_doctype('Logistics Request', function() {\n        //                         let doc = frappe.model.get_new_doc('Logistics Request');\n        //                         doc.logistic_type = \"Export\";\n        //                         doc.po_so = \"Sales Invoice\";\n        //                         doc.cargo_type = frm.doc.custom_cargo_mode;\n        //                         doc.order_no = frm.doc.name;\n        //                         doc.gross_wt = frm.doc.custom_total_gross_weight;\n        //                         doc.net_wt = frm.doc.total_net_weight;\n        //                         doc.seacontainertype = frm.doc.seacontainertype;\n        //                         doc.cbm = frm.doc.custom_total_cbm;\n        //                         frappe.set_route(\"Form\", \"Logistics Request\", doc.name);\n        //                     });\n\n        //                         }\n        //                     })\n        //                 }\n        //             }\n        //         });\n\n\n        //     }, __('Create'))\n        // }\n    },\n    custom_scan_qid(frm) {\n        let qid = frm.doc.custom_scan_qid\n        if (!qid) return;\n\n        frappe.call({\n            method: \"onegene.onegene.custom.get_quality_inspection_data_for_si\",\n            args: {\n                qid: qid,\n                customer: frm.doc.customer\n            },\n            callback: function(r) {\n                if (r.message) {\n                    if (r.message == \"not found\") {\n                        frappe.msgprint({\n                            message: \"The QID you entered is not valid.\",\n                            title: \"Invalid QID\",\n                            indicator: \"red\"\n                        });\n                        frappe.msgprint({\n                            message: \"நீங்கள் உள்ளிட்ட QID சரியில்லை.\",\n                            title: \"Invalid QID\",\n                            indicator: \"red\"\n                        });\n                        frm.set_value(\"custom_scan_qid\", \"\");\n                    } else {\n\n                        let {\n                            0: item_code = \"\",\n                            1: accepted_qty = 0,\n                            2: rack = \"\",\n                            3: location = \"\",\n                            4: uom = \"\",\n                            5: item_name = \"\",\n                            6: quality_inspection = \"\"\n                        } = r.message;\n\n                        // Check duplicate QID child table\n                        let exists = frm.doc.items?.some(row =>\n                            (row.custom_qid || \"\")\n                                .split(\",\")\n                                .map(q => q.trim())\n                                .includes(qid)\n                        );\n\n                        if (exists) {\n                            frappe.msgprint(\"QID \" + qid + \" already added in the list.\");\n                            frappe.msgprint(\"QID \" + qid + \" ஏற்கனவே list-ல் சேர்க்கப்பட்டுள்ளது.\");\n                            frm.set_value(\"custom_scan_qid\", \"\");\n                            return;\n                        }\n\n                        let existing_row = frm.doc.items?.find(row => row.item_code === item_code);\n                        if (existing_row) {\n\n                            existing_row.qty = flt(existing_row.qty) + flt(accepted_qty);\n                            existing_row.quality_inspection = quality_inspection;\n\n                            // append comma-separated qid\n                            if (existing_row.custom_qid) {\n                                let qids = existing_row.custom_qid.split(',');\n                                if (!qids.includes(qid)) {\n                                    existing_row.custom_qid = existing_row.custom_qid + ',' + qid;\n                                }\n                            } else {\n                                existing_row.custom_qid = qid;\n                            }\n\n                            frm.refresh_field(\"items\");\n                            frm.set_value(\"custom_scan_qid\", \"\");\n                            return;\n                        }\n\n                        // Add NEW row\n                        let child = frm.add_child(\"items\");\n                        frappe.model.set_value(child.doctype, child.name, \"item_code\", item_code);\n\n                        setTimeout(() => {\n                            child.qty = accepted_qty;\n                            child.quality_inspection = quality_inspection;\n                            child.custom_qid = qid; // <----- FIXED HERE\n                            \n                            frm.refresh_field(\"items\");\n                        }, 900);\n\n                        frm.refresh_field(\"items\");\n                        frm.set_value(\"custom_scan_qid\", \"\");\n                        frm.refresh_field(\"custom_scan_qid\");\n                    }\n                }\n            },\n            error: function(r) {\n                frm.set_value(\"custom_scan_qid\", \"\");\n                frappe.show_alert({\n                    message: __(\"Invalid QR scanned\"),\n                    indicator: \"red\"\n                });\n            }\n        });\n\n    },\n    container_occupancy_html(frm) {\n        if (!frm.doc.__islocal) {\n            let occupancy = Math.round((frm.doc.custom_container_occupancy || 0) * 100) / 100;\n            if (occupancy >= 60) {\n                frm.fields_dict.custom_container_occupancy_html.$wrapper.html(`\n    \t            <p>Container Occupancy</p>\n                    <div style=\"width: 100%; background-color: #f3f3f3; border-radius: 10px; margin-bottom: 10px;\">\n                    <p style=\"color: white;text-align: center; position: absolute; left: 45%;\">${occupancy} %</p>\n                        <div style=\"width: ${occupancy}%; max-width: 100%; background-color: #59ba8b; border-radius: 10px; text-align: center; color: white\">\n                            <p>&nbsp;</p>\n                        </div>\n                    </div>\n                `);\n            } else {\n                frm.fields_dict.custom_container_occupancy_html.$wrapper.html(`\n    \t            <p>Container Occupancy</p>\n                    <div style=\"width: 100%; background-color: #f3f3f3; border-radius: 10px; margin-bottom: 10px;\">\n                    <p style=\"color: black;text-align: center; position: absolute; left: 45%;\">${occupancy} %</p>\n                        <div style=\"width: ${occupancy}%; max-width: 100%; background-color: #59ba8b; border-radius: 10px; text-align: center; color: white\">\n                            <p>&nbsp;</p>\n                        </div>\n                    </div>\n                `);\n            }\n        }\n    },\n    customer_set_query(frm) {\n        if (frm.doc.custom_invoice_type == \"Export Invoice\") {\n            frm.set_query(\"customer\", function() {\n                return {\n                    filters: {\n                        \"customer_group\": \"Export\"\n                    }\n                }\n            })\n        } else if (frm.doc.custom_invoice_type == \"Tax Invoice\") {\n            frm.set_query(\"customer\", function() {\n                return {\n                    filters: {\n                        \"customer_group\": \"Domestic\"\n                    }\n                }\n            })\n        } else {\n            frm.set_query(\"customer\", function() {\n                return {}\n            })\n        }\n    },\n    custom_scope_of_delivery(frm) {\n        if (frm.doc.custom_scope_of_delivery) {\n            frm.set_query(\"incoterm\", function() {\n                return {\n                    filters: {\n                        \"custom_type\": frm.doc.custom_scope_of_delivery\n                    }\n                }\n            })\n        }\n    },\n    custom_invoice_type(frm) {\n        frm.set_value('customer', '');\n\n        frm.clear_table('items');\n\n        frm.refresh_field('customer');\n        frm.refresh_field('items');\n        set_required_fields(frm);\n        if (frm.doc.custom_invoice_type == \"Credit Note\") {\n            frm.set_value(\"is_return\", 1);\n        } else {\n            frm.set_value(\"is_return\", 0);\n        }\n        if (frm.doc.__islocal) {\n\n            const today = new Date();\n            let currentYear = today.getFullYear() % 100;\n            let nextYear = (currentYear + 1) % 100;\n            let year_format = `${currentYear}${nextYear}`;\n            frm.set_value('custom_fiscal_year', year_format);\n\n\n            let prefix = \"\";\n            switch (frm.doc.custom_invoice_type) {\n                case \"Tax Invoice\":\n                    prefix = \"D\";\n                    break;\n                case \"Export Invoice\":\n                    prefix = \"E\";\n                    break;\n                case \"Supplementary Invoice\":\n                    prefix = \"SI\";\n                    break;\n                case \"Non Commercial Invoice\":\n                    prefix = \"NCI\";\n                    break;\n                case \"Tooling Invoice\":\n                    prefix = \"TI\";\n                    break;\n                case \"Scrap Invoice\":\n                    prefix = \"SCR\";\n                    break;\n                case \"Tooling Invoice - Exp\":\n                    prefix = \"TI\";\n                    break;\n            }\n\n            if (prefix) {\n                frm.set_value(\"naming_series\", `.${prefix}..${year_format}..#####.`);\n            }\n        }\n\n\n\n\n        frm.trigger('customer_set_query')\n        if (frm.doc.custom_invoice_type == \"Export Invoice\") {\n            frm.set_value(\"is_export_with_gst\", 1)\n            frm.refresh_field('is_export_with_gst');\n            frm.reload_doc()\n\n        }\n        if (frm.doc.custom_invoice_type != \"Export Invoice\") {\n            frm.set_value(\"is_export_with_gst\", 0)\n            frm.refresh_field('is_export_with_gst');\n            frm.reload_doc()\n        }\n\n\n    },\n    // \tcustom_invoice_type(frm){\n    // \t    if(frm.doc.custom_invoice_type == \"Export Invoice\"){\n    // \t        frm.set_value(\"is_export_with_gst\",1)\n    // \t        frm.refresh_field('is_export_with_gst');\n    // \t        frm.reload_doc()\n\n    // \t    }\n    // \t    if(frm.doc.custom_invoice_type != \"Export Invoice\"){\n    // \t        frm.set_value(\"is_export_with_gst\",0)\n    // \t        frm.refresh_field('is_export_with_gst');\n    // \t        frm.reload_doc()\n    // \t    }\n\n\n    // \t},\n\n    custom_total_cbm(frm) {\n        frm.trigger('calculate_container_occupancy');\n    },\n    seacontainertype(frm) {\n        // frm.trigger('calculate_container_occupancy');\n        let cbm_value;\n        switch (frm.doc.seacontainertype) {\n            case 'LCL':\n                cbm_value = 15;\n                break;\n            case '20Ft.Container':\n                cbm_value = 33.2;\n                break;\n            case '40Ft.Container':\n                cbm_value = 67.7;\n                break;\n            default:\n                cbm_value = 76.4;\n        }\n        let occupancy = (frm.doc.custom_total_cbm / cbm_value) * 100;\n        if (frm.doc.custom_total_cbm > cbm_value) {\n            let no_of_containers = Math.ceil(frm.doc.custom_total_cbm / cbm_value);\n            frm.set_value(\"custom_no_of_containers\", no_of_containers);\n            frm.set_df_property('seacontainertype', 'read_only', 0)\n        }\n    },\n    calculate_container_occupancy(frm) {\n        if (frm.doc.custom_total_cbm && frm.doc.seacontainertype) {\n            let cbm_value;\n            switch (frm.doc.seacontainertype) {\n                case 'LCL':\n                    cbm_value = 15;\n                    break;\n                case '20Ft.Container':\n                    cbm_value = 33.2;\n                    break;\n                case '40Ft.Container':\n                    cbm_value = 67.7;\n                    break;\n                default:\n                    cbm_value = 76.4;\n            }\n            let occupancy = (frm.doc.custom_total_cbm / cbm_value) * 100;\n            if (frm.doc.custom_total_cbm > 76.4) {\n                let no_of_containers = Math.ceil(frm.doc.custom_total_cbm / cbm_value);\n                occupancy = (frm.doc.custom_total_cbm / (cbm_value * no_of_containers)) * 100\n                frm.set_value(\"custom_no_of_containers\", no_of_containers);\n                frm.set_df_property('seacontainertype', 'read_only', 0)\n            }\n            frm.set_value('custom_container_occupancy', occupancy);\n        }\n    },\n\n    calculate_total_cbm(frm) {\n        if (frm.doc.custom_invoice_type == \"Export Invoice\") {\n            let total_cbm = 0;\n            let total_gross_weight = 0;\n            let total_packing_weight = 0;\n            let custom_total_no_of_boxes = 0;\n            let custom_total_no_of_pallets = 0;\n\n            for (let i = 0; i < frm.doc.items.length; i++) {\n                total_cbm += frm.doc.items[i].custom_cbm || 0;\n                total_packing_weight += frm.doc.items[i].custom_packing_weight || 0;\n                total_gross_weight += frm.doc.items[i].custom_gross_weight || 0;\n                custom_total_no_of_boxes += frm.doc.items[i].custom_no_of_boxes || 0;\n                custom_total_no_of_pallets += frm.doc.items[i].custom_no_of_pallets || 0;\n            }\n\n            frm.set_value(\"custom_total_cbm\", total_cbm);\n            frm.set_value(\"custom_total_packing_weight\", total_packing_weight);\n            frm.set_value(\"custom_total_gross_weight\", total_gross_weight);\n            frm.set_value(\"custom_total_no_of_boxes\", custom_total_no_of_boxes);\n            frm.set_value(\"custom_total_no_of_pallets\", custom_total_no_of_pallets);\n\n            if (frm.doc.custom_cargo_mode === \"Sea\") {\n                if (total_cbm > 0 && total_cbm <= 15) {\n                    frm.set_value(\"seacontainertype\", \"LCL\");\n                } else if (total_cbm > 15 && total_cbm <= 33.2) {\n                    frm.set_value(\"seacontainertype\", \"20Ft.Container\");\n                } else if (total_cbm > 33.2 && total_cbm <= 67.7) {\n                    frm.set_value(\"seacontainertype\", \"40Ft.Container\");\n                } else if (total_cbm > 67.7) {\n                    frm.set_value(\"seacontainertype\", \"40(HC)\");\n                } else {\n                    frm.set_value(\"seacontainertype\", \"\");\n                }\n            }\n        }\n\n    },\n\n    onload(frm) {\n        \n        setTimeout(() => {\n            frm.remove_custom_button('Quality Inspection(s)', 'Create');\n        }, 50);\n\n        if (!frm.doc.__islocal && frm.doc.docstatus == 1 && frm.doc.custom_invoice_type == \"Tax Invoice\") {\n            var f_name = frm.doc.name;\n            frm.add_custom_button(__(\"Tax Invoice\"), function() {\n                var print_format = \"Tax Invoice Print format\";\n                window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                    \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                    \"&name=\" + encodeURIComponent(f_name) +\n                    \"&trigger_print=1\" +\n                    \"&format=\" + print_format +\n                    \"&no_letterhead=0\"\n                ));\n            }, __('Print'));\n        }\n        if (!frm.doc.__islocal && frm.doc.docstatus != 2 && frm.doc.custom_invoice_type == \"Tax Invoice\") {\n            frm.add_custom_button(__(\"Tax Invoice\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_view_tax\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n        }\n\n        // frm.page.clear_primary_action(); \n        frm.remove_custom_button('Fetch Timesheet');\n        if (frm.doc.workflow_state !== 'Approved' || frm.doc.workflow_state != 'Dispatched') {\n            $(\"button[data-original-title='Print']\").hide();\n\n        }\n\n\n\n        update_fields_based_on_items(frm);\n        if (frm.doc.custom_invoice_type != \"Tax Invoice\") {\n            frm.add_custom_button(__(\"Export Invoice\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_EI\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n            frm.add_custom_button(__(\"Annexure\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_annexure\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n            frm.add_custom_button(__(\"Pallet\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_pallet\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n            frm.add_custom_button(__(\"Address\"), function() {\n                frappe.call({\n                    method: \"onegene.onegene.custom.create_html_address\",\n                    args: {\n                        doc: frm.doc\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.html) {\n                            let d = new frappe.ui.Dialog({\n\n                                size: \"large\",\n                                primary_action_label: __(\"Close\"),\n                                primary_action: function() {\n                                    d.hide();\n                                }\n                            });\n                            d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"80%\")\n                            d.$body.html(r.message.html);\n                            d.show();\n                        } else {\n                            frappe.msgprint(__(\"Unable to load preview\"));\n                            frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                        }\n                    }\n                });\n            }, __(\"Report View\"));\n        }\n         if (!frm.doc.__islocal && frm.doc.docstatus == 0 && frm.doc.custom_invoice_type == \"Export Invoice\" && ['Waiting for LR Request'].includes(frm.doc.workflow_state)) {\n            if (frappe.user.has_role(\"Sales User\") || frappe.user.has_role(\"Sales Manager\") || frappe.user.has_role(\"Administrator\") || frappe.user.has_role(\"System manager\")) {\n\n                frm.add_custom_button(__('Logistics Request'), function() {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.logistics_request.logistics_request.get_box_summary\",\n                        args: {\n                            sales_invoice: frm.doc.name\n                        },\n                        callback: function(r) {\n                            if (r.message) {\n\n                                frappe.db.get_value(\"Logistics Request\", {\n                                    \"order_no\": frm.doc.name\n                                }, \"name\").then(i => {\n                                    if (i && i.message.name) {\n                                        frappe.msgprint(__('Logistic Request already created <b>{0}</b>', [i.message.name]));\n                                        frappe.msgprint(__('Logistic Request <b>{0}</b> ஏற்கனவே உருவாக்கப்பட்டுள்ளது', [i.message.name]));\n                                    } else {\n\n\n\n                                        const [box_data, pallet_data] = r.message;\n                                        frappe.model.with_doctype('Logistics Request', function() {\n                                            let doc = frappe.model.get_new_doc('Logistics Request');\n                                            doc.logistic_type = \"Export\";\n                                            doc.po_so = \"Sales Invoice\";\n                                            doc.cargo_type = frm.doc.custom_cargo_mode;\n                                            doc.shipping_line = frm.doc.custom_cargo_mode;\n                                            doc.order_no = frm.doc.name;\n                                            doc.customer = frm.doc.customer;\n                                            doc.tentative_production_completion = frm.doc.custom_tentative_production_completion_date;\n                                            doc.gross_wt = frm.doc.custom_total_gross_weight;\n                                            doc.net_wt = frm.doc.total_net_weight;\n                                            doc.seacontainertype = frm.doc.seacontainertype;\n                                            doc.scope_of_delivery = frm.doc.custom_scope_of_delivery;\n                                            doc.cbm = frm.doc.custom_total_cbm;\n                                            doc.inventory_destination = \"Direct to Customer\";\n                                            (frm.doc.items || []).forEach(item => {\n                                                let child = frappe.model.add_child(doc, \"product_description_so\");\n\n                                                Object.keys(item).forEach(field => {\n                                                    if (![\"doctype\", \"name\", \"parent\", \"parentfield\", \"parenttype\", \"__unsaved\", \"idx\"].includes(field)) {\n                                                        child[field] = item[field];\n                                                    }\n                                                });\n                                            });\n\n                                            (box_data || []).forEach(row => {\n                                                let child = frappe.model.add_child(doc, \"box_summary_table\");\n                                                child.box = row.box;\n                                                child.total_no_of_box = row.total_no_of_box;\n                                                child.weight_per_unit = row.weight_per_unit;\n                                                child.total_weight = row.total_weight;\n                                                child.total_length = row.total_length;\n                                                child.total_breadth = row.total_breadth;\n                                                child.total_height = row.total_height;\n                                            });\n                                            (pallet_data || []).forEach(pal => {\n                                                let child = frappe.model.add_child(doc, \"pallet_summary\");\n                                                child.pallet = pal.box;\n                                                child.total_no_of_pallet = pal.total_no_of_box;\n                                                child.weight_per_unit = pal.weight_per_unit;\n                                                child.total_weight = pal.total_weight;\n                                                child.total_length = pal.total_length;\n                                                child.total_breadth = pal.total_breadth;\n                                                child.total_height = pal.total_height;\n                                            });\n\n                                            // frappe.set_route(\"Form\", \"Logistics Request\", doc.name);\n                                            frappe.db.insert(doc).then(new_doc => {\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} is created`);\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} உருவாக்கப்பட்டுள்ளது`);\n                                                frm.reload_doc()\n                                            });\n                                        });\n\n\n\n                                    }\n                                })\n\n\n                            } else {\n\n\n\n                                frappe.db.get_value(\"Logistics Request\", {\n                                    \"order_no\": frm.doc.name\n                                }, \"name\").then(i => {\n                                    if (i && i.message.name) {\n\n\n                                        frappe.set_route(\"Form\", \"Logistics Request\", i.message.name);\n                                    } else {\n\n\n\n                                        frappe.model.with_doctype('Logistics Request', function() {\n                                            let doc = frappe.model.get_new_doc('Logistics Request');\n                                            doc.logistic_type = \"Export\";\n                                            doc.po_so = \"Sales Invoice\";\n                                            doc.cargo_type = frm.doc.custom_cargo_mode;\n                                            doc.shipping_line = frm.doc.custom_cargo_mode;\n                                            doc.order_no = frm.doc.name;\n                                            doc.gross_wt = frm.doc.custom_total_gross_weight;\n                                            doc.net_wt = frm.doc.total_net_weight;\n                                            doc.seacontainertype = frm.doc.seacontainertype;\n                                            doc.cbm = frm.doc.custom_total_cbm;\n                                            doc.tentative_production_completion = frm.doc.custom_tentative_production_completion_date;\n                                            doc.scope_of_delivery = frm.doc.custom_scope_of_delivery;\n                                            doc.inventory_destination = \"Direct to Customer\";\n\n                                            // frappe.set_route(\"Form\", \"Logistics Request\", doc.name);\n\n                                            frappe.db.insert(doc).then(new_doc => {\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} is created`);\n                                                frappe.msgprint(`Logistics Request ${new_doc.name} உருவாக்கப்பட்டுள்ளது`);\n                                            });\n                                        });\n\n                                    }\n                                })\n                            }\n                        }\n                    });\n\n\n                }, __('Create'))\n\n            }\n        }\n\n\n\n        if (frm.doc.docstatus != 2 && frm.doc.custom_invoice_type == \"Export Invoice\") {\n            var f_name = frm.doc.name;\n            frappe.db.get_value(\"Logistics Request\", {\n                \"order_no\": frm.doc.name\n            }, \"name\").then(r => {\n                if (frm.doc.docstatus == 1) {\n                    frm.add_custom_button(__(\"Export Invoice\"), function() {\n                        var print_format = \"Export Invoice Print New\";\n                        window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                            \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                            \"&name=\" + encodeURIComponent(f_name) +\n                            \"&trigger_print=1\" +\n                            \"&format=\" + print_format +\n                            \"&no_letterhead=0\"\n                        ));\n                    }, __('Print'));\n                }\n\n                if (r.message && r.message.name) {\n                    frm.add_custom_button(__(\"Packing List\"), function() {\n                        var print_format = \"Packing List\";\n                        window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                            \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                            \"&name=\" + encodeURIComponent(f_name) +\n                            \"&trigger_print=1\" +\n                            \"&format=\" + print_format +\n                            \"&no_letterhead=0\"\n                        ));\n                    }, __('Print'));\n                    frm.add_custom_button(__(\"Packing List\"), function() {\n                        frappe.call({\n                            method: \"onegene.onegene.custom.create_html_packing\",\n                            args: {\n                                doc: frm.doc\n                            },\n                            callback: function(r) {\n                                if (r.message && r.message.html) {\n                                    let d = new frappe.ui.Dialog({\n\n                                        size: \"large\",\n                                        primary_action_label: __(\"Close\"),\n                                        primary_action: function() {\n                                            d.hide();\n                                        }\n                                    });\n                                    d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n                                    d.$body.html(r.message.html);\n                                    d.show();\n                                } else {\n                                    frappe.msgprint(__(\"Unable to load preview\"));\n                                    frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n                                }\n                            }\n                        });\n                    }, __(\"Report View\"));\n\n                }\n\n                frm.add_custom_button(__(\"Annexure\"), function() {\n                    var print_format = \"Annexure Print\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                }, __('Print'));\n\n                frm.add_custom_button(__(\"Pallet\"), function() {\n                    var print_format = \"Pallet\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                }, __('Print'));\n\n                frm.add_custom_button(__(\"Address\"), function() {\n                    var print_format = \"Address Print\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Sales Invoice\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                }, __('Print'));\n            });\n        }\n\n\n\n        frm.fields_dict.custom_pick_list.$wrapper.empty();\n        update_fields_based_on_items(frm);\n\n        if (frm.doc.docstatus == 0 && frappe.user.has_role(\"System Manager\")) {\n            frm.set_df_property(\"set_posting_time\", \"hidden\", 0)\n        } else {\n            frm.set_df_property(\"set_posting_time\", \"hidden\", 1)\n        }\n\n        frm.fields_dict.custom_pick_list.$wrapper.empty();\n        update_fields_based_on_items(frm);\n\n        if (frm.doc.docstatus == 0 && frappe.user.has_role(\"System Manager\")) {\n            frm.set_df_property(\"set_posting_time\", \"hidden\", 0)\n        } else {\n            frm.set_df_property(\"set_posting_time\", \"hidden\", 1)\n        }\n\n\n\n        if (frm.doc.__islocal) {\n\n            const today = new Date();\n            let currentYear = today.getFullYear() % 100;\n            let nextYear = (currentYear + 1) % 100;\n            let year_format = `${currentYear}${nextYear}`;\n            frm.set_value('custom_fiscal_year', year_format);\n\n            let prefix = \"\";\n            switch (frm.doc.custom_invoice_type) {\n                case \"Tax Invoice\":\n                    prefix = \"D\";\n                    break;\n                case \"Export Invoice\":\n                    prefix = \"E\";\n                    break;\n                case \"Supplementary Invoice\":\n                    prefix = \"SI\";\n                    break;\n                case \"Non Commercial Invoice\":\n                    prefix = \"NCI\";\n                    break;\n                case \"Tooling Invoice\":\n                    prefix = \"TI\";\n                    break;\n                case \"Scrap Invoice\":\n                    prefix = \"SCR\";\n                    break;\n                case \"Tooling Invoice - Exp\":\n                    prefix = \"TI\";\n                    break;\n            }\n\n            if (prefix) {\n                frm.set_value(\"naming_series\", `.${prefix}..${year_format}..#####.`);\n            }\n\n            // Credit Note Invoice\n            if (frm.doc.is_return == 1) {\n                frm.set_value(\"custom_invoice_type\", \"Credit Note\")\n            }\n        }\n\n\n        frm.fields_dict.items.grid.get_field('custom_box').get_query = function(doc, cdt, cdn) {\n            let row = locals[cdt][cdn];\n            return {\n                filters: {\n                    \"name\": [\"in\", get_boxes(row.item_code)]\n                }\n            };\n        };\n        frm.fields_dict.items.grid.get_field('custom_pallet').get_query = function(doc, cdt, cdn) {\n            let row = locals[cdt][cdn];\n            return {\n                filters: {\n                    \"name\": [\"in\", get_pallets(row.item_code)]\n                }\n            };\n        };\n        frm.fields_dict.items.grid.get_field('sales_order').get_query = function(doc, cdt, cdn) {\n            const row = locals[cdt][cdn];\n\n            if (!row.item_code || !doc.customer) {\n                return {\n                    filters: {\n                        name: \"\"\n                    }\n                };\n            }\n\n            return {\n                query: \"onegene.onegene.custom.get_so_for_sii\",\n                filters: {\n                    item_code: row.item_code,\n                    customer: doc.customer\n                }\n            };\n        };\n        frm.fields_dict.items.grid.get_field('custom_customers_po_number').get_query = function(doc, cdt, cdn) {\n            const row = locals[cdt][cdn];\n\n            if (!row.item_code || !doc.customer) {\n                return {\n                    filters: {\n                        name: \"\"\n                    }\n                };\n            }\n\n            return {\n                query: \"onegene.onegene.custom.get_customer_po_query\",\n                filters: {\n                    item_code: row.item_code,\n                    customer: doc.customer\n                }\n            };\n        };\n        setTimeout(() => {\n            frm.fields_dict.items.grid.get_field('item_code').get_query = function(doc, cdt, cdn) {\n                const row = locals[cdt][cdn];\n\n                if (!doc.customer) {\n                    frappe.msgprint(\"Please select a Customer first.\");\n                    frappe.msgprint(\"முதலில் ஒரு Customer-ஐ தேர்ந்தெடுக்கவும்.\")\n                    return;\n                }\n\n                return {\n                    query: \"onegene.onegene.custom.get_items_for_sii\",\n                    filters: {\n                        customer: doc.customer,\n                        invoice_type: doc.custom_invoice_type\n                    }\n                };\n            };\n        }, 100); // Delay in milliseconds (100 ms = 0.1 second)\n\n\n    }\n})\n\nfunction update_fields_based_on_items(frm) {\n    let has_item_code = false;\n\n    if (frm.doc.items && frm.doc.items.length > 0) {\n        for (let row of frm.doc.items) {\n            if (row.item_code) {\n                has_item_code = true;\n                break;\n            }\n        }\n    }\n\n    frm.set_df_property('customer', 'read_only', has_item_code ? 1 : 0);\n\n\n}\n\nfunction get_boxes(item_code) {\n    let boxes = [];\n\n    // Fetch the item document to get the list of supplier names from Supplier Item child table\n    frappe.call({\n        method: \"frappe.client.get\",\n        args: {\n            doctype: \"Item\",\n            name: item_code\n        },\n        async: false, // Ensure the call completes before proceeding\n        callback: function(response) {\n            let item_doc = response.message;\n            if (item_doc && item_doc.custom_box) {\n                boxes = item_doc.custom_box.map(box => box.box);\n            }\n        }\n    });\n\n    return boxes;\n}\n\nfunction get_pallets(item_code) {\n    let pallets = [];\n\n    // Fetch the item document to get the list of supplier names from Supplier Item child table\n    frappe.call({\n        method: \"frappe.client.get\",\n        args: {\n            doctype: \"Item\",\n            name: item_code\n        },\n        async: false, // Ensure the call completes before proceeding\n        callback: function(response) {\n            let item_doc = response.message;\n            if (item_doc && item_doc.custom_pallet) {\n                pallets = item_doc.custom_pallet.map(pallet => pallet.pallet);\n            }\n        }\n    });\n\n    return pallets;\n}\n\n\n\n\nfrappe.ui.form.on('Sales Invoice Item', {\n\n    item_code: function(frm, cdt, cdn) {\n        row = locals[cdt][cdn];\n        refresh_stock_pick_list(frm);\n        if (!row.item_code) {\n            row.rate = 0;\n            row.custom_customers_po_number = '';\n            row.sales_order = '';\n            row.description = '';\n            row.warehouse = '';\n\n            frm.fields_dict['items'].grid.refresh_row(row);\n        }\n        validate_and_set_customers_po(frm, cdt, cdn);\n        // validate_and_set_sales_order(frm, cdt, cdn);\n        update_fields_based_on_items(frm);\n        handlePalletBoxData(frm, cdt, cdn);\n        frappe.model.set_value(cdt, cdn, 'warehouse', \"Finished Goods - WAIP\");\n        frappe.model.set_value(cdt, cdn, 'qty', '');\n        frappe.call({\n            method: \"onegene.onegene.custom.si_qty_warehouse_qty_validation\",\n            args: {\n                \"item_code\": row.item_code,\n                \"name\": frm.doc.name,\n            },\n            callback: function(r) {\n                if (r.message) {\n                    frappe.model.set_value(cdt, cdn, 'custom_available_qty_at_warehouse', r.message);\n                }\n            }\n        })\n        // setTimeout(() => {\n        //     row = locals[cdt][cdn]\n        //     frappe.model.set_value(row.doctype, row.name, \"qty\", '');\n        // }, 1000);\n\n        let current_row = locals[cdt][cdn];\n        if (frm.doc.custom_invoice_type!=\"Export Invoice\"){\n            if (current_row.item_code) {\n            frappe.db.get_value('Item', current_row.item_code, 'gst_hsn_code')\n                .then(r => {\n                    const hsn_code = r.message.gst_hsn_code;\n                    current_row.gst_hsn_code = hsn_code;\n                    frm.refresh_field('items');\n\n                    // Find index of current row\n                    let current_index = frm.doc.items.findIndex(row => row.name === current_row.name);\n                    // selecting gst and adding tax template\n                    if (current_index == 0) {\n                        if (current_row.gst_hsn_code && frm.doc.customer && frm.doc.company) {\n                            frappe.call({\n                                method: \"onegene.utils.get_item_tax_and_sales_template\",\n                                args: {\n                                    hsn_code: current_row.gst_hsn_code,\n                                    customer: frm.doc.customer,\n                                    company: frm.doc.company\n                                },\n                                freeze: true,\n                                freeze_message: __(\"Fetching Tax...\"),\n                                callback: function(r) {\n                                    if (r.message) {\n                                        frappe.model.set_value(cdt, cdn, \"item_tax_template\", r.message.item_tax_template);\n                                        frm.set_value(\"taxes_and_charges\", r.message.sales_taxes_and_charges_template);\n                                    }\n                                    // frappe.model.set_value(cdt, cdn, 'qty', '');\n                                }\n                            });\n                        }\n\n                    }\n                    if (current_index > 0) {\n                        let previous_row = frm.doc.items[current_index - 1];\n\n                        if (previous_row.gst_hsn_code && previous_row.gst_hsn_code !== hsn_code) {\n                            let msg = frappe.msgprint({\n                                title: __(\"Removing Current Row\"),\n                                message: __(\"HSN Code mismatch: <b>{0}</b> (Previous) vs <b>{1}</b> (Current)\",\n                                    [previous_row.gst_hsn_code, hsn_code]),\n                                indicator: 'orange'\n                            });\n\n                            frm.get_field('items').grid.grid_rows_by_docname[cdn].remove();\n                            frm.refresh_field('items');\n                            setTimeout(() => {\n                                if (msg && msg.hide) msg.hide();\n                            }, 1000);\n                        }\n                    }\n                });\n        }\n        }\n        \n\n        frm.refresh_field('item');\n        setTimeout(() => {\n            if (row.item_code && row.custom_customers_po_number) {\n                frappe.call({\n                    method: \"onegene.onegene.custom.get_rate_from_sales_order\",\n                    args: {\n                        item_code: row.item_code,\n                        customer_po: row.custom_customers_po_number\n                    },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.model.set_value(cdt, cdn, \"rate\", r.message);\n                        }\n                    }\n                });\n            }\n        }, 500);\n\n\n    },\n    items_remove: function(frm, cdt, cdn) {\n        // update_pick_list(frm);\n        refresh_stock_pick_list(frm);\n    },\n    items_add: function(frm) {\n        refresh_stock_pick_list(frm);\n    },\n    custom_customers_po_number: function(frm, cdt, cdn) {\n        const row = locals[cdt][cdn];\n\n        if (frm.doc.customer && row.item_code) {\n            frappe.call({\n                method: \"onegene.onegene.custom.get_customer_po_number\",\n                args: {\n                    customer: frm.doc.customer,\n                    item_code: row.item_code\n                },\n                callback: function(r) {\n                    if (r.message && Array.isArray(r.message)) {\n                        const valid_po_nos = r.message;\n                        row._valid_po_nos = valid_po_nos;\n\n                        if (valid_po_nos.length === 1) {\n                            frappe.model.set_value(cdt, cdn, \"custom_customers_po_number\", valid_po_nos[0]);\n                        }\n\n                        if (\n                            row.custom_customers_po_number &&\n                            !valid_po_nos.includes(row.custom_customers_po_number)\n                        ) {\n                            frappe.model.set_value(cdt, cdn, \"custom_customers_po_number\", \"\");\n                            frappe.model.set_value(cdt, cdn, \"sales_order\", \"\");\n                            return;\n                        }\n\n                        if (row.custom_customers_po_number) {\n                            frappe.db.get_value('Sales Order', {\n                                po_no: row.custom_customers_po_number,\n                                customer: frm.doc.customer\n                            }, 'name').then(r => {\n                                if (r && r.message && r.message.name) {\n                                    frappe.model.set_value(cdt, cdn, 'sales_order', r.message.name);\n                                }\n                            });\n                        }\n                    }\n                }\n            });\n        }\n        setTimeout(() => {\n            if (row.item_code && row.custom_customers_po_number) {\n                frappe.call({\n                    method: \"onegene.onegene.custom.get_rate_from_sales_order\",\n                    args: {\n                        item_code: row.item_code,\n                        customer_po: row.custom_customers_po_number\n                    },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.model.set_value(cdt, cdn, \"rate\", r.message);\n                        }\n                    }\n                });\n            }\n        }, 500);\n    },\n    sales_order: function(frm, cdt, cdn) {\n        const row = locals[cdt][cdn];\n        if (!row.sales_order) return;\n        // read only\n        const read_only = row.sales_order && frm.doc.custom_invoice_type != \"Credit Note\";\n\n        frm.fields_dict['items'].grid.update_docfield_property(\n            'rate', // field to make read-only\n            'read_only', // property\n            read_only, // value\n            row.name // specific row\n        );\n        frappe.call({\n            method: \"onegene.onegene.custom.get_so_for_sii\",\n            args: {\n                doctype: \"Sales Order\",\n                txt: \"\",\n                searchfield: \"name\",\n                start: 0,\n                page_len: 5,\n                filters: {\n                    item_code: row.item_code,\n                    customer: frm.doc.customer,\n                }\n            },\n            callback: function(r) {\n                const so_list = r.message.map(row => row[0]);\n                if (!so_list.includes(row.sales_order)) {\n                    frappe.model.set_value(cdt, cdn, 'sales_order', '');\n                    return;\n                }\n            }\n        });\n\n        let sales_order = row.sales_order;\n        if (sales_order) {\n            frappe.call({\n                method: \"onegene.onegene.custom.get_so_item_details\",\n                args: {\n                    sales_order: sales_order,\n                    item_code: row.item_code,\n                },\n                freeze: true,\n                freeze_message: \"Loading SO Details...\",\n                callback: function(r) {\n                    if (!r.message) return;\n                    // row.qty = r.message[0];\n                    row.so_detail = r.message[1];\n                    row.rate = r.message[2];\n                    row.amount = r.message[0] * r.message[2];\n                    frm.refresh_field(\"items\");\n                }\n            });\n            // Duplicate Items Valdiation\n            setTimeout(() => {\n                let duplicate_found = frm.doc.items.some(\n                    item => item.item_code === row.item_code && item.name !== row.name && item.sales_order === row.sales_order\n\n                );\n\n                if (duplicate_found) {\n                    let d = frappe.msgprint({\n                        title: __(\"Removing Duplicate Entry\"),\n                        message: __(\"Item Code <b>{0}</b> is already added.\", [row.item_code]),\n                        indicator: 'red'\n                    });\n                    frm.get_field('items').grid.grid_rows_by_docname[cdn].remove();\n                    frm.refresh_field('items');\n                    setTimeout(() => {\n                        if (d && d.hide) d.hide();\n                    }, 2000);\n                }\n            }, 500);\n        }\n        handlePalletBoxData(frm, cdt, cdn)\n    },\n\n    custom_no_of_boxes: function(frm, cdt, cdn) {\n        var child = locals[cdt][cdn];\n        if (child.custom_pallet && child.custom_no_of_boxes && child.item_code && child.custom_box) {\n            frappe.call({\n                method: 'onegene.onegene.custom.set_pallet_weight',\n                args: {\n                    item: child.item_code,\n                    box: child.custom_box,\n                    pallet: child.custom_pallet,\n                    box_qty: child.custom_no_of_boxes\n                },\n            }).then(r => {\n                if (r.message) {\n                    child.custom_no_of_pallets = r.message[0];\n                    child.custom_total_weight_of_pallets = r.message[1];\n                    child.custom_pallet_length = r.message[2];\n                    child.custom_pallet_breadth = r.message[3];\n                    child.custom_pallet_height = r.message[4];\n                    child.custom_cbm = (r.message[0] * r.message[2] * r.message[3] * r.message[4]) / 1000000000;\n                }\n                child.custom_packing_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets;\n                child.custom_gross_weight = child.custom_packing_weight + child.total_weight;\n                frm.refresh_field(\"items\");\n            });\n            frm.trigger('calculate_total_cbm')\n        }\n    },\n    qty: function(frm, cdt, cdn) {\n\n        let child = locals[cdt][cdn];\n\n\n        let date_obj = new Date(frm.doc.posting_date);\n        let month_str = date_obj.toLocaleString('en-us', {\n            month: 'short'\n        }).toUpperCase();\n        let year = date_obj.getFullYear();\n        if (child.qty === 0) return;\n\n        if (child.sales_order) {\n            frappe.call({\n                method: \"onegene.onegene.custom.set_qty_sales_invoice\",\n                args: {\n                    item_code: child.item_code,\n                    sales_order: child.sales_order,\n                    schedule_month: month_str,\n                    schedule_year: year,\n                    qty: child.qty\n                },\n                callback: function(r) {\n\n\n                    const scheduled_qty = Number(r.message);\n\n                    if (scheduled_qty) {\n\n                        if (!isNaN(scheduled_qty) && child.qty > scheduled_qty) {\n\n                            frappe.msgprint(`${r.message}`)\n\n                            frappe.model.set_value(child.doctype, child.name, \"qty\", 0);\n\n                            frm.refresh_field(\"items\");\n\n\n                        }\n\n                    }\n\n\n                }\n\n            });\n        }\n\n        if (child.custom_available_qty_at_warehouse < child.qty) {\n\n            // frappe.msgprint(`Quantity should not be greater than the stock Qty. Available Qty is ${child.custom_available_qty_at_warehouse}`)\n            // frappe.model.set_value(child.doctype, child.name, \"qty\", 0);\n        }\n\n        if (frm.doc.custom_invoice_type != \"Export Invoice\") {\n            if (child.qty > 0 && child.custom_pack_size > 0) {\n                child.custom_no_of_boxes = Math.ceil(child.qty / child.custom_pack_size)\n            } else {\n                child.custom_no_of_boxes = 1\n            }\n        }\n\n\n\n\n        if (child.item_code && child.custom_box && child.qty && frm.doc.custom_invoice_type == \"Export Invoice\") {\n            frappe.call({\n                method: 'onegene.onegene.custom.set_box_weight',\n                args: {\n                    'item': child.item_code,\n                    'box': child.custom_box,\n                    'item_qty': child.qty\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        child.custom_no_of_boxes = r.message[0]\n                        child.custom_total_weight_of_boxes = r.message[1]\n                        child.custom_box_length = r.message[2]\n                        child.custom_box_breadth = r.message[3]\n                        child.custom_box_height = r.message[4]\n                    }\n                    if (child.custom_pallet && child.custom_no_of_boxes && child.item_code && child.custom_box) {\n                        frappe.call({\n                            method: 'onegene.onegene.custom.set_pallet_weight',\n                            args: {\n                                item: child.item_code,\n                                box: child.custom_box,\n                                pallet: child.custom_pallet,\n                                box_qty: child.custom_no_of_boxes\n                            },\n                        }).then(r => {\n                            if (r.message) {\n                                child.custom_no_of_pallets = r.message[0];\n                                child.custom_total_weight_of_pallets = r.message[1];\n                                child.custom_pallet_length = r.message[2];\n                                child.custom_pallet_breadth = r.message[3];\n                                child.custom_pallet_height = r.message[4];\n                                child.custom_cbm = (r.message[0] * r.message[2] * r.message[3] * r.message[4]) / 1000000000;\n                            }\n                            child.custom_packing_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets;\n                            child.custom_gross_weight = child.custom_packing_weight + child.total_weight;\n                            frm.refresh_field(\"items\");\n                        });\n                        frm.trigger('calculate_total_cbm')\n\n\n                    }\n                    child.custom_packing_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets\n                    child.custom_gross_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets + child.total_weight\n                    frm.refresh_field(\"items\");\n                }\n            });\n            frm.trigger('calculate_total_cbm');\n\n        }\n\n        if (child.qty && frm.doc.custom_invoice_type != \"Credit Note\") {\n            frappe.call({\n                method: 'onegene.onegene.custom.validate_qty_in_sales_invoice',\n                args: {\n                    'item_code': child.item_code,\n                    'sales_order': child.sales_order,\n                    'qty': child.qty,\n                    'idx': child.idx,\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        frappe.model.set_value(child.doctype, child.name, \"qty\", 0);\n                        if (child.delivery_note) {\n                            frappe.msgprint(\n                                __(`<b>Row ${child.idx}</b>: Cannot invoice more than the quantity available in Delivery Note <b>${child.delivery_note}</b> for Item <b>${child.item_code}</b>. Available Quantity: <b>${r.message}</b>`),\n                                __(\"Quantity Exceeds Delivery Note Limit\")\n                            );\n                            frappe.msgprint(\n                                __(`<b>Row ${child.idx}</b>: Delivery Note <b>${child.delivery_note}</b> இல் உள்ள அளவை விட Item <b>${child.item_code}</b> க்கு invoice செய்ய முடியாது. கிடைக்கும் அளவு: <b>${r.message}</b>`),\n                                __(\"Quantity Exceeds Delivery Note Limit\")\n                            );\n\n                        } else {\n                            frappe.msgprint(\n                                __(`<b>Row ${child.idx}</b>: Cannot invoice more than the quantity available in Sales Order <b>${child.sales_order}</b> for Item <b>${child.item_code}</b>. Available Quantity: <b>${r.message}</b>`),\n                                __(\"Quantity Exceeds Sales Order Limit\")\n                            );\n                            frappe.msgprint(\n                                __(`<b>Row ${child.idx}</b>: Sales Order <b>${child.sales_order}</b> இல் உள்ள அளவை விட Item <b>${child.item_code}</b> க்கு invoice செய்ய முடியாது. கிடைக்கும் அளவு: <b>${r.message}</b>`),\n                                __(\"Quantity Exceeds Sales Order Limit\")\n                            );\n\n                        }\n                    }\n\n                    frm.refresh_field(\"items\");\n                }\n\n\n            });\n        }\n        handlePalletBoxData(frm, cdt, cdn)\n    },\n\n\n\n\n    custom_box: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn];\n        if (child.custom_box && child.qty) {\n            frappe.call({\n                method: 'onegene.onegene.custom.set_box_weight',\n                args: {\n                    'item': child.item_code,\n                    'box': child.custom_box,\n                    'item_qty': child.qty\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        child.custom_no_of_boxes = r.message[0]\n                        child.custom_total_weight_of_boxes = r.message[1]\n                        child.custom_box_length = r.message[2]\n                        child.custom_box_breadth = r.message[3]\n                        child.custom_box_height = r.message[4]\n                    }\n                    child.custom_packing_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets\n                    child.custom_gross_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets + child.total_weight\n                    frm.refresh_field(\"items\");\n                }\n            });\n            frm.trigger('calculate_total_cbm');\n\n        }\n    },\n    custom_pallet: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn];\n        if (child.qty && child.custom_pallet && child.custom_no_of_boxes && child.item_code && child.custom_box) {\n            frappe.call({\n                method: 'onegene.onegene.custom.set_pallet_weight',\n                args: {\n                    item: child.item_code,\n                    box: child.custom_box,\n                    pallet: child.custom_pallet,\n                    box_qty: child.custom_no_of_boxes\n                },\n            }).then(r => {\n                if (r.message) {\n                    child.custom_no_of_pallets = r.message[0];\n                    child.custom_total_weight_of_pallets = r.message[1];\n                    child.custom_pallet_length = r.message[2];\n                    child.custom_pallet_breadth = r.message[3];\n                    child.custom_pallet_height = r.message[4];\n                    child.custom_cbm = (r.message[0] * r.message[2] * r.message[3] * r.message[4]) / 1000000000;\n                }\n                child.custom_packing_weight = child.custom_total_weight_of_boxes + child.custom_total_weight_of_pallets;\n                child.custom_gross_weight = child.custom_packing_weight + child.total_weight;\n                frm.refresh_field(\"items\");\n            });\n            frm.trigger('calculate_total_cbm')\n\n\n        }\n    },\n    // custom_total_weight_of_boxes: function(frm, cdt, cdn) {\n    //     let child = locals[cdt][cdn];\n    //     child.custom_packing_weight = child.custom_total_weight_of_boxes+child.custom_total_weight_of_pallets+child.total_weight\n    //     frm.refresh_field(\"items\");\n    // },\n    // custom_total_weight_of_pallets: function(frm, cdt, cdn) {\n    //     let child = locals[cdt][cdn];\n    //     child.custom_packing_weight = child.custom_total_weight_of_boxes+child.custom_total_weight_of_pallets+child.total_weight\n    //     frm.refresh_field(\"items\");\n    // }\n\n\n})\n\nasync function handlePalletBoxData(frm, cdt, cdn) {\n    if (frm.doc.custom_invoice_type == \"Export Invoice\") {\n        const row = locals[cdt][cdn];\n        if (!row.item_code || !frm.doc.customer) return;\n\n        try {\n\n            // 3. Box filters and defaults\n            const boxes = get_boxes(row.item_code);\n            frm.fields_dict.items.grid.get_field('custom_box').get_query = function(doc) {\n                return {\n                    filters: {\n                        \"name\": [\"in\", boxes]\n                    }\n                };\n            };\n            if (boxes.length === 1) {\n                await frappe.model.set_value(cdt, cdn, 'custom_box', boxes[0]);\n            }\n\n            // 4. Pallet filters and defaults\n            const pallets = get_pallets(row.item_code);\n            frm.fields_dict.items.grid.get_field('custom_pallet').get_query = function(doc) {\n                return {\n                    filters: {\n                        \"name\": [\"in\", pallets]\n                    }\n                };\n            };\n            if (pallets.length === 1) {\n                await frappe.model.set_value(cdt, cdn, 'custom_pallet', pallets[0]);\n            }\n\n            // 5. Box weight and packing calculations\n            if (row.custom_box && row.qty) {\n                const boxRes = await frappe.call({\n                    method: 'onegene.onegene.custom.set_box_weight',\n                    args: {\n                        'item': row.item_code,\n                        'box': row.custom_box,\n                        'item_qty': row.qty\n                    }\n                });\n\n                if (boxRes.message) {\n                    row.custom_no_of_boxes = boxRes.message[0];\n                    row.custom_total_weight_of_boxes = boxRes.message[1];\n                    row.custom_box_length = boxRes.message[2];\n                    row.custom_box_breadth = boxRes.message[3];\n                    row.custom_box_height = boxRes.message[4];\n                }\n\n                // 6. Pallet weight calculations\n                if (row.custom_pallet && row.custom_no_of_boxes && row.item_code && row.custom_box) {\n                    const palletRes = await frappe.call({\n                        method: 'onegene.onegene.custom.set_pallet_weight',\n                        args: {\n                            item: row.item_code,\n                            box: row.custom_box,\n                            pallet: row.custom_pallet,\n                            box_qty: row.custom_no_of_boxes\n                        }\n                    });\n\n                    if (palletRes.message) {\n                        row.custom_no_of_pallets = palletRes.message[0];\n                        row.custom_total_weight_of_pallets = palletRes.message[1];\n                        row.custom_pallet_length = palletRes.message[2];\n                        row.custom_pallet_breadth = palletRes.message[3];\n                        row.custom_pallet_height = palletRes.message[4];\n                        row.custom_cbm = (palletRes.message[0] * palletRes.message[2] * palletRes.message[3] * palletRes.message[4]) / 1000000000;\n                    }\n\n                    row.custom_packing_weight = row.custom_total_weight_of_boxes + row.custom_total_weight_of_pallets;\n                    row.custom_gross_weight = row.custom_packing_weight + row.total_weight;\n                    frm.refresh_field(\"items\");\n                    frm.trigger('calculate_total_cbm');\n                } else {\n                    row.custom_packing_weight = row.custom_total_weight_of_boxes + row.custom_total_weight_of_pallets;\n                    row.custom_gross_weight = row.custom_packing_weight + row.total_weight;\n                    frm.refresh_field(\"items\");\n                    frm.trigger('calculate_total_cbm');\n                }\n            }\n        } catch (err) {\n            console.error(\"Error during item processing:\", err);\n        }\n    }\n\n}\n\nfunction validate_and_set_customers_po(frm, cdt, cdn) {\n    const row = locals[cdt][cdn];\n\n    frm.fields_dict[\"items\"].grid.get_field(\"custom_customers_po_number\").get_query = function(doc, cdt, cdn) {\n        let child = locals[cdt][cdn];\n        return {\n            query: \"onegene.onegene.custom.get_customer_po_query\",\n            filters: {\n                customer: frm.doc.customer,\n                item_code: child.item_code\n            }\n        };\n    };\n\n    if (frm.doc.customer && row.item_code) {\n        frappe.call({\n            method: \"onegene.onegene.custom.get_customer_po_number\",\n            args: {\n                customer: frm.doc.customer,\n                item_code: row.item_code\n            },\n            callback: function(r) {\n                if (r.message && Array.isArray(r.message)) {\n                    row._valid_po_nos = r.message;\n                    if (r.message.length === 1) {\n                        frappe.model.set_value(cdt, cdn, \"custom_customers_po_number\", r.message[0]);\n                        frappe.call({\n                            method: \"onegene.onegene.custom.get_balance_schedule\",\n                            args: {\n                                pdate: frm.doc.posting_date,\n                                item_code: row.item_code,\n                                po_no: r.message[0]\n                            },\n                            callback: function(res) {\n                                if (res.message && res.message.pending_qty) {\n\n                                    frappe.model.set_value(cdt, cdn, \"custom_schedule_balance_qty\", res.message.pending_qty);\n                                }\n                            }\n                        });\n                    }\n                }\n            }\n        });\n    }\n}\n\nasync function validate_and_set_sales_order(frm, cdt, cdn) {\n    const row = locals[cdt][cdn];\n    if (!row.item_code || !frm.doc.customer) return;\n\n    try {\n        // 1. Validate item against allowed list\n        const itemResult = await frappe.call({\n            method: \"onegene.onegene.custom.get_items_for_sii\",\n            args: {\n                doctype: \"Sales Order\",\n                txt: \"\",\n                searchfield: \"name\",\n                start: 0,\n                page_len: 5,\n                filters: {\n                    item_code: row.item_code,\n                    customer: frm.doc.customer,\n                    invoice_type: frm.doc.custom_invoice_type,\n                }\n            }\n        });\n\n        const item_list = itemResult.message.map(r => r[0]);\n        if (!item_list.includes(row.item_code)) {\n            frappe.msgprint({\n                title: __(\"Invalid Item\"),\n                message: __(\"Item <b>{0}</b> is not allowed for the selected customer.\", [row.item_code]),\n                indicator: \"red\"\n            });\n            frm.get_field(\"items\").grid.grid_rows_by_docname[cdn].remove();\n            frm.refresh_field(\"items\");\n            return;\n        }\n\n        // 2. Auto-set sales order if only one match\n        const soResult = await frappe.call({\n            method: \"onegene.onegene.custom.get_so_for_sii\",\n            args: {\n                doctype: \"Sales Order\",\n                txt: \"\",\n                searchfield: \"name\",\n                start: 0,\n                page_len: 5,\n                filters: {\n                    item_code: row.item_code,\n                    customer: frm.doc.customer,\n                }\n            }\n        });\n\n        if (soResult.message && soResult.message.length === 1) {\n            await frappe.model.set_value(cdt, cdn, \"sales_order\", soResult.message[0][0]);\n        }\n\n    } catch (err) {\n        console.error(\"Error during validation and SO setting:\", err);\n    }\n}\n\n\nfunction set_required_fields(frm) {\n    const is_credit_note = frm.doc.custom_invoice_type === 'Credit Note';\n\n    // Make 'sales_order' mandatory only if NOT Credit Note\n    frm.fields_dict['items'].grid.update_docfield_property(\n        'sales_order',\n        'reqd',\n        !is_credit_note\n    );\n\n    // Make 'custom_customers_po_number' mandatory only if NOT Credit Note\n    frm.fields_dict['items'].grid.update_docfield_property(\n        'custom_customers_po_number',\n        'reqd',\n        !is_credit_note\n    );\n}\n\n\n\nfunction refresh_stock_pick_list(frm) {\n    // Collect unique item codes from the child table\n    const item_codes = (frm.doc.items || [])\n        .map(row => row.item_code)\n        .filter(Boolean)\n        .filter((value, index, self) => self.indexOf(value) === index); // Ensures uniqueness\n\n    if (!item_codes.length) {\n        frm.fields_dict.custom_pick_list.$wrapper.empty();\n        return;\n    }\n\n    // Make the API call to get stock data\n    frappe.call({\n        method: 'onegene.onegene.custom.sales_invoice_pick_list_all',\n        args: {\n            item_codes_json: JSON.stringify(item_codes)\n        },\n        callback: function(r) {\n            if (!r.message || !r.message.length) {\n                return;\n            }\n\n            let html = `\n                <table style=\"border:1px solid black;\" class=\"table table-bordered table-sm\">\n                    <thead style=\"border:1px solid black;\">\n                        <tr style=\"border:1px solid black;\">\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">S.NO</th>\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">Item Code</th>\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">Item Name</th>\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">Warehouse</th>\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">Rack</th>\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">Location</th>\n                            <th style=\"background-color:orange; text-align:center; border:1px solid black; line-height:1;\">Available Quantity</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n            `;\n\n            let seen = new Set();\n            let sr = 1;\n\n            r.message.forEach(row => {\n                if (row.available_qty && Number(row.available_qty) > 0) {\n                    const isFirst = !seen.has(row.item_code);\n                    if (isFirst) seen.add(row.item_code);\n\n                    html += `\n                    <tr style=\"border:1px solid black;\">\n                        <td style=\"border:1px solid black; text-align:center; line-height:1;\">${sr}</td>\n                        <td style=\"border:1px solid black; text-align:left; line-height:1;\">${row.item_code || ''}</td>\n                        <td style=\"border:1px solid black; text-align:left; line-height:1;\">${row.item_name || ''}</td>\n                        <td style=\"border:1px solid black; text-align:left; line-height:1;\">${row.warehouse || '-'}</td>\n                        <td style=\"border:1px solid black; text-align:left; line-height:1;\">${row.rack || '-'}</td>\n                        <td style=\"border:1px solid black; text-align:left; line-height:1;\">${row.location || '-'}</td>\n                        <td style=\"border:1px solid black; text-align:right; line-height:1;\">${row.available_qty || 0}</td>\n                    </tr>\n                `;\n\n                    sr++;\n\n                }\n            });\n\n            html += `</tbody></table>`;\n            frm.fields_dict.custom_pick_list.$wrapper.html(html);\n        }\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.051592",
  "module": "ONEGENE",
  "name": "Sales Order List",
  "script": "frappe.listview_settings['Sales Order'] = {\r\n    onload: function(listview) {\r\n        if (frappe.user.has_role(\"System Manager\")) {\r\n            listview.page.add_inner_button(\"Import Schedule\", function() {\r\n                frappe.set_route('sales-order-schedule-settings')\r\n            });\r\n        }\r\n        \r\n    }\r\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Address",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.558621",
  "module": "ONEGENE",
  "name": "Address",
  "script": "frappe.ui.form.on('Address', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\tonload(frm){\n\t    frm.set_query('state',function(){\n\t        return{\n\t            filters:{\n\t                country :frm.doc.country\n\t                \n\t            }\n\t        }\n\t    })\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Logistics Request",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.453697",
  "module": "ONEGENE",
  "name": "Logistics Request",
  "script": "frappe.ui.form.on('Logistics Request', {\n// \trefresh(frm) {\n// \t\t if (!frm.doc.__islocal &&  frm.doc.logistic_type == \"Export\" && frm.doc.owner == frappe.session.user) {\n\t\t     \n\t\t     \n// \t\t     \tfrm.add_custom_button(__(\"Export Packing List\"), function () {\n// \t\t\tvar f_name = frm.doc.name\n// \t\t\tvar print_format = \"LR Packing List\";\n// \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n// \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Logistics Request\")\n// \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n// \t\t\t\t+ \"&trigger_print=1\"\n// \t\t\t\t+ \"&format=\" + print_format\n// \t\t\t\t+ \"&no_letterhead=0\"\n// \t\t\t));\n// \t\t},__('Print'));\n\t\n// \t\t }\n// \t\t if(frm.doc.recommended_ffw){\n// \t\t frm.add_custom_button(__(\"FFW\"), function () {\n//                     frappe.call({\n//                         method: \"onegene.onegene.custom.create_html_lr\",\n//                         args: {\n//                             doc: frm.doc\n//                         },\n//                         callback: function (r) {\n//                             if (r.message && r.message.html) {\n//                                 let d = new frappe.ui.Dialog({\n                                    \n//                                     size: \"large\",\n//                                     primary_action_label: __(\"Close\"),\n//                                     primary_action: function () {\n//                                         d.hide();\n//                                     }\n//                                 });\n            \n//                                 d.$body.html(r.message.html);\n//                                 d.show();\n//                             } else {\n//                                 frappe.msgprint(__(\"Unable to load preview\"));\n//                                 frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n//                             }\n//                         }\n//                     });\n//                 },__(\"Report View\"));\n// \t\t }\n// \t\t if(frm.doc.logistic_type == \"Export\"){\n// \t\t     frm.add_custom_button(__(\"Export Packing List\"), function () {\n//                     frappe.call({\n//                         method: \"onegene.onegene.custom.create_html_lr_export\",\n//                         args: {\n//                             doc: frm.doc\n//                         },\n//                         callback: function (r) {\n//                             if (r.message && r.message.html) {\n//                                 let d = new frappe.ui.Dialog({\n                                    \n//                                     size: \"large\",\n//                                     primary_action_label: __(\"Close\"),\n//                                     primary_action: function () {\n//                                         d.hide();\n//                                     }\n//                                 });\n            \n//                                 d.$body.html(r.message.html);\n//                                 d.show();\n//                             } else {\n//                                 frappe.msgprint(__(\"Unable to load preview\"));\n//                                 frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n//                             }\n//                         }\n//                     });\n//                 },__(\"Report View\"));\n//                 if (frm.doc.po_so == \"Sales Invoice\"){\n//                     frm.add_custom_button(__(\"Export Invoice\"), function () {\n//                     frappe.call({\n//                         method: \"onegene.onegene.doctype.logistics_request.logistics_request.create_html_EI\",\n//                         args: {\n//                             sales_invoice: frm.doc.order_no,\n//                         },\n//                         callback: function (r) {\n//                             if (r.message && r.message.html) {\n//                                 let d = new frappe.ui.Dialog({\n                                    \n//                                     size: \"large\",\n//                                     primary_action_label: __(\"Close\"),\n//                                     primary_action: function () {\n//                                         d.hide();\n//                                     }\n//                                 });\n//                                 d.$wrapper.find(\".modal-dialog\").css(\"max-width\", \"65%\")\n//                                 d.$body.html(r.message.html);\n//                                 d.show();\n//                             } else {\n//                                 frappe.msgprint(__(\"Unable to load preview\"));\n//                                 frappe.msgprint(__(\"Preview ஐ load செய்ய முடியவில்லை\"))\n\n//                             }\n//                         }\n//                     });\n//                 },__(\"Report View\"));\n//                     if(frm.doc.owner == frappe.session.user){\n//                     frm.add_custom_button(__(\"Export Invoice\"), function () {\n//                         var print_format = \"Export Invoice Print New\";\n//                         window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n//                             + \"doctype=\" + encodeURIComponent(\"Sales Invoice\")\n//                             + \"&name=\" + encodeURIComponent(frm.doc.order_no)\n//                             + \"&trigger_print=1\"\n//                             + \"&format=\" + print_format\n//                             + \"&no_letterhead=0\"\n//                         ));\n//                     }, __('Print'));\n//                     }\n//                 }\n//                 // frm.add_custom_button(__(\"Packing List Logistics\"),\n//                 //     function () {\n//                 //         frappe.call({\n//                 //             method: \"onegene.onegene.custom.packing_list\",\n//                 //             args: {\n//                 //                 sales_invoice: frm.doc.order_no\n//                 //             },\n//                 //             callback: function (r) {\n//                 //                 if (r.message) {   \n//                 //                     let d = new frappe.ui.Dialog({\n//                 //                         title: __(\"Packing List Logistics\"),\n//                 //                         size: \"large\",\n//                 //                         primary_action_label: __(\"Close\"),\n//                 //                         primary_action: function () {\n//                 //                             d.hide();\n//                 //                         }\n//                 //                     });\n                \n//                 //                     d.$body.html(r.message);\n//                 //                     d.show();\n//                 //                 } else {\n//                 //                     frappe.msgprint(__(\"Unable to load preview\"));\n//                 //                 }\n//                 //             }\n//                 //         });\n//                 //     },\n//                 //     __(\"Report View\")\n//                 // );\n\n// \t\t }\n// \t},\n\tcargo_type(frm){\n\t    \n\t    if(frm.doc.cargo_type){\n\t    frm.set_value(\"shipping_line\",frm.doc.cargo_type)\n\t    }\n\t},\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Card",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.091182",
  "module": "ONEGENE",
  "name": "Job Card",
  "script": "frappe.ui.form.on('Job Card', {\n    onload(frm) {\n        // cur_frm.page.btn_secondary.hide()\n        // cur_frm.page.btn_primary.hide()\n        if (!frm.doc.__islocal) {\n            frm.fields_dict['scrap_items'].grid.get_field('item_code').get_query = function(doc, cdt, cdn) {\n                return {\n                    query: \"onegene.onegene.custom.set_query_for_jc_scrap_item\",\n                    filters: {\n                        name: doc.name,\n                        work_order: frm.doc.work_order,\n                        sequence_id: frm.doc.sequence_id\n                    }\n                };\n            };\n        }\n\n        frm.set_df_property('custom_possible_qty', 'label', '<b style=\"color: green;\">Possible Qty</b>');\n        if (!frm.doc.__islocal) {\n            if (\n                frm.doc.status != \"Submitted\" &&\n                frm.doc.status != \"Cancelled\" &&\n                frm.doc.status != \"Completed\"\n            ) {\n                // frappe.call({\n                //     method: \"onegene.onegene.custom.update_possible_qty_onload\",\n                //     args: { name: frm.doc.name },\n                //     callback: function(r) {\n                //         if (r.message && r.message.updated) {\n                //             // update possible qty\n                //             frm.set_value(\"custom_possible_qty\", r.message.possible_qty);\n\n                //             // clear and set child tables\n                //             frm.clear_table(\"custom_rm_availability\");\n                //             (r.message.rm_availability || []).forEach(row => {\n                //                 let d = frm.add_child(\"custom_rm_availability\");\n                //                 Object.assign(d, row);\n                //             });\n\n                //             frm.clear_table(\"custom_required_material_for_operation\");\n                //             (r.message.required_materials || []).forEach(row => {\n                //                 let d = frm.add_child(\"custom_required_material_for_operation\");\n                //                 Object.assign(d, row);\n                //             });\n\n                //             frm.refresh_fields();\n                //             frm.save();\n                //         }\n                //     }\n                // });\n            }\n            frappe.call({\n                method: \"onegene.onegene.custom.get_raw_materials_for_jobcard_on_mt\",\n                args: {\n                    name: frm.doc.name,\n                    disable_save: true\n                },\n            });\n            frappe.db.get_value(\"Item\", frm.doc.production_item, \"rejection_allowance\").then(r => {\n                let rejection_allowance_percent = r.message.rejection_allowance || 0;\n                let max_allowed_rejection = (frm.doc.for_quantity || 0) * (rejection_allowance_percent / 100);\n                let total_rejected_qty = frm.doc.custom_rejected_qty || 0;\n                if (total_rejected_qty > max_allowed_rejection) {\n                    let msg = __('Total Rejected Quantity (' + total_rejected_qty + ') exceeds the Rejection Allowance')\n                    frm.dashboard.add_comment(msg, \"red\", true);\n                }\n            })\n        }\n        frm.set_query(\"custom_shift_type\", () => {\n            return {\n                query: \"onegene.onegene.custom.get_shift_for_current_time\",\n            };\n        });\n        frm.set_query('workstation', function() {\n            return {\n                query: 'onegene.onegene.custom.get_warehouses',\n                filters: {\n                    name: frm.doc.name\n                }\n            };\n        });\n        frm.set_query(\"custom_supervisor\", () => {\n            return {\n                query: \"onegene.onegene.custom.get_supervisor\",\n                filters: {\n                    department: frm.doc.custom_department\n                }\n            };\n        });\n    },\n    custom_process_rework(frm) {\n        let d = new frappe.ui.Dialog({\n            title: __('Enter Details'),\n            fields: [{\n                    fieldtype: 'Section Break',\n                    label: __('Employee Details'),\n                },\n                {\n                    fieldtype: 'Column Break',\n                },\n                {\n                    fieldtype: 'Link',\n                    label: __('Employee'),\n                    fieldname: 'employee',\n                    options: 'Employee',\n                    reqd: 1,\n                    change: function() {\n                        getEmployeeDepartment();\n                        getEmployeeName();\n                    }\n                },\n                {\n                    fieldtype: 'Link',\n                    label: __('Supervisor'),\n                    fieldname: 'supervisor',\n                    options: 'Employee',\n                    reqd: 1,\n                    read_only: 1,\n                    change: function() {\n                        getSupervisorName();\n                    }\n                },\n                {\n                    fieldtype: 'Link',\n                    label: __('Department'),\n                    fieldname: 'department',\n                    options: 'Department',\n                    read_only: 1,\n                },\n                {\n                    fieldtype: 'Column Break',\n                },\n                {\n                    fieldtype: 'Data',\n                    label: __('Employee Name'),\n                    fieldname: 'employee_name',\n                    reqd: 1,\n                },\n                {\n                    fieldtype: 'Data',\n                    label: __('Supervisor Name'),\n                    fieldname: 'supervisor_name',\n                    read_only: 1,\n                    reqd: 1\n                },\n                {\n                    fieldtype: 'Link',\n                    label: __('Shift Type'),\n                    fieldname: 'shift',\n                    options: 'Shift Type',\n                    reqd: 1,\n                    change: function() {\n                        validateShift();\n                    }\n                },\n                {\n                    fieldtype: 'Section Break',\n                    label: __('Operation & Workstation'),\n                },\n                {\n                    fieldtype: 'Column Break',\n                },\n                {\n                    fieldtype: 'Link',\n                    label: __('Operation'),\n                    fieldname: 'operation',\n                    default: frm.doc.operation,\n                    options: 'Operation',\n                    read_only: 1\n                },\n                {\n                    fieldtype: 'Column Break',\n                },\n                {\n                    fieldtype: 'Link',\n                    label: __('Workstation'),\n                    fieldname: 'workstation',\n                    default: frm.doc.workstation,\n                    options: 'Workstation',\n                    reqd: 1\n                },\n                {\n                    fieldtype: 'Section Break',\n                    label: __('Production Process'),\n                },\n                {\n                    fieldtype: 'Column Break',\n                },\n                {\n                    fieldtype: 'Int',\n                    label: __('<b style=\"color: #4169e1;\">Possible to Production</b>'),\n                    fieldname: 'possible_qty',\n                    default: frm.doc.custom_rework_waiting_qty,\n                    read_only: 1\n                },\n                {\n                    fieldtype: 'Int',\n                    label: __('Processed Quantity'),\n                    fieldname: 'processed_qty',\n                    // default: frm.doc.custom_rework_waiting_qty,\n                    read_only: 0,\n                    reqd: 1\n                },\n                {\n                    fieldtype: 'Int',\n                    label: __('<span style=\"color: green;\">Accepted Quantity</span>'),\n                    default: 0,\n                    fieldname: 'qty',\n                },\n                {\n                    fieldtype: 'Column Break',\n                },\n                {\n                    fieldtype: 'Int',\n                    label: __('<span style=\"color: red;\">Rejected Quantity</span>'),\n                    fieldname: 'rejected_qty'\n                },\n                {\n                    fieldtype: 'Link',\n                    label: __('Rejection Category'),\n                    fieldname: 'rejection_category',\n                    options: 'Rejection Category',\n                    depends_on: 'eval:doc.rejected_qty',\n                    mandatory_depends_on: 'eval:doc.rejected_qty'\n                },\n                {\n                    fieldtype: 'Link',\n                    label: __('Rejection Reason'),\n                    fieldname: 'rejection_remarks',\n                    options: 'Rejection Reason',\n                    depends_on: 'eval:doc.rejected_qty',\n                    mandatory_depends_on: 'eval:doc.rejected_qty'\n                },\n            ],\n            primary_action_label: __('Submit'),\n            primary_action(values) {\n                let processed_qty = values.processed_qty || 0;\n                let accepted_qty = values.qty || 0;\n                let rejected_qty = values.rejected_qty || 0;\n                let rework_qty = values.rework_qty || 0;\n\n                if (accepted_qty > processed_qty) {\n                    frappe.msgprint({\n                        title: __('Invalid Quantity'),\n                        indicator: 'red',\n                        message: `<span style=\"color: red;\">${__('Accepted Quantity cannot be more than Processed Quantity.')}</span>`\n                    });\n                    frappe.msgprint({\n                        title: __('தவறான அளவு'),\n                        indicator: 'red',\n                        message: `<span style=\"color: red;\">${__('ஏற்றுக்கொள்ளப்பட்ட அளவு செயலாக்கப்பட்ட அளவுக்கு மேல் இருக்க முடியாது.')}</span>`\n                    });\n\n                } else if (processed_qty > frm.doc.for_quantity) {\n                    frappe.msgprint({\n                        title: __('Invalid Quantity'),\n                        indicator: 'red',\n                        message: `<span style=\"color: red;\">${__('Processed Quantity cannot be more than Possible Rework Qty')}</span>`\n                    });\n                    frappe.msgprint({\n                        title: __('தவறான அளவு'),\n                        indicator: 'red',\n                        message: `<span style=\"color: red;\">${__('செயலாக்கப்பட்ட அளவு சாத்தியமான மீள்செய்யும் அளவுக்கு மேல் இருக்க முடியாது')}</span>`\n                    });\n\n\n                } else if (processed_qty !== (accepted_qty + rejected_qty)) {\n                    frappe.msgprint({\n                        title: __('Invalid Quantity'),\n                        indicator: 'red',\n                        message: `<span style=\"color: red;\">${__('Processed Quantity must be equal to the sum of Accepted, Rejected Quantities.')}</span>`\n                    });\n                    frappe.msgprint({\n                        title: __('தவறான அளவு'),\n                        indicator: 'red',\n                        message: `<span style=\"color: red;\">${__('செயலாக்கப்பட்ட அளவு, ஏற்றுக்கொள்ளப்பட்ட மற்றும் மறுக்கப்பட்ட அளவுகளின் கூட்டுத் தொகைக்கு சமமாக இருக்க வேண்டும்.')}</span>`\n                    });\n\n\n\n                } else {\n                    const args = {\n                        processed_qty: processed_qty,\n                        rejected_qty: rejected_qty,\n                        rejection_remarks: rejected_qty > 0 ? values.rejection_remarks : null,\n                        rework_qty: 0,\n                        rework_remarks: null,\n                        job_card_id: frm.doc.name,\n                        accepted_qty: accepted_qty,\n                        employee: values.employee,\n                        shift: values.shift,\n                        workstation: values.workstation,\n                        rejection_category: values.rejection_category,\n                        department: values.department,\n                        supervisor: values.supervisor,\n                        rework_category: null,\n                    };\n                    frappe.call({\n                        method: \"onegene.onegene.custom.job_card_rework_entry\",\n                        args: {\n                            args: args\n                        },\n                        freeze: true,\n                        callback: function(r) {\n                            if (r.message) {\n\n                            }\n                            d.hide();\n                        }\n                    });\n                }\n            }\n        });\n        d.fields_dict.rejection_remarks.get_query = () => {\n            return {\n                query: \"onegene.onegene.custom.get_rejection_reason\",\n                filters: {\n                    rejection_category: d.get_value('rejection_category')\n                }\n            };\n        };\n        d.show();\n\n        function getEmployeeDepartment() {\n            frappe.db.get_value(\"Employee\", {\n                    \"name\": d.get_value(\"employee\")\n                }, \"department\")\n                .then(r => {\n                    d.set_value(\"department\", r.message ? r.message.department : '');\n                    autoSetSupervisor();\n                });\n        }\n\n        function getEmployeeName() {\n            frappe.db.get_value(\"Employee\", {\n                    \"name\": d.get_value(\"employee\")\n                }, \"employee_name\")\n                .then(r => {\n                    d.set_value(\"employee_name\", r.message ? r.message.employee_name : '');\n                });\n        }\n\n        function recalculateAcceptedQty() {\n            const processed = flt(d.get_value(\"processed_qty\"));\n            const accepted = processed;\n            d.set_value(\"qty\", accepted >= 0 ? accepted : 0);\n        }\n\n        function validateProcessedQty() {\n            const processed = flt(d.get_value(\"processed_qty\"));\n            const possible = flt(d.get_value(\"possible_qty\"));\n            const qty = flt(d.get_value(\"qty\"));\n            if (processed > possible) {\n                frappe.msgprint({\n                    message: `<span style=\"color: red;\">Processed Quantity cannot be greater than the Possible to Production</span>`,\n                    indicator: \"red\"\n                });\n                frappe.msgprint({\n                    message: `<span style=\"color: red;\">செயலாக்கப்பட்ட அளவு தயாரிப்பிற்கான சாத்திய அளவுக்கு மேல் இருக்க முடியாது</span>`,\n                    indicator: \"red\"\n                });\n\n                d.set_value(\"processed_qty\", 0)\n            }\n            if (qty > processed) {\n                frappe.msgprint({\n                    message: `<span style=\"color: red;\">Accepted Quantity cannot be greater than the Processed Quantity</span>`,\n                    indicator: \"red\"\n                });\n                frappe.msgprint({\n                    message: `<span style=\"color: red;\">ஏற்றுக்கொள்ளப்பட்ட அளவு செயலாக்கப்பட்ட அளவுக்கு மேல் இருக்க முடியாது</span>`,\n                    indicator: \"red\"\n                });\n\n\n                d.set_value(\"qty\", 0)\n            }\n        }\n\n        function recalculateRejectedQty() {\n            const processed = flt(d.get_value(\"processed_qty\"));\n            const accepted = flt(d.get_value(\"qty\"));\n            const rework = flt(d.get_value(\"rework_qty\"));\n            const rejected = processed - accepted - rework;\n            d.set_value(\"rejected_qty\", rejected >= 0 ? rejected : 0);\n        }\n\n        function validateShift() {\n            let shift = d.get_value(\"shift\");\n            if (shift) {\n                frappe.call({\n                    method: \"onegene.onegene.custom.get_shift_for_current_time\",\n                    callback: function(r) {\n                        if (r.message) {\n                            const shift_list = r.message\n                                .map(s => s[0])\n                                .filter(v => v);\n                            if (shift && !shift_list.includes(shift)) {\n                                d.set_value(\"shift\", \"\");\n                            }\n                        }\n                    }\n                });\n            }\n        }\n\n\n        // Bind accepted_qty to update rework_qty\n        d.get_field(\"processed_qty\").$wrapper.find(\"input\").on(\"input\", () => {\n            // recalculateAcceptedQty();\n            validateProcessedQty();\n        });\n        d.get_field(\"qty\").$wrapper.find(\"input\").on(\"input\", () => {\n            // recalculateAcceptedQty();\n            validateProcessedQty();\n        });\n\n\n        // Bind rejected_qty to update rework_qty\n        // d.get_field(\"rejected_qty\").$wrapper.find(\"input\").on(\"input\", () => {\n        //     recalculateReworkQty();\n        // });\n\n        // d.get_field(\"qty\").$wrapper.find(\"change\").on(\"change\", () => {\n        //     validateAcceptedQty();\n        // });\n\n        d.fields_dict.shift.get_query = () => {\n            return {\n                query: \"onegene.onegene.custom.get_shift_for_current_time\",\n            };\n        };\n\n        d.fields_dict.supervisor.get_query = () => {\n            return {\n                query: \"onegene.onegene.custom.get_supervisor\",\n                filters: {\n                    department: d.get_value('department')\n                }\n            };\n        };\n\n        function getSupervisorName() {\n            if (d.get_value('supervisor')) {\n                frappe.call({\n                    method: \"onegene.onegene.custom.get_supervisor_name\",\n                    args: {\n                        supervisor: d.get_value('supervisor'),\n                    },\n                    callback: function(r) {\n                        if (r.message) {\n                            d.set_value('supervisor_name', r.message);\n                        }\n                    }\n                });\n            }\n        }\n\n        function autoSetSupervisor() {\n            frappe.call({\n                method: \"onegene.onegene.custom.get_supervisor\",\n                args: {\n                    doctype: \"Employee\",\n                    txt: \"\",\n                    searchfield: \"name\",\n                    start: 0,\n                    page_len: 20,\n                    filters: {\n                        department: d.get_value('department')\n                    }\n                },\n                callback: function(r) {\n                    if (r.message && r.message.length === 1) {\n                        d.set_value(\"supervisor\", r.message[0][0]);\n                        d.set_value(\"supervisor_name\", r.message[0][1]);\n                    }\n                }\n            });\n        }\n    },\n\n\n    custom_shift_type(frm) {\n        frappe.call({\n            method: \"onegene.onegene.custom.get_shift_for_current_time\",\n            callback: function(r) {\n                if (r.message) {\n                    const shift_list = r.message\n                        .map(s => s[0])\n                        .filter(v => v);\n                    if (frm.doc.custom_shift_type && !shift_list.includes(frm.doc.custom_shift_type)) {\n                        frm.set_value(\"custom_shift_type\", \"\");\n                        frm.set_value(\"custom_shift_start_time\", \"\");\n                        frm.set_value(\"custom_shift_end_time\", \"\");\n                    }\n                }\n            }\n        });\n    },\n\n\n\n\n\n\n\n    refresh(frm) {\n        frm.fields_dict[\"time_logs\"].grid.cannot_add_rows = true;\n        frm.fields_dict[\"time_logs\"].grid.only_sortable = false;\n        frm.fields_dict[\"time_logs\"].refresh();\n        setTimeout(() => {\n            const $breadcrumb = $('#navbar-breadcrumbs li a').filter(function () {\n                return $(this).text().trim().includes(\"Job Card\");\n            });\n\n            if ($breadcrumb.length) {\n                $breadcrumb.off().on(\"click\", function (e) {\n                    e.preventDefault();\n                    frappe.set_route(\"query-report\", \"Job Card\");\n                    return false;\n                });\n            }\n        }, 300);\n        \n         if(frm.doc.time_logs && frm.doc.time_logs.length){\n            \n            let logsrows =\"\";\n            \n            \n            \n            frm.doc.time_logs.forEach(r=>{\n                \n                logsrows +=`\n                \n                <tr > \n                <td style=\"text-align:center; border:1px solid #dbd2d9; border-bottom:0; border-left:0; \">${r.idx}</td>\n                <td style=\"text-align:left; border:1px solid #dbd2d9; border-bottom:0;\">${r.custom_docname}</td>\n                <td style=\"text-align:left; border:1px solid #dbd2d9; border-bottom:0;\">${r.custom_entry_type}</td>\n                <td style=\"text-align:left; border:1px solid #dbd2d9; border-bottom:0;\">${r.custom_shift_type}</td>\n                <td style=\"text-align:left; border:1px solid #dbd2d9; border-bottom:0;\">${r.employee}</td>\n                <td style=\"text-align:right; border:1px solid #dbd2d9; border-bottom:0;\">${r.completed_qty}</td>\n                <td style=\"text-align:right; border:1px solid #dbd2d9; border-bottom:0;\">${r.custom_rejected_qty}</td>\n                <td style=\"text-align:right; border:1px solid #dbd2d9; border-bottom:0;\">${r.custom_rework_qty}</td>\n                <td style=\"text-align:left; border:1px solid #dbd2d9; border-bottom:0; border-right:0;\"><button class=\"generate-qr-btn\" data-cdt=\"${r.doctype}\" data-cdn=\"${r.name}\" style=\"border-radius:5px; border: 1px solid #80bec1; background-color:white;\">Generate QR</button></td>\n                </tr>\n                \n                \n                `;\n                \n            })\n            \n            \n            \n            \n            \n            \n            \n            \n            let logsHTML=`\n            \n            <div style=\"\n                border:1px solid #dbd2d9;\n                border-radius:8px;\n                overflow:hidden;\n            \">\n            \n            <table class=\"table table-bordered\" style=\"margin:0;\">\n            <thead>\n            <tr >\n            <th style=\"text-align:center; background-color:#f3f3f3; font-weight:normal; line-height:1; color:#7c7c7c;  border:1px solid #dbd2d9; border-left: 0; border-top:0;\">No.</th>\n            <th style=\"text-align:center; background-color:#f3f3f3; font-weight:normal; line-height:1; color:#7c7c7c; border:1px solid #dbd2d9; border-top:0;\">Docname</th>\n            <th style=\"text-align:center; background-color:#f3f3f3; font-weight:normal; line-height:1; color:#7c7c7c; border:1px solid #dbd2d9; border-top:0;\">Entry Type</th>\n            <th style=\"text-align:center; background-color:#f3f3f3; font-weight:normal; line-height:1; color:#7c7c7c; border:1px solid #dbd2d9; border-top:0;\">Shift Type</th>\n            <th style=\"text-align:center; background-color:#f3f3f3; font-weight:normal; line-height:1; color:#7c7c7c; border:1px solid #dbd2d9; border-top:0;\">Employee</th>\n            <th style=\"text-align:center; background-color:#f3f3f3; font-weight:normal; line-height:1; color:#7c7c7c; border:1px solid #dbd2d9; border-top:0;\">Completed Qty</th>\n            <th style=\"text-align:center; background-color:#f3f3f3; font-weight:normal; line-height:1; color:#7c7c7c; border:1px solid #dbd2d9; border-top:0;\">Rejected Qty</th>\n            <th style=\"text-align:center; background-color:#f3f3f3; font-weight:normal; line-height:1; color:#7c7c7c; border:1px solid #dbd2d9; border-top:0;\">Rework Qty</th>\n            <th style=\"text-align:center; background-color:#f3f3f3; font-weight:normal; line-height:1; color:#7c7c7c; border:1px solid #dbd2d9; border-top:0; border-right:0;\">Generate QR</th>\n            </tr>\n            </thead>\n            <tbody>\n            ${logsrows}\n            </tbody>\n            </table>\n            </div>`;\n            \n            frm.fields_dict.custom_logs.$wrapper.html(logsHTML);\n            \n            \n        }\n        \n        $(document).on('click', '.generate-qr-btn', function () {\n        let cdt = $(this).data('cdt');\n        let cdn = $(this).data('cdn');\n    \n        let row = locals[cdt][cdn];\n        let parent_name = cur_frm.doc.name;\n    \n        // frappe.call({\n        //     method: \"onegene.onegene.utils.get_qid_for_job_card_from_child_row\",\n        //     args: {\n        //         parent: parent_name,\n        //         child_doctype: cdt,\n        //         child_name: cdn\n        //     },\n        //     freeze: true,\n        //     callback(res) {\n        //         if (res.message) {\n        //             window.open(res.message);\n        //         }\n        //     }\n        // });\n        \n        frappe.call({\n            method: \"onegene.onegene.utils.get_qr_html_for_child_row\",\n            args: {\n                parent: parent_name,\n                child_doctype: cdt,\n                child_name: row.name\n            },\n            callback(r) {\n                if (r.message) {\n                    let d = new frappe.ui.Dialog({\n                        title: 'Generate QR',\n                        fields: [{\n                            label: 'QR Preview',\n                            fieldname: 'html',\n                            fieldtype: 'HTML',\n                            options: r.message // set HTML from backend\n                        }, ],\n                        primary_action_label: 'Download',\n                        primary_action(values) {\n                            frappe.call({\n                                method: \"onegene.onegene.utils.get_qid_for_job_card_from_child_row\",\n                                args: {\n                                    parent: parent_name,\n                                    child_doctype: cdt,\n                                    child_name: row.name\n                                },\n                                callback(res) {\n                                    if (res.message) {\n                                        window.open(res.message); // open PDF link\n                                    }\n                                }\n                            });\n                            d.hide();\n                        }\n                    });\n\n                    d.show();\n                }\n            }\n        });\n        \n        \n    });\n        \n        // if (!frm.doc.__islocal && frm.doc.status != 'Completed') {\n        //     frm.add_custom_button(__('Cancel'), function() {\n\n        //         frm.set_value(\"custom_cancelled\",1)\n        //         frm.set_value(\"status\", \"Cancelled\"); \n        //         frm.save()\n\n        //     });\n        // }\n        \n        if (frm.doc.custom_cancelled == 1) {\n\n            frm.meta.fields.forEach(field => {\n                frm.set_df_property(field.fieldname, \"read_only\", 1);\n            });\n\n\n\n            frm.page.clear_actions_menu();\n            frm.clear_custom_buttons();\n            frm.disable_save();\n\n        }\n\n\n\n        if (!frm.doc.__islocal) {\n\n            frappe.call({\n                method: \"onegene.onegene.custom.get_raw_materials_for_jobcard_on_mt\",\n                args: {\n                    name: frm.doc.name,\n                    disable_save: true\n                },\n            });\n        }\n        frm.set_query('workstation', function() {\n            return {\n                query: 'onegene.onegene.custom.get_warehouses',\n                filters: {\n                    name: frm.doc.operation\n                }\n            };\n        });\n        if (flt(frm.doc.custom_possible_qty) > 0 && (frm.doc.docstatus == 0) && (frm.doc.custom_cancelled == 0)) {\n            frm.add_custom_button(__(\"Entry\"), async () => {\n                let to_transfer = frm.doc.items.some((row) => row.transferred_qty < row.required_qty);\n                if (to_transfer) {\n                    const materials = frm.doc.custom_required_material_for_operation || [];\n                    const warehouse_map = {};\n                    await Promise.all(\n                        materials.map(row =>\n                            frappe.db.get_value(\"Item\", row.item_code, \"custom_warehouse\").then(res => {\n                                if (res.message.custom_warehouse && res.message.custom_warehouse.includes(\"Semi Finished Goods - WAIP\", \"Finished Goods - WAIP\")) {\n                                    warehouse_map[row.item_code] = res.message.custom_warehouse;\n                                } else {\n                                    warehouse_map[row.item_code] = \"Shop Floor - WAIP\"\n                                }\n                            })\n                        )\n                    );\n                    let data = frm.doc.custom_required_material_for_operation ?\n                        frm.doc.custom_required_material_for_operation.filter(row => row.stock_qty > 0) // only keep rows with stock\n                        .map(row => {\n                            const matching_item = frm.doc.items.find(it => it.item_code === row.item_code && it.transferred_qty < it.required_qty);\n                            return {\n                                item_code: row.item_code,\n                                item_name: row.item_name,\n                                available_qty: row.stock_qty,\n                                total_required_qty: row.total_required_qty,\n                                available_transfer_qty: matching_item ?\n                                    ((matching_item.required_qty - matching_item.transferred_qty) <= row.stock_qty ?\n                                        (matching_item.required_qty - matching_item.transferred_qty) :\n                                        row.stock_qty) : 0,\n                                // s_warehouse: matching_item ? matching_item.source_warehouse : \"SFS - WAIP\",\n                                s_warehouse: warehouse_map[row.item_code],\n                                t_warehouse: frm.doc.wip_warehouse ? frm.doc.wip_warehouse : \"Work In Progress - WAIP\"\n                            };\n\n                        })\n                        .filter(row => row.available_transfer_qty > 0) :\n                        [];\n                    if (data.length > 0) {\n                        frappe.call({\n                            method: \"erpnext.manufacturing.doctype.job_card.job_card.make_stock_entry_new\",\n                            args: {\n                                source_name: frm.doc.name,\n                                items: data\n                            },\n                            freeze: true,\n                            freeze_message: \"Tranferring Materials to WIP ...\",\n                            callback: function(r) {\n                                if (r.message) {\n                                    // \t\tfrappe.msgprint(`Stock Entry <a href=\"/app/stock-entry/${r.message}\" target=\"_blank\">${r.message}</a> created.`);\n                                    frappe.call({\n                                        method: \"onegene.onegene.custom.get_raw_materials_for_jobcard_on_mt\",\n                                        args: {\n                                            name: frm.doc.name,\n                                        },\n                                        freeze: true,\n                                        freeze_message: \"Tranferring Materials to WIP ...\",\n                                    })\n                                    let d = new frappe.ui.Dialog({\n                                        title: __('Enter Details'),\n                                        fields: [{\n                                                fieldtype: 'Section Break',\n                                                label: __('Employee Details'),\n                                            },\n                                            {\n                                                fieldtype: 'Column Break',\n                                            },\n                                            {\n                                                fieldtype: 'Link',\n                                                label: __('Employee'),\n                                                fieldname: 'employee',\n                                                options: 'Employee',\n                                                reqd: 1,\n                                                change: function() {\n                                                    getEmployeeDepartment();\n                                                    getEmployeeName();\n                                                }\n                                            },\n                                            {\n                                                fieldtype: 'Link',\n                                                label: __('Supervisor'),\n                                                fieldname: 'supervisor',\n                                                options: 'Employee',\n                                                reqd: 1,\n                                                read_only: 1,\n                                                change: function() {\n                                                    getSupervisorName();\n                                                }\n                                            },\n                                            {\n                                                fieldtype: 'Link',\n                                                label: __('Department'),\n                                                fieldname: 'department',\n                                                options: 'Department',\n                                                read_only: 1,\n                                            },\n                                            {\n                                                fieldtype: 'Column Break',\n                                            },\n                                            {\n                                                fieldtype: 'Data',\n                                                label: __('Employee Name'),\n                                                fieldname: 'employee_name',\n                                                reqd: 1,\n                                            },\n                                            {\n                                                fieldtype: 'Data',\n                                                label: __('Supervisor Name'),\n                                                fieldname: 'supervisor_name',\n                                                read_only: 1,\n                                                reqd: 1\n                                            },\n                                            {\n                                                fieldtype: 'Link',\n                                                label: __('Shift Type'),\n                                                fieldname: 'shift',\n                                                options: 'Shift Type',\n                                                reqd: 1,\n                                                change: function() {\n                                                    validateShift();\n                                                }\n                                            },\n                                            {\n                                                fieldtype: 'Section Break',\n                                                label: __('Operation & Workstation'),\n                                            },\n                                            {\n                                                fieldtype: 'Column Break',\n                                            },\n                                            {\n                                                fieldtype: 'Link',\n                                                label: __('Operation'),\n                                                fieldname: 'operation',\n                                                default: frm.doc.operation,\n                                                options: 'Operation',\n                                                read_only: 1\n                                            },\n                                            {\n                                                fieldtype: 'Column Break',\n                                            },\n                                            {\n                                                fieldtype: 'Link',\n                                                label: __('Workstation'),\n                                                fieldname: 'workstation',\n                                                default: frm.doc.workstation,\n                                                options: 'Workstation',\n                                                reqd: 1\n                                            },\n                                            {\n                                                fieldtype: 'Section Break',\n                                                label: __('Production Process'),\n                                            },\n                                            {\n                                                fieldtype: 'Column Break',\n                                            },\n                                            {\n                                                fieldtype: 'Int',\n                                                label: __('<b style=\"color: #4169e1;\">Possible to Production</b>'),\n                                                fieldname: 'possible_qty',\n                                                default: frm.doc.custom_possible_qty,\n                                                read_only: 1\n                                            },\n                                            {\n                                                fieldtype: 'Int',\n                                                label: __('Processed Quantity'),\n                                                fieldname: 'processed_qty',\n                                                // default: frm.doc.for_quantity - frm.doc.total_completed_qty - frm.doc.custom_rejected_qty - frm.doc.custom_rework_rejected_qty,\n                                                read_only: 0,\n                                                reqd: 1\n                                            },\n                                            {\n                                                fieldtype: 'Int',\n                                                label: __('<span style=\"color: green;\">Accepted Quantity</span>'),\n                                                default: 0,\n                                                fieldname: 'qty',\n                                            },\n                                            {\n                                                fieldtype: 'Column Break',\n                                            },\n                                            {\n                                                fieldtype: 'Int',\n                                                label: __('<span style=\"color: red;\">Rejected Quantity</span>'),\n                                                fieldname: 'rejected_qty'\n                                            },\n                                            {\n                                                fieldtype: 'Link',\n                                                label: __('Rejection Category'),\n                                                fieldname: 'rejection_category',\n                                                options: 'Rejection Category',\n                                                depends_on: 'eval:doc.rejected_qty',\n                                                mandatory_depends_on: 'eval:doc.rejected_qty'\n                                            },\n                                            {\n                                                fieldtype: 'Link',\n                                                label: __('Rejection Reason'),\n                                                fieldname: 'rejection_remarks',\n                                                options: 'Rejection Reason',\n                                                depends_on: 'eval:doc.rejected_qty',\n                                                mandatory_depends_on: 'eval:doc.rejected_qty'\n                                            },\n                                            {\n                                                fieldtype: 'Int',\n                                                label: __('<span style=\"color: orange;\">Rework Quantity</span>'),\n                                                fieldname: 'rework_qty'\n                                            },\n                                            {\n                                                fieldtype: 'Link',\n                                                label: __('Rework Category'),\n                                                fieldname: 'rework_category',\n                                                options: 'Rework Category',\n                                                depends_on: 'eval:doc.rework_qty',\n                                                mandatory_depends_on: 'eval:doc.rework_qty'\n                                            },\n                                            {\n                                                fieldtype: 'Link',\n                                                label: __('Rework Reason'),\n                                                fieldname: 'rework_remarks',\n                                                options: 'Rework Reason',\n                                                depends_on: 'eval:doc.rework_qty',\n                                                mandatory_depends_on: 'eval:doc.rework_qty'\n                                            },\n                                        ],\n                                        primary_action_label: __('Submit'),\n                                        primary_action(values) {\n                                            let processed_qty = values.processed_qty\n                                            let accepted_qty = values.qty || 0\n                                            let rejected_qty = values.rejected_qty || 0\n                                            let rework_qty = values.rework_qty || 0\n\n                                            if (accepted_qty > processed_qty) {\n                                                frappe.msgprint({\n                                                    title: __('Invalid Quantity'),\n                                                    indicator: 'red',\n                                                    message: `<span style=\"color: red;\">${__('Accepted Quantity cannot be more than Processed Quantity.')}</span>`\n                                                });\n                                                frappe.msgprint({\n                                                    title: __('தவறான அளவு'),\n                                                    indicator: 'red',\n                                                    message: `<span style=\"color: red;\">${__('ஏற்றுக்கொள்ளப்பட்ட அளவு செயலாக்கப்பட்ட அளவுக்கு மேல் இருக்க முடியாது.')}</span>`\n                                                });\n                                            } else if (processed_qty > frm.doc.for_quantity) {\n                                                frappe.msgprint({\n                                                    title: __('Invalid Quantity'),\n                                                    indicator: 'red',\n                                                    message: `<span style=\"color: red;\">${__('Processed Quantity cannot be more than Qty To Manufacture')}</span>`\n                                                });\n                                                frappe.msgprint({\n                                                    title: __('தவறான அளவு'),\n                                                    indicator: 'red',\n                                                    message: `<span style=\"color: red;\">${__('செயலாக்கப்பட்ட அளவு தயாரிக்க வேண்டிய அளவைவிட அதிகமாக இருக்க முடியாது')}</span>`\n                                                });\n\n                                            } else if (processed_qty !== (accepted_qty + rejected_qty + rework_qty)) {\n                                                frappe.msgprint({\n                                                    title: __('Invalid Quantity'),\n                                                    indicator: 'red',\n                                                    message: `<span style=\"color: red;\">${__('Processed Quantity must be equal to the sum of Accepted, Rejected and Rework Quantities.')}</span>`\n                                                });\n                                                frappe.msgprint({\n                                                    title: __('தவறான அளவு'),\n                                                    indicator: 'red',\n                                                    message: `<span style=\"color: red;\">${__('செயலாக்கப்பட்ட அளவு, ஏற்றுக்கொள்ளப்பட்ட, மறுக்கப்பட்ட மற்றும் மீள்செய்யும் அளவுகளின் கூட்டுத் தொகைக்கு சமமாக இருக்க வேண்டும்.')}</span>`\n                                                });\n                                            } else {\n                                                const args = {\n                                                    processed_qty: processed_qty,\n                                                    rejected_qty: rejected_qty,\n                                                    rejection_remarks: rejected_qty > 0 ? values.rejection_remarks : null,\n                                                    rework_qty: rework_qty,\n                                                    rework_remarks: rework_qty > 0 ? values.rework_remarks : null,\n                                                    job_card_id: frm.doc.name,\n                                                    accepted_qty: accepted_qty,\n                                                    employee: values.employee,\n                                                    shift: values.shift,\n                                                    workstation: values.workstation,\n                                                    rejection_category: values.rejection_category,\n                                                    department: values.department,\n                                                    supervisor: values.supervisor,\n                                                    rework_category: values.rework_category,\n                                                };\n                                                frappe.call({\n                                                    method: \"onegene.onegene.custom.job_card_process_entry\",\n                                                    args: {\n                                                        args: args\n                                                    },\n                                                    freeze: true,\n                                                    callback: function(r) {\n                                                        if (r.message) {\n                                                            cur_frm.reload_doc();\n                                                        }\n                                                        d.hide();\n                                                    }\n                                                });\n                                            }\n                                        }\n                                    });\n                                    d.fields_dict.workstation.get_query = () => {\n                                        return {\n                                            query: \"onegene.onegene.custom.get_warehouses\",\n                                            filters: {\n                                                name: frm.doc.operation\n                                            }\n                                        };\n                                    };\n                                    d.fields_dict.rejection_remarks.get_query = () => {\n                                        return {\n                                            query: \"onegene.onegene.custom.get_rejection_reason\",\n                                            filters: {\n                                                rejection_category: d.get_value('rejection_category')\n                                            }\n                                        };\n                                    };\n                                    d.fields_dict.rework_remarks.get_query = () => {\n                                        return {\n                                            query: \"onegene.onegene.custom.get_rework_reason\",\n                                            filters: {\n                                                rework_category: d.get_value('rework_category')\n                                            }\n                                        };\n                                    };\n                                    d.show();\n\n                                    function getEmployeeDepartment() {\n                                        frappe.db.get_value(\"Employee\", {\n                                                \"name\": d.get_value(\"employee\")\n                                            }, \"department\")\n                                            .then(r => {\n                                                d.set_value(\"department\", r.message ? r.message.department : '');\n                                                autoSetSupervisor();\n                                            });\n                                    }\n\n                                    function getEmployeeName() {\n                                        frappe.db.get_value(\"Employee\", {\n                                                \"name\": d.get_value(\"employee\")\n                                            }, \"employee_name\")\n                                            .then(r => {\n                                                d.set_value(\"employee_name\", r.message ? r.message.employee_name : '');\n                                            });\n                                    }\n\n\n                                    function recalculateAcceptedQty() {\n                                        const processed = flt(d.get_value(\"processed_qty\"));\n                                        const accepted = processed;\n                                        d.set_value(\"qty\", accepted >= 0 ? accepted : 0);\n                                    }\n\n                                    function validateProcessedQty() {\n                                        const processed = flt(d.get_value(\"processed_qty\"));\n                                        const possible = flt(d.get_value(\"possible_qty\"));\n                                        const qty = flt(d.get_value(\"qty\"));\n                                        if (processed > possible) {\n                                            frappe.msgprint({\n                                                message: `<span style=\"color: red;\">Processed Quantity cannot be greater than the Possible to Production</span>`,\n                                                indicator: \"red\"\n                                            });\n                                            frappe.msgprint({\n                                                message: `<span style=\"color: red;\">செயலாக்கப்பட்ட அளவு தயாரிப்பிற்கு சாத்தியமான அளவைவிட அதிகமாக இருக்க முடியாது</span>`,\n                                                indicator: \"red\"\n                                            });\n                                            d.set_value(\"processed_qty\", 0);\n                                        }\n\n                                        if (qty > processed) {\n                                            frappe.msgprint({\n                                                message: `<span style=\"color: red;\">Accepted Quantity cannot be greater than the Processed Quantity</span>`,\n                                                indicator: \"red\"\n                                            });\n                                            frappe.msgprint({\n                                                message: `<span style=\"color: red;\">ஏற்றுக்கொள்ளப்பட்ட அளவு செயலாக்கப்பட்ட அளவுக்கு மேல் இருக்க முடியாது</span>`,\n                                                indicator: \"red\"\n                                            });\n\n                                            d.set_value(\"qty\", 0);\n                                        }\n\n                                    }\n\n                                    function validateAcceptedQty() {\n                                        const processed = flt(d.get_value(\"qty\"));\n                                        const possible = flt(d.get_value(\"possible_qty\"));\n                                        if (processed > possible) {\n                                            frappe.msgprint({\n                                                message: `<span style=\"color: red;\">Processed Quantity cannot be greater than the Possible to Production</span>`,\n                                                indicator: \"red\"\n                                            });\n                                            frappe.msgprint({\n                                                message: `<span style=\"color: red;\">செயலாக்கப்பட்ட அளவு தயாரிக்க சாத்தியமான அளவைவிட அதிகமாக இருக்க முடியாது</span>`,\n                                                indicator: \"red\"\n                                            });\n\n                                            d.set_value(\"processed_qty\", 0);\n                                        }\n\n                                    }\n\n                                    function validateRejectedQty() {\n                                        frappe.db.get_value(\"Item\", frm.doc.production_item, \"rejection_allowance\").then(r => {\n                                            let rejection_allowance_percent = r.message.rejection_allowance || 0;\n                                            let max_allowed_rejection = (frm.doc.for_quantity || 0) * (rejection_allowance_percent / 100);\n                                            let total_rejected_qty = (frm.doc.custom_rejected_qty || 0) + (flt(d.get_value(\"rejected_qty\")) || 0);\n                                            if (total_rejected_qty > max_allowed_rejection) {\n                                                frappe.msgprint({\n                                                    message: `<span style=\"color: red;\">${__('Total Rejected Quantity (' + total_rejected_qty + ') exceeds the Rejection Allowance (' + rejection_allowance_percent + '% = ' + max_allowed_rejection + ' units).')}</span>`,\n                                                    indicator: 'red'\n                                                });\n                                                frappe.msgprint({\n                                                    message: `<span style=\"color: red;\">${__('மொத்த மறுக்கப்பட்ட அளவு (' + total_rejected_qty + ') மறுக்கும் அனுமதி (' + rejection_allowance_percent + '% = ' + max_allowed_rejection + ' யூனிட்கள்) ஐ மீறுகிறது.')}</span>`,\n                                                    indicator: 'red'\n                                                });\n\n                                            }\n\n                                        })\n\n                                    }\n\n                                    function recalculateRejectedQty() {\n                                        const processed = flt(d.get_value(\"processed_qty\"));\n                                        const accepted = flt(d.get_value(\"qty\"));\n                                        const rework = flt(d.get_value(\"rework_qty\"));\n                                        const rejected = processed - accepted - rework;\n                                        d.set_value(\"rejected_qty\", rejected >= 0 ? rejected : 0);\n                                    }\n\n                                    function recalculateReworkQty() {\n                                        const processed = flt(d.get_value(\"processed_qty\"));\n                                        const accepted = flt(d.get_value(\"qty\"));\n                                        const rejected = flt(d.get_value(\"rejected_qty\"));\n                                        const rework = processed - accepted - rejected;\n                                        d.set_value(\"rework_qty\", rework >= 0 ? rework : 0);\n                                    }\n\n                                    function validateShift() {\n                                        let shift = d.get_value(\"shift\");\n                                        if (shift) {\n                                            frappe.call({\n                                                method: \"onegene.onegene.custom.get_shift_for_current_time\",\n                                                callback: function(r) {\n                                                    if (r.message) {\n                                                        const shift_list = r.message\n                                                            .map(s => s[0])\n                                                            .filter(v => v);\n                                                        if (shift && !shift_list.includes(shift)) {\n                                                            d.set_value(\"shift\", \"\");\n                                                        }\n                                                    }\n                                                }\n                                            });\n                                        }\n                                    }\n\n                                    // Bind accepted_qty to update rework_qty\n                                    d.get_field(\"processed_qty\").$wrapper.find(\"input\").on(\"input\", () => {\n                                        // recalculateAcceptedQty();\n                                        validateProcessedQty();\n                                    });\n                                    d.get_field(\"qty\").$wrapper.find(\"input\").on(\"input\", () => {\n                                        // recalculateAcceptedQty();\n                                        validateProcessedQty();\n                                    });\n\n                                    // Bind accepted_qty and rework_qty to update rejected_qty\n                                    [\"qty\"].forEach(fieldname => {\n                                        d.get_field(fieldname).$wrapper.find(\"input\").on(\"input\", () => {\n                                            // recalculateRejectedQty();\n                                        });\n                                    });\n\n                                    // Bind rejected_qty to update rework_qty\n                                    d.get_field(\"rejected_qty\").$wrapper.find(\"input\").on(\"input\", () => {\n                                        recalculateReworkQty();\n                                        validateRejectedQty();\n                                    });\n\n                                    d.fields_dict.shift.get_query = () => {\n                                        return {\n                                            query: \"onegene.onegene.custom.get_shift_for_current_time\",\n                                        };\n                                    };\n\n                                    d.fields_dict.supervisor.get_query = () => {\n                                        return {\n                                            query: \"onegene.onegene.custom.get_supervisor\",\n                                            filters: {\n                                                department: d.get_value('department')\n                                            }\n                                        };\n                                    };\n\n                                    function getSupervisorName() {\n                                        frappe.call({\n                                            method: \"onegene.onegene.custom.get_supervisor_name\",\n                                            args: {\n                                                supervisor: d.get_value('supervisor'),\n                                            },\n                                            callback: function(r) {\n                                                if (r.message) {\n                                                    d.set_value('supervisor_name', r.message);\n                                                }\n                                            }\n                                        });\n                                    }\n\n                                    function autoSetSupervisor() {\n                                        frappe.call({\n                                            method: \"onegene.onegene.custom.get_supervisor\",\n                                            args: {\n                                                doctype: \"Employee\",\n                                                txt: \"\",\n                                                searchfield: \"name\",\n                                                start: 0,\n                                                page_len: 20,\n                                                filters: {\n                                                    department: d.get_value('department')\n                                                }\n                                            },\n                                            callback: function(r) {\n                                                if (r.message && r.message.length === 1) {\n                                                    d.set_value(\"supervisor\", r.message[0][0]);\n                                                    d.set_value(\"supervisor_name\", r.message[0][1]);\n\n                                                }\n                                            }\n                                        });\n                                    }\n\n                                }\n                            }\n                        })\n                    } else {\n                        let d = new frappe.ui.Dialog({\n                            title: __('Enter Details'),\n                            fields: [{\n                                    fieldtype: 'Section Break',\n                                    label: __('Employee Details'),\n                                },\n                                {\n                                    fieldtype: 'Column Break',\n                                },\n                                {\n                                    fieldtype: 'Link',\n                                    label: __('Employee'),\n                                    fieldname: 'employee',\n                                    options: 'Employee',\n                                    reqd: 1,\n                                    change: function() {\n                                        getEmployeeDepartment();\n                                        getEmployeeName();\n                                    }\n                                },\n                                {\n                                    fieldtype: 'Link',\n                                    label: __('Supervisor'),\n                                    fieldname: 'supervisor',\n                                    options: 'Employee',\n                                    reqd: 1,\n                                    read_only: 1,\n                                    change: function() {\n                                        getSupervisorName();\n                                    }\n                                },\n                                {\n                                    fieldtype: 'Link',\n                                    label: __('Department'),\n                                    fieldname: 'department',\n                                    options: 'Department',\n                                    read_only: 1,\n                                },\n                                {\n                                    fieldtype: 'Column Break',\n                                },\n                                {\n                                    fieldtype: 'Data',\n                                    label: __('Employee Name'),\n                                    fieldname: 'employee_name',\n                                    reqd: 1,\n                                },\n                                {\n                                    fieldtype: 'Data',\n                                    label: __('Supervisor Name'),\n                                    fieldname: 'supervisor_name',\n                                    read_only: 1,\n                                    reqd: 1\n                                },\n                                {\n                                    fieldtype: 'Link',\n                                    label: __('Shift Type'),\n                                    fieldname: 'shift',\n                                    options: 'Shift Type',\n                                    reqd: 1,\n                                    change: function() {\n                                        validateShift();\n                                    }\n                                },\n                                {\n                                    fieldtype: 'Section Break',\n                                    label: __('Operation & Workstation'),\n                                },\n                                {\n                                    fieldtype: 'Column Break',\n                                },\n                                {\n                                    fieldtype: 'Link',\n                                    label: __('Operation'),\n                                    fieldname: 'operation',\n                                    default: frm.doc.operation,\n                                    options: 'Operation',\n                                    read_only: 1\n                                },\n                                {\n                                    fieldtype: 'Column Break',\n                                },\n                                {\n                                    fieldtype: 'Link',\n                                    label: __('Workstation'),\n                                    fieldname: 'workstation',\n                                    default: frm.doc.workstation,\n                                    options: 'Workstation',\n                                    reqd: 1\n                                },\n                                {\n                                    fieldtype: 'Section Break',\n                                    label: __('Production Process'),\n                                },\n                                {\n                                    fieldtype: 'Column Break',\n                                },\n                                {\n                                    fieldtype: 'Int',\n                                    label: __('<b style=\"color: #4169e1;\">Possible to Production</b>'),\n                                    fieldname: 'possible_qty',\n                                    default: frm.doc.custom_possible_qty,\n                                    read_only: 1\n                                },\n                                {\n                                    fieldtype: 'Int',\n                                    label: __('Processed Quantity'),\n                                    fieldname: 'processed_qty',\n                                    // default: frm.doc.for_quantity - frm.doc.total_completed_qty - frm.doc.custom_rejected_qty - frm.doc.custom_rework_rejected_qty,\n                                    read_only: 0,\n                                    reqd: 1\n                                },\n                                {\n                                    fieldtype: 'Int',\n                                    label: __('<span style=\"color: green;\">Accepted Quantity</span>'),\n                                    default: 0,\n                                    fieldname: 'qty',\n                                },\n                                {\n                                    fieldtype: 'Column Break',\n                                },\n                                {\n                                    fieldtype: 'Int',\n                                    label: __('<span style=\"color: red;\">Rejected Quantity</span>'),\n                                    fieldname: 'rejected_qty'\n                                },\n                                {\n                                    fieldtype: 'Link',\n                                    label: __('Rejection Category'),\n                                    fieldname: 'rejection_category',\n                                    options: 'Rejection Category',\n                                    depends_on: 'eval:doc.rejected_qty',\n                                    mandatory_depends_on: 'eval:doc.rejected_qty'\n                                },\n                                {\n                                    fieldtype: 'Link',\n                                    label: __('Rejection Reason'),\n                                    fieldname: 'rejection_remarks',\n                                    options: 'Rejection Reason',\n                                    depends_on: 'eval:doc.rejected_qty',\n                                    mandatory_depends_on: 'eval:doc.rejected_qty'\n                                },\n                                {\n                                    fieldtype: 'Int',\n                                    label: __('<span style=\"color: orange;\">Rework Quantity</span>'),\n                                    fieldname: 'rework_qty'\n                                },\n                                {\n                                    fieldtype: 'Link',\n                                    label: __('Rework Category'),\n                                    fieldname: 'rework_category',\n                                    options: 'Rework Category',\n                                    depends_on: 'eval:doc.rework_qty',\n                                    mandatory_depends_on: 'eval:doc.rework_qty'\n                                },\n                                {\n                                    fieldtype: 'Link',\n                                    label: __('Rework Reason'),\n                                    fieldname: 'rework_remarks',\n                                    options: 'Rework Reason',\n                                    depends_on: 'eval:doc.rework_qty',\n                                    mandatory_depends_on: 'eval:doc.rework_qty'\n                                },\n                            ],\n                            primary_action_label: __('Submit'),\n                            primary_action(values) {\n                                let processed_qty = values.processed_qty || 0\n                                let accepted_qty = values.qty || 0\n                                let rejected_qty = values.rejected_qty || 0\n                                let rework_qty = values.rework_qty || 0\n\n                                if (accepted_qty > processed_qty) {\n                                    frappe.msgprint({\n                                        title: __('Invalid Quantity'),\n                                        indicator: 'red',\n                                        message: `<span style=\"color: red;\">${__('Accepted Quantity cannot be more than Processed Quantity.')}</span>`\n                                    });\n                                    frappe.msgprint({\n                                        title: __('தவறான அளவு'),\n                                        indicator: 'red',\n                                        message: `<span style=\"color: red;\">${__('ஏற்றுக்கொள்ளப்பட்ட அளவு செயலாக்கப்பட்ட அளவுக்கு மேல் இருக்க முடியாது.')}</span>`\n                                    });\n\n                                } else if (processed_qty > frm.doc.for_quantity) {\n                                    frappe.msgprint({\n                                        title: __('Invalid Quantity'),\n                                        indicator: 'red',\n                                        message: `<span style=\"color: red;\">${__('Processed Quantity cannot be more than Qty To Manufacture')}</span>`\n                                    });\n                                    frappe.msgprint({\n                                        title: __('தவறான அளவு'),\n                                        indicator: 'red',\n                                        message: `<span style=\"color: red;\">${__('செயலாக்கப்பட்ட அளவு தயாரிக்க வேண்டிய அளவைவிட அதிகமாக இருக்க முடியாது')}</span>`\n                                    });\n\n                                } else if (processed_qty !== (accepted_qty + rejected_qty + rework_qty)) {\n                                    frappe.msgprint({\n                                        title: __('Invalid Quantity'),\n                                        indicator: 'red',\n                                        message: `<span style=\"color: red;\">${__('Processed Quantity must be equal to the sum of Accepted, Rejected and Rework Quantities.')}</span>`\n                                    });\n                                    frappe.msgprint({\n                                        title: __('தவறான அளவு'),\n                                        indicator: 'red',\n                                        message: `<span style=\"color: red;\">${__('செயலாக்கப்பட்ட அளவு, ஏற்றுக்கொள்ளப்பட்ட, மறுக்கப்பட்ட மற்றும் மீள்செய்யும் அளவுகளின் கூட்டுத் தொகைக்கு சமமாக இருக்க வேண்டும்.')}</span>`\n                                    });\n\n                                } else {\n                                    const args = {\n                                        processed_qty: processed_qty,\n                                        rejected_qty: rejected_qty,\n                                        rejection_remarks: rejected_qty > 0 ? values.rejection_remarks : null,\n                                        rework_qty: rework_qty,\n                                        rework_remarks: rework_qty > 0 ? values.rework_remarks : null,\n                                        job_card_id: frm.doc.name,\n                                        accepted_qty: accepted_qty,\n                                        employee: values.employee,\n                                        shift: values.shift,\n                                        workstation: values.workstation,\n                                        rejection_category: values.rejection_category,\n                                        department: values.department,\n                                        supervisor: values.supervisor,\n                                        rework_category: values.rework_category,\n                                    };\n                                    frappe.call({\n                                        method: \"onegene.onegene.custom.job_card_process_entry\",\n                                        args: {\n                                            args: args\n                                        },\n                                        freeze: true,\n                                        callback: function(r) {\n                                            if (r.message) {\n                                                cur_frm.reload_doc();\n                                            }\n                                            d.hide();\n                                        }\n                                    });\n                                }\n                            }\n                        });\n                        d.fields_dict.workstation.get_query = () => {\n                            return {\n                                query: \"onegene.onegene.custom.get_warehouses\",\n                                filters: {\n                                    name: frm.doc.operation\n                                }\n                            };\n                        };\n                        d.fields_dict.rejection_remarks.get_query = () => {\n                            return {\n                                query: \"onegene.onegene.custom.get_rejection_reason\",\n                                filters: {\n                                    rejection_category: d.get_value('rejection_category')\n                                }\n                            };\n                        };\n                        d.fields_dict.rework_remarks.get_query = () => {\n                            return {\n                                query: \"onegene.onegene.custom.get_rework_reason\",\n                                filters: {\n                                    rework_category: d.get_value('rework_category')\n                                }\n                            };\n                        };\n                        d.show();\n\n                        function getEmployeeDepartment() {\n                            frappe.db.get_value(\"Employee\", {\n                                    \"name\": d.get_value(\"employee\")\n                                }, \"department\")\n                                .then(r => {\n                                    d.set_value(\"department\", r.message ? r.message.department : '');\n                                    autoSetSupervisor();\n                                });\n                        }\n\n                        function getEmployeeName() {\n                            frappe.db.get_value(\"Employee\", {\n                                    \"name\": d.get_value(\"employee\")\n                                }, \"employee_name\")\n                                .then(r => {\n                                    d.set_value(\"employee_name\", r.message ? r.message.employee_name : '');\n                                });\n                        }\n\n                        function recalculateAcceptedQty() {\n                            const processed = flt(d.get_value(\"processed_qty\"));\n                            const accepted = processed;\n                            d.set_value(\"qty\", accepted >= 0 ? accepted : 0);\n                        }\n\n                        function validateProcessedQty() {\n                            const processed = flt(d.get_value(\"processed_qty\"));\n                            const possible = flt(d.get_value(\"possible_qty\"));\n                            const qty = flt(d.get_value(\"qty\"));\n                            if (processed > possible) {\n                                frappe.msgprint({\n                                    message: `<span style=\"color: red;\">Processed Quantity cannot be greater than the Possible to Production</span>`,\n                                    indicator: \"red\"\n                                });\n                                frappe.msgprint({\n                                    message: `<span style=\"color: red;\">செயலாக்கப்பட்ட அளவு தயாரிப்பிற்கு சாத்தியமான அளவைவிட அதிகமாக இருக்க முடியாது</span>`,\n                                    indicator: \"red\"\n                                });\n\n                                d.set_value(\"processed_qty\", 0);\n                            }\n\n                            if (qty > processed) {\n                                frappe.msgprint({\n                                    message: `<span style=\"color: red;\">Accepted Quantity cannot be greater than the Processed Quantity</span>`,\n                                    indicator: \"red\"\n                                });\n                                frappe.msgprint({\n                                    message: `<span style=\"color: red;\">ஏற்றுக்கொள்ளப்பட்ட அளவு செயலாக்கப்பட்ட அளவுக்கு மேல் இருக்க முடியாது</span>`,\n                                    indicator: \"red\"\n                                });\n\n                                d.set_value(\"qty\", 0);\n                            }\n\n                        }\n\n                        function validateRejectedQty() {\n                            frappe.db.get_value(\"Item\", frm.doc.production_item, \"rejection_allowance\").then(r => {\n                                let rejection_allowance_percent = r.message.rejection_allowance || 0;\n                                let max_allowed_rejection = (frm.doc.for_quantity || 0) * (rejection_allowance_percent / 100);\n                                let total_rejected_qty = (frm.doc.custom_rejected_qty || 0) + (flt(d.get_value(\"rejected_qty\")) || 0);\n                                if (total_rejected_qty > max_allowed_rejection) {\n                                    frappe.msgprint({\n                                        message: `<span style=\"color: red;\">${__('Total Rejected Quantity (' + total_rejected_qty + ') exceeds the Rejection Allowance (' + rejection_allowance_percent + '% = ' + max_allowed_rejection + ' units).')}</span>`,\n                                        indicator: 'red'\n                                    });\n                                    frappe.msgprint({\n                                        message: `<span style=\"color: red;\">${__('மொத்த மறுக்கப்பட்ட அளவு (' + total_rejected_qty + ') மறுக்கும் அனுமதி (' + rejection_allowance_percent + '% = ' + max_allowed_rejection + ' யூனிட்கள்) ஐ மீறுகிறது.')}</span>`,\n                                        indicator: 'red'\n                                    });\n\n                                }\n\n                            })\n                        }\n\n                        function recalculateRejectedQty() {\n                            const processed = flt(d.get_value(\"processed_qty\"));\n                            const accepted = flt(d.get_value(\"qty\"));\n                            const rework = flt(d.get_value(\"rework_qty\"));\n                            const rejected = processed - accepted - rework;\n                            d.set_value(\"rejected_qty\", rejected >= 0 ? rejected : 0);\n                        }\n\n                        function recalculateReworkQty() {\n                            const processed = flt(d.get_value(\"processed_qty\"));\n                            const accepted = flt(d.get_value(\"qty\"));\n                            const rejected = flt(d.get_value(\"rejected_qty\"));\n                            const rework = processed - accepted - rejected;\n                            d.set_value(\"rework_qty\", rework >= 0 ? rework : 0);\n                        }\n\n                        function validateShift() {\n                            let shift = d.get_value(\"shift\");\n                            if (shift) {\n                                frappe.call({\n                                    method: \"onegene.onegene.custom.get_shift_for_current_time\",\n                                    callback: function(r) {\n                                        if (r.message) {\n                                            const shift_list = r.message\n                                                .map(s => s[0])\n                                                .filter(v => v);\n                                            if (shift && !shift_list.includes(shift)) {\n                                                d.set_value(\"shift\", \"\");\n                                            }\n                                        }\n                                    }\n                                });\n                            }\n                        }\n\n                        // Bind accepted_qty to update rework_qty\n                        d.get_field(\"processed_qty\").$wrapper.find(\"input\").on(\"input\", () => {\n                            // recalculateAcceptedQty();\n                            validateProcessedQty();\n                        });\n                        d.get_field(\"qty\").$wrapper.find(\"input\").on(\"input\", () => {\n                            // recalculateAcceptedQty();\n                            validateProcessedQty();\n                        });\n\n                        // Bind accepted_qty and rework_qty to update rejected_qty\n                        [\"qty\"].forEach(fieldname => {\n                            d.get_field(fieldname).$wrapper.find(\"input\").on(\"input\", () => {\n                                // recalculateRejectedQty();\n                            });\n                        });\n\n                        // Bind rejected_qty to update rework_qty\n                        d.get_field(\"rejected_qty\").$wrapper.find(\"input\").on(\"input\", () => {\n                            recalculateReworkQty();\n                            validateRejectedQty();\n                        });\n                        d.fields_dict.shift.get_query = () => {\n                            return {\n                                query: \"onegene.onegene.custom.get_shift_for_current_time\",\n                            };\n                        };\n                        d.fields_dict.supervisor.get_query = () => {\n                            return {\n                                query: \"onegene.onegene.custom.get_supervisor\",\n                                filters: {\n                                    department: d.get_value('department')\n                                }\n                            };\n                        };\n\n                        function getSupervisorName() {\n                            frappe.call({\n                                method: \"onegene.onegene.custom.get_supervisor_name\",\n                                args: {\n                                    supervisor: d.get_value('supervisor'),\n                                },\n                                callback: function(r) {\n                                    if (r.message) {\n                                        d.set_value('supervisor_name', r.message);\n                                    }\n                                }\n                            });\n                        }\n\n                        function autoSetSupervisor() {\n                            frappe.call({\n                                method: \"onegene.onegene.custom.get_supervisor\",\n                                args: {\n                                    doctype: \"Employee\",\n                                    txt: \"\",\n                                    searchfield: \"name\",\n                                    start: 0,\n                                    page_len: 20,\n                                    filters: {\n                                        department: d.get_value('department')\n                                    }\n                                },\n                                callback: function(r) {\n                                    if (r.message && r.message.length === 1) {\n                                        d.set_value(\"supervisor\", r.message[0][0]);\n                                        d.set_value(\"supervisor_name\", r.message[0][1]);\n                                    }\n                                }\n                            });\n                        }\n                    }\n                } else {\n                    let d = new frappe.ui.Dialog({\n                        title: __('Enter Details'),\n                        fields: [{\n                                fieldtype: 'Section Break',\n                                label: __('Employee Details'),\n                            },\n                            {\n                                fieldtype: 'Column Break',\n                            },\n                            {\n                                fieldtype: 'Link',\n                                label: __('Employee'),\n                                fieldname: 'employee',\n                                options: 'Employee',\n                                reqd: 1,\n                                change: function() {\n                                    getEmployeeDepartment();\n                                    getEmployeeName();\n                                }\n                            },\n                            {\n                                fieldtype: 'Link',\n                                label: __('Supervisor'),\n                                fieldname: 'supervisor',\n                                options: 'Employee',\n                                reqd: 1,\n                                read_only: 1,\n                                change: function() {\n                                    getSupervisorName();\n                                }\n                            },\n                            {\n                                fieldtype: 'Link',\n                                label: __('Department'),\n                                fieldname: 'department',\n                                options: 'Department',\n                                read_only: 1,\n                            },\n                            {\n                                fieldtype: 'Column Break',\n                            },\n                            {\n                                fieldtype: 'Data',\n                                label: __('Employee Name'),\n                                fieldname: 'employee_name',\n                                reqd: 1,\n                            },\n                            {\n                                fieldtype: 'Data',\n                                label: __('Supervisor Name'),\n                                fieldname: 'supervisor_name',\n                                read_only: 1,\n                                reqd: 1\n                            },\n                            {\n                                fieldtype: 'Link',\n                                label: __('Shift Type'),\n                                fieldname: 'shift',\n                                options: 'Shift Type',\n                                reqd: 1,\n                                change: function() {\n                                    validateShift();\n                                }\n                            },\n                            {\n                                fieldtype: 'Section Break',\n                                label: __('Operation & Workstation'),\n                            },\n                            {\n                                fieldtype: 'Column Break',\n                            },\n                            {\n                                fieldtype: 'Link',\n                                label: __('Operation'),\n                                fieldname: 'operation',\n                                default: frm.doc.operation,\n                                options: 'Operation',\n                                read_only: 1\n                            },\n                            {\n                                fieldtype: 'Column Break',\n                            },\n                            {\n                                fieldtype: 'Link',\n                                label: __('Workstation'),\n                                fieldname: 'workstation',\n                                default: frm.doc.workstation,\n                                options: 'Workstation',\n                                reqd: 1\n                            },\n                            {\n                                fieldtype: 'Section Break',\n                                label: __('Production Process'),\n                            },\n                            {\n                                fieldtype: 'Column Break',\n                            },\n                            {\n                                fieldtype: 'Int',\n                                label: __('<b style=\"color: #4169e1;\">Possible to Production</b>'),\n                                fieldname: 'possible_qty',\n                                default: frm.doc.custom_possible_qty,\n                                read_only: 1\n                            },\n                            {\n                                fieldtype: 'Int',\n                                label: __('Processed Quantity'),\n                                fieldname: 'processed_qty',\n                                // default: frm.doc.for_quantity - frm.doc.total_completed_qty - frm.doc.custom_rejected_qty - frm.doc.custom_rework_rejected_qty,\n                                read_only: 0,\n                                reqd: 1\n                            },\n                            {\n                                fieldtype: 'Int',\n                                label: __('<span style=\"color: green;\">Accepted Quantity</span>'),\n                                default: 0,\n                                fieldname: 'qty',\n                            },\n                            {\n                                fieldtype: 'Column Break',\n                            },\n                            {\n                                fieldtype: 'Int',\n                                label: __('<span style=\"color: red;\">Rejected Quantity</span>'),\n                                fieldname: 'rejected_qty'\n                            },\n                            {\n                                fieldtype: 'Link',\n                                label: __('Rejection Category'),\n                                fieldname: 'rejection_category',\n                                options: 'Rejection Category',\n                                depends_on: 'eval:doc.rejected_qty',\n                                mandatory_depends_on: 'eval:doc.rejected_qty'\n                            },\n                            {\n                                fieldtype: 'Link',\n                                label: __('Rejection Reason'),\n                                fieldname: 'rejection_remarks',\n                                options: 'Rejection Reason',\n                                depends_on: 'eval:doc.rejected_qty',\n                                mandatory_depends_on: 'eval:doc.rejected_qty'\n                            },\n                            {\n                                fieldtype: 'Int',\n                                label: __('<span style=\"color: orange;\">Rework Quantity</span>'),\n                                fieldname: 'rework_qty'\n                            },\n                            {\n                                fieldtype: 'Link',\n                                label: __('Rework Category'),\n                                fieldname: 'rework_category',\n                                options: 'Rework Category',\n                                depends_on: 'eval:doc.rework_qty',\n                                mandatory_depends_on: 'eval:doc.rework_qty'\n                            },\n                            {\n                                fieldtype: 'Link',\n                                label: __('Rework Reason'),\n                                fieldname: 'rework_remarks',\n                                options: 'Rework Reason',\n                                depends_on: 'eval:doc.rework_qty',\n                                mandatory_depends_on: 'eval:doc.rework_qty'\n                            },\n                        ],\n                        primary_action_label: __('Submit'),\n                        primary_action(values) {\n                            let processed_qty = values.processed_qty || 0\n                            let accepted_qty = values.qty || 0\n                            let rejected_qty = values.rejected_qty || 0\n                            let rework_qty = values.rework_qty || 0\n                            if (accepted_qty > processed_qty) {\n                                frappe.msgprint({\n                                    title: __('Invalid Quantity'),\n                                    indicator: 'red',\n                                    message: `<span style=\"color: red;\">${__('Accepted Quantity cannot be more than Processed Quantity.')}</span>`\n                                });\n                                frappe.msgprint({\n                                    title: __('தவறான அளவு'),\n                                    indicator: 'red',\n                                    message: `<span style=\"color: red;\">${__('ஏற்றுக்கொள்ளப்பட்ட அளவு செயலாக்கப்பட்ட அளவுக்கு மேல் இருக்க முடியாது.')}</span>`\n                                });\n\n                            } else if (processed_qty > frm.doc.for_quantity) {\n                                frappe.msgprint({\n                                    title: __('Invalid Quantity'),\n                                    indicator: 'red',\n                                    message: `<span style=\"color: red;\">${__('Processed Quantity cannot be more than Qty To Manufacture')}</span>`\n                                });\n                                frappe.msgprint({\n                                    title: __('தவறான அளவு'),\n                                    indicator: 'red',\n                                    message: `<span style=\"color: red;\">${__('செயலாக்கப்பட்ட அளவு தயாரிக்க வேண்டிய அளவைவிட அதிகமாக இருக்க முடியாது')}</span>`\n                                });\n\n                            } else if (processed_qty !== (accepted_qty + rejected_qty + rework_qty)) {\n                                frappe.msgprint({\n                                    title: __('Invalid Quantity'),\n                                    indicator: 'red',\n                                    message: `<span style=\"color: red;\">${__('Processed Quantity must be equal to the sum of Accepted, Rejected and Rework Quantities.')}</span>`\n                                });\n                                frappe.msgprint({\n                                    title: __('தவறான அளவு'),\n                                    indicator: 'red',\n                                    message: `<span style=\"color: red;\">${__('செயலாக்கப்பட்ட அளவு, ஏற்றுக்கொள்ளப்பட்ட, மறுக்கப்பட்ட மற்றும் மீள்செய்யும் அளவுகளின் கூட்டுத் தொகைக்கு சமமாக இருக்க வேண்டும்.')}</span>`\n                                });\n\n                            } else {\n                                const args = {\n                                    processed_qty: processed_qty,\n                                    rejected_qty: rejected_qty,\n                                    rejection_remarks: rejected_qty > 0 ? values.rejection_remarks : null,\n                                    rework_qty: rework_qty,\n                                    rework_remarks: rework_qty > 0 ? values.rework_remarks : null,\n                                    job_card_id: frm.doc.name,\n                                    accepted_qty: accepted_qty,\n                                    employee: values.employee,\n                                    shift: values.shift,\n                                    workstation: values.workstation,\n                                    rejection_category: values.rejection_category,\n                                    rework_category: values.rework_category,\n                                    supervisor: values.supervisor,\n                                    department: values.department,\n                                };\n                                frappe.call({\n                                    method: \"onegene.onegene.custom.job_card_process_entry\",\n                                    args: {\n                                        args: args\n                                    },\n                                    freeze: true,\n                                    callback: function(r) {\n                                        if (r.message) {\n                                            cur_frm.reload_doc();\n                                        }\n                                        d.hide();\n                                    }\n                                });\n                            }\n                        }\n                    });\n                    d.fields_dict.workstation.get_query = () => {\n                        return {\n                            query: \"onegene.onegene.custom.get_warehouses\",\n                            filters: {\n                                name: frm.doc.operation\n                            }\n                        };\n                    };\n                    d.fields_dict.rejection_remarks.get_query = () => {\n                        return {\n                            query: \"onegene.onegene.custom.get_rejection_reason\",\n                            filters: {\n                                rejection_category: d.get_value('rejection_category')\n                            }\n                        };\n                    };\n                    d.fields_dict.rework_remarks.get_query = () => {\n                        return {\n                            query: \"onegene.onegene.custom.get_rework_reason\",\n                            filters: {\n                                rework_category: d.get_value('rework_category')\n                            }\n                        };\n                    };\n                    d.show();\n\n                    function getEmployeeDepartment() {\n                        frappe.db.get_value(\"Employee\", {\n                                \"name\": d.get_value(\"employee\")\n                            }, \"department\")\n                            .then(r => {\n                                d.set_value(\"department\", r.message ? r.message.department : '');\n                                autoSetSupervisor();\n                            });\n                    }\n\n                    function getEmployeeName() {\n                        frappe.db.get_value(\"Employee\", {\n                                \"name\": d.get_value(\"employee\")\n                            }, \"employee_name\")\n                            .then(r => {\n                                d.set_value(\"employee_name\", r.message ? r.message.employee_name : '');\n                            });\n                    }\n\n                    function recalculateAcceptedQty() {\n                        const processed = flt(d.get_value(\"processed_qty\"));\n                        const accepted = processed;\n                        d.set_value(\"qty\", accepted >= 0 ? accepted : 0);\n                    }\n\n                    function validateProcessedQty() {\n                        const processed = flt(d.get_value(\"processed_qty\"));\n                        const possible = flt(d.get_value(\"possible_qty\"));\n                        const qty = flt(d.get_value(\"qty\"));\n                        if (processed > possible) {\n                            frappe.msgprint({\n                                message: `<span style=\"color: red;\">Processed Quantity cannot be greater than the Possible to Production</span>`,\n                                indicator: \"red\"\n                            });\n                            frappe.msgprint({\n                                message: `<span style=\"color: red;\">செயலாக்கப்பட்ட அளவு தயாரிப்பிற்கு சாத்தியமான அளவைவிட அதிகமாக இருக்க முடியாது</span>`,\n                                indicator: \"red\"\n                            });\n\n                            d.set_value(\"processed_qty\", 0);\n                        }\n\n                        if (qty > processed) {\n                            frappe.msgprint({\n                                message: `<span style=\"color: red;\">Accepted Quantity cannot be greater than the Processed Quantity</span>`,\n                                indicator: \"red\"\n                            });\n                            frappe.msgprint({\n                                message: `<span style=\"color: red;\">ஏற்றுக்கொள்ளப்பட்ட அளவு செயலாக்கப்பட்ட அளவுக்கு மேல் இருக்க முடியாது</span>`,\n                                indicator: \"red\"\n                            });\n\n                            d.set_value(\"qty\", 0);\n                        }\n\n                    }\n\n                    function validateRejectedQty() {\n                        frappe.db.get_value(\"Item\", frm.doc.production_item, \"rejection_allowance\").then(r => {\n                            let rejection_allowance_percent = r.message.rejection_allowance || 0;\n                            let max_allowed_rejection = (frm.doc.for_quantity || 0) * (rejection_allowance_percent / 100);\n                            let total_rejected_qty = (frm.doc.custom_rejected_qty || 0) + (flt(d.get_value(\"rejected_qty\")) || 0);\n                            if (total_rejected_qty > max_allowed_rejection) {\n                                frappe.msgprint({\n                                    message: `<span style=\"color: red;\">${__('Total Rejected Quantity (' + total_rejected_qty + ') exceeds the Rejection Allowance (' + rejection_allowance_percent + '% = ' + max_allowed_rejection + ' units).')}</span>`,\n                                    indicator: 'red'\n                                });\n                                frappe.msgprint({\n                                    message: `<span style=\"color: red;\">${__('மொத்த மறுக்கப்பட்ட அளவு (' + total_rejected_qty + ') மறுக்கும் அனுமதி (' + rejection_allowance_percent + '% = ' + max_allowed_rejection + ' யூனிட்கள்) ஐ மீறுகிறது.')}</span>`,\n                                    indicator: 'red'\n                                });\n\n                            }\n\n                        })\n                    }\n\n                    function validateShift() {\n                        let shift = d.get_value(\"shift\");\n                        if (shift) {\n                            frappe.call({\n                                method: \"onegene.onegene.custom.get_shift_for_current_time\",\n                                callback: function(r) {\n                                    if (r.message) {\n                                        const shift_list = r.message\n                                            .map(s => s[0])\n                                            .filter(v => v);\n                                        if (shift && !shift_list.includes(shift)) {\n                                            d.set_value(\"shift\", \"\");\n                                        }\n                                    }\n                                }\n                            });\n                        }\n                    }\n\n                    function recalculateRejectedQty() {\n                        const processed = flt(d.get_value(\"processed_qty\"));\n                        const accepted = flt(d.get_value(\"qty\"));\n                        const rework = flt(d.get_value(\"rework_qty\"));\n                        const rejected = processed - accepted - rework;\n                        d.set_value(\"rejected_qty\", rejected >= 0 ? rejected : 0);\n                    }\n\n                    function recalculateReworkQty() {\n                        const processed = flt(d.get_value(\"processed_qty\"));\n                        const accepted = flt(d.get_value(\"qty\"));\n                        const rejected = flt(d.get_value(\"rejected_qty\"));\n                        const rework = processed - accepted - rejected;\n                        d.set_value(\"rework_qty\", rework >= 0 ? rework : 0);\n                    }\n\n                    // Bind accepted_qty to update rework_qty\n                    d.get_field(\"processed_qty\").$wrapper.find(\"input\").on(\"input\", () => {\n                        // recalculateAcceptedQty();\n                        validateProcessedQty();\n                    });\n                    d.get_field(\"qty\").$wrapper.find(\"input\").on(\"input\", () => {\n                        // recalculateAcceptedQty();\n                        validateProcessedQty();\n                    });\n\n                    // Bind accepted_qty and rework_qty to update rejected_qty\n                    [\"qty\"].forEach(fieldname => {\n                        d.get_field(fieldname).$wrapper.find(\"input\").on(\"input\", () => {\n                            // recalculateRejectedQty();\n                        });\n                    });\n\n                    // Bind rejected_qty to update rework_qty\n                    d.get_field(\"rejected_qty\").$wrapper.find(\"input\").on(\"input\", () => {\n                        recalculateReworkQty();\n                        validateRejectedQty();\n                    });\n                    d.fields_dict.shift.get_query = () => {\n                        return {\n                            query: \"onegene.onegene.custom.get_shift_for_current_time\",\n                        };\n                    };\n                    d.fields_dict.supervisor.get_query = () => {\n                        return {\n                            query: \"onegene.onegene.custom.get_supervisor\",\n                            filters: {\n                                department: d.get_value('department')\n                            }\n                        };\n                    };\n\n                    function getSupervisorName() {\n                        frappe.call({\n                            method: \"onegene.onegene.custom.get_supervisor_name\",\n                            args: {\n                                supervisor: d.get_value('supervisor'),\n                            },\n                            callback: function(r) {\n                                if (r.message) {\n                                    d.set_value('supervisor_name', r.message);\n                                }\n                            }\n                        });\n                    }\n\n                    function autoSetSupervisor() {\n                        frappe.call({\n                            method: \"onegene.onegene.custom.get_supervisor\",\n                            args: {\n                                doctype: \"Employee\",\n                                txt: \"\",\n                                searchfield: \"name\",\n                                start: 0,\n                                page_len: 20,\n                                filters: {\n                                    department: d.get_value('department')\n                                }\n                            },\n                            callback: function(r) {\n                                if (r.message && r.message.length === 1) {\n                                    d.set_value(\"supervisor\", r.message[0][0]);\n                                    d.set_value(\"supervisor_name\", r.message[0][1]);\n                                }\n                            }\n                        });\n                    }\n                }\n            }).css({\n                'color': 'white',\n                'background-color': \"#000000\"\n            });\n\n        }\n        frappe.db.get_value(\"Item\", {\n            \"name\": frm.doc.production_item\n        }, \"item_billing_type\").then(r => {\n\n            if (r && r.message.item_billing_type) {\n\n                if (r.message.item_billing_type == \"Billing\" && frm.doc.total_completed_qty > 0) {\n\n                    // frm.add_custom_button(__(\"Generate QR\"), function() {\n                    //     var letter_head = frm.doc.letter_head;\n                    //     var f_name = frm.doc.name;\n                    //     var print_format = \"Job Card\";\n                    //     window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                    //         \"doctype=\" + encodeURIComponent(\"Job Card\") +\n                    //         \"&name=\" + encodeURIComponent(f_name) +\n                    //         \"&trigger_print=1\" +\n                    //         \"&format=\" + print_format +\n                    //         \"&no_letterhead=0\" +\n                    //         \"&letterhead=\" + encodeURIComponent(letter_head)\n                    //     ));\n                    // }).css({\n                    //     'color': 'white',\n                    //     'background-color': \"#000000\"\n                    // });\n\n\n                    // frm.add_custom_button(__(\"Generate QR\"), function() {\n                    //     var letter_head = frm.doc.letter_head;\n                    //     var f_name = frm.doc.name;\n                    //     var print_format = \"Job Card\";\n                    //     var page_width = \"210mm\";\n                    //     if(frm.doc.custom_rejected_qty > 0 && frm.doc.custom_rework_waiting_qty_details > 0){\n                    //         var page_height = \"210mm\";\n                    //     }else if(frm.doc.custom_rejected_qty > 0 || frm.doc.custom_rework_waiting_qty_details > 0){\n                    //         var page_height = \"140mm\";\n                    //     }else{\n                    //         var page_height = \"70mm\";\n                    //     }\n\n\n                    //     window.open(frappe.urllib.get_full_url(\"/api/method/onegene.api.custom_pdf.download_custom_size_pdf?\" +\n                    //         \"doctype=\" + encodeURIComponent(\"Job Card\") +\n                    //         \"&name=\" + encodeURIComponent(f_name) +\n                    //         \"&trigger_print=1\" +\n                    //         \"&format=\" + print_format +\n                    //         \"&no_letterhead=0\" +\n                    //         \"&letterhead=\" + encodeURIComponent(letter_head)\n                    //         + \"&page_width=\" + encodeURIComponent(page_width)\n                    //         + \"&page_height=\" + encodeURIComponent(page_height)\n                    //     ));\n                    // }).css({\n                    //     'color': 'white',\n                    //     'background-color': \"#000000\"\n                    // });\n\n\n\n\n\n\n\n                }\n\n\n            }\n\n\n        })\n\n\n\n\n\n        if (!frappe.user.has_role(\"System Manager\")) {\n\n\n            let allowed = [\"custom_shift_type\", \"time_logs\"];\n\n            frm.fields.forEach(field => {\n                if (!allowed.includes(field.df.fieldname)) {\n                    frm.set_df_property(field.df.fieldname, \"read_only\", 1);\n                } else {\n                    frm.set_df_property(field.df.fieldname, \"read_only\", 0);\n                }\n            });\n        }\n\n\n\n        if (!frm.doc.__islocal) {\n            frappe.call({\n                method: \"onegene.onegene.custom.job_card_dashboard_comment\",\n                args: {\n                    \"name\": frm.doc.name\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        let tool = r.message[0];\n                        let life = r.message[2] - r.message[4];\n                        let waiting_qty = r.message[5];\n                        msg = r.message\n                        frm.dashboard.clear_headline();\n                        frm.dashboard.add_comment(msg, \"red\", true);\n                    }\n                }\n            });\n        }\n        frm.fields_dict.custom_column_description.$wrapper.html(`\n            <table class=\"w-100 mb-3\">\n                <tr>\n                    <td style=\"padding-left: 10px;\"><b>RQ -</b> Required Quantity</td>\n                    <td style=\"padding-left: 10px;\"><b>TRQ -</b>Total Required Quantity</td>\n                    <td style=\"padding-left: 10px;\"><b>AQ -</b> Available Quantity</td>\n                </tr>\n                <tr>\n                    <td style=\"padding-left: 10px;\"><b>PPQ -</b> Possible Production Quantity</td>\n                    <td style=\"padding-left: 10px;\"><b>CQ -</b> Consumption Qty</td>\n                </tr>\n            </table>\n        `);\n        if (frm.doc.status == \"Completed\") {\n            frappe.call({\n                method: \"onegene.onegene.custom.get_quality_inspection\",\n                args: {\n                    \"item_code\": frm.doc.production_item,\n                },\n                callback: function(r) {\n                    if (r.message && r.message == \"ok\") {\n                        frm.add_custom_button('Quality Inspection', () => {\n                            frappe.model.with_doctype('Quality Inspection', function() {\n                                let doc = frappe.model.get_new_doc(\"Quality Inspection\");\n                                doc.inspection_type = \"In Process\"\n                                doc.reference_type = \"Job Card\";\n                                doc.reference_name = frm.doc.name\n                                doc.item_code = frm.doc.production_item\n\n\n\n\n                                frappe.set_route('Form', 'Quality Inspection', doc.name);\n                            });\n                        }, __('Make'));\n                    }\n                }\n            });\n\n\n\n\n        }\n    },\n\n\n\n    total_completed_qty(frm) {\n        if (frm.doc.custom_tool && frm.doc.time_logs && frm.doc.time_logs.length > 0) {\n            let new_completed_qty = frm.doc.total_completed_qty || 0;\n            let time_logs = frm.doc.time_logs;\n            let last_completed_qty = 0;\n            let qty_to_add = 0;\n\n            if (time_logs.length > 1) {\n                last_completed_qty = time_logs[time_logs.length - 2].completed_qty;\n                qty_to_add = new_completed_qty - last_completed_qty;\n\n                if (qty_to_add > 0) {\n                    frappe.msgprint({\n                        message: `<span style=\"color: red;\">Tool usage increment: ${qty_to_add}</span>`,\n                        indicator: 'red'\n                    });\n                    frappe.msgprint({\n                        message: `<span style=\"color: red;\">கருவி பயன்பாடு அதிகரிப்பு: ${qty_to_add}</span>`,\n                        indicator: 'red'\n                    });\n\n\n                    // Optional: Save to a custom field for server sync\n                }\n\n            } else if (time_logs.length === 1) {\n                last_completed_qty = time_logs[0].completed_qty;\n\n                if (last_completed_qty === new_completed_qty && new_completed_qty > 0) {\n                    qty_to_add = last_completed_qty;\n                    frappe.msgprint({\n                        message: `<span style=\"color: red;\">Tool usage increment: ${qty_to_add}</span>`,\n                        indicator: 'red'\n                    });\n                    frappe.msgprint({\n                        message: `<span style=\"color: red;\">கருவி பயன்பாடு அதிகரிப்பு: ${qty_to_add}</span>`,\n                        indicator: 'red'\n                    });\n\n                    // Optional: Save to a custom field for server sync\n                }\n            }\n\n            // You could store qty_to_add in a custom field if needed:\n            // frm.set_value('custom_tool_increment', qty_to_add);\n        }\n    },\n\n\n\n    //   employee: function(frm){\n    //       frm.refresh_field(\"custom_supervisor\")\n    //       frm.refresh_field(\"custom_shift_type\")\n\n    //   }\n\n\n\n});\n\nfrappe.ui.form.on('Job Card Scrap Item', {\n    item_code: function(frm, cdt, cdn) {\n        const row = locals[cdt][cdn];\n        if (!frm.doc.__islocal) {\n            frappe.call({\n                method: \"onegene.onegene.custom.check_items_in_jc_scrap_item\",\n                args: {\n\n                    parent: frm.doc.name,\n                    item_code: row.item_code,\n                    work_order: frm.doc.work_order,\n                    sequence_id: frm.doc.sequence_id\n\n                },\n                callback: function(r) {\n                    if (!r.message || r.message.length === 0) {\n                        if (row.item_code) {\n                            frappe.msgprint(`Item Code '${row.item_code}' is not in Job Card Items.`);\n                            frappe.msgprint(`Item Code '${row.item_code}' Job Card-ல் இல்லை.`);\n                            // frappe.model.set_value(cdt, cdn, \"item_code\", \"\");\n                            frm.fields_dict.scrap_items.grid.grid_rows_by_docname[cdn].remove();\n                            frm.refresh_field(\"scrap_items\");\n                        }\n                    }\n                }\n            });\n        }\n    }\n});\n\n\nfrappe.ui.form.on('Job Card Time Log', {\n    custom_generate_qr(frm, cdt, cdn) {\n        let row = locals[cdt][cdn]; // child row\n        let parent_name = frm.doc.name; // parent job card name\n        \n        // frappe.call({\n        //                         method: \"onegene.onegene.utils.get_qid_for_job_card_from_child_row\",\n        //                         args: {\n        //                             parent: parent_name,\n        //                             child_doctype: cdt,\n        //                             child_name: row.name\n        //                         },\n        //                         freeze: true,\n        //                         callback(res) {\n        //                             if (res.message) {\n        //                                 window.open(res.message); // open PDF link\n        //                             }\n        //                         }\n        //                     });\n\n        // // Call backend to get QR HTML\n        frappe.call({\n            method: \"onegene.onegene.utils.get_qr_html_for_child_row\",\n            args: {\n                parent: parent_name,\n                child_doctype: cdt,\n                child_name: row.name\n            },\n            callback(r) {\n                if (r.message) {\n                    let d = new frappe.ui.Dialog({\n                        title: 'Generate QR',\n                        fields: [{\n                            label: 'QR Preview',\n                            fieldname: 'html',\n                            fieldtype: 'HTML',\n                            options: r.message // set HTML from backend\n                        }, ],\n                        primary_action_label: 'Download',\n                        primary_action(values) {\n                            frappe.call({\n                                method: \"onegene.onegene.utils.get_qid_for_job_card_from_child_row\",\n                                args: {\n                                    parent: parent_name,\n                                    child_doctype: cdt,\n                                    child_name: row.name\n                                },\n                                callback(res) {\n                                    if (res.message) {\n                                        window.open(res.message); // open PDF link\n                                    }\n                                }\n                            });\n                            d.hide();\n                        }\n                    });\n\n                    d.show();\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.458971",
  "module": "ONEGENE",
  "name": "Customer",
  "script": "frappe.ui.form.on('Customer', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\t\n\tcustom_country(frm) {\n\t    if (frm.doc.custom_country) {\n\t        if (frm.doc.custom_country != \"India\") {\n\t            frm.set_value(\"customer_group\",\"Export\")\n\t        }\n\t    }\n\t},\n\t\n\tterritory(frm){\n\t    if(frm.doc.territory == \"India\"){\n\t        \n\t        frm.set_value(\"custom_country\",\"India\")\n\t    }\n\t    else{\n\t        frm.set_value(\"custom_country\",\"\")\n\t    }\n\t},\n\t\n\t\n\tcustomer_group(frm){\n\t    \n\t    if(frm.doc.customer_group ==\"Export\" && frm.doc.custom_country ==\"India\"){\n\t        \n\t        frm.set_value(\"custom_country\",\"\")\n\t    }\n\t    \n\t},\n\t\n\tvalidate(frm){\n\t    \n\t     if(frm.doc.customer_group ==\"Export\" && frm.doc.custom_country ==\"India\"){\n\t        \n\t        frm.set_value(\"custom_country\",\"\")\n\t        \n\t        frappe.throw(_(\"For Export Customer Group the Country Not be india\"))\n\t    }\n\t    \n\t},\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Issue",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.512048",
  "module": "ONEGENE",
  "name": "Issue - list",
  "script": "let core_settings = frappe.listview_settings['Issue'] || {};\nfrappe.listview_settings['Issue'] = {\n    ...core_settings,\n    onload(listview){\n        var currentUrl = new URL(window.location.href);\n        const user = frappe.session.user;\n        if (!frappe.user.has_role(\"System Manager\")) {\n\n            var targetUrl = `https://erp.onegeneindia.in/app/issue?owner=${user}`;\n            if (currentUrl.href != targetUrl) {\n                window.location.href = targetUrl;\n            }\n        }\n        \n    },\n    refresh(listview){\n        var currentUrl = new URL(window.location.href);\n        const user = frappe.session.user;\n        if (!frappe.user.has_role(\"System Manager\")) {\n            var targetUrl = `https://erp.onegeneindia.in/app/issue?owner=${user}`;\n            if (currentUrl.href != targetUrl) {\n                window.location.href = targetUrl;\n            }\n        }\n        \n    },\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Shift Assignment",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.402466",
  "module": "ONEGENE",
  "name": "Shift Assignment",
  "script": "frappe.ui.form.on('Shift Assignment', {\n\tonload(frm){\n        frm.set_query(\"shift_type\", function() {\n            return {\n                filters: {\n                    custom_disabled: 0\n                }\n            };\n        });\n    },\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Attendance Tool",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.365060",
  "module": "ONEGENE",
  "name": "Employee Attendance Tool",
  "script": "frappe.ui.form.on('Employee Attendance Tool', {\n\tonload(frm){\n        frm.set_query(\"shift\", function() {\n            return {\n                filters: {\n                    custom_disabled: 0\n                }\n            };\n        });\n    },\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Shift Request",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.327349",
  "module": "ONEGENE",
  "name": "Shift Request",
  "script": "frappe.ui.form.on('Shift Request', {\n\tonload(frm){\n        frm.set_query(\"shift_type\", function() {\n            return {\n                filters: {\n                    custom_disabled: 0\n                }\n            };\n        });\n    },\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Department",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.284289",
  "module": "ONEGENE",
  "name": "Department",
  "script": "frappe.ui.form.on('Department', {\n    setup: function(frm) {\n        frm.set_query(\"shift\", \"custom_ot_details\", function(doc, cdt, cdn) {\n            return {\n                filters: {\n                    custom_disabled: 0  \n                }\n            };\n        });\n    },\n\t  onload: function(frm) {\n        if (!frm.doc.custom_ot_details || frm.doc.custom_ot_details.length === 0) {\n\n            frappe.call({\n                method: \"frappe.client.get_list\",\n                args: {\n                    doctype: \"Shift Type\",\n                    filters: {\n                        custom_disabled: 0\n                    },\n                    fields: [\"name\"],\n                    limit_page_length: 1000\n                },\n                callback: function(response) {\n                    if (response.message && response.message.length > 0) {\n                        let shift_types = response.message;\n\n                        shift_types.forEach(shift => {\n                            let row = frm.add_child(\"custom_ot_details\");\n                            row.shift = shift.name;\n                        });\n\n                        frm.refresh_field(\"custom_ot_details\");\n                    }\n                }\n            });\n        }\n    }\n})\n\nfrappe.ui.form.on('OT Details', {\n    \n\n   shift: function(frm, cdt, cdn) {\n        let current_row = locals[cdt][cdn];\n        let selected_shift = current_row.shift;\n\n        if (!selected_shift) return;\n\n        let duplicate_found = false;\n        frm.doc.custom_ot_details.forEach(row => {\n            if (row.shift === selected_shift && row.name !== current_row.name) {\n                duplicate_found = true;\n            }\n        });\n\n        if (duplicate_found) {\n            frappe.msgprint({\n                title: \"Duplicate Shift\",\n                message: `Shift \"${selected_shift}\" is already selected in another row.`,\n                indicator: \"red\"\n            });\n\n            frm.get_field(\"custom_ot_details\").grid.grid_rows_by_docname[cdn].remove();\n            frm.refresh_field(\"custom_ot_details\");\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.247938",
  "module": "ONEGENE",
  "name": "Work Order",
  "script": "frappe.ui.form.on('Work Order', {\n\trefresh(frm) {\n\t\tfrm.fields_dict.custom_column_description_1.$wrapper.html(`\n            <table class=\"w-100 mb-3\">\n                <tr>\n                    <td style=\"padding-left: 10px;\"><b>CQ -</b> Completed Quantity</td>\n                    <td style=\"padding-left: 10px;\"><b>PLQ -</b>Process Loss Quantity</td>\n                    <td style=\"padding-left: 10px;\"><b>WQ -</b> Waiting Quantity</td>\n                </tr>\n            </table>\n        `);\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.211578",
  "module": "ONEGENE",
  "name": "Work Order List",
  "script": "let core_settings = frappe.listview_settings['Work Order'] || {};\r\n\r\nfrappe.listview_settings['Work Order'] = {\r\n    ...core_settings,\r\n    onload(listview) {\r\n       \r\n        \r\n        listview.filter_area.add([[listview.doctype, 'custom_is_queued', '=', 0]]);\r\n    }\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Tool",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.173307",
  "module": "ONEGENE",
  "name": "Tool",
  "script": "frappe.ui.form.on('Tool', {\n// \ttool_name(frm) {\n// \t    frm.set_value('title', frm.doc.tool_name)\n// \t}\n\nrefresh(frm){\n    if (!frm.doc.__islocal) {\n        frm.set_df_property(\"tool_life\", \"read_only\", 1);\n        frm.set_df_property(\"total_processed_qty\", \"read_only\", 1);\n        frm.set_df_property(\"custom_balance_life\", \"read_only\", 1);\n    }\n    if(frm.doc.custom_balance_life == 0){\n        \n        frm.add_custom_button(\"Refurbish\",()=>{\n            frappe.confirm(\"Do you want to refurbish the tool?\",\n            ()=>{\n                \n                frm.set_value(\"total_processed_qty\",0)\n                frm.save()\n                .then(()=>{\n                    \n                    \n                    frm.add_child('custom_refurbishment_log', {\n                \"date\":frappe.datetime.get_today(),\n                \"approval\":frappe.session.user,\n                // \"balance_life\": frm.doc.custom_balance_life\n                });\n\n                frm.refresh_field('custom_refurbishment_log');\n                \n                frm.save()\n                    \n                    \n                    \n                })\n                \n                \n            \n\n                \n\n            },\n            \n            \n            \n            \n            )\n            \n        })\n        \n    }\n    \n    if(frm.doc.status != \"Scrap\"){\n    frm.add_custom_button(\"Scrap\",()=>{\n        frappe.confirm(\"Do you want to mark the tool as Scrap?\",\n        ()=>{\n            \n            frm.set_value(\"custom_scrapbox\",1)\n            frm.set_value(\"status\",\"Scrap\")\n            \n            frm.save()\n        }\n        )\n    })\n    \n    }\n    \n    \n    \n    \n},\n\n// custom_balance_life(frm){\n    \n//     if (frm.doc.status === \"Scrap\") {\n//     return;\n//   }\n\n    \n    \n    \n//     if(frm.doc.custom_balance_life==0){\n//         frm.set_value(\"status\",\"Inactive\")\n//     }\n//     else{\n//       frm.set_value(\"status\",\"Active\") \n//     }\n//     },\n\ntool_life(frm){\n    \n    frm.trigger(\"calculate_balance_life\")\n},\n\ntotal_processed_qty(frm){\n    \n    frm.trigger(\"calculate_balance_life\")\n    \n},\n\ncalculate_balance_life(frm){\n    \n    frm.set_value(\"custom_balance_life\",frm.doc.tool_life - frm.doc.total_processed_qty)\n}\n\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quality Inspection",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.440590",
  "module": "ONEGENE",
  "name": "Quality Inspection",
  "script": "frappe.ui.form.on('Quality Inspection', {\n    setup(frm) {\n        frm.set_indicator_formatter('specification', function(doc) {\n            let readings = [\n                doc.reading_1,\n                doc.reading_2,\n                doc.reading_3,\n                doc.reading_4,\n                doc.reading_5\n            ];\n\n            let has_readings = readings.some(r => r && r !== 0);\n\n            if (!has_readings) {\n                return \"grey\";\n            }\n\n            if (doc.status === \"Accepted\") {\n                return \"green\";\n            } else {\n                return \"red\";\n            }\n        });\n        if (frm.doc.docstatus !=1) {\n            if (frm.doc.custom_inspection_type === \"Incoming\") {\n                frm.set_df_property(\"reference_type\", \"options\", [\n                    \"\",\n                    \"Purchase Receipt\",\n                    \"Purchase Invoice\",\n                    \"Subcontracting Receipt\"\n                ]);\n            } else if (frm.doc.custom_inspection_type === \"In Process\") {\n                frm.set_df_property(\"reference_type\", \"options\", [\n                    \"\",\n                    \"Job Card\",\n                ]);\n                frm.set_value(\"reference_type\", \"Job Card\");\n            } else if (frm.doc.custom_inspection_type === \"Outgoing\") {\n                frm.set_df_property(\"reference_type\", \"options\", [\n                    \"\",\n                    \"Delivery Note\",\n                    \"Sales Invoice\",\n                    \"Stock Entry\"\n                ]);\n            } else {\n                // reset / default\n                frm.set_df_property(\"reference_type\", \"options\", [\"\"]);\n            }\n            if(frm.doc.reference_type){\n                frm.set_query(\"reference_name\", function() {\n        \t\t\tlet filters = {};\n        \t\t\tif (frm.doc.reference_type == 'Purchase Receipt') {\n        \t\t\t\tfilters= {\n        \t\t\t\t\t\"docstatus\": [\"=\", 1],\n        \t\t\t\t\t\n        \t\t\t\t};\n        \t\t\t}\n        \t\t\telse if(frm.doc.reference_type == 'Job Card'){\n        \t\t\t    return{\n        \t\t\t\t    query:\"onegene.onegene.quality_inspection.ref_name_job_card\",\n        \t\t\t    }\n        \t\t\t}\n        \t\t\telse{\n        \t\t\t    filters= {\n        \t\t\t\t\t\"docstatus\": [\"=\", 1],\n        \t\t\t\t};\n        \t\t\t}\n    \t\t\treturn { filters: filters };\t\n    \t\t});\n            }\n            if (frm.doc.reference_name) {\n                frm.set_query(\"custom_quality_pending\", () => ({\n                    filters: {\n                        status: \"Inspection Pending\",\n                        reference_type: frm.doc.reference_type,\n                        reference_name: frm.doc.reference_name\n                    }\n                }));\n            }\n        }\n\n    },\n    custom_inspection_type:function(frm){\n        if (frm.doc.custom_inspection_type === \"Incoming\") {\n                frm.set_df_property(\"reference_type\", \"options\", [\n                    \"\",\n                    \"Purchase Receipt\",\n                    \"Purchase Invoice\",\n                    \"Subcontracting Receipt\"\n                ]);\n            } else if (frm.doc.custom_inspection_type === \"In Process\") {\n                frm.set_df_property(\"reference_type\", \"options\", [\n                    \"\",\n                    \"Job Card\",\n                ]);\n                frm.set_value(\"reference_type\", \"Job Card\");\n            } else if (frm.doc.custom_inspection_type === \"Outgoing\") {\n                frm.set_df_property(\"reference_type\", \"options\", [\n                    \"\",\n                    \"Delivery Note\",\n                    \"Sales Invoice\",\n                    \"Stock Entry\"\n                ]);\n            } else {\n                // reset / default\n                frm.set_df_property(\"reference_type\", \"options\", [\"\"]);\n            }\n        if(frm.doc.custom_inspection_type){\n        frm.set_value(\"inspection_type\",frm.doc.custom_inspection_type)\n        }\n        \n        \n    },\n    item_code(frm) {\n        if (frm.doc.item_code) {\n            frappe.db.get_value(\"Item\", frm.doc.item_code, \"pack_size\").then(res => {\n                if (res.message && res.message.pack_size) {\n                    frm.set_value(\"custom_pack_size\", res.message.pack_size);\n                } else {\n                    frm.set_value(\"custom_pack_size\", 0);\n                }\n            });\n            frappe.db.get_value(\"Item\", frm.doc.item_code, \"item_group\").then(res => {\n                if (res.message && res.message.item_group) {\n                    frm.set_value(\"custom_item_group\", res.message.item_group);\n                } else {\n                    frm.set_value(\"custom_item_group\", 0);\n                }\n            });\n            frappe.db.get_value(\"Item\", frm.doc.item_code, \"item_name\").then(res => {\n                if (res.message && res.message.item_name) {\n                    frm.set_value(\"item_name\", res.message.item_name);\n                } else {\n                    frm.set_value(\"item_name\", 0);\n                }\n            });\n        } else {\n            frm.set_value(\"custom_pack_size\", 0);\n        }\n        if (frm.doc.custom_quality_pending && frm.doc.item_code && frm.doc.custom_item_billing_type && frm.doc.reference_type) {\n            let inspection_template = \"\";\n            setTimeout(function() {\n                if (frm.doc.reference_type == \"Job Card\") {\n                    if (frm.doc.custom_item_billing_type == \"Billing\") {\n                        inspection_template = frm.doc.item_code + \"-Final\";\n                    }\n                    else {\n                        inspection_template = frm.doc.item_code + \"-Process\";\n                    }\n                    frm.set_value(\"quality_inspection_template\", inspection_template);    \n                }\n            }, 500);\n        }\n    },\n    custom_quality_pending(frm) {\n        if (frm.doc.custom_quality_pending && frm.doc.item_code && frm.doc.custom_item_billing_type && frm.doc.reference_type) {\n            let inspection_template = \"\";\n            setTimeout(function() {\n                if (frm.doc.reference_type == \"Job Card\") {\n                    if (frm.doc.custom_item_billing_type == \"Billing\") {\n                        inspection_template = frm.doc.item_code + \"-Final\";\n                    }\n                    else {\n                        inspection_template = frm.doc.item_code + \"-Process\";\n                    }\n                    frm.set_value(\"quality_inspection_template\", inspection_template);    \n                }\n            }, 500);\n        }\n    },\n\n    inspection_type: function(frm) {\n        if (!frm.doc.inspection_type) {\n            frm.set_value(\"reference_type\", \"\");\n            frm.set_value(\"reference_name\", \"\");\n            frm.set_value(\"custom_quality_pending\", \"\");\n            frm.set_value(\"item_code\", \"\");\n            frm.set_value(\"custom_no_of_bins\", \"\");\n            frm.set_value(\"custom_pending_qty\", \"\");\n            frm.set_value(\"custom_possible_inspection_qty\", \"\");\n            frm.set_value(\"custom_accepted_qty\", \"\");\n            frm.set_value(\"quality_inspection_template\", \"\");\n            frm.set_value(\"custom_inspected_qty\", \"\");\n            frm.set_value(\"custom_rejected_qty\", \"\");\n            frm.set_value(\"custom_rework_qty\", \"\");\n            frm.set_value(\"readings\", \"\");\n            frm.set_value(\"custom_rejection_category\", \"\");\n            frm.set_value(\"custom_rework_category\", \"\");\n            frm.set_value(\"custom_rejection_reason\", \"\");\n            frm.set_value(\"custom_rework_reason\", \"\");\n            frm.set_value(\"custom_item_group\", \"\")\n        }\n        if (frm.doc.inspection_type === \"Incoming\") {\n            frm.set_df_property(\"reference_type\", \"options\", [\n                \"\",\n                \"Purchase Receipt\",\n                \"Purchase Invoice\",\n                \"Subcontracting Receipt\"\n            ]);\n            if ([\"Job Card\", \"Delivery Note\", \"Sales Invoice\", \"Stock Entry\"].includes(frm.doc.reference_type)) {\n                frm.set_value(\"reference_type\", \"\");\n                frm.set_value(\"reference_name\", \"\");\n                frm.set_value(\"custom_quality_pending\", \"\");\n                frm.set_value(\"item_code\", \"\");\n                frm.set_value(\"custom_no_of_bins\", \"\");\n                frm.set_value(\"custom_pending_qty\", \"\");\n                frm.set_value(\"custom_possible_inspection_qty\", \"\");\n                frm.set_value(\"custom_accepted_qty\", \"\");\n                frm.set_value(\"quality_inspection_template\", \"\");\n                frm.set_value(\"custom_inspected_qty\", \"\");\n                frm.set_value(\"custom_rejected_qty\", \"\");\n                frm.set_value(\"custom_rework_qty\", \"\");\n                frm.set_value(\"readings\", \"\");\n                frm.set_value(\"custom_rejection_category\", \"\");\n                frm.set_value(\"custom_rework_category\", \"\");\n                frm.set_value(\"custom_rejection_reason\", \"\");\n                frm.set_value(\"custom_rework_reason\", \"\");\n                frm.set_value(\"custom_item_group\", \"\")\n            }\n        } else if (frm.doc.inspection_type === \"In Process\") {\n            frm.set_df_property(\"reference_type\", \"options\", [\n                \"\",\n                \"Job Card\",\n            ]);\n            frm.set_value(\"reference_type\", \"Job Card\")\n            if ([\"Delivery Note\", \"Sales Invoice\", \"Stock Entry\", \"Purchase Receipt\", \"Purchase Invoice\", \"Subcontracting Receipt\"].includes(frm.doc.reference_type)) {\n                frm.set_value(\"reference_type\", \"\");\n                frm.set_value(\"reference_name\", \"\");\n                frm.set_value(\"custom_quality_pending\", \"\");\n                frm.set_value(\"item_code\", \"\");\n                frm.set_value(\"custom_no_of_bins\", \"\");\n                frm.set_value(\"custom_pending_qty\", \"\");\n                frm.set_value(\"custom_possible_inspection_qty\", \"\");\n                frm.set_value(\"custom_accepted_qty\", \"\");\n                frm.set_value(\"quality_inspection_template\", \"\");\n                frm.set_value(\"custom_inspected_qty\", \"\");\n                frm.set_value(\"custom_rejected_qty\", \"\");\n                frm.set_value(\"custom_rework_qty\", \"\");\n                frm.set_value(\"readings\", \"\");\n                frm.set_value(\"custom_rejection_category\", \"\");\n                frm.set_value(\"custom_rework_category\", \"\");\n                frm.set_value(\"custom_rejection_reason\", \"\");\n                frm.set_value(\"custom_rework_reason\", \"\");\n                frm.set_value(\"custom_item_group\", \"\")\n            }\n        } else if (frm.doc.inspection_type === \"Outgoing\") {\n            frm.set_df_property(\"reference_type\", \"options\", [\n                \"\",\n                \"Delivery Note\",\n                \"Sales Invoice\",\n                \"Stock Entry\"\n            ]);\n            if ([\"Job Card\", \"Purchase Receipt\", \"Purchase Invoice\", \"Subcontracting Receipt\"].includes(frm.doc.reference_type)) {\n                frm.set_value(\"reference_type\", \"\");\n                frm.set_value(\"reference_name\", \"\");\n                frm.set_value(\"custom_quality_pending\", \"\");\n                frm.set_value(\"item_code\", \"\");\n                frm.set_value(\"custom_no_of_bins\", \"\");\n                frm.set_value(\"custom_pending_qty\", \"\");\n                frm.set_value(\"custom_possible_inspection_qty\", \"\");\n                frm.set_value(\"custom_accepted_qty\", \"\");\n                frm.set_value(\"quality_inspection_template\", \"\");\n                frm.set_value(\"custom_inspected_qty\", \"\");\n                frm.set_value(\"custom_rejected_qty\", \"\");\n                frm.set_value(\"custom_rework_qty\", \"\");\n                frm.set_value(\"readings\", \"\");\n                frm.set_value(\"custom_rejection_category\", \"\");\n                frm.set_value(\"custom_rework_category\", \"\");\n                frm.set_value(\"custom_rejection_reason\", \"\");\n                frm.set_value(\"custom_rework_reason\", \"\");\n                frm.set_value(\"custom_item_group\", \"\")\n            }\n        } else {\n            // reset / default\n            frm.set_df_property(\"reference_type\", \"options\", [\"\"]);\n        }\n    },\n\n    before_workflow_action: async (frm) => {\n        if (frm.doc.workflow_state == \"Pending For HOD\") {\n            if (frm.selected_workflow_action == \"Approve\") {\n                // $.each(frm.doc.readings, function(i, j) {\n                //     j.status = 'Accepted';\n                // });\n                // frm.set_value('status','Accepted');\n                // await frm.save();\n                await frappe.call({\n                    method: \"erpnext.stock.doctype.quality_inspection.quality_inspection.inspect_and_set_status_new\",\n                    args: {\n                        \"doc\": frm.doc.name,\n                    }\n                });\n                // $.each(frm.doc.readings, function(i, j) {\n                //     j.status = 'Approved'\n                // })\n\n            }\n        }\n    },\n\n    reference_name(frm) {\n\n        if (frm.doc.reference_type && frm.doc.reference_type == \"Job Card\") {\n            if (frm.doc.reference_name) {\n                frappe.db.get_value(\"Job Card\", {\n                    \"name\": frm.doc.reference_name\n                }, \"production_item\").then(r => {\n\n                    if (r.message && r.message.production_item) {\n                        frm.set_value(\"item_code\", r.message.production_item)\n                    } else {\n                        frm.set_value(\"item_code\", \"\")\n                    }\n                })\n                \n                if (frm.doc.reference_type == \"Job Card\" && frm.doc.reference_name) {\n            frappe.call({\n                method: \"onegene.onegene.quality_inspection.get_quality_pending\",\n                args: {\n                    job_card: frm.doc.reference_name\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        frm.set_value(\"custom_quality_pending\", r.message[0]);\n                        frm.set_value(\"custom_pending_qty\", r.message[1]);\n                        frm.set_value(\"custom_possible_inspection_qty\", r.message[1]);\n                        frm.refresh_field(\"custom_quality_pending\");\n                    } else {\n                        frm.set_value(\"custom_quality_pending\", \"\");\n                        frm.set_value(\"custom_pending_qty\", 0);\n                        frm.set_value(\"custom_possible_inspection_qty\", 0);\n                        frappe.msgprint({\n                            message: `<span style=\"color:red;\">${__(\"No Quality Pending available for this Job Card.\")}</span>`,\n                            indicator: \"red\"\n                        });\n\n                    }\n                }\n            });\n        }\n            } else {\n                frm.set_value(\"item_code\", \"\")\n            }\n        }\n    },\n\n    refresh(frm) {\n        \n        \n         if(frappe.user.has_role(\"Quality User\")){\n            \n            if(!(frappe.user.has_role(\"Administrator\") || frappe.user.has_role(\"System Manager\") || frappe.user.has_role(\"Quality Manager\") || frappe.user.has_role(\"Quality Engineer\"))){\n             \n             let allowed = [\"reference_name\",\"readings\"];\n             \n             frm.fields.forEach(field => {\n                if (!allowed.includes(field.df.fieldname)) {\n                    frm.set_df_property(field.df.fieldname, \"read_only\", 1);\n                } \n            });\n            \n            \n            //  const grid = frm.get_field(\"readings\").grid;\n                \n                \n            //     grid.cannot_add_rows = true;\n\n               \n            //     grid.wrapper.find('.grid-remove-row').hide();\n\n                \n            //     frm.fields_dict[\"readings\"].$wrapper.find('.grid-add-row').hide();\n            \n            \n            const grid = frm.get_field(\"readings\").grid;\n                grid.cannot_add_rows = true;\n\n                \n                frm.fields_dict[\"readings\"].$wrapper.find('.grid-add-row').hide();\n\n               \n                frm.fields_dict[\"readings\"].$wrapper.find('.grid-remove-rows').hide();\n\n                \n                frm.fields_dict[\"readings\"].$wrapper.find('.grid-row-check').hide();\n\n                \n                frm.fields_dict[\"readings\"].$wrapper.find('input[type=\"checkbox\"]').prop(\"disabled\", true);\n\n                \n                frm.fields_dict[\"readings\"].$wrapper.find('.grid-header .grid-row-check').hide();\n            \n            \n                \n            }\n        }\n        \n        \n        \tfrm.set_query(\"reference_name\", function() {\n\t\t\tlet filters = {};\n\t\t\tif (frm.doc.reference_type != 'Job Card') {\n\t\t\t    \n\t\t\t    \n                \n\t\t\t\tfilters= {\n\t\t\t\t\t\"docstatus\": [\"!=\", 2],\n\t\t\t\t};\n                \n\t\t\t}\n\t\t\t\n\t\t\telse if(frm.doc.reference_type == 'Job Card'){\n\t\t\t    \n\t\t\t    return{\n\n\t\t\t\tquery:\"onegene.onegene.quality_inspection.ref_name_job_card\",\n\t\t\t\t\n\t\t\t}\n\t\t\t}\n\t\t\t    \n\t\t\t\n\t\t\t\n\t\t\treturn { filters: filters };\t\n\t\t});\n\t\t\n\n\n\n        frm.set_query(\"reference_type\", function() {\n            return {\n                filters: {\n                    inspection_type: frm.doc.inspection_type\n                }\n            }\n        })\n\n        frm.trigger('set_reading_list_view');\n        frm.fields_dict[\"readings\"].grid.update_docfield_property('custom_send_for_approval', 'hidden', 1);\n        frm.refresh_field(\"readings\");\n            if (frm.doc.docstatus == 0 && frm.doc.workflow_state == \"Draft\") {\n                frm.add_custom_button(__(\"Inspection Entry\"), () => {\n                    \n                    if (!frm.doc.readings || frm.doc.readings.length === 0) {\n                        frappe.msgprint(__('No parameters found to mark readings'));\n                        return;\n                    }\n                    \n                    let all_filled = true;\n                    (frm.doc.readings || []).forEach(row => {\n                        if (!(row.reading_1 && row.reading_2 && row.reading_3 && row.reading_4 && row.reading_5)) {\n                            all_filled = false;\n                        }\n                    });\n                    if (!all_filled) {\n                        frappe.msgprint(__('Please fill all readings (1–5) for every Paramters.'));\n                        frappe.msgprint(__('எல்லா Parameter-களுக்கும் அனைத்து (1–5)  reading-களையும் நிரப்பவும்.'));\n                        return;\n                    }\n                    \n                    let d = new frappe.ui.Dialog({\n                        title: 'Enter details',\n                        fields: [{\n                                fieldtype: 'Section Break'\n                            },\n                            {\n                                fieldtype: 'Column Break'\n                            },\n                            {\n                                label: 'Employee',\n                                fieldname: 'employee',\n                                fieldtype: 'Link',\n                                options: 'Employee',\n                                reqd: 1,\n                                change: function() {\n                                    getEmployeeName();\n                                    getUserId();\n                                }\n                            },\n                            {\n                                label: 'User ID',\n                                fieldname: 'inspected_by',\n                                fieldtype: 'Link',\n                                options: 'User',\n                                reqd: 1,\n                                read_only: 1\n                            },\n                            {\n                                fieldtype: 'Column Break'\n                            },\n                            {\n                                label: 'Employee Name',\n                                fieldname: 'employee_name',\n                                fieldtype: 'Data',\n                                read_only: 1\n                            },\n                            {\n                                label: 'Shift Type',\n                                fieldname: 'shift_type',\n                                fieldtype: 'Link',\n                                options: 'Shift Type',\n                                reqd: 1,\n                                change: function() {\n                                    validateShift();\n                                }\n                            },\n                            {\n                                fieldtype: 'Section Break'\n                            },\n                            {\n                                fieldtype: 'Column Break'\n                            },\n                            {\n                                label: '<b style=\"color: #4169e1;\">Possible Inspection Qty</b>',\n                                fieldname: 'possible_inspection_qty',\n                                fieldtype: 'Int',\n                                read_only: 1,\n                                default: flt(frm.doc.custom_possible_inspection_qty) || 0\n                            },\n                            {\n                                label: 'Inspected Qty',\n                                fieldname: 'inspected_qty',\n                                fieldtype: 'Int',\n                                default: flt(frm.doc.custom_inspected_qty) || 0,\n                                reqd: 1\n                            },\n                            {\n                                label: 'Pack Size',\n                                fieldname: 'pack_size',\n                                fieldtype: 'Int',\n                                default: flt(frm.doc.custom_pack_size) || 0,\n                                read_only: 1\n                            },\n                            {\n                                fieldtype: 'Column Break'\n                            },\n                            {\n                                label: 'Inspection Pending Qty',\n                                fieldname: 'pending_qty',\n                                fieldtype: 'Int',\n                                read_only: 1,\n                                default: flt(frm.doc.custom_pending_qty) || 0\n                            },\n                            {\n                                label: '<span style=\"color: green;\">Accepted Qty</span>',\n                                fieldname: 'accepted_qty',\n                                fieldtype: 'Int',\n                                default: flt(frm.doc.custom_accepted_qty) || 0,\n                            },\n                            {\n                                label: 'No. of Bins',\n                                fieldname: 'no_of_bins',\n                                fieldtype: 'Int',\n                                default: flt(frm.doc.custom_no_of_bins) || 0,\n                                read_only: 1\n                            },\n\n                            {\n                                fieldtype: 'Section Break'\n                            },\n                            {\n                                fieldtype: 'Column Break'\n                            },\n                            // {\n                            //     label: '<span style=\"color: red;\">Rejected Qty</span>',\n                            //     fieldname: 'rejected_qty',\n                            //     fieldtype: 'Int',\n                            //     default: flt(frm.doc.custom_rejected_qty) || 0\n                            // },\n                            {\n                                label: '<span style=\"color: red;\">Rejected Qty</span>',\n                                fieldname: 'rejected_qty',\n                                fieldtype: 'Int',\n                                default: flt(frm.doc.custom_rejected_qty) || 0,\n                                change: function() {\n                                    let rejected_qty = this.get_value() || 0;\n                                    let rework_qty = d.get_value('rework_qty') || 0;\n                                    let accepted_qty = d.get_value('accepted_qty') || 0;\n                                    let inspected_qty = d.get_value('inspected_qty') || 0;\n\n                                    if (rejected_qty > 0 && (rejected_qty + rework_qty + accepted_qty !== inspected_qty)) {\n                                        // frappe.msgprint(\"Sum of Rejected, Rework and Accepted Qty should match Inspected Qty\");\n                                        d.set_value('rework_qty') = inspected_qty - accepted_qty - rejected_qty\n                                        this.set_value(0); // Reset field to 0\n                                    }\n                                }\n                            },\n                            {\n                                label: 'Rejection Category',\n                                fieldname: 'rejection_category',\n                                fieldtype: 'Link',\n                                options: 'Rejection Category',\n                                depends_on: 'eval: doc.rejected_qty',\n                                mandatory_depends_on: 'eval: doc.rejected_qty'\n                            },\n                            {\n                                label: 'Rejection Reason',\n                                fieldname: 'rejection_reason',\n                                fieldtype: 'Link',\n                                options: 'Rejection Reason',\n                                depends_on: 'eval: doc.rejected_qty',\n                                mandatory_depends_on: 'eval: doc.rejected_qty'\n                            },\n\n                            {\n                                fieldtype: 'Column Break'\n                            },\n                            // {\n                            //     label: '<span style=\"color: orange;\">Rework Qty</span>',\n                            //     fieldname: 'rework_qty',\n                            //     fieldtype: 'Int',\n                            //     default: flt(frm.doc.custom_rework_qty) || 0\n                            // },\n                            {\n                                label: '<span style=\"color: orange;\">Rework Qty</span>',\n                                fieldname: 'rework_qty',\n                                fieldtype: 'Int',\n                                default: flt(frm.doc.custom_rework_qty) || 0,\n                                change: function() {\n                                    let rejected_qty = d.get_value('rejected_qty') || 0;\n                                    let rework_qty = this.get_value() || 0;\n                                    let accepted_qty = d.get_value('accepted_qty') || 0;\n                                    let inspected_qty = d.get_value('inspected_qty') || 0;\n\n                                    if (rework_qty > 0 && (rejected_qty + rework_qty + accepted_qty !== inspected_qty)) {\n                                        // frappe.msgprint(\"Sum of Rejected, Rework and Accepted Qty should match Inspected Qty\");\n                                        d.set_value('rejected_qty') = inspected_qty - accepted_qty - rework_qty\n                                        this.set_value(0); // Reset field to 0\n                                    }\n                                }\n                            },\n                            {\n                                label: 'Rework Category',\n                                fieldname: 'rework_category',\n                                fieldtype: 'Link',\n                                options: 'Rework Category',\n                                depends_on: 'eval: doc.rework_qty',\n                                mandatory_depends_on: 'eval: doc.rework_qty'\n                            },\n                            {\n                                label: 'Rework Reason',\n                                fieldname: 'rework_reason',\n                                fieldtype: 'Link',\n                                options: 'Rework Reason',\n                                depends_on: 'eval: doc.rework_qty',\n                                mandatory_depends_on: 'eval: doc.rework_qty'\n                            }\n                        ],\n                        size: 'large',\n                        primary_action_label: 'Submit',\n                        primary_action(values) {\n                            let rejected_qty = values.rejected_qty || 0;\n                            let rework_qty = values.rework_qty || 0;\n                            let inspected_qty = values.inspected_qty || 0;\n                            let accepted_qty = values.accepted_qty || 0;\n                            let pending_qty = values.pending_qty || 0;\n\n                            if (rejected_qty === 0 && rework_qty === 0 && inspected_qty !== accepted_qty) {\n                                frappe.msgprint({\n                                    message: `<span style=\"color: red;\">Rejected Qty and Rework Qty are not Present. Please adjust your Inspected Qty</span>`\n                                });\n\n                                return;\n                            }\n\n                            if ((rejected_qty > 0 || rework_qty > 0) && (rejected_qty + rework_qty + accepted_qty !== inspected_qty)) {\n                                frappe.msgprint({\n                                    message: `<span style=\"color: red;\">Sum of Rejected, Rework and Accepted Qty should match Inspected Qty</span>`,\n                                    indicator: \"red\"\n                                });\n\n                                return;\n                            }\n                            \n                            \n                             if (frm.__confirmed) {\n                                    \n                                    return;\n                                }\n                        \n                                if (frm.doc.readings && frm.doc.readings.length > 0) {\n                                    for (let row of frm.doc.readings) {\n                                        for (let i = 1; i <= 10; i++) {\n                                            const reading_value = row[`reading_${i}`];\n                                            if (reading_value < row.min_value || reading_value > row.max_value) {\n                                                frappe.confirm(\n                                                    '<p style=\"color:red;\">Some readings are mismatched. Do you still want to save?</p>',\n                                                    () => {\n                                                        \n                                                        \n                             if ((rejected_qty + rework_qty + accepted_qty) == inspected_qty) {\n                                 let rejection_reason = values.rejection_reason;\n                                let rejection_category = values.rejection_category;\n                                let rework_reason = values.rework_reason;\n                                let rework_category = values.rework_category;\n                                \n                                if (rejected_qty === 0) {\n                                    rejection_reason = \"\";\n                                    rejection_category = \"\"; // optional if you want to reset category too\n                                }\n                                \n                                if (rework_qty === 0) {\n                                    rework_reason = \"\";\n                                    rework_category = \"\"; // optional if you want to reset category too\n                                }\n                                frm.set_value('custom_employee', values.employee);\n                                frm.set_value('custom_accepted_qty', accepted_qty);\n                                frm.set_value('custom_pending_qty', values.pending_qty);\n                                frm.set_value('custom_rejected_qty', rejected_qty);\n                                frm.set_value('custom_rework_qty', rework_qty);\n                                frm.set_value('custom_rejection_category', rejection_category);\n                                frm.set_value('custom_rework_category', rework_category);\n                                frm.set_value('custom_rejection_reason', rejection_reason);\n                                frm.set_value('custom_rework_reason', rework_reason);\n                                frm.set_value('custom_inspected_qty', inspected_qty);\n                                frm.set_value('custom_no_of_bins', values.no_of_bins);\n                                frm.set_value('inspected_by', values.inspected_by);\n                                frm.set_value('custom_shift', values.shift_type);\n                                frm.save().then(() => {\n                                    // Trigger your server-side call here\n                                    frappe.call({\n                                        method: \"onegene.onegene.custom.quality_inspection_state_change\", // replace with your method\n                                        args: {\n                                            quality_inspection: frm.doc.name // passing the saved doc name\n                                        },\n                                        callback: function(r) {\n                                            if (r.message) {\n                                                frm.reload_doc()\n                                            }\n                                        }\n                                    });\n                                });\n\n                                d.hide();\n                            }\n                                                        \n                                                        \n                                                        frm.__confirmed = true;\n                                                        frm.save(); \n                                                    },\n                                                    () => {\n                                                        \n                                                    }\n                                                );\n                                                throw \"Waiting for user confirmation...\";\n                                            }\n                                        }\n                                    }\n                                }\n\n\n\n                            if ((rejected_qty + rework_qty + accepted_qty) == inspected_qty) {\n                                let rejection_reason = values.rejection_reason;\n                                let rejection_category = values.rejection_category;\n                                let rework_reason = values.rework_reason;\n                                let rework_category = values.rework_category;\n                                \n                                if (rejected_qty === 0) {\n                                    rejection_reason = \"\";\n                                    rejection_category = \"\"; // optional if you want to reset category too\n                                }\n                                \n                                if (rework_qty === 0) {\n                                    rework_reason = \"\";\n                                    rework_category = \"\"; // optional if you want to reset category too\n                                }\n\n                                frm.set_value('custom_employee', values.employee);\n                                frm.set_value('custom_accepted_qty', accepted_qty);\n                                frm.set_value('custom_pending_qty', values.pending_qty);\n                                frm.set_value('custom_rejected_qty', rejected_qty);\n                                frm.set_value('custom_rework_qty', rework_qty);\n                                frm.set_value('custom_rejection_category', rejection_category);\n                                frm.set_value('custom_rework_category', rework_category);\n                                frm.set_value('custom_rejection_reason', rejection_reason);\n                                frm.set_value('custom_rework_reason', rework_reason);\n                                frm.set_value('custom_inspected_qty', inspected_qty);\n                                frm.set_value('custom_no_of_bins', values.no_of_bins);\n                                frm.set_value('inspected_by', values.inspected_by);\n                                frm.set_value('custom_shift', values.shift_type);\n                                frm.save().then(() => {\n                                    // Trigger your server-side call here\n                                    frappe.call({\n                                        method: \"onegene.onegene.custom.quality_inspection_state_change\", // replace with your method\n                                        args: {\n                                            quality_inspection: frm.doc.name // passing the saved doc name\n                                        },\n                                        callback: function(r) {\n                                            if (r.message) {\n                                                frm.reload_doc()\n                                            }\n                                        }\n                                    });\n                                });\n\n                                d.hide();\n                            }\n                            // else {\n                            //     frappe.msgprint(\"The Inspected Qty should be equal to the sum of Accepted Qty, Rejected Qty and Rework Qty\")\n                            // }\n                            // if (values.rejected_qty) {\n                            //     if (values.rejected)\n                            // }\n                        }\n                    });\n\n                    // --- Helpers ---\n                    function getEmployeeName() {\n                        frappe.db.get_value(\"Employee\", {\n                                \"name\": d.get_value(\"employee\")\n                            }, \"employee_name\")\n                            .then(r => {\n                                d.set_value(\"employee_name\", r.message ? r.message.employee_name : '');\n                            });\n                    }\n                    \n                    function getUserId() {\n                        frappe.db.get_value(\"Employee\", {\n                                \"name\": d.get_value(\"employee\")\n                            }, \"user_id\")\n                            .then(r => {\n                                d.set_value(\"inspected_by\", r.message ? r.message.user_id : '');\n                            });\n                    }\n                    \n                    function validateInspectedQty() {\n                        const possible = flt(d.get_value(\"possible_inspection_qty\")) || 0;\n                        const inspected = flt(d.get_value(\"inspected_qty\")) || 0;\n                        if (inspected > possible) {\n                            frappe.msgprint(\"Inspected Qty cannot be greater than the Possible Production Quantity\")\n                            d.set_value('inspected_qty', 0);\n                        }\n                    }\n\n                    function validateAcceptedQty() {\n                        const inspected = flt(d.get_value(\"inspected_qty\")) || 0;\n                        const accepted = flt(d.get_value(\"accepted_qty\")) || 0;\n                        if (accepted > inspected) {\n                            frappe.msgprint({\n                                message: `<span style=\"color: red;\">Accepted Qty cannot be greater than the Inspected Qty</span>`,\n                                indicator: \"red\"\n                            });\n                            d.set_value('accepted_qty', 0);\n                            d.set_value('no_of_bins', 0);\n                        }\n                    }\n\n                    function recalculatePendingQty() {\n                        const possible = flt(d.get_value(\"possible_inspection_qty\")) || 0;\n                        const inspected = flt(d.get_value(\"inspected_qty\")) || 0;\n                        const pending = possible - inspected;\n                        d.set_value(\"pending_qty\", pending >= 0 ? pending : 0);\n                        // d.set_value(\"accepted_qty\", inspected >= 0 ? inspected : 0);\n                    }\n\n                    function recalculateBinCount() {\n                        const accepted = flt(d.get_value(\"accepted_qty\")) || 0;\n                        let pack_size = flt(d.get_value(\"pack_size\")) || 0;\n                        if (pack_size > 0) {\n                            bin_count = Math.ceil(accepted / pack_size);\n                            remainder = accepted % pack_size;\n                            if (remainder > 0) {\n                                const accepted = flt(d.get_value(\"accepted_qty\")) || 0;\n                                let pack_size = flt(d.get_value(\"pack_size\")) || 0;\n                                // d.set_value('accepted_qty', accepted - remainder);\n                                d.set_value('accepted_qty', 0)\n                                frappe.msgprint(\"<b style='color: red'>The Accepted Quantity should be in the multiples of Pack Size</b>\")\n                            }\n                        } else {\n                            bin_count = accepted;\n                        }\n                        d.set_value(\"no_of_bins\", bin_count)\n                    }\n\n                    function recalculateRejectedQty() {\n                        const inspected = flt(d.get_value(\"inspected_qty\")) || 0;\n                        const accepted = flt(d.get_value(\"accepted_qty\")) || 0;\n                        const rework = flt(d.get_value(\"rework_qty\")) || 0;\n                        let rejected = inspected - accepted - rework;\n                        if (rejected < 0) rejected = 0;\n                        d.set_value(\"rejected_qty\", rejected);\n                    }\n\n                    function recalculateReworkQty() {\n                        const inspected = flt(d.get_value(\"inspected_qty\")) || 0;\n                        const accepted = flt(d.get_value(\"accepted_qty\")) || 0;\n                        const rejected = flt(d.get_value(\"rejected_qty\")) || 0;\n                        let rework = inspected - accepted - rejected;\n                        if (rework < 0) rework = 0;\n                        d.set_value(\"rework_qty\", rework);\n                    }\n                    \n                    function validateShift() {\n                        let shift = d.get_value(\"shift_type\");\n                        if (shift) {\n                            frappe.call({\n                                method: \"onegene.onegene.custom.get_shift_for_current_time\",\n                                callback: function(r) {\n                                    if (r.message) {\n                                        const shift_list = r.message\n                                            .map(s => s[0])\n                                            .filter(v => v);\n                                        if (shift && !shift_list.includes(shift)) {\n                                            d.set_value(\"shift_type\", \"\");\n                                        }\n                                    }\n                                }\n                            });\n                        }\n                    }\n\n\n                    // --- Bind Changes ---\n                    d.fields_dict.inspected_qty.df.onchange = () => {\n                        validateInspectedQty();\n                        recalculatePendingQty();\n                        recalculateBinCount();\n                    };\n\n                    d.fields_dict.accepted_qty.df.onchange = () => {\n                        validateAcceptedQty();\n                        recalculateBinCount();\n                        // recalculateRejectedQty();\n                        // recalculateReworkQty();\n                    };\n                    \n                    d.fields_dict.shift_type.get_query = () => {\n                        return {\n                            query: \"onegene.onegene.custom.get_shift_for_current_time\",\n                        };\n                    };\n\n                    // d.get_field(\"rejected_qty\").$input.on(\"input\", recalculateReworkQty);\n                    // d.get_field(\"rework_qty\").$input.on(\"input\", recalculateRejectedQty);\n\n                    d.fields_dict.rejection_reason.get_query = () => {\n                        return {\n                            query: \"onegene.onegene.custom.get_rejection_reason\",\n                            filters: {\n                                rejection_category: d.get_value('rejection_category')\n                            }\n                        };\n                    };\n                    d.fields_dict.rework_reason.get_query = () => {\n                        return {\n                            query: \"onegene.onegene.custom.get_rework_reason\",\n                            filters: {\n                                rework_category: d.get_value('rework_category')\n                            }\n                        };\n                    };\n\n                    d.show();\n                }).css({\n                    'color': 'white',\n                    'background-color': \"#000000\"\n                });\n            } else {\n                //     frm.add_custom_button(__(\"Generate QR\"), function () {\n                //     var letter_head = frm.doc.letter_head;\n                //     var f_name = frm.doc.name;\n                //     var print_format =\"Quality Inspection QID\";\n                //      window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                //         + \"doctype=\" + encodeURIComponent(\"Quality Inspection\")\n                //         + \"&name=\" + encodeURIComponent(f_name)\n                //         + \"&trigger_print=1\"\n                //         + \"&format=\" + print_format\n                //         + \"&no_letterhead=0\"\n                //         + \"&letterhead=\" + encodeURIComponent(letter_head) \n                //       ));\n                // }).css({ 'color': 'white', 'background-color': \"#000000\" });\n                if (frm.doc.docstatus == 1 && frm.doc.status == \"Accepted\") {\n\n                    frm.add_custom_button(__(\"Generate QR\"), function() {\n                        frappe.call({\n                            method: \"onegene.onegene.quality_inspection.get_qid_for_quality_inspection_html\",\n                            args: {\n                                quality_inspection: frm.doc.name,\n                            },\n                            callback(r) {\n                                if (r.message) {\n                                    let d = new frappe.ui.Dialog({\n                                        title: 'Generate QR',\n                                        size: \"large\",\n                                        fields: [{\n                                            label: 'QR Preview',\n                                            fieldname: 'html',\n                                            fieldtype: 'HTML',\n                                            options: r.message // set HTML from backend\n                                        }, ],\n                                        primary_action_label: 'Download',\n                                        primary_action(values) {\n                                            frappe.call({\n                                                method: \"onegene.onegene.quality_inspection.get_qid_for_quality_inspection\",\n                                                args: {\n                                                    quality_inspection: frm.doc.name,\n                                                },\n                                                callback(res) {\n                                                    if (res.message) {\n                                                        window.open(res.message); // open PDF link\n                                                    }\n                                                }\n                                            });\n                                            d.hide();\n                                        }\n                                    });\n\n                                    d.show();\n                                }\n                            }\n                        });\n                    }).css({\n                        'color': 'white',\n                        'background-color': \"#000000\"\n                    });\n\n                }\n            }\n    },\n    \n    \n      onload(frm){\n        \n        \n          if(frappe.user.has_role(\"Quality User\")){\n            \n            if(!(frappe.user.has_role(\"Administrator\") || frappe.user.has_role(\"System Manager\") || frappe.user.has_role(\"Quality Manager\") || frappe.user.has_role(\"Quality Engineer\"))){\n             \n             let allowed = [\"custom_inspection_type\",\"reference_type\",\"reference_name\",\"readings\"];\n             \n             frm.fields.forEach(field => {\n                if (!allowed.includes(field.df.fieldname)) {\n                    frm.set_df_property(field.df.fieldname, \"read_only\", 1);\n                } \n            });\n             \n                \n            }\n        }\n        \n        \n    },\n    \n   \n    \n    show_approval_btn(frm) {\n        frm.fields_dict[\"readings\"].grid.update_docfield_property('dis_qty', 'hidden', 0);\n    },\n    hide_approval_btn(frm) {\n        frm.fields_dict[\"readings\"].grid.update_docfield_property('dis_qty', 'hidden', 1);\n    },\n    // set_reading_list_view(frm) {\n    //     let grid = frm.fields_dict.readings.grid;\n\n    //     // Example: Show reading_1 in list view if majority of rows have numeric = 1\n    //     let numeric_count = frm.doc.readings.filter(row => row.numeric).length;\n    //     let show_reading_1 = numeric_count >= frm.doc.readings.length / 2;\n\n    //     grid.update_docfield_property(\"reading_1\", \"in_list_view\", show_reading_1 ? 1 : 0);\n    //     grid.update_docfield_property(\"reading\", \"in_list_view\", show_reading_1 ? 0 : 1);\n\n    //     grid.refresh();\n    // }\n});\n\n\nfrappe.ui.form.on('Quality Inspection Reading', {\n    \n    numeric(frm, cdt, cdn) {\n        // frm.trigger('set_reading_list_view');\n    },\n    reading_1: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_1 >= child.min_value && child.reading_1 <= child.max_value){\n        trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 1 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_2: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_2 >= child.min_value && child.reading_2 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 2 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_3: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_3 >= child.min_value && child.reading_3 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 3 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_4: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_4 >= child.min_value && child.reading_4 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 4 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_5: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_5 >= child.min_value && child.reading_5 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 5 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_6: function(frm, cdt, cdn) {\n         let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_6 >= child.min_value && child.reading_6 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 6 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_7: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_7 >= child.min_value && child.reading_7 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 7 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_8: function(frm, cdt, cdn) {\n        let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_8 >= child.min_value && child.reading_8 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 8 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_9: function(frm, cdt, cdn) {\n         let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_9 >= child.min_value && child.reading_9 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 9 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n    reading_10: function(frm, cdt, cdn) {\n         let child = locals[cdt][cdn]\n        let child_table = frm.doc.readings || [];\n        let row_idx = child_table.findIndex(row => row.name === child.name) + 1; \n        if(child.reading_10 >= child.min_value && child.reading_10 <= child.max_value){\n           trigger_inspect_status(frm);\n        }\n        else{\n            frappe.msgprint(`<b>Row ${row_idx}</b> : Reading 10 value is mismatched  `)\n            trigger_inspect_status(frm);\n        }\n    },\n\n    // reading_1: check_readings,\n    // reading_2: check_readings,\n    // reading_3: check_readings,\n    // reading_4: check_readings,\n    // reading_5: check_readings,\n    // reading_6: check_readings,\n    // reading_7: check_readings,\n    // reading_8: check_readings,\n    // reading_9: check_readings,\n    // reading_10: check_readings\n});\n\nfunction trigger_inspect_status(frm) {\n    if (!frm.doc.readings || frm.doc.readings.length === 0) return;\n    if (!frm.doc.__islocal) {\n        frappe.call({\n            method: \"erpnext.stock.doctype.quality_inspection.quality_inspection.inspect_and_set_status_new\",\n            args: {\n                doc: frm.doc.name\n            },\n            callback: function(r) {\n                if (!r.exc) {\n                    frm.refresh_field('readings');\n                    frm.refresh_field('status');\n                    frm.save()\n                }\n            }\n        });\n    }\n    else {\n        check_readings(frm)\n    }\n}\n\nfunction check_readings(frm) {\n    let rejected = false;\n\n    frm.doc.readings.forEach(row => {\n        for (let i = 1; i <= 5; i++) {\n            let reading = row[`reading_${i}`];\n            if (reading && (reading < row.min_value || reading > row.max_value)) {\n                rejected = true;\n            }\n        }\n    });\n    if (!rejected) {\n        frm.set_value(\"status\", \"Accepted\")\n    }\n    else {\n        frm.set_value(\"status\", \"Rejected\")\n    }\n    // frm.fields_dict[\"readings\"].grid.update_docfield_property('custom_send_for_approval', 'hidden', !show_approval);\n    frm.refresh_field(\"readings\");\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Card",
  "enabled": 0,
  "modified": "2025-12-17 16:35:44.997498",
  "module": "ONEGENE",
  "name": "Job Card List",
  "script": "let core_settings = frappe.listview_settings['Job Card'] || {};\r\n\r\nfrappe.listview_settings['Job Card'] = {\r\n    ...core_settings,\r\n    onload(listview) {\r\n       \r\n        \r\n        listview.filter_area.add([[listview.doctype, 'status', '!=', 'Completed']]);\r\n        listview.filter_area.add([[\r\n            \"Job Card\",\r\n            \"posting_date\",\r\n            \"=\",\r\n            frappe.datetime.get_today()\r\n        ]]);\r\n        listview.filter_area.add([[listview.doctype, 'custom_is_queued', '=', 0]]);\r\n    }\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.080555",
  "module": "ONEGENE",
  "name": "Material Request List",
  "script": "let core_settings = frappe.listview_settings['Material Request'] || {};\n\nfrappe.listview_settings['Material Request'] = {\n    ...core_settings,\n\n    onload: function(listview) {\n        \n        //  if (frappe.user.has_role('Stock User')) {\n        //     // force ignore_user_permissions for filters\n        //     listview.page.fields_dict['custom_department'] &&\n        //         (listview.page.fields_dict['custom_department'].df.ignore_user_permissions = 1);\n\n        //     listview.page.fields_dict['custom_requested_by'] &&\n        //         (listview.page.fields_dict['custom_requested_by'].df.ignore_user_permissions = 1);\n        // }\n        \n        \n        if (frappe.user.has_role('Stock User')) {\n            // Disable user permission filters for custom fields\n            if (listview.page.fields_dict['custom_department']) {\n                listview.page.fields_dict['custom_department'].df.ignore_user_permissions = 1;\n                listview.page.fields_dict['custom_department'].refresh();\n            }\n            if (listview.page.fields_dict['custom_requested_by']) {\n                listview.page.fields_dict['custom_requested_by'].df.ignore_user_permissions = 1;\n                listview.page.fields_dict['custom_requested_by'].refresh();\n            }\n        }\n        \n        \n        \n        \n        \n        \n        listview.filter_area.clear().then(r=>{\n            \n            \n            listview.filter_area.add([[\n            \"Material Request\",\n            \"transaction_date\",\n            \"=\",\n            frappe.datetime.get_today()\n        ]]);\n            \n            \n        });\n        \n    },\n    \n    refresh : function(listview){\n        \n        \n        //  if (frappe.user.has_role('Stock User')) {\n        //     // force ignore_user_permissions for filters\n        //     listview.page.fields_dict['custom_department'] &&\n        //         (listview.page.fields_dict['custom_department'].df.ignore_user_permissions = 1);\n\n        //     listview.page.fields_dict['custom_requested_by'] &&\n        //         (listview.page.fields_dict['custom_requested_by'].df.ignore_user_permissions = 1);\n        // }\n        \n        \n        if (frappe.user.has_role('Stock User')) {\n            // Disable user permission filters for custom fields\n            if (listview.page.fields_dict['custom_department']) {\n                listview.page.fields_dict['custom_department'].df.ignore_user_permissions = 1;\n                listview.page.fields_dict['custom_department'].refresh();\n            }\n            if (listview.page.fields_dict['custom_requested_by']) {\n                listview.page.fields_dict['custom_requested_by'].df.ignore_user_permissions = 1;\n                listview.page.fields_dict['custom_requested_by'].refresh();\n            }\n        }\n        \n        \n      \n        \n        \n    listview.page.add_inner_button(__('Requested vs Actual'), function () {\n    let tableHTML = \"\";\n\n    let d = new frappe.ui.Dialog({\n        title: __(\"Requested vs Actual Qty\"),\n        fields: [\n            {\n                fieldtype: \"Date\",\n                fieldname: \"from_date\",\n                label: \"From Date\",\n                default: frappe.datetime.get_today(),\n                reqd: 1,\n                onchange: function () {\n                    update_table();\n                }\n            },\n            {\n                fieldtype: 'Column Break',\n            },\n            {\n                fieldtype: \"Date\",\n                fieldname: \"to_date\",\n                label: \"To Date\",\n                default: frappe.datetime.get_today(),\n                reqd: 1,\n                onchange: function () {\n                    update_table();\n                }\n            },\n            {\n                fieldtype: 'Section Break',\n            },\n            {\n                fieldtype: \"HTML\",\n                fieldname: \"requested_vs_actual_table\",\n                options: tableHTML\n            }\n        ],\n        size: 'large',\n        primary_action_label: __('Download'),\n        \n        \n        primary_action() {\n    let from_date = d.get_value('from_date');\n    let to_date = d.get_value('to_date');\n\n    if (!from_date || !to_date) {\n        frappe.msgprint(__('Please select both From Date and To Date'));\n        return;\n    }\n\n    \n    let download_url = `/api/method/onegene.onegene.custom.download_request_vs_actual_excel?from_date=${from_date}&to_date=${to_date}`;\n    \n    \n    window.open(download_url);\n}\n        \n                \n                \n                \n    });\n\n    d.show();\n    \n    d.get_primary_btn().prop(\"disabled\", true);\n\n    function update_table() {\n        let from_date = d.get_value('from_date');\n        let to_date = d.get_value('to_date');\n\n        \n        if (!from_date || !to_date) {\n            d.get_primary_btn().prop(\"disabled\", true);\n            return;\n        }\n\n        frappe.call({\n            method: \"onegene.onegene.custom.request_vs_actual_mt\",\n            args: {\n                from_date: from_date,\n                to_date: to_date\n            },\n            callback: function (response) {\n                let data = response.message;\n                if (data && data.length > 0) {\n                    let tableRows = '';\n                    let total_requested = 0;\n                    let total_completed = 0;\n\n                    data.forEach(row => {\n                        if (row.requested_qty > 0) {\n                            total_requested += row.requested_qty;\n                            total_completed += row.completed_qty;\n\n                            tableRows += `\n                                <tr style=\"border:1px solid black;\"> \n                                    <td style=\"text-align:left; border:1px solid black;\">${row.item_code}</td>\n                                    <td style=\"text-align:left; border:1px solid black;\">${row.item_name}</td>\n                                    <td style=\"text-align:right; border:1px solid black;\">${row.requested_qty.toFixed(2)}</td>\n                                    <td style=\"text-align:right; border:1px solid black;\">${row.completed_qty > 0 ? row.completed_qty.toFixed(2) : \"-\"}</td>\n                                </tr>\n                            `;\n                        }\n                    });\n\n                    total_requested = total_requested.toFixed(2);\n                    total_completed = total_completed.toFixed(2);\n\n                    let tableHTML = `\n                        <table class=\"table table-bordered\" style=\"border:1px solid black;\">\n                            <thead>\n                                <tr style=\"border:1px solid black;\">\n                                    <th style=\"text-align:center; background-color:orange; border:1px solid black;\">Item Code</th>\n                                    <th style=\"text-align:center; background-color:orange; border:1px solid black;\">Item Name</th>\n                                    <th style=\"text-align:center; background-color:orange; border:1px solid black;\">Requested</th>\n                                    <th style=\"text-align:center; background-color:orange; border:1px solid black;\">Issued</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                ${tableRows}\n                                <tr style=\"background-color:yellow; font-weight:bold; border:1px solid black;\">\n                                    <td colspan=\"2\" style=\"border:1px solid black;\">Total</td>\n                                    <td colspan=\"1\" style=\"border:1px solid black; text-align:right;\">${total_requested}</td>\n                                    <td colspan=\"1\" style=\"border:1px solid black; text-align:right;\">${total_completed}</td>\n                                </tr>\n                            </tbody>\n                        </table>\n                    `;\n                    d.fields_dict['requested_vs_actual_table'].$wrapper.html(tableHTML);\n                    d.get_primary_btn().prop(\"disabled\", false);\n                } else {\n                    d.fields_dict['requested_vs_actual_table'].$wrapper.html(\"<p style='text-align:center; color:red; '>No data available</p>\");\n                    d.get_primary_btn().prop(\"disabled\", true);\n                }\n            }\n        });\n    }\n});\n\n     \n\n   \n    }\n};\n\n\n\n\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.714614",
  "module": "ONEGENE",
  "name": "Stock Entry",
  "script": "// frappe.ui.form.on('Stock Entry', {\n//     refresh(frm) {\n//         // frm.add_custom_button(__(\"Entry\"), function() {\n//         //     let d = new frappe.ui.Dialog({\n//         //         title: __('Enter Details'),\n//         //         fields: [{\n//         //                 fieldtype: 'Link',\n//         //                 label: __('Inspection ID'),\n//         //                 fieldname: 'quality_inspection',\n//         //                 options: 'Quality Inspection',\n//         //                 reqd: 1,\n//         //                 change: function() {\n//         //                     getQualityInspectionData();\n//         //                 }\n//         //             },\n//         //             {\n//         //                 fieldtype: 'Link',\n//         //                 label: __('Item Code'),\n//         //                 fieldname: 'item_code',\n//         //                 options: 'Item',\n//         //                 reqd: 1,\n//         //                 read_only: 1,\n//         //             },\n//         //             {\n//         //                 fieldtype: 'Int',\n//         //                 label: __('Receiving Qty'),\n//         //                 fieldname: 'accepted_qty',\n//         //                 reqd: 1,\n//         //                 read_only: 1,\n//         //             },\n//         //             {\n//         //                 fieldtype: 'Link',\n//         //                 label: __('Rack'),\n//         //                 fieldname: 'rack',\n//         //                 options: 'Rack',\n//         //                 reqd: 1\n//         //             },\n//         //             {\n//         //                 fieldtype: 'Link',\n//         //                 label: __('Location'),\n//         //                 fieldname: 'location',\n//         //                 options: 'Rack Location',\n//         //                 reqd: 1\n//         //             },\n//         //             {\n//         //                 fieldtype: 'Link',\n//         //                 label: __('UOM'),\n//         //                 fieldname: 'uom',\n//         //                 options: 'UOM',\n//         //                 hidden: 1\n//         //             },\n//         //         ],\n//         //         primary_action_label: __('Submit'),\n//         //         primary_action(values) {\n//         //             // frm.set_value(\"from_warehouse\", \"Quality Outward - WAIP\");\n//         //             // frm.set_value(\"to_warehouse\", \"Finished Goods - WAIP\");\n//         //             frm.doc.items = frm.doc.items.filter(row => row.item_code);\n//         //             let child = frm.add_child(\"items\", {\n//         //                 item_code: values.item_code, // Or fetch item_code linked to this inspection\n//         //                 qty: values.accepted_qty,\n//         //                 s_warehouse: \"Quality Outward - WAIP\",\n//         //                 t_warehouse: \"Finished Goods - WAIP\",\n//         //                 custom_rack: values.rack,\n//         //                 custom_location: values.location,\n//         //                 uom: values.uom,\n//         //                 conversion_factor: 1,\n//         //                 transfer_qty: values.accepted_qty,\n//         //             });\n\n//         //             frm.refresh_field(\"items\");\n//         //             d.hide();\n//         //         }\n//         //     });\n\n//         //     function getQualityInspectionData() {\n//         //         let quality_inspection = d.get_value(\"quality_inspection\");\n//         //         if (!quality_inspection) return;\n\n//         //         frappe.call({\n//         //             method: \"onegene.onegene.custom.get_quality_inspection_data\",\n//         //             args: {\n//         //                 quality_inspection: quality_inspection\n//         //             },\n//         //             callback: function(r) {\n//         //                 if (r.message) {\n//         //                     let accepted_qty = r.message[1] || 0;\n//         //                     let rack = r.message[2] || \"\";\n//         //                     let location = r.message[3] || \"\";\n//         //                     let item_code = r.message[0] || \"\";\n//         //                     let uom = r.message[4] || \"\";\n\n//         //                     d.set_value(\"item_code\", item_code);\n//         //                     d.set_value(\"accepted_qty\", accepted_qty);\n//         //                     d.set_value(\"uom\", uom);\n//         //                     d.set_value(\"rack\", rack);\n//         //                     d.set_value(\"location\", location);\n//         //                 }\n//         //             }\n//         //         });\n//         //     }\n            \n//         //     d.fields_dict.rack.get_query = () => {\n//         //         return {\n//         //             query: \"onegene.onegene.custom.get_rack_query\",\n//         //             filters: {\n//         //                 item_code: d.get_value(\"item_code\")\n//         //             }\n//         //         };\n//         //     };\n        \n            \n//         //     d.fields_dict.location.get_query = () => {\n//         //         return {\n//         //             query: \"onegene.onegene.custom.get_rack_location_query\",\n//         //             filters: {\n//         //                 item_code: d.get_value(\"item_code\")\n//         //             }\n//         //         };\n//         //     }\n            \n//         //     d.show();\n//         // });\n\n//         if (frm.doc.custom_issued_by != '' && frm.doc.__islocal) {\n//             user = frappe.session.user\n//             frappe.db.get_value(\"Employee\", {\n//                     'user_id': user\n//                 }, ['name'])\n//                 .then(r => {\n//                     if (r.message && r.message.name) {\n//                         frm.set_value('custom_issued_by', r.message.name);\n//                     }\n\n//                 })\n//         }\n//         if (frm.doc.__islocal) {\n//             frm.set_value('stock_entry_type', 'Material Transfer')\n//             frappe.after_ajax(() => {\n//                 // Wait a little to ensure items are mapped (if delayed)\n//                 setTimeout(() => {\n//                     (frm.doc.items || []).forEach(item => {\n//                         frappe.model.set_value(item.doctype, item.name, 'qty', 0);\n//                     });\n//                 }, 300); // small delay to ensure items exist\n//             });\n//         }\n//         frm.set_query(\"custom_material_request\", function() {\n//             const today = frappe.datetime.get_today();\n//             const today_830 = `${today} 08:30:00`;\n//             return {\n//                 filters: {\n//                     \"docstatus\": 1,\n//                     \"material_request_type\": \"Material Transfer\",\n//                     \"status\": [\"not in\", [\"Transferred\", \"Issued\", \"Cancelled\", \"Stopped\"]],\n//                     \"creation\": [\">\", today_830]\n//                 }\n//             }\n//         })\n//     },\n//     onload(frm) {\n//         if (frm.doc.custom_issued_by != '' && frm.doc.__islocal) {\n//             user = frappe.session.user\n//             frappe.db.get_value(\"Employee\", {\n//                     'user_id': user\n//                 }, ['name'])\n//                 .then(r => {\n//                     if (r.message && r.message.name) {\n//                         frm.set_value('custom_issued_by', r.message.name);\n//                     }\n\n//                 })\n//         }\n//         if (frm.doc.__islocal) {\n//             frm.set_value('stock_entry_type', 'Material Transfer')\n//             frappe.after_ajax(() => {\n//                 setTimeout(() => {\n//                     (frm.doc.items || []).forEach(item => {\n//                         frappe.model.set_value(item.doctype, item.name, 'qty', 0);\n//                     });\n//                 }, 300);\n//             });\n\n//             frm.refresh_field('items');\n//             setTimeout(function() {\n//             if (frm.doc.custom_material_request && frm.doc.__islocal) {\n//                 frappe.call({\n//                     method: \"frappe.client.get\",\n//                     args: {\n//                         doctype: \"Material Request\",\n//                         name: frm.doc.custom_material_request\n//                     },\n//                     callback: function(response) {\n//                         if (response.message) {\n//                             let mr_doc = response.message;\n\n//                             frm.doc.items.forEach(item => {\n//                                 frappe.model.set_value(item.doctype, item.name, 't_warehouse', \"Shop Floor - WAIP\");\n//                                 let matching_item = mr_doc.items.find(mr_item => mr_item.item_code === item.item_code);\n\n//                                 if (matching_item) {\n//                                     let balance_qty = flt(matching_item.qty) - flt(matching_item.ordered_qty);\n\n//                                     frappe.model.set_value(item.doctype, item.name, 'balance_qty_to_receive', balance_qty);\n//                                 }\n//                             });\n//                         }\n//                     }\n//                 });\n//             }\n//         }, 1000);\n//         }\n//     },\n//     custom_material_request(frm) {\n//         frappe.call({\n//             method: \"erpnext.stock.doctype.material_request.material_request.make_stock_entry\",\n//             args: {\n//                 source_name: frm.doc.custom_material_request, // first selected MR\n//             },\n//             callback(r) {\n//                 if (!r.message) return;\n//                 // Clear existing items in Stock Entry\n//                 frm.clear_table(\"items\");\n\n//                 // Add items from the response\n//                 (r.message.items || []).forEach(row => {\n//                     const child = frm.add_child(\"items\");\n//                     Object.assign(child, row);\n//                     child.qty = 0;\n//                 });\n                \n//                 frm.doc.to_warehouse = \"Shop Floor - WAIP\";\n//                 frm.refresh_field(\"items\");\n//             }\n//         });\n//     }\n\n// })\n\n// frappe.ui.form.on('Stock Entry Detail', {\n//     qty(frm, cdt, cdn) {\n//         var child = locals[cdt][cdn]\n        \n//          if(child.item_code){\n//           frappe.db.get_value(\"Item\",{\"name\":child.item_code},\"custom_warehouse\").then(r=>{\n//               if (r.message && r.message.custom_warehouse){\n//                   frappe.model.set_value(cdt,cdn,\"t_warehouse\",r.message.custom_warehouse)\n//               }\n               \n//           })\n           \n           \n//         }\n        \n        \n//         if (child.s_warehouse || child.t_warehouse && frm.doc.stock_entry_type == \"Material Transfer\") {\n//             frappe.call({\n//                 'method': 'onegene.onegene.custom.validate_stock_qty',\n//                 'args': {\n//                     'item_code': child.item_code,\n//                     \"warehouse\": child.s_warehouse || child.t_warehouse,\n//                     \"posting_date\": frm.doc.posting_date,\n//                     \"posting_time\": frm.doc.posting_time,\n//                     \"qty\": child.qty,\n//                     \"idx\": child.idx\n//                 }\n//             })\n//             if (child.qty > child.actual_qty) {\n//                 frappe.model.set_value(cdt, cdn, 'qty', 0);\n//             }\n//         }\n//     },\n//     item_code(frm, cdt, cdn) {\n//         var child = locals[cdt][cdn]\n        \n    \n        \n//         if (child.s_warehouse || child.t_warehouse && frm.doc.stock_entry_type == \"Material Transfer\") {\n//             frappe.call({\n//                 'method': 'onegene.onegene.custom.validate_stock_qty',\n//                 'args': {\n//                     'item_code': child.item_code,\n//                     \"warehouse\": child.s_warehouse || child.t_warehouse,\n//                     \"posting_date\": frm.doc.posting_date,\n//                     \"posting_time\": frm.doc.posting_time,\n//                     \"qty\": child.qty,\n//                     \"idx\": child.idx\n//                 }\n//             })\n//         }\n//         if (frm.doc.custom_material_request && child.item_code) {\n//             frappe.call({\n//                 method: \"frappe.client.get\",\n//                 args: {\n//                     doctype: \"Material Request\",\n//                     name: frm.doc.custom_material_request\n//                 },\n//                 callback: function(response) {\n//                     if (response.message) {\n//                         var mr_doc = response.message;\n\n//                         // Find matching item row in Material Request\n//                         var matching_item = mr_doc.items.find(mr_item => mr_item.item_code === child.item_code);\n\n//                         if (matching_item) {\n//                             var balance_qty = flt(matching_item.qty) - flt(matching_item.ordered_qty);\n\n//                             frappe.model.set_value(cdt, cdn, \"balance_qty_to_receive\", balance_qty);\n//                         }\n//                     }\n//                 }\n//             });\n//         }\n\n        \n//     }\n// })\n\n// frappe.ui.form.on('Stock Entry', {\n//     onload: function(frm) {\n//         if (!frm.doc.posting_time) {\n//             frm.set_value('posting_time', frappe.datetime.now_time());\n//         }\n//     }\n// });\n\n\nfrappe.ui.form.on('Stock Entry Detail', {\n    \n    \n    item_code(frm, cdt, cdn) {\n        \n        var child = locals[cdt][cdn]\n        \n        \n         if(child.item_code){\n          frappe.db.get_value(\"Item\",{\"name\":child.item_code},\"custom_warehouse\").then(r=>{\n               if (r.message && r.message.custom_warehouse){\n                   frappe.model.set_value(cdt,cdn,\"t_warehouse\",r.message.custom_warehouse)\n               }\n               \n           })\n           \n           \n        }\n        \n    }\n})\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order Schedule",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.721575",
  "module": "ONEGENE",
  "name": "Sales Order Schedule",
  "script": "let core_settings = frappe.listview_settings['Sales Order Schedule'] || {};\nfrappe.listview_settings['Sales Order Schedule'] = {\n    ...core_settings,\n\tonload: function(listview) {\n\t    \n\t    listview.filter_area.clear().then(r=>{\n            \n            const currentMonth = new Date().toLocaleString('default', { month: 'short' }).toUpperCase();\n       \n        \n        listview.filter_area.add([[\n            \"Sales Order Schedule\",\"schedule_month\" ,\"=\",currentMonth\n\n            \n            ]]);\n            \n             if (frappe.user.has_role(\"Administrator\") || frappe.user.has_role(\"System Manager\")) {\n            listview.page.add_inner_button(\"Import Schedule\", function() {\n                frappe.set_route('sales-order-schedule-settings')\n            });\n        }\n            \n            \n        })\n\t    \n\t    \n       \n        \n    },\n    \n    \n      \nrefresh: function(listview) {\n        listview.page.add_inner_button(__('Customer Wise'), function() {\n            const filters = listview.filter_area.get();\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\n\n            const year = new Date().getFullYear().toString().slice(-2);\n\n\n            if (!mon) {\n                mon = new Date().toLocaleString('default', {\n                    month: 'short'\n                }).toUpperCase();\n            }\n\n\n\n            frappe.call({\n                method: \"onegene.onegene.custom.customer_wise_plan\",\n                args: {\n                    month: mon\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        const groupedData = r.message;\n                        const groups = Object.keys(groupedData);\n\n                        const leftGroup = groups.find(g => g.toUpperCase() === 'DOMESTIC') || groups[0] || 'DOMESTIC';\n                        const rightGroup = groups.find(g => g.toUpperCase() === 'EXPORT') || groups[1] || 'EXPORT';\n\n                        const leftCustomers = groupedData[leftGroup] || {};\n                        const rightCustomers = groupedData[rightGroup] || {};\n\n                        // generateTableHTML now returns {html, subtotal}\n                        const leftData = generateTableHTML(leftGroup, leftCustomers);\n                        const rightData = generateTableHTML(rightGroup, rightCustomers);\n\n                        const combinedHTML = `\n                <style>\n                    .table-container {\n                        display: flex;\n                        justify-content: space-between;\n                        align-items: flex-start;\n                        gap: 20px;\n                        flex-wrap: wrap;\n                    }\n                    .table-wrapper {\n                        flex: 1;\n                        min-width: 48%;\n                    }\n                    table {\n                        width: 100%;\n                        border-collapse: collapse;\n                    }\n                    th, td {\n                        padding: 6px;\n                        text-align: left;\n                        font-size: 12px;\n                        vertical-align: top;\n                    }\n                    th {\n                        background-color: #ffc000;\n                        text-align: center;\n                        color: black;\n                    }\n                    .subtotal-row {\n                        \n                        font-weight: bold;\n                    }\n                    .type-text {\n                        color: red;\n                        font-weight: bold;\n                        text-align: center;\n                        vertical-align: middle;\n                    }\n                    .no-right-border {\n                        border-right: none !important;\n                    }\n                </style>\n                <div style=\"border:0.3px solid gray;border-bottom-width: thin;\">\n                <div style=\"display: flex; justify-content: center; align-items: center;border-bottom:1px solid gray;\">\n                    <p style=\"font-size:20px; font-weight:bold; margin-top:5px; color:black; \">Customer Wise Sales Plan - ${mon}'${year}</p>\n                </div>\n\n                <div class=\"table-container\" style=\"border-right:hidden;\">\n                    <div class=\"table-wrapper\" style=\"border-left:none;\">${leftData.html}</div>\n                    <div class=\"table-wrapper\" style=\"border-right:hidden !important;border-bottom:hidden !important;border-width:thin;\">${rightData.html}</div>\n                </div>\n                \n                <div style=\"display: flex;  align-items: center; border: 0.5px solid gray; background-color:yellow; border-bottom:hidden;border-left:hidden;border-right:hidden;\">\n                    <p style=\"font-weight:bold; margin-top:5px; margin-left:500px; color:black;\">\n                        Total Sales Plan: <span style=\"margin-left:150px;border-top:hidden;\">₹ ${(leftData.subtotal + rightData.subtotal).toLocaleString()}</span>\n                    </p>\n                </div>\n                </div>\n            `;\n\n                        let dialog = new frappe.ui.Dialog({\n                            title: __(\"Customer Wise Sales Plan\"),\n                            fields: [{\n                                fieldtype: \"HTML\",\n                                fieldname: \"customer_wise_table\",\n                                options: combinedHTML\n                            }],\n                            size: 'extra-large'\n                        });\n\n                        dialog.show();\n                    }\n                }\n            });\n\n\n\n\n\n\n        }, __('Summary Value'));\n\n\n        listview.page.add_inner_button(__('Department Wise'), function() {\n            const filters = listview.filter_area.get();\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\n\n            const year = new Date().getFullYear().toString().slice(-2);\n\n            if (!mon) {\n                mon = new Date().toLocaleString('default', {\n                    month: 'short'\n                }).toUpperCase();\n            }\n\n            frappe.call({\n                method: \"onegene.onegene.custom.department_wise_plan\",\n                args: {\n                    month: mon\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        const groupedData = r.message;\n                        const departments = Object.keys(groupedData) // sorted for clarity\n                        let grandTotal = 0;\n\n                        let tableHTML = `\n                    <style>\n                        table {\n                            width: 100%;\n                            border-collapse: collapse;\n                            font-size: 13px;\n                        }\n                        th, td {\n                            border: 1px solid #000;\n                            padding: 8px;\n                            text-align: left;\n                        }\n                        th {\n                            background-color: #ffc000;\n                            color: black;\n                            text-align: center;\n                        }\n                        .title-row td {\n                            font-size: 18px;\n                            font-weight: bold;\n                            text-align: center;\n                            border: none;\n                            padding: 12px 0;\n                        }\n                        .total-row {\n                            background-color: #ffff00;\n                            font-weight: bold;\n                        }\n                        .right-align {\n                            text-align: right;\n                        }\n                    </style>\n\n                    <table>\n                        \n                        <thead>\n                        <tr >\n                            <td colspan=\"2\" style=\"text-align:center; font-size:20px; font-weight:bold; color:black;\">Department Wise Sales Plan - ${mon}'${year}</td>\n                        </tr>\n                            <tr>\n                                <th style=\"color:black;\">Department</th>\n                                <th style=\"color:#2206f6;\">Schedule Value</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                `;\n\n                        departments.forEach(dep => {\n                            let amount = groupedData[dep] || 0;\n                            amount = Math.round(amount);\n                            grandTotal += amount;\n\n                            tableHTML += `\n                        <tr>\n                            <td style=\"color:black;\">${dep}</td>\n                            <td class=\"right-align\" style=\"color:black;\">${amount === 0 ? \"-\" : \"₹ \" + amount.toLocaleString()}</td>\n                        </tr>\n                    `;\n                        });\n\n                        // Add TOTAL row\n                        tableHTML += `\n                    <tr class=\"total-row\">\n                        <td style=\"color:black;\">TOTAL</td>\n                        <td class=\"right-align;\" style=\" text-align:right; color:black;\">₹ ${grandTotal.toLocaleString()}</td>\n                    </tr>\n                `;\n\n                        tableHTML += `</tbody></table>`;\n\n                        let dialog = new frappe.ui.Dialog({\n                            title: __(\"Department Wise Sales Plan\"),\n                            fields: [{\n                                fieldtype: \"HTML\",\n                                fieldname: \"department_wise_table\",\n                                options: tableHTML\n                            }],\n                            size: 'medium'\n                        });\n\n                        dialog.show();\n                    }\n                }\n            });\n        }, __('Summary Value'));\n\n        listview.page.add_inner_button(__('Customer Group Wise'), function() {\n            const filters = listview.filter_area.get();\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\n\n            const year = new Date().getFullYear().toString().slice(-2);\n\n            if (!mon) {\n                mon = new Date().toLocaleString('default', {\n                    month: 'short'\n                }).toUpperCase();\n            }\n\n            frappe.call({\n                method: \"onegene.onegene.custom.customer_group_wise\",\n                args: {\n                    month: mon\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        const groupedData = r.message;\n                        const departments = Object.keys(groupedData) // sorted for clarity\n                        let grandTotal = 0;\n\n                        let tableHTML = `\n                    <style>\n                        table {\n                            width: 100%;\n                            border-collapse: collapse;\n                            font-size: 13px;\n                        }\n                        th, td {\n                            border: 1px solid #000;\n                            padding: 8px;\n                            text-align: left;\n                        }\n                        th {\n                            background-color: #ffc000;\n                            color: black;\n                            text-align: center;\n                        }\n                        .title-row td {\n                            font-size: 18px;\n                            font-weight: bold;\n                            text-align: center;\n                            border: none;\n                            padding: 12px 0;\n                        }\n                        .total-row {\n                            background-color: #ffff00;\n                            font-weight: bold;\n                        }\n                        .right-align {\n                            text-align: right;\n                        }\n                    </style>\n\n                    <table>\n                        \n                        <thead>\n                        <tr >\n                            <td colspan=\"2\" style=\"text-align:center; font-size:20px; font-weight:bold; color:black;\">Customer Group Wise Sales Plan - ${mon}'${year}</td>\n                        </tr>\n                            <tr>\n                                <th style=\"color:black;\">Customer Group</th>\n                                <th style=\"color:#2206f6;\">Schedule Value</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                `;\n\n                        departments.forEach(dep => {\n                            let amount = groupedData[dep] || 0;\n                            amount = Math.round(amount);\n                            grandTotal += amount;\n\n                            tableHTML += `\n                        <tr>\n                            <td style=\"color:black;\">${dep}</td>\n                            <td class=\"right-align\" style=\"color:black;\">${amount === 0 ? \"-\" : \"₹ \" + amount.toLocaleString()}</td>\n                        </tr>\n                    `;\n                        });\n\n                        // Add TOTAL row\n                        tableHTML += `\n                    <tr class=\"total-row\">\n                        <td style=\"color:black;\">TOTAL</td>\n                        <td class=\"right-align;\" style=\" text-align:right; color:black;\">₹ ${grandTotal.toLocaleString()}</td>\n                    </tr>\n                `;\n\n                        tableHTML += `</tbody></table>`;\n\n                        let dialog = new frappe.ui.Dialog({\n                            title: __(\"Customer Group Wise Sales Plan\"),\n                            fields: [{\n                                fieldtype: \"HTML\",\n                                fieldname: \"department_wise_table\",\n                                options: tableHTML\n                            }],\n                            size: 'medium'\n                        });\n\n                        dialog.show();\n                    }\n                }\n            });\n        }, __('Summary Value'));\n\n        if (frappe.user.has_role(\"System Manager\") || frappe.user.has_role(\"Administrator\")) {\n            listview.page.add_inner_button(__('Currency'), function() {\n            const filters = listview.filter_area.get();\n            const scheduleMonthFilter = filters.find(f => f[1] === \"schedule_month\");\n            let mon = scheduleMonthFilter ? scheduleMonthFilter[3] : null;\n\n            const year = new Date().getFullYear().toString().slice(-2);\n            const nextyear = parseInt(year) + 1;\n\n            if (!mon) {\n                mon = new Date().toLocaleString('default', {\n                    month: 'short'\n                }).toUpperCase();\n            }\n\n\n            frappe.call({\n                method: \"onegene.onegene.doctype.sales_order_schedule.sales_order_schedule.currency_exchange_rate_list\",\n                args: {\n                    month: mon\n                },\n                callback: function(r) {\n                    if (r.message) {\n\n                        const dialog = new frappe.ui.Dialog({\n                            title: __(\"Currency Exchange Rate List\"),\n                            fields: [{\n                                label: \"Exchange Rates\",\n                                fieldname: \"exchange_rates\",\n                                fieldtype: \"Table\",\n                                cannot_add_rows: true,\n                                in_place_edit: true,\n                                data: r.message,\n                                fields: [{\n                                        fieldname: 'currency',\n                                        fieldtype: 'Data',\n                                        label: 'Currency',\n                                        read_only: 1,\n                                        in_list_view: 1,\n                                    },\n                                    {\n                                        fieldname: 'exchange_rate',\n                                        fieldtype: 'Float',\n                                        label: 'Exchange Rate (INR)',\n                                        precision: 6,\n                                        in_list_view: 1,\n                                    }\n                                ]\n                            }],\n                            size: \"medium\"\n                        });\n\n                        dialog.set_primary_action(\"Update\", function() {\n\n                            // ✅ get values from dialog\n                            const values = dialog.get_values();\n\n                            frappe.call({\n                                method: \"onegene.onegene.doctype.sales_order_schedule.sales_order_schedule.update_exchange_rates\",\n                                args: {\n                                    month: mon,\n                                    data: JSON.stringify(values.exchange_rates),\n                                },\n                                freeze: true,\n                                callback: function(r) {\n                                    if (r.message) {\n                                        frappe.msgprint({\n                                            title: __('Success'),\n                                            message: __('Exchange Rate updated successfully.'),\n                                            indicator: 'green'\n                                        });\n                                    }\n                                }\n                            });\n\n                            dialog.hide();\n                        });\n\n                        dialog.show();\n                    }\n                }\n            });\n\n\n\n\n        });\n        }\n\n    }\n\n\n    \n}\n\n\n\n\nfunction generateTableHTML(group, customers) {\n    const keys = Object.keys(customers);\n    let subtotal = 0;\n\n    keys.sort((a, b) => {\n        const aIsHanon = a.trim().toLowerCase().startsWith(\"hanon\");\n        const bIsHanon = b.trim().toLowerCase().startsWith(\"hanon\");\n\n        if (aIsHanon && !bIsHanon) return -1; // a first\n        if (!aIsHanon && bIsHanon) return 1; // b first\n        return 0; // otherwise keep original order\n    });\n\n\n    let html = `\n        <table border=\"1\" style=\"border-collapse:collapse;\">\n            <thead>\n                <tr>\n                    <th style=\"width: 100px;border-top:hidden;\">Type</th>\n                    <th style=\"border-top:hidden;\">Customer</th>\n                    <th style=\"color:#2206f6;border-top:hidden;\">Schedule Value</th>\n                </tr>\n            </thead>\n            <tbody>\n    `;\n\n    keys.forEach((cust, index) => {\n        let value = customers[cust] || 0;\n        value = Math.round(value);\n        subtotal += value;\n\n        html += `<tr>`;\n\n        // For the \"Type\" column, show group name only once (rowspan)\n        if (index === 0) {\n            const borderStyle = group === \"Domestic\" ? \"border-left: hidden;\" : \"\";\n            const borderStyle_EXPORT = group === \"Export\" ? \"border-bottom: hidden;\" : \"\";\n            html += `<td rowspan=\"${keys.length +1}\" class=\"type-text\" style=\"vertical-align: middle; text-align: center; font-weight: bold; color: #b00d0a;${borderStyle}${borderStyle_EXPORT}\">${group ==\"Domestic\" ? \"DOMESTIC\" : \"EXPORT\"}</td>`;\n        }\n        const borderStyle_new = group === \"Export\" ? \"border-right: hidden;\" : \"\";\n        html += `\n                <td style=\"font-weight:bold;color:black;\">${cust}</td>\n                <td style=\"text-align:right; font-weight:bold; color:black;${borderStyle_new}\">${value ? \"₹ \" + value.toLocaleString() : \"-\"}</td>\n            </tr>`;\n    });\n\n    if (keys.length === 0) {\n\n        html += `\n            <tr>\n                <td class=\"type-text\" style=\"vertical-align: middle; text-align: center; font-weight: bold; color: #b00d0a;\">${group}</td>\n                <td colspan=\"2\" style=\"text-align:center;\">No Data</td>\n            </tr>`;\n    }\n    subtotal = Math.round(subtotal);\n    const borderStyle_EXPORT = group === \"Export\" ? \"border-bottom: hidden !important;\" : \"\";\n    // Only subtotal row remains\n    html += `\n        <tr>\n            \n            <td colspan=\"1\" style=\"background-color: #00ffff; color:black;${borderStyle_EXPORT} \">SUB TOTAL</td>\n            <td style=\"text-align:right; background-color: #00ffff; color:black;${borderStyle_EXPORT} \">₹ ${subtotal.toLocaleString()}</td>\n        </tr>\n    </tbody></table>`;\n\n    return {\n        html,\n        subtotal\n    };\n}\n\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.104754",
  "module": "ONEGENE",
  "name": "Item List",
  "script": "let core_settings = frappe.listview_settings['Item'] || {};\r\n\r\nfrappe.listview_settings['Item'] = {\r\n    ...core_settings,\r\n    onload(listview) {\r\n\r\n        listview.filter_area.clear().then(() => {\r\n            listview.filter_area.add([\r\n                [\"Item\", \"custom_service_category\", \"!=\", \"Subcontracting\"]\r\n            ]);\r\n        });\r\n    }\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Workflow Notification Settings",
  "enabled": 0,
  "modified": "2025-12-17 16:35:44.503000",
  "module": "ONEGENE",
  "name": "Workflow Notification Settings",
  "script": "frappe.ui.form.on('Workflow Notification Settings', {\r\n    refresh(frm) {\r\n        let list = [\r\n            'Approved by CMD',\r\n            'Approved by HOD',\r\n            'Draft',\r\n            'Scheduled',\r\n            'Dispatched',\r\n            'Approved by BMD',\r\n            'Approved by SMD',\r\n            'Invoice Submitted',\r\n            'Variation - Pending for Finance',\r\n            'Finance',\r\n            'In Transit',\r\n            'Delivered',\r\n            'Closed',\r\n            'Pending for Finance',\r\n            'Approved by Finance',\r\n            'Pending for CMD'\r\n        ];\r\n\r\n        frm.fields_dict[\"workflow_notification\"].grid.get_field(\"workflow_state\").get_query = function(doc, cdt, cdn) {\r\n            let row = locals[cdt][cdn];\r\n            if (row.document_type === \"Logistics Request\") {\r\n                return {\r\n                    filters: {\r\n                        name: [\"in\", list]\r\n                    }\r\n                };\r\n            }\r\n        };\r\n        frm.fields_dict[\"workflow_notification\"].grid.get_field(\"document_type\").get_query = function(doc, cdt, cdn) {\r\n            let row = locals[cdt][cdn];\r\n                return {\r\n                    filters: {\r\n                        name: [\"in\", 'Logistics Request']\r\n                    }\r\n                };\r\n            \r\n        };\r\n        \r\n    }\r\n});\r\nfrappe.ui.form.on(\"Workflow Notification\", {   // child table doctype\r\n    validate(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n\r\n        if (row.receiver) {\r\n            // Split by newline or comma\r\n            let emails = row.receiver\r\n                .split(/[\\n,]+/)\r\n                .map(e => e.trim())\r\n                .filter(Boolean);\r\n\r\n            let always_send = (frm.doc.always_send_to || \"\")\r\n                .split(\"\\n\")\r\n                .map(e => e.trim())\r\n                .filter(Boolean);\r\n\r\n            let email_regex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n\r\n            for (let email of emails) {\r\n                // 1. Validate format\r\n                if (!email_regex.test(email)) {\r\n                    frappe.msgprint({\r\n                        title: __(\"Validation\"),\r\n                        message: __(\"Receiver <b>{0}</b> is not a valid email address\", [email]),\r\n                        indicator: \"red\"\r\n                    });\r\n                    frappe.model.set_value(cdt, cdn, \"receiver\", \"\");\r\n                    return;\r\n                }\r\n\r\n                // 2. Validate against \"Always send to these ids\"\r\n                if (always_send.includes(email)) {\r\n                    frappe.msgprint({\r\n                        title: __(\"Validation\"),\r\n                        message: __(\"Receiver <b>{0}</b> already exists in 'Always send to these ids'\", [email]),\r\n                        indicator: \"red\"\r\n                    });\r\n                    frappe.model.set_value(cdt, cdn, \"receiver\", \"\");\r\n                    return;\r\n                }\r\n\r\n                // 3. Validate against enabled System Users\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"User\",\r\n                        filters: {\r\n                            email: email,\r\n                            enabled: 1\r\n                        },\r\n                        fields: [\"name\"]\r\n                    },\r\n                    callback: function(r) {\r\n                        if (!r.message || r.message.length === 0) {\r\n                            frappe.msgprint({\r\n                                title: __(\"Validation\"),\r\n                                message: __(\"Receiver <b>{0}</b> is not an enabled User\", [email]),\r\n                                indicator: \"red\"\r\n                            });\r\n                            frappe.model.set_value(cdt, cdn, \"receiver\", \"\");\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    }\r\n});\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quality Pending",
  "enabled": 1,
  "modified": "2025-12-17 16:35:45.067027",
  "module": "ONEGENE",
  "name": "Quality Pending",
  "script": "frappe.listview_settings['Quality Pending'] = {\r\n    onload(listview) {\r\n        listview.filter_area.add([[listview.doctype, 'status', '!=', 'Completed']]);\r\n    }\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "General DC",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.559328",
  "module": "ONEGENE",
  "name": "General DC",
  "script": "frappe.ui.form.on('General DC', {\n    validate: function(frm) {\n        let total = 0;\n        frm.doc.items.forEach(row => {\n            total += row.amount || 0;\n        });\n        frm.set_value(\"total\", total);\n    },\n\trefresh(frm) {\n\t    $(\"button[data-original-title='Print']\").hide();\n\t\tif(!frm.doc.__islocal && frm.doc.docstatus==1){\n\t         frm.add_custom_button(__(\"Print\"), function () {\n\t\t\tvar f_name = frm.doc.name\n\t\t\tvar print_format = \"General DC\";\n\t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n\t\t\t\t+ \"doctype=\" + encodeURIComponent(\"General DC\")\n\t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n\t\t\t\t+ \"&trigger_print=1\"\n\t\t\t\t+ \"&format=\" + print_format\n\t\t\t\t+ \"&no_letterhead=0\"\n\t\t\t));\n\t\t});\n\t\t}\n\t\tif(!frm.doc.__islocal && frm.doc.docstatus!=2){\n\t\tfrm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.general_dc.general_dc.print_html_view\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n\t\t}\n        \tif(frm.doc.is_return && frm.doc.is_return==1){\n\t\t    if(!frappe.user.has_role(\"System Manager\") && frappe.user.has_role(\"Supplier\")){\n\t\t        \n\t\t       \n\t\t       \n\t\t    frm.set_df_property(\"warehouse\", \"hidden\", 1);\n            frm.set_df_property(\"vehicle_number\", \"hidden\", 1);\n            frm.set_df_property(\"requested_by\", \"hidden\", 1);\n            frm.set_df_property(\"requested_department\", \"hidden\", 1);\n            frm.set_df_property(\"requester_name\", \"hidden\", 1);\n\t\t        \n\t\t    }\n\t\t}\n\t},\n\t\n\t\tis_return(frm){\n\t    \tif(frm.doc.is_return && frm.doc.is_return==1){\n\t\t    if(!frappe.user.has_role(\"System Manager\") && frappe.user.has_role(\"Supplier\")){\n\t\t        \n\t\t       \n\t\t       \n\t\t    frm.set_df_property(\"warehouse\", \"hidden\", 1);\n            frm.set_df_property(\"vehicle_number\", \"hidden\", 1);\n            frm.set_df_property(\"requested_by\", \"hidden\", 1);\n            frm.set_df_property(\"requested_department\", \"hidden\", 1);\n            frm.set_df_property(\"requester_name\", \"hidden\", 1);\n\t\t        \n\t\t    }\n\t\t}\n\t}\n})\n\nfrappe.ui.form.on(\"General DC Item\", {\n    item_code(frm, cdt, cdn) {\n        let current_row = locals[cdt][cdn];\n        let duplicate_found = false;\n\n        frm.doc.items.forEach(row => {\n            if (row.item_code === current_row.item_code && row.name !== current_row.name) {\n                duplicate_found = true;\n            }\n        });\n\n        if (duplicate_found) {\n            let d = frappe.msgprint({\n                title: __(\"Removing Duplicate Entry\"),\n                message: __(\"Item Code <b>{0}</b> is already added.\", [current_row.item_code]),\n                indicator: 'red'\n            });\n            frm.get_field('items').grid.grid_rows_by_docname[cdn].remove();\n            frm.refresh_field('items');\n            setTimeout(() => {\n                if (d && d.hide) d.hide();\n            }, 1500);\n        }\n    }\n    \n    \n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Transfer",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.400384",
  "module": "ONEGENE",
  "name": "Material Transfer",
  "script": "frappe.ui.form.on('Material Transfer', {\n// \trefresh(frm) {\n//             frm.add_custom_button(__('Print MR'), function () {\n//                 const docname = frm.doc.name;\n//                 const print_format = \"Material Transfer\";\n//                 const letter_head = frappe.defaults.get_default(\"letter_head\") || \"\";\n\n//                 const pdf_url = `/api/method/frappe.utils.print_format.download_pdf?doctype=Material Transfer`\n//                     + `&name=${encodeURIComponent(docname)}`\n//                     + `&format=${encodeURIComponent(print_format)}`\n//                     + `&no_letterhead=0`\n//                     + `&letterhead=${encodeURIComponent(letter_head)}`\n//                     + `&trigger_print=1`;\n\n//                 window.open(frappe.urllib.get_full_url(pdf_url));\n//             });\n// \t},\n// \t    setup(frm){\n//         // frappe.call({\n//         //     method: \"onegene.onegene.custom.get_user_permitted_department\",\n//         //     callback: function(r) {\n//         //         let permitted_departments = r.message || [];\n                \n//         //         // Set query after fetching departments\n//         //         frm.set_query(\"custom_requested_by\", function() {\n//         //             return {\n//         //                 filters: {\n//         //                     \"department\": [\"in\", permitted_departments]\n//         //                 }\n//         //             };\n//         //         });\n//         //     }\n//         // });\n//         frappe.call({\n//     method: \"onegene.onegene.custom.get_user_permitted_department\",\n//     callback: function(r) {\n//         let permitted_departments = r.message || [];\n        \n//         if (permitted_departments.length === 0) {\n//                 frm.set_query(\"issued_by\", function() {\n//                     return {}; // no filter → all employees visible\n//                 });\n//                 return;\n//             }\n\n//         // Get all child departments for the permitted departments\n//         frappe.call({\n//             method: \"frappe.client.get_list\",\n//             args: {\n//                 doctype: \"Department\",\n//                 filters: {\n//                     \"parent_department\": [\"in\", permitted_departments]\n//                 },\n//                 fields: [\"name\"]\n//             },\n//             callback: function(child_r) {\n//                 let child_departments = child_r.message.map(d => d.name) || [];\n                \n//                 // Combine parent and child departments\n//                 let departments_to_filter = permitted_departments.concat(child_departments);\n\n//                 // Set query for employee field\n//                 frm.set_query(\"issued_by\", function() {\n//                     return {\n//                         filters: {\n//                             \"department\": [\"in\", departments_to_filter]\n//                         }\n//                     };\n//                 });\n//             }\n//         });\n//     }\n// });\n\n        \n//     },\n\n\n\n\n  material_request :function(frm){\n            \n        console.log(frm.doc.material_request);\n        // setTimeout(() => {    \n        if (frm.doc.material_request) {\n            frappe.call({\n                method: 'onegene.onegene.doctype.material_transfer.material_transfer.get_mt_table',\n                args: {\n                    // doctype: 'Material Request',\n                    name: frm.doc.material_request\n                },\n                callback: function(r) {\n                    \n                    if (r.message) {\n                        let dc_items = r.message.items || [];\n\n                        frm.clear_table('item');  \n\n                        dc_items.forEach(function(dc_item) {\n                        let row = frm.add_child('item');\n                        row.item_code = dc_item.item_code;\n                        row.item_name = dc_item.item_name;\n                        row.material_request_item = dc_item.name;\n                        row.requested_qty = dc_item.qty;\n                        frappe.db.get_value(\"Bin\", {\"warehouse\": frm.doc.default_source_warehouse, \"item_code\": dc_item.item_code}, \"actual_qty\").then(bin => {\n                            row.stock_qty = bin.message.actual_qty;\n                        })\n                        row.uom = dc_item.stock_uom;\n                        row.source_warehouse=frm.doc.default_source_warehouse;\n                        row.target_warehouse=frm.doc.default_target_warehouse;\n                    });\n                    \n               \n\n\n                    \n                    frm.refresh_field('item');\n                    }\n                }\n            });\n        }else{\n            frm.clear_table('item');  \n            frm.refresh_field('item');\n        }\n\n    // },1000)\n   },\n\n\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Transfer",
  "enabled": 0,
  "modified": "2025-12-17 16:35:44.759241",
  "module": "ONEGENE",
  "name": "Material Transfer List",
  "script": "\n\nfrappe.listview_settings['Material Transfer'] = {\n    onload: function(listview) {\n       \n        listview.filter_area.clear().then(r=>{\n            \n            \n            listview.filter_area.add([[\n            \"Material Transfer\",\n            \"posting_date\",\n            \"=\",\n            frappe.datetime.get_today()\n        ]]);\n            \n            \n        });\n        \n    }\n};\n\n\n\n\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Inter Office Memo",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.379249",
  "module": "ONEGENE",
  "name": "Inter Office Memo List",
  "script": "frappe.listview_settings['Inter Office Memo'] = {\r\n    enable_edit: false,\r\n\r\n    onload(listview) {\r\n        listview.settings.disable_edit = true;\r\n        if (frappe.user.has_role(\"System Manager\")) return;\r\n\r\n        const role_workflow_map = {\r\n            \"HOD\": [\"Pending For HOD\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n            \"Material Manager\": [\"Pending for Material Manager\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n            \"GM\": [\"Pending for GM\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n            \"Accounts Manager\": [\"Pending for Finance\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n            \"BMD\": [\"Pending for BMD\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n            \"CMD\": [\"Pending for CMD\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n            \"Design Manager\": [\"Pending for Design Manager\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n            \"Marketing Manager\": [\"Pending for Marketing Manager\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n            \"Plant Head\": [\"Pending for Plant Head\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n            \"Production Manager\": [\"Pending for Production Manager\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n            \"SMD\": [\"Pending for SMD\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n            \"Quality Manager\": [\"Pending for Quality Team\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n            \"HR Manager\": [\"Pending for HR\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n             \"PPC\": [\"Pending for PPC\", \"Approved\", \"Rejected\", \"Cancelled\"],\r\n             \"Supplier\": [\"Pending for Supplier\", \"Approved\", \"Rejected\", \"Cancelled\"]\r\n        };\r\n\r\n        let states = [];\r\n        let default_pending = null; \r\n\r\n        Object.keys(role_workflow_map).forEach(role => {\r\n            if (frappe.user.has_role(role)) {\r\n                const role_states = role_workflow_map[role];\r\n                const pending_state = role_states.find(s => s.toLowerCase().startsWith(\"pending\"));\r\n                if (pending_state && !default_pending) {\r\n                    default_pending = pending_state;\r\n                }\r\n\r\n                states = states.concat(role_states);\r\n            }\r\n        });\r\n\r\n        states = [...new Set(states)];\r\n\r\n        if (states.length) {\r\n            listview.filter_area.add([\r\n                [\"Inter Office Memo\", \"workflow_state\", \"in\", states]\r\n            ]);\r\n\r\n            if (default_pending) {\r\n                listview.filter_area.add([\r\n                    [\"Inter Office Memo\", \"workflow_state\", \"=\", default_pending]\r\n                ]);\r\n            }\r\n\r\n            listview.refresh();\r\n        }\r\n    }\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "General DC",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.622596",
  "module": "ONEGENE",
  "name": "General DC-List",
  "script": "frappe.listview_settings['General DC'] = {\r\n    refresh(listview) {\r\n        frappe.call({\r\n            method: \"onegene.onegene.doctype.general_dc.general_dc.get_user_supplier_permission\",\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    const supplier_value = r.message;\r\n\r\n                    let supplier_field = listview.page.fields_dict.supplier;\r\n\r\n                    // If no filter is already applied, set it\r\n                    if (!supplier_field.get_value()) {\r\n                        listview.filter_area.add([\r\n                            [\"General DC\", \"supplier\", \"=\", supplier_value]\r\n                        ]);\r\n                        listview.run();\r\n                    }\r\n\r\n                    // Set the value and disable the field to make it read-only\r\n                    supplier_field.set_value(supplier_value);\r\n\r\n                    // Disable the supplier filter input (read-only)\r\n                    // Wait a tick to ensure the field exists in DOM\r\n                    setTimeout(() => {\r\n                        const supplier_input = $(supplier_field.$wrapper).find('input');\r\n                        supplier_input.prop('disabled', true); // make it read-only\r\n                    }, 100);\r\n                }\r\n            }\r\n        });\r\n    }\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Data Import",
  "enabled": 0,
  "modified": "2025-12-17 16:35:44.343294",
  "module": "ONEGENE",
  "name": "Data Import",
  "script": "frappe.ui.form.on('Data Import', {\n\trefresh(frm) {\n\t\tconsole.log(frm.doc.owner)\n\t},\n\tonload(frm){\n\t    console.log(frm.doc.owner)\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "OT Request",
  "enabled": 1,
  "modified": "2025-12-17 16:35:44.160065",
  "module": "ONEGENE",
  "name": "OT Request",
  "script": "frappe.ui.form.on('OT Request', {\n\tonload(frm) {\n        if (frm.doc.__islocal) {\n            frappe.call({\n                method: \"onegene.onegene.custom.get_today_value\",\n                callback: function(r) {\n                    if (r.message) {\n                        frm.set_value('ot_requested_date', r.message);\n                    }\n                }\n            });\n        }\n    }\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Meeting",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.858742",
  "module": "ONEGENE",
  "name": "Meeting",
  "script": "frappe.listview_settings['Meeting'].onload = function(listview) {\r\n    window.location.href = \"/app/meeting/view/calendar/default\";\r\n}; ",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Supplier",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.219048",
  "module": "ONEGENE",
  "name": "Supplier",
  "script": "frappe.ui.form.on(\"Supplier\", {\r\n    \r\n    refresh(frm){\r\n        \r\n        frm.set_df_property(\"supplier_code\",\"read_only\",1)\r\n    },\r\n    \r\n    onload(frm){\r\n        \r\n        frm.set_df_property(\"supplier_code\",\"read_only\",1)\r\n        frm.initial_group = frm.doc.supplier_group;\r\n        \r\n       \r\n    },\r\n    \r\n    after_save(frm){\r\n        \r\n        if(frm.initial_group != frm.doc.supplier_group){\r\n            \r\n            \r\n            \r\n            frappe.call({\r\n                method:\"onegene.onegene.custom.change_supp_grp_user\",\r\n                args:{\r\n                    name:frm.doc.supplier_code,\r\n                    old_grp:frm.initial_group,\r\n                    new_grp : frm.doc.supplier_group\r\n                },\r\n                // callback :function(r){\r\n                //     console.log(\"Done\")\r\n                    \r\n                    \r\n                // }\r\n               \r\n            })\r\n        }\r\n        \r\n        frm.initial_group = frm.doc.supplier_group;\r\n        \r\n        \r\n    },\r\n    \r\n    \r\n    \r\n    \r\n    supplier_group :function(frm) {\r\n        \r\n        if(frm.doc.__islocal){\r\n        const groupWV = [\r\n            \"Import- Bought-Out\", \"Import- Raw Material\",\r\n            \"Local - Bought-Out\", \"Local - Raw Material\",\r\n            \"Outsourcing\"\r\n        ];\r\n\r\n        const groupWG = [\r\n           \"Manufacturer\", \"Electrical\",\r\n            \"General\", \"Hardware\", \"Pharmaceutical\",\r\n            \"Services\", \"Tooling & Fixtures\"\r\n        ];\r\n        \r\n        const groupFFW = [ \"Transporter\" ]\r\n\r\n        let prefix = \"WG\";\r\n\r\n        if (groupWV.includes(frm.doc.supplier_group)) {\r\n            prefix = \"WV\";\r\n        } else if (groupWG.includes(frm.doc.supplier_group)) {\r\n            prefix = \"WG\";\r\n        } else if (groupFFW.includes(frm.doc.supplier_group)) {\r\n            prefix = \"FFW\";\r\n        }\r\n\r\n        frappe.call({\r\n            method: \"onegene.onegene.custom.get_next_supplier_code\",\r\n            args: { prefix: prefix },\r\n            callback: function (r) {\r\n                if (r.message) {\r\n                    frm.set_value(\"supplier_code\", r.message);\r\n                    \r\n                    \r\n                }\r\n            }\r\n        });\r\n        \r\n        if(frm.doc.supplier_group && frm.doc.supplier_group ==\"Transporter\"){\r\n            \r\n            frm.set_value(\"ffw\",1)\r\n        }\r\n        else{\r\n            frm.set_value(\"ffw\",0)\r\n        }\r\n        \r\n        \r\n        \r\n        }\r\n        \r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Category",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.279482",
  "module": "ONEGENE",
  "name": "Employee Category",
  "script": "frappe.ui.form.on('Employee Category', {\n\tvalidate(frm) {\n\t    if (frm.doc.custom_limit_ot) {\n\t        if (frm.doc.custom_ot_limit < 1) {\n\t            frappe.throw(\"The OT Limit Hrs should be greater than 0\");\n\t        }\n\t    }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "User",
  "enabled": 1,
  "modified": "2025-12-17 16:35:42.641789",
  "module": "ONEGENE",
  "name": "User List",
  "script": "let core_settings = frappe.listview_settings['User'] || {};\n\nfrappe.listview_settings['User'] = {\n    ...core_settings,\n    onload(listview) {\n        const filters = listview.filter_area.get();\n\n        // If `enabled` filter already exists, don't add again\n        const already_added = filters.some(f => f[1] === \"enabled\");\n\n        if (!already_added) {\n            listview.filter_area.clear().then(() => {\n                listview.filter_area.add([\n                    [\"User\", \"enabled\", \"=\", 1]\n                ]);\n            });\n        };\n        \n        \n         if (!document.getElementById('role-suggestion-style')) {\n            $('<style id=\"role-suggestion-style\">')\n                .text(`\n                    .role-suggestions {\n                        background: #fff;\n                    }\n\n                    .role-suggestion-item {\n                        padding: 4px 14px;\n                        font-weight:bold;\n                        margin: 4px 2px;\n                        border-radius: 8px;\n                        cursor: pointer;\n                        transition: background-color 0.15s ease;\n                    }\n\n                    /* First item default background */\n                    .role-suggestion-item.default-active {\n                        background-color: #f2f2f2;\n                    }\n\n                    /* Hover state */\n                    .role-suggestion-item:hover {\n                        background-color: #e0e0e0;\n                    }\n                `)\n                .appendTo('head');\n        }\n        \n        let suppress_input_clear = false;\n        \n        \n        //supplier group hide functionality\n        \n         function get_quick_filter(fieldname) {\n            return listview.page.fields_dict[fieldname];\n        }\n\n        frappe.after_ajax(() => {\n\n            let user_category = get_quick_filter(\"user_category\");\n            let supplier_group = get_quick_filter(\"supplier_group\");\n\n            if (!user_category || !supplier_group) {\n                console.log(\"Quick filters not found:\", listview.page.fields_dict);\n                return;\n            }\n\n            function toggle_supplier_filter() {\n                let val = user_category.get_value();\n\n                if (val === \"Supplier\") {\n                    supplier_group.$wrapper.show();\n                } else {\n                    supplier_group.$wrapper.hide();\n                }\n            }\n\n            \n            toggle_supplier_filter();\n\n           \n            user_category.$input.on(\"change\", toggle_supplier_filter);\n\n        });\n        \n        \n                const wrapper = $('<div class=\"form-group\">')\n            .appendTo(listview.page.page_form.find('.standard-filter-section'));\n\n        const input = $('<input type=\"text\" class=\"form-control\" placeholder=\"Role\" style=\"width:140px;\">')\n            .appendTo(wrapper);\n\n        const suggestionBox = $('<div class=\"role-suggestions\" style=\"position:absolute;  padding:4px 2px; border-radius:5px; background:#fff; border:1px solid #ccc; z-index:1000; display:none; width:280px; max-height:300px; overflow-y:auto; padding-left:3px;\"></div>')\n            .appendTo(wrapper);\n\n        let roles = [];\n\n        frappe.call({\n            method: \"frappe.client.get_list\",\n            args: { doctype: \"Role\", fields: [\"name\"] },\n            callback(r) {\n                roles = (r.message || []).map(r => r.name);\n            }\n        });\n\n        function showSuggestions(filter = \"\") {\n            suggestionBox.empty();\n\n            let matches = filter\n                ? roles.filter(r => r.toLowerCase().includes(filter.toLowerCase()))\n                : roles;\n\n            if (!matches.length) {\n                suggestionBox.hide();\n                return;\n            }\n\n            matches.forEach((role, index) => {\n               \n                \n                  $('<div>')\n                    .addClass('role-suggestion-item')\n                    .toggleClass('default-active', index === 0) \n                    .text(role)\n                    .on('click', () => {\n                        input.val(role);\n                        suggestionBox.hide();\n                        applyRoleFilter(role);\n                    })\n                    .appendTo(suggestionBox);\n            });\n\n            suggestionBox.show();\n        }\n\n  \n        \n        \n\n\n\n// input.on('input', function () {\n//     const val = this.value;\n       \n    \n\n   \n//     applyRoleFilter(val);\n\n//     showSuggestions(val);\n// });\n\n\nlet roleFilterTimeout = null;\n\ninput.on('input', function () {\n    const val = this.value;\n\n    showSuggestions(val);\n\n    clearTimeout(roleFilterTimeout);\n    roleFilterTimeout = setTimeout(() => {\n        applyRoleFilter(val);\n    }, 400); \n});\n\n\n\n        input.on('focus', function () {\n            if (!this.value) {\n                showSuggestions();\n            }\n        });\n\n        $(document).on('click', function (e) {\n            if (!wrapper.is(e.target) && wrapper.has(e.target).length === 0) {\n                suggestionBox.hide();\n            }\n        });\n\n        \n\n        function setRoleInUrl(role) {\n            let url = new URL(window.location.href);\n            url.searchParams.set('role', role);\n            window.history.pushState({}, '', url);\n        }\n\n      \n        \n\n\n// function applyRoleFilter(role) {\n//     const filters = listview.filter_area.get(); // get all current filters\n\n//     if (!role || role.trim() === \"\") {\n       \n//         const otherFilters = filters.filter(f => !(f[0] === \"Has Role\" && f[1] === \"role\" && f[4] === \"User\"));\n\n        \n//         listview.filter_area.clear();\n\n        \n//         if (otherFilters.length) {\n//             listview.filter_area.add(otherFilters);\n//         }\n\n//         return;\n//     }\n\n    \n//     const exists = filters.some(f =>\n//         f[0] === \"Has Role\" &&\n//         f[1] === \"role\" &&\n//         f[4] === \"User\" &&\n//         f[3] === role\n//     );\n\n//     if (!exists) {\n//         listview.filter_area.add([\n//             [\"Has Role\", \"role\", \"=\", role, \"User\"]\n//         ]);\n//     }\n// }\n\n\nfunction applyRoleFilter(role) {\n    const allFilters = listview.filter_area.get();\n\n    \n    const preservedFilters = allFilters.filter(f =>\n        !(f[0] === \"Has Role\" && f[1] === \"role\" && f[4] === \"User\")\n    );\n\n    \n    suppress_input_clear = true;\n\n    listview.filter_area.clear();\n\n    \n    suppress_input_clear = false;\n\n    if (preservedFilters.length) {\n        listview.filter_area.add(preservedFilters);\n    }\n\n    if (role && role.trim()) {\n        listview.filter_area.add([\n            [\"Has Role\", \"role\", \"=\", role, \"User\"]\n        ]);\n    }\n}\n\n        const urlParams = new URLSearchParams(window.location.search);\n        const roleFromUrl = urlParams.get('role');\n\n        if (roleFromUrl) {\n            input.val(roleFromUrl);\n            applyRoleFilter(roleFromUrl);\n        }\n        \n     const original_clear = listview.filter_area.clear.bind(listview.filter_area);\n\nlistview.filter_area.clear = function () {\n    const result = original_clear();\n\n    \n    if (!suppress_input_clear) {\n        input.val(\"\");\n        \n    }\n\n    return result;\n};\n\n\n       \n\n        \n        \n        \n        \n    }\n};\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Gate Entry",
  "enabled": 1,
  "modified": "2025-12-17 16:35:43.168748",
  "module": "ONEGENE",
  "name": "Gate Entry",
  "script": "frappe.ui.form.on('Gate Entry', {\r\n   \r\n\r\n    party_type(frm) {\r\n        update_party_code(frm);\r\n    },\r\n\r\n    party(frm) {\r\n        update_party_code(frm);\r\n    }\r\n});\r\n\r\nfunction update_party_code(frm) {\r\n    \r\n    frm.set_df_property(\"customer_code\", \"hidden\", 1);\r\n    frm.set_df_property(\"supplier_code\", \"hidden\", 1);\r\n\r\n    if (!frm.doc.party_type || !frm.doc.party) return;\r\n\r\n    if (frm.doc.party_type === \"Customer\") {\r\n\r\n        frm.set_df_property(\"customer_code\", \"hidden\", 0);\r\n\r\n        frappe.db.get_value(\"Customer\", { name: frm.doc.party }, \"name\").then(r => {\r\n            if (r.message) {\r\n                frm.set_value(\"customer_code\", r.message.name);\r\n            }\r\n        });\r\n\r\n    } else if (frm.doc.party_type === \"Supplier\") {\r\n\r\n        frm.set_df_property(\"supplier_code\", \"hidden\", 0);\r\n\r\n        frappe.db.get_value(\"Supplier\", { name: frm.doc.party }, \"name\").then(r => {\r\n            if (r.message) {\r\n                frm.set_value(\"supplier_code\", r.message.name);\r\n            }\r\n        });\r\n    }\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Inter Office Memo",
  "enabled": 1,
  "modified": "2025-12-17 16:35:42.852310",
  "module": "ONEGENE",
  "name": "Inter Office Memo",
  "script": "frappe.ui.form.on('Inter Office Memo', {\n    \n    onload_post_render(frm) {\n        render_approval_grid_buttons(frm);\n        render_approval_grid_buttons1(frm);\n         setTimeout(function () {\n\n\n            $('.dropdown-menu a').each(function () {\n                if ($(this).text().trim() === 'Reject') {\n                    $(this).hide();\n                }\n            });\n\n\n            let approveExists = $('.dropdown-menu a').filter(function () {\n                return $(this).text().trim() === 'Approve';\n            }).length > 0;\n\n\n            let reopenExists = $('.dropdown-menu a').filter(function () {\n                return $(this).text().trim() === 'Reopen';\n            }).length > 0;\n\n\n            if (approveExists && !reopenExists) {\n            \n\n                    let approveBtn = $('.dropdown-menu a').filter(function () {\n                        return $(this).text().trim() === 'Approve';\n                    });\n\n                    let customBtn = $('<a style=\"margin-top:10px;\" class=\"dropdown-item reject-with-remarks\" href=\"#\">Reject</a>');\n\n\n                    if (approveBtn.length) {\n                        approveBtn.after(customBtn);\n\n                    } else {\n                        $('.dropdown-menu').append(customBtn);\n\n                    }\n\n\n                    customBtn.on('click', function (e) {\n                        e.preventDefault();\n\n                        let previous_state = cur_frm.doc.workflow_state;\n\n                        let d = new frappe.ui.Dialog({\n                            title: \"Provide Rejection Remarks\",\n                            fields: [\n                                {\n                                    fieldname: \"rejection_remarks\",\n                                    label: \"Rejection Remarks\",\n                                    fieldtype: \"Small Text\",\n                                    reqd: 1\n                                }\n                            ],\n                            primary_action_label: \"Submit\",\n                            primary_action(values) {\n                                let remarks = values.rejection_remarks?.trim();\n                                if (!remarks) {\n                                    frappe.msgprint(\"Rejection remarks are required.\");\n                                    return;\n                                }\n\n                                d.hide();\n\n                                frappe.call({\n                                    method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.set_rejection_remarks\",\n                                    args: {\n                                        doctype: cur_frm.doc.doctype,\n                                        docname: cur_frm.doc.name,\n                                        remarks: remarks,\n                                        previous_state: previous_state\n                                    },\n                                    callback(r) {\n                                        if (!r.exc) {\n                                            frappe.msgprint(\"Document has been rejected successfully.\");\n                                            frm.reload_doc();\n                                            location.reload();\n                                        }\n                                    }\n                                });\n                            }\n                        });\n\n                        d.show();\n                    });\n                }\n\n        }, 550);\n    },\n    onload(frm){\n        if(!frm.doc.__islocal){\n             if(!frappe.user.has_role('System Manager')){\n            $(\"button[data-original-title=Print]\").hide();\n            }\n            if(frm.doc.iom_type==\"Approval for Supplier Stock Reconciliation\" && frm.doc.workflow_state == \"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                \n                 frm.add_custom_button(__(\"Print\"), function() {\n                    var f_name = frm.doc.name\n                    var print_format = \"Approval for Supplier Stock Reconciliation\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Inter Office Memo\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                });\n            \n                \n            }\n            \n                          if(frm.doc.iom_type==\"Approval for Supplier Stock Reconciliation\"){\n                     \n                      frm.add_custom_button(__(\"Report View\"), function() {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_supplier_reqest_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function(r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n\n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function() {\n                                        d.hide();\n                                    }\n                                });\n\n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n                     \n                 }   \n\n            if(frm.doc.iom_type==\"Approval for Travel Request\" && frm.doc.workflow_state == \"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                \n                 frm.add_custom_button(__(\"Print\"), function() {\n                    var f_name = frm.doc.name\n                    var print_format = \"Approval for Travel Request\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Inter Office Memo\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                });\n            \n                \n            }\n             \n              if(frm.doc.iom_type==\"Approval for Travel Request\"){\n                     \n                      frm.add_custom_button(__(\"Report View\"), function() {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_travel_request_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function(r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n\n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function() {\n                                        d.hide();\n                                    }\n                                });\n\n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n                     \n                 }   \n            \n            \n            \n            \n             if (frm.doc.iom_type == \"Approval for New Customer Registration\" && frm.doc.workflow_state == \"Approved\" && frm.doc.customer_created==0 && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))) {\n                frm.add_custom_button(__(\"Create Customer\"), function() {\n                    frappe.call({\n                    method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.create_customer_from_iom\",\n                    args: {\n                        iom_name: frm.doc.name\n                    },\n                    freeze: true,\n                    freeze_message: \"Creating Customer...\",\n                    callback: function (r) {\n                        if (!r.exc) {\n                            frappe.msgprint({\n                                title: \"Success\",\n                                message: \"Customer Created: <b>\" + r.message + \"</b>\",\n                                indicator: \"green\"\n                            });\n\n                            frappe.set_route(\"Form\", \"Customer\", r.message);\n                        }\n                    }\n                });\n                });\n            }\n\n                                if (frm.doc.iom_type == \"Approval for New Customer Registration\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_customer_registeration_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\t\t    if (frm.doc.iom_type == \"Approval for New Customer Registration\" && frm.doc.workflow_state == \"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))) {\n                frm.add_custom_button(__(\"Print\"), function() {\n                    var f_name = frm.doc.name\n                    var print_format = \"Approval for New Customer Registration\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Inter Office Memo\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                });\n            }\n\n            if (frm.doc.iom_type == \"Approval for New Supplier Registration\" && frm.doc.workflow_state == \"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))) {\n                frm.add_custom_button(__(\"Print\"), function() {\n                    var f_name = frm.doc.name\n                    var print_format = \"Approval for New Supplier Registration\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Inter Office Memo\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                });\n            }\n             if (frm.doc.iom_type == \"Approval for New Supplier Registration\" && frm.doc.workflow_state == \"Approved\" && frm.doc.supplier_create==0 && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))) {\n                frm.add_custom_button(__(\"Create Supplier\"), function() {\n                    frappe.call({\n                    method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.create_supplier_from_iom\",\n                    args: {\n                        iom_name: frm.doc.name\n                    },\n                    freeze: true,\n                    freeze_message: \"Creating Supplier...\",\n                    callback: function (r) {\n                        if (!r.exc) {\n                            frappe.msgprint({\n                                title: \"Success\",\n                                message: \"Supplier Created: <b>\" + r.message + \"</b>\",\n                                indicator: \"green\"\n                            });\n\n                            frappe.set_route(\"Form\", \"Supplier\", r.message);\n                        }\n                    }\n                });\n                });\n            }\n                        if (frm.doc.iom_type == \"Approval for New Supplier Registration\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_supplier_registeration_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\n             if(frm.doc.iom_type == \"Approval for Business Visit\" && frm.doc.workflow_state==\"Approved\"&& (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for Business Visit\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n            if (frm.doc.iom_type == \"Approval for Business Visit\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_business_visit_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\n            if ((frm.doc.iom_type == \"Approval for Price Revision SO\" || frm.doc.iom_type==\"Approval for Price Revision PO\") && frm.doc.department_from == \"Marketing - WAIP\"  ) {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_price_revision_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if (frm.doc.iom_type == \"Approval for Stock Change Request - Stock Reconciliation\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_stock_change_req_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\t\t    if (frm.doc.iom_type == \"Approval for Manpower Request\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_manpower_req_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if (frm.doc.iom_type == \"Approval for Price Revision PO\" && frm.doc.department_from != \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n            \n            \n                    // Step 1: Check workflow state\n                        \n                        let remarks = frm.doc.rejection_remarks || [];\n            \n                        if (remarks.length > 0) {\n                            // Step 2: Get the last row\n                            let last_row = remarks[remarks.length - 1];\n                            if (frm.doc.workflow_state == \"Rejected\"){\n                                last_row.check_reopened = 1\n                            }\n                            else{\n                                last_row.check_reopened = 0\n                            }\n                            // Step 3: Check the checkbox field\n                            if (last_row.check_reopened == 1) {\n                                method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_price_revision_mpl_html\";\n                            } else {\n                                method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_price_revision_mpl_html\";\n                            }\n                        } else {\n                            // No remarks found, fallback to default method\n                            method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_price_revision_mpl_html\";\n                        }\n                    \n            \n                    // Step 4: Call backend method\n                    frappe.call({\n                        method: method_to_call,\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            \n            if (frm.doc.iom_type == \"Approval for Credit Note\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_credit_note_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Credit Note\" && frm.doc.department_from == \"Marketing - WAIP\"&& frm.doc.workflow_state==\"Approved\"&& (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for Credit Note\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n            if(frm.doc.iom_type == \"Approval for Stock Change Request - Stock Reconciliation\" && frm.doc.workflow_state==\"Approved\"&& (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for Stock Change Request\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n            if(frm.doc.iom_type == \"Approval for Manpower Request\" && frm.doc.workflow_state==\"Approved\"&& (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for Manpower Request\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n\n            if (frm.doc.iom_type == \"Approval for New Business PO\" && frm.doc.department_from != \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n            \n            \n                    // Step 1: Check workflow state\n                        \n                        let remarks = frm.doc.rejection_remarks || [];\n            \n                        if (remarks.length > 0) {\n                            // Step 2: Get the last row\n                            let last_row = remarks[remarks.length - 1];\n                            if (frm.doc.workflow_state == \"Rejected\"){\n                                last_row.check_reopened = 1\n                            }\n                            else{\n                                last_row.check_reopened = 0\n                            }\n                            // Step 3: Check the checkbox field\n                            if (last_row.check_reopened == 1) {\n                                method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_air_shipment_reopen_html_new\";\n                            } else {\n                                method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_new_business_po_html_new\";\n                            }\n                        } else {\n                            // No remarks found, fallback to default method\n                            method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_new_business_po_html_new\";\n                        }\n                    \n            \n                    // Step 4: Call backend method\n                    frappe.call({\n                        method: method_to_call,\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for New Business PO\" && (frm.doc.department_from != \"Marketing - WAIP\")&& frm.doc.workflow_state==\"Approved\"&& (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for New Business PO NEW\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n\n\t\t\n\t\t  \tif (frm.doc.iom_type == \"Approval for New Business SO\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_new_business_po_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            \n            \n            if(frm.doc.iom_type == \"Approval for New Business SO\" && frm.doc.workflow_state==\"Approved\"&& (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for New Business PO\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n\n\t\t\n\t\t  \tif ((frm.doc.iom_type == \"Approval for Price Revision SO\" || frm.doc.iom_type==\"Approval for Price Revision PO\") && frm.doc.department_from == \"Marketing - WAIP\"  ) {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_price_revision_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\t\t  \tif((frm.doc.iom_type == \"Approval for Price Revision SO\" || frm.doc.iom_type==\"Approval for Price Revision PO\") && frm.doc.department_from == \"Marketing - WAIP\"&& frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Price Revision PO\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\t\t  \t \tif (frm.doc.iom_type == \"Approval for Schedule Increase\" && frm.doc.department_from == \"Raw Material - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_schedule_increase_material_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    size: \"large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\nif(frm.doc.iom_type == \"Approval for Schedule Increase\" && frm.doc.department_from == \"Raw Material - WAIP\"&& frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for Schedule Increase Material\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n\t\t  \n\t        if (frm.doc.iom_type == \"Approval for Tooling Invoice\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_tooling_invoice_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\n            \tif(frm.doc.iom_type == \"Approval for Tooling Invoice\" && frm.doc.department_from == \"Marketing - WAIP\"&& frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Tooling Invoice\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if(frm.doc.iom_type == \"Approval for Proto Sample SO\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Proto Sample PO\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\t\t  \t        if (frm.doc.iom_type == \"Approval for Proto Sample SO\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_proto_sample_marketing_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Debit Note / Supplementary Invoice\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Debit Note Marketing\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\t\t  \t        if (frm.doc.iom_type == \"Approval for Debit Note / Supplementary Invoice\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_debit_note_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n             if(frm.doc.iom_type == \"Approval for Business Volume Increase\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Business Volume Increase\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\t\t  \t        if (frm.doc.iom_type == \"Approval for Business Volume Increase\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_business_volume_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Customer Name/Address Change\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Customer Name/Address Change\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n             if (frm.doc.iom_type == \"Approval for Customer Name/Address Change\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_customer_name_change_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Payment Write Off\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Payment Write Off\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                         if (frm.doc.iom_type == \"Approval for Payment Write Off\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_payment_right_off_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Sales Order DC\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Sales Order DC\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if (frm.doc.iom_type == \"Approval for Sales Order DC\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_sales_order_dc_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Item Level Change\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Item Level Change\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                        if (frm.doc.iom_type == \"Approval for Item Level Change\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_part_level_change_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Invoice Cancel\" && frm.doc.department_from == \"Delivery - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Invoice Cancel\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                                    if (frm.doc.iom_type == \"Approval for Invoice Cancel\" && frm.doc.department_from == \"Delivery - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_invoice_cancel_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Air Shipment\" && frm.doc.department_from == \"Delivery - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Air Shipment Delivery\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if (frm.doc.iom_type == \"Approval for Air Shipment\" && frm.doc.department_from == \"Delivery - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n            \n            \n                    // Step 1: Check workflow state\n                        \n                        let remarks = frm.doc.rejection_remarks || [];\n            \n                        if (remarks.length > 0) {\n                            // Step 2: Get the last row\n                            let last_row = remarks[remarks.length - 1];\n                            if (frm.doc.workflow_state == \"Rejected\"){\n                                last_row.check_reopened = 1\n                            }\n                            else{\n                                last_row.check_reopened = 0\n                            }\n                            // Step 3: Check the checkbox field\n                            if (last_row.check_reopened == 1) {\n                                method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_air_shipment_reopen_html\";\n                            } else {\n                                method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_air_shipment_delivery_html\";\n                            }\n                        } else {\n                            // No remarks found, fallback to default method\n                            method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_air_shipment_delivery_html\";\n                        }\n                    \n            \n                    // Step 4: Call backend method\n                    frappe.call({\n                        method: method_to_call,\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\n            if(frm.doc.iom_type == \"Approval for Tools & Dies Invoice\" && frm.doc.department_from == \"M P L & Purchase - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Tools and Dies Invoice\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if (frm.doc.iom_type == \"Approval for Tools & Dies Invoice\" && frm.doc.department_from == \"M P L & Purchase - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_tools_and_dies_invoice\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Schedule Revised\" && frm.doc.department_from == \"Delivery - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Schedule Increase New\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\nif (frm.doc.iom_type == \"Approval for Schedule Revised\" && frm.doc.department_from == \"M P L & Purchase - WAIP\" && frappe.session.user=='jothi.m@gruoupteampro.com') {\n    frm.add_custom_button(__(\"Report View1\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo_html_view.get_schedule_revise_delivery_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            \n                        if (frm.doc.iom_type == \"Approval for Schedule Revised\" && frm.doc.department_from == \"Delivery - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo_html_view.get_schedule_increase_delivery_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n             if(frm.doc.iom_type == \"Approval for Air Shipment\" && frm.doc.department_from == \"M P L & Purchase - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Air Shipment Material\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                                    if (frm.doc.iom_type == \"Approval for Air Shipment\" && frm.doc.department_from == \"M P L & Purchase - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_schedule_increase.get_air_shipment_material_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Material Request - New Project\" && frm.doc.department_from == \"NPD - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Material Request\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if (frm.doc.iom_type == \"Approval for Material Request - New Project\" && frm.doc.department_from == \"NPD - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_material_request_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Price Revision PO\" && frm.doc.department_from == \"Raw Material - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Price Revision PO Material\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                        if (frm.doc.iom_type == \"Approval for Price Revision PO\" && frm.doc.department_from == \"Raw Material - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_price_revision_material_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n                if(frm.doc.iom_type == \"Approval for Product Conversion\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Product Conversion\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                 if(frm.doc.iom_type == \"Approval for Vendor Split order\" && frm.doc.department_from == \"Raw Material - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Vendor Split order\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if (frm.doc.iom_type == \"Approval for Vendor Split order\" && frm.doc.department_from == \"Raw Material - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_vendor_split_order_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n if(frm.doc.iom_type == \"Approval for Debit Note\" && frm.doc.department_from == \"M P L & Purchase - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Debit Note Material\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                        if (frm.doc.iom_type == \"Approval for Debit Note\" && frm.doc.department_from == \"Raw Material - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_debit_note_materail_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            \t\t   if (frm.doc.iom_type == \"Approval for New Business JO\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_schedule_increase.get_new_business_jo_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Price Revision PO\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Price Revision PO\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if(frm.doc.iom_type == \"Approval for New Business JO\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"New Business JO\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\n            \t\t   if (frm.doc.iom_type == \"Approval for Price Revision JO\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_schedule_increase.get_price_revision_jo_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\nif(frm.doc.iom_type == \"Approval for Price Revision JO\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Price Revision JO\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\t\n\t\t                \t\t   if (frm.doc.iom_type == \"Approval for Schedule Revised\" && (frm.doc.department_from==\"M P L & Purchase - WAIP\" || frm.doc.department_from==\"PPS - WAIP\")) {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo_html_view.get_schedule_revise_delivery_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Schedule Revised\" && frm.doc.workflow_state==\"Approved\" && (frm.doc.department_from==\"M P L & Purchase - WAIP\"|| frm.doc.department_from==\"PPS - WAIP\") && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Schedule Revised\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\t\t                \t\t   if (frm.doc.iom_type == \"Approval for Product Conversion\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_schedule_increase.get_product_conversion_material_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n if (frm.doc.iom_type == \"Approval for Proto Sample PO\" && frm.doc.department_from==\"M P L & Purchase - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_schedule_increase.get_proto_sample_material_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n    if(frm.doc.iom_type == \"Approval for Proto Sample PO\" && frm.doc.department_from==\"M P L & Purchase - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                                frm.add_custom_button(__(\"Print\"), function () {\n                    \t\t\tvar f_name = frm.doc.name\n                    \t\t\tvar print_format = \"Approval for Proto Sample PO Material\";\n                    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                    \t\t\t\t+ \"&trigger_print=1\"\n                    \t\t\t\t+ \"&format=\" + print_format\n                    \t\t\t\t+ \"&no_letterhead=0\"\n                    \t\t\t));\n        \t\t});\n                }\n\t if (frm.doc.iom_type == \"Approval for Debit Note\" && frm.doc.department_from==\"M P L & Purchase - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_schedule_increase.get_debit_material_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\t\t  \t\t  \t\n            \n        }\n    },\n\trefresh(frm) {\n\t    \n\t    \n\t     if(frm.doc.workflow_state == \"Approved\" && frappe.user.has_role(\"System Manager\")){\n            if (frm.doc.response_data) {\n                frm.fields_dict.response.$wrapper.html(frm.doc.response_data)\n            }\n            if(frm.doc.iom_type == \"Approval for Price Revision PO\" || frm.doc.iom_type == \"Approval for Price Revision SO\" || frm.doc.iom_type == \"Approval for Price Revision JO\" ){\n                \n                let btn = frm.add_custom_button(__(\"Revise Item Price\"),function(){\n                    \n                    frappe.call({\n                        method:\"onegene.onegene.price_revision_iom.item_price_revision_iom\",\n                        args:{\n                            docname:frm.doc.name\n                        },\n                        freeze: true,\n                        freeze_message: __(\"Updating item prices...\"),\n                        callback :function(r){\n                            \n                            if(r.message){\n                                frm.reload_doc();\n                                frappe.msgprint(\"Item Price revised successfully\")\n                            }\n                            else{\n                                frappe.msgprint(\"Error caused while revision of item price\")\n                            }\n                            \n                        }\n                    })\n                })\n                \n                if (frm.doc.item_price_revised) {\n                    $(btn).prop(\"disabled\", true).addClass(\"disabled\");\n                }\n                \n            }\n            \n            if (frm.doc.iom_type == \"Approval for Schedule Revised\") {\n                let schedule_revise_btn = frm.add_custom_button(__(\"Revise Schedule\"), function() {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_for_schedule_revised.revise_schedule\",\n                        args: {\n                            docname: frm.doc.name\n                        },\n                        freeze: true,\n                        freeze_message: __(\"Revising Schedule...\"),\n                        callback: function(r) {\n\n                            if (r.message) {\n                                frm.reload_doc();\n                                frappe.msgprint(\"Schedule revised successfully\")\n                            } else {\n                                frappe.msgprint(\"Error caused while revision of schedule qty\")\n                            }\n\n                        }\n                    })\n                });\n                if (frm.doc.item_schedule_revised) {\n                    $(schedule_revise_btn).prop(\"disabled\", true).addClass(\"disabled\");\n                }\n            }\n            \n            if ([\"Approval for New Business JO\", \"Approval for New Business PO\", \"Approval for New Business SO\"].includes(frm.doc.iom_type)) {\n                \n                let now = new Date();\n                let startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n                let startDate = [\n                    startOfMonth.getFullYear(),\n                    String(startOfMonth.getMonth() + 1).padStart(2, '0'),\n                    String(startOfMonth.getDate()).padStart(2, '0')\n                ].join('-');\n                let monthShort = now.toLocaleString(\"en-US\", { month: \"short\" }).toUpperCase();\n\n                let create_order_btn = frm.add_custom_button(__(\"Create Order\"), async function() {\n                    // Create Sales Order\n                    if (frm.doc.iom_type == \"Approval for New Business SO\") {\n                        let new_items = frm.doc.approval_business_po.map(row => ({\n                            item_code: row.item_code,\n                            qty: row.qty,\n                            rate: row.rate\n                        }));\n                        let so = frappe.model.get_new_doc(\"Sales Order\");\n                        so.custom_inter_office_memo = frm.doc.name\n                        so.company = \"WONJIN AUTOPARTS INDIA PVT.LTD.\";\n                        so.customer = frm.doc.customer;\n                        so.customer_group = frm.doc.customer_group;\n                        so.customer_order_type = frm.doc.order_type === \"Fixed Order\" ? \"Fixed\" : \"Open\";\n                        so.po_no = frm.doc.po_no;\n                        so.po_date = frm.doc.po_date;\n                        so.set_warehouse = \"Finished Goods - WAIP\";\n                        so.currency = frm.doc.currency; // corrected typo\n                        so.selling_price_list = \"Standard Selling\";\n                        so.order_type = \"Sales\";\n                        so.naming_series = \"SAL-ORD-.YYYY.-\";\n                        so.ignore_pricing_rule = 1;\n                        so.price_list_currency = \"INR\";\n                        frappe.db.get_value(\n                            \"Currency Conversion\",\n                            frm.doc.currency,\n                            \"exchange_rate\"\n                        ).then(r => {\n                            so.conversion_rate = r.message.exchange_rate || 1;\n                        });\n                        \n                        let delivery_date = \"\";\n                        if (frm.doc.order_type === \"Open Order\") {\n                            let r = await frappe.call({\n                                method: \"onegene.onegene.custom.get_last_date_of_fiscal\",\n                                freeze: true\n                            });\n                            delivery_date = r.message;\n                            so.delivery_date = delivery_date;\n                        }\n                \n                        // add items from child table\n                        if (frm.doc.order_type == \"Fixed Order\") {\n                            frm.doc.approval_business_po.forEach(row => {\n                                let item = frappe.model.add_child(so, \"Sales Order Item\", \"items\");\n                                item.item_code = row.part_no;\n                                item.item_name = row.part_name;\n                                item.qty = 1;\n                                item.open_qty = 1;\n                                setTimeout(() => {\n                                    item.rate = row.po_price;\n                                    item.amount = row.po_price * row.qty;\n                                }, 2500);\n                                item.gst_hsn_code = row.hsn_code;\n                                item.uom = row.uom;\n                                item.stock_uom = row.uom;\n    \n                                let schedule = frappe.model.add_child(so, \"Sales Order Schedule Item\", \"custom_schedule_table\");\n                                schedule.item_code = row.part_no;\n                                schedule.item_name = row.part_name;\n                                schedule.schedule_qty = row.qty;\n                                schedule.schedule_date = startDate;\n                                schedule.schedule_month = monthShort;\n                                schedule.pending_qty = row.qty;\n                            });\n                        }\n                        \n                        else {\n                            frm.doc.approval_business_po.forEach(row => {\n                                let item = frappe.model.add_child(so, \"Sales Order Item\", \"items\");\n                                item.item_code = row.part_no;\n                                item.item_name = row.part_name;\n                                item.qty = row.qty;\n                                item.open_qty = row.qty;\n                                item.uom = row.uom;\n                                item.stock_uom = row.uom\n                                item.gst_hsn_code = row.hsn_code;\n                    \n                                if (delivery_date) {\n                                    frappe.model.set_value(item.doctype, item.name, \"delivery_date\", delivery_date);\n                                }\n                                setTimeout(() => {\n                                    frappe.model.set_value(item.doctype, item.name, \"rate\", row.po_price);\n                                    frappe.model.set_value(item.doctype, item.name, \"amount\", row.po_price * row.qty);\n                                }, 2500);\n                                \n                                if (row.qty > 1) {\n                                    let schedule = frappe.model.add_child(so, \"Sales Order Schedule Item\", \"custom_schedule_table\");\n                                    schedule.item_code = row.part_no;\n                                    schedule.item_name = row.part_name;\n                                    schedule.schedule_qty = row.qty;\n                                    schedule.schedule_date = startDate;\n                                    schedule.schedule_month = monthShort;\n                                    schedule.pending_qty = row.qty;\n                                }\n                            });\n                        }\n                        \n                        frappe.set_route(\"Form\", \"Sales Order\", so.name);\n                    }\n                    // Create Purchase Order\n                    if (frm.doc.iom_type == \"Approval for New Business PO\") {\n                        let new_items = frm.doc.approval_business_po.map(row => ({\n                            item_code: row.item_code,\n                            qty: row.qty,\n                            rate: row.rate\n                        }));\n                        \n                        let po = frappe.model.get_new_doc(\"Purchase Order\");\n                        po.custom_inter_office_memo = frm.doc.name;\n                        po.custom_po_type = \"Purchase Order\";\n                        po.company = \"WONJIN AUTOPARTS INDIA PVT.LTD.\";\n                        po.supplier = frm.doc.supplier;\n                        po.supplier_group = frm.doc.supplier_group;\n                        po.custom_order_type = frm.doc.order_type === \"Fixed Order\" ? \"Fixed\" : \"Open\";\n                        po.set_warehouse = \"Stores - WAIP\";\n                        po.currency = frm.doc.currency; // corrected typo\n                        po.selling_price_list = \"Standard Buying\";\n                        po.ignore_pricing_rule = 1;\n                        po.price_list_currency = \"INR\";\n                        frappe.db.get_value(\n                            \"Currency Conversion\",\n                            frm.doc.currency,\n                            \"exchange_rate\"\n                        ).then(r => {\n                            po.conversion_rate = r.message.exchange_rate || 1;\n                        });\n                \n                        // add items from child table\n                        if (frm.doc.order_type == \"Fixed Order\") {\n                            frm.doc.custom_approval_for_new_business_po.forEach(row => {\n                                let item = frappe.model.add_child(po, \"Purchase Order Item\", \"items\");\n                                item.item_code = row.part_no;\n                                item.item_name = row.part_name;\n                                item.qty = row.qty;\n                                item.open_qty = row.qty;\n                                setTimeout(() => {\n                                    item.rate = row.po_price;\n                                    item.amount = row.po_price * row.qty;\n                                }, 2300);\n                                item.gst_hsn_code = row.hsn_code;\n                                item.uom = row.uom;\n                                item.stock_uom = row.uom;\n    \n                                let schedule = frappe.model.add_child(po, \"Purchase Order Schedule Item\", \"custom_schedule_table\");\n                                schedule.item_code = row.part_no;\n                                schedule.item_name = row.part_name;\n                                schedule.schedule_qty = row.qty;\n                                schedule.schedule_date = startDate;\n                                schedule.schedule_month = monthShort;\n                                schedule.pending_qty = row.qty;\n                            });\n                        }\n                        \n                        else {\n                            frm.doc.custom_approval_for_new_business_po.forEach(row => {\n                                let item = frappe.model.add_child(po, \"Purchase Order Item\", \"items\");\n                                item.item_code = row.part_no;\n                                item.item_name = row.part_name;\n                                item.qty = row.qty;\n                                item.open_qty = row.qty;\n                                setTimeout(() => {\n                                    item.rate = row.po_price;\n                                    item.amount = row.po_price * row.qty;\n                                }, 2300);\n                                item.gst_hsn_code = row.hsn_code;\n                                item.uom = row.uom;\n                                item.stock_uom = row.uom;\n                                \n                                if (row.qty > 1) {\n                                    let schedule = frappe.model.add_child(po, \"Purchase Order Schedule Item\", \"custom_schedule_table\");\n                                    schedule.item_code = row.part_no;\n                                    schedule.item_name = row.part_name;\n                                    schedule.schedule_qty = row.qty;\n                                    schedule.schedule_date = startDate;\n                                    schedule.schedule_month = monthShort;\n                                    schedule.pending_qty = row.qty;\n                                }\n                            });\n                        }\n                        \n                        frappe.set_route(\"Form\", \"Purchase Order\", po.name);\n                    }\n                    // Create Job Order\n                    if (frm.doc.iom_type == \"Approval for New Business JO\") {\n                        let new_items = frm.doc.approval_business_po.map(row => ({\n                            item_code: row.item_code,\n                            qty: row.qty,\n                            rate: row.rate\n                        }));\n                        \n                        let po = frappe.model.get_new_doc(\"Purchase Order\");\n                        po.custom_inter_office_memo = frm.doc.name;\n                        po.custom_po_type = \"Job Order\";\n                        po.company = \"WONJIN AUTOPARTS INDIA PVT.LTD.\";\n                        po.supplier = frm.doc.supplier;\n                        po.supplier_group = frm.doc.supplier_group;\n                        po.custom_order_type = frm.doc.order_type === \"Fixed Order\" ? \"Fixed\" : \"Open\";\n                        po.set_warehouse = \"Stores - WAIP\";\n                        po.currency = frm.doc.currency; // corrected typo\n                        po.selling_price_list = \"Standard Buying\";\n                        po.ignore_pricing_rule = 1;\n                        po.price_list_currency = \"INR\";\n                        frappe.db.get_value(\n                            \"Currency Conversion\",\n                            frm.doc.currency,\n                            \"exchange_rate\"\n                        ).then(r => {\n                            po.conversion_rate = r.message.exchange_rate || 1;\n                        });\n                \n                        // add items from child table\n                        if (frm.doc.order_type == \"Fixed Order\") {\n                            frm.doc.new_business_jo.forEach(row => {\n                                let item = frappe.model.add_child(po, \"Purchase Order Item\", \"items\");\n                                item.item_code = row.item_code;\n                                item.item_name = row.item_name;\n                                item.qty = row.qty;\n                                item.open_qty = row.qty;\n                                setTimeout(() => {\n                                    item.rate = row.po_price;\n                                    item.amount = row.po_price * row.qty;\n                                }, 2500);\n                                item.gst_hsn_code = row.hsn_code;\n                                item.uom = row.uom;\n                                item.stock_uom = row.uom;\n    \n                                let schedule = frappe.model.add_child(po, \"Purchase Order Schedule Item\", \"custom_schedule_table\");\n                                schedule.item_code = row.item_code;\n                                schedule.item_name = row.item_name;\n                                schedule.schedule_qty = row.qty;\n                                schedule.schedule_date = startDate;\n                                schedule.schedule_month = monthShort;\n                                schedule.pending_qty = row.qty;\n                            });\n                        }\n                        \n                        else {\n                            frm.doc.new_business_jo.forEach(row => {\n                                let item = frappe.model.add_child(po, \"Purchase Order Item\", \"items\");\n                                item.item_code = row.item_code;\n                                item.item_name = row.item_name;\n                                item.qty = row.qty;\n                                item.open_qty = row.qty;\n                                setTimeout(() => {\n                                    item.rate = row.po_price;\n                                    item.amount = row.po_price * row.qty;\n                                }, 2500);\n                                item.gst_hsn_code = row.hsn_code;\n                                item.uom = row.uom;\n                                item.stock_uom = row.uom;\n                                \n                                if (row.qty > 1) {\n                                    let schedule = frappe.model.add_child(po, \"Purchase Order Schedule Item\", \"custom_schedule_table\");\n                                    schedule.item_code = row.item_code;\n                                    schedule.item_name = row.item_name;\n                                    schedule.schedule_qty = row.qty;\n                                    schedule.schedule_date = startDate;\n                                    schedule.schedule_month = monthShort;\n                                    schedule.pending_qty = row.qty;\n                                }\n                            });\n                        }\n                        \n                        frappe.set_route(\"Form\", \"Purchase Order\", po.name);\n                    }\n                });\n                if (frm.doc.order_created) {\n                    $(create_order_btn).prop(\"disabled\", true).addClass(\"disabled\");\n                }\n            }\n        }\n\t    \n\t    \n\t    \n\t    \n\t    \n\t    \n\t    \n\t    render_approval_grid_buttons(frm);\n\t    render_approval_grid_buttons1(frm);\n\t    \n\t    if (frm.doc.docstatus == 0){\n    \t    if(frm.doc.iom_type==\"Approval for Price Revision PO\"){\n    \t        if(frm.doc.customer){\n    \t            frm.set_value(\"document\",\"Sales Order\")\n    \t        }\n    \t        else if(frm.doc.supplier){\n    \t            frm.set_value(\"document\",\"Purchase Order\")\n    \t        }\n    \t    }\n\t    }\n\t    \n\t\tif(!frm.doc.__islocal){\n\t\t     if(!frappe.user.has_role('System Manager')){\n            $(\"button[data-original-title=Print]\").hide();\n            }\n\t\t    if(frm.doc.iom_type==\"Approval for Supplier Stock Reconciliation\" && frm.doc.workflow_state == \"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                \n                 frm.add_custom_button(__(\"Print\"), function() {\n                    var f_name = frm.doc.name\n                    var print_format = \"Approval for Supplier Stock Reconciliation\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Inter Office Memo\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                });\n            \n                \n            }\n\t\t                              if(frm.doc.iom_type==\"Approval for Supplier Stock Reconciliation\"){\n                     \n                      frm.add_custom_button(__(\"Report View\"), function() {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_supplier_reqest_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function(r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n\n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function() {\n                                        d.hide();\n                                    }\n                                });\n\n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n                     \n                 }   \n\n\t\t    \n\t\t     if(frm.doc.iom_type==\"Approval for Travel Request\" && frm.doc.workflow_state == \"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                \n                 frm.add_custom_button(__(\"Print\"), function() {\n                    var f_name = frm.doc.name\n                    var print_format = \"Approval for Travel Request\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Inter Office Memo\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                });\n            \n                \n            }\n             \n              if(frm.doc.iom_type==\"Approval for Travel Request\"){\n                     \n                      frm.add_custom_button(__(\"Report View\"), function() {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_travel_request_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function(r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n\n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function() {\n                                        d.hide();\n                                    }\n                                });\n\n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n                     \n                 }  \n\t\t    \n\t\t    \n\t\t    if (frm.doc.iom_type == \"Approval for New Customer Registration\" && frm.doc.workflow_state == \"Approved\" && frm.doc.customer_created==0 && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))) {\n                frm.add_custom_button(__(\"Create Customer\"), function() {\n                    frappe.call({\n                    method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.create_customer_from_iom\",\n                    args: {\n                        iom_name: frm.doc.name\n                    },\n                    freeze: true,\n                    freeze_message: \"Creating Customer...\",\n                    callback: function (r) {\n                        if (!r.exc) {\n                            frappe.msgprint({\n                                title: \"Success\",\n                                message: \"Customer Created: <b>\" + r.message + \"</b>\",\n                                indicator: \"green\"\n                            });\n\n                            frappe.set_route(\"Form\", \"Customer\", r.message);\n                        }\n                    }\n                });\n                });\n            }\n\n                                if (frm.doc.iom_type == \"Approval for New Customer Registration\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_customer_registeration_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\t\t    if (frm.doc.iom_type == \"Approval for New Customer Registration\" && frm.doc.workflow_state == \"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))) {\n                frm.add_custom_button(__(\"Print\"), function() {\n                    var f_name = frm.doc.name\n                    var print_format = \"Approval for New Customer Registration\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Inter Office Memo\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                });\n            }\n\n\n\t\t    if (frm.doc.iom_type == \"Approval for New Supplier Registration\" && frm.doc.workflow_state == \"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))) {\n                frm.add_custom_button(__(\"Print\"), function() {\n                    var f_name = frm.doc.name\n                    var print_format = \"Approval for New Supplier Registration\";\n                    window.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\" +\n                        \"doctype=\" + encodeURIComponent(\"Inter Office Memo\") +\n                        \"&name=\" + encodeURIComponent(f_name) +\n                        \"&trigger_print=1\" +\n                        \"&format=\" + print_format +\n                        \"&no_letterhead=0\"\n                    ));\n                });\n            }\n             if (frm.doc.iom_type == \"Approval for New Supplier Registration\" && frm.doc.workflow_state == \"Approved\" && frm.doc.supplier_create==0 && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))) {\n                frm.add_custom_button(__(\"Create Supplier\"), function() {\n                    frappe.call({\n                    method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.create_supplier_from_iom\",\n                    args: {\n                        iom_name: frm.doc.name\n                    },\n                    freeze: true,\n                    freeze_message: \"Creating Supplier...\",\n                    callback: function (r) {\n                        if (!r.exc) {\n                            frappe.msgprint({\n                                title: \"Success\",\n                                message: \"Supplier Created: <b>\" + r.message + \"</b>\",\n                                indicator: \"green\"\n                            });\n\n                            frappe.set_route(\"Form\", \"Supplier\", r.message);\n                        }\n                    }\n                });\n                });\n            }\n\t\t                            if (frm.doc.iom_type == \"Approval for New Supplier Registration\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_supplier_registeration_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\n\t\t     if(frm.doc.iom_type == \"Approval for Business Visit\" && frm.doc.workflow_state==\"Approved\"&& (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for Business Visit\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n\t\t                if (frm.doc.iom_type == \"Approval for Business Visit\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_business_visit_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\n\t\t    if (frm.doc.iom_type == \"Approval for Stock Change Request - Stock Reconciliation\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_stock_change_req_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\t\t    if (frm.doc.iom_type == \"Approval for Manpower Request\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_manpower_req_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\n\t\t  \n\t\t  \n\t\t  if (frm.doc.iom_type == \"Approval for Price Revision PO\" && frm.doc.department_from != \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n            \n            \n                    // Step 1: Check workflow state\n                        \n                        let remarks = frm.doc.rejection_remarks || [];\n            \n                        if (remarks.length > 0) {\n                            // Step 2: Get the last row\n                            let last_row = remarks[remarks.length - 1];\n                            if (frm.doc.workflow_state == \"Rejected\"){\n                                last_row.check_reopened = 1\n                            }\n                            else{\n                                last_row.check_reopened = 0\n                            }\n                            // Step 3: Check the checkbox field\n                            if (last_row.check_reopened == 1) {\n                                method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_price_revision_mpl_html\";\n                            } else {\n                                method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_price_revision_mpl_html\";\n                            }\n                        } else {\n                            // No remarks found, fallback to default method\n                            method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_price_revision_mpl_html\";\n                        }\n                    \n            \n                    // Step 4: Call backend method\n                    frappe.call({\n                        method: method_to_call,\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            \n\t\t  \n\t\t   \n\t\t   \n\t\t    \n\t\t   if (frm.doc.iom_type == \"Approval for Credit Note\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_credit_note_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Credit Note\" && frm.doc.department_from == \"Marketing - WAIP\"&& frm.doc.workflow_state==\"Approved\"&& (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for Credit Note\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n            if(frm.doc.iom_type == \"Approval for Stock Change Request - Stock Reconciliation\" && frm.doc.workflow_state==\"Approved\"&& (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for Stock Change Request\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n            if(frm.doc.iom_type == \"Approval for Manpower Request\" && frm.doc.workflow_state==\"Approved\"&& (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for Manpower Request\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n\n          if (frm.doc.iom_type == \"Approval for New Business PO\" && frm.doc.department_from != \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n            \n            \n                    // Step 1: Check workflow state\n                        \n                        let remarks = frm.doc.rejection_remarks || [];\n            \n                        if (remarks.length > 0) {\n                            // Step 2: Get the last row\n                            let last_row = remarks[remarks.length - 1];\n                            if (frm.doc.workflow_state == \"Rejected\"){\n                                last_row.check_reopened = 1\n                            }\n                            else{\n                                last_row.check_reopened = 0\n                            }\n                            // Step 3: Check the checkbox field\n                            if (last_row.check_reopened == 1) {\n                                method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_new_business_po_html_new\";\n                            } else {\n                                method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_new_business_po_html_new\";\n                            }\n                        } else {\n                            // No remarks found, fallback to default method\n                            method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_new_business_po_html_new\";\n                        }\n                    \n            \n                    // Step 4: Call backend method\n                    frappe.call({\n                        method: method_to_call,\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            \n            \n            if(frm.doc.iom_type == \"Approval for New Business PO\" && (frm.doc.department_from != \"Marketing - WAIP\")&& frm.doc.workflow_state==\"Approved\"&& (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for New Business PO NEW\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n\n\t\t\n\t\t  \t        if (frm.doc.iom_type == \"Approval for New Business SO\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_new_business_po_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            \n            \n            if(frm.doc.iom_type == \"Approval for New Business SO\" && frm.doc.workflow_state==\"Approved\"&& (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for New Business PO\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n\n\t\t\n\t\t  \t\t  \tif ((frm.doc.iom_type == \"Approval for Price Revision SO\" || frm.doc.iom_type==\"Approval for Price Revision PO\") && frm.doc.department_from == \"Marketing - WAIP\"  ) {\n\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_price_revision_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\t\t  \t\t  \tif((frm.doc.iom_type == \"Approval for Price Revision SO\" || frm.doc.iom_type==\"Approval for Price Revision PO\") && frm.doc.department_from == \"Marketing - WAIP\"&& frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Price Revision PO\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\t\t  \t\t  \t\n\t\t  \t\t  \t\n\t\t  \t\t  \tif (frm.doc.iom_type == \"Approval for Schedule Increase\" && frm.doc.department_from == \"Raw Material - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_schedule_increase_material_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    size: \"large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\nif(frm.doc.iom_type == \"Approval for Schedule Increase\" && frm.doc.department_from == \"Raw Material - WAIP\"&& frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                frm.add_custom_button(__(\"Print\"), function () {\n    \t\t\tvar f_name = frm.doc.name\n    \t\t\tvar print_format = \"Approval for Schedule Increase Material\";\n    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n    \t\t\t\t+ \"&trigger_print=1\"\n    \t\t\t\t+ \"&format=\" + print_format\n    \t\t\t\t+ \"&no_letterhead=0\"\n    \t\t\t));\n    \t\t});\n            }\n\t\t  \n\t        if (frm.doc.iom_type == \"Approval for Tooling Invoice\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_tooling_invoice_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\n            \tif(frm.doc.iom_type == \"Approval for Tooling Invoice\" && frm.doc.department_from == \"Marketing - WAIP\"&& frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Tooling Invoice\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if(frm.doc.iom_type == \"Approval for Proto Sample SO\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Proto Sample PO\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\t\t  \t        if (frm.doc.iom_type == \"Approval for Proto Sample SO\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_proto_sample_marketing_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Debit Note / Supplementary Invoice\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Debit Note Marketing\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\t\t  \t        if (frm.doc.iom_type == \"Approval for Debit Note / Supplementary Invoice\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_debit_note_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n             if(frm.doc.iom_type == \"Approval for Business Volume Increase\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Business Volume Increase\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\t\t  \t        if (frm.doc.iom_type == \"Approval for Business Volume Increase\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_business_volume_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Customer Name/Address Change\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Customer Name/Address Change\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n             if (frm.doc.iom_type == \"Approval for Customer Name/Address Change\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_customer_name_change_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Payment Write Off\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Payment Write Off\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                         if (frm.doc.iom_type == \"Approval for Payment Write Off\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_payment_right_off_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Sales Order DC\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Sales Order DC\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if (frm.doc.iom_type == \"Approval for Sales Order DC\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_sales_order_dc_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Item Level Change\" && frm.doc.department_from == \"Marketing - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Item Level Change\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                        if (frm.doc.iom_type == \"Approval for Item Level Change\" && frm.doc.department_from == \"Marketing - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_part_level_change_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Invoice Cancel\" && frm.doc.department_from == \"Delivery - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Invoice Cancel\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                                    if (frm.doc.iom_type == \"Approval for Invoice Cancel\" && frm.doc.department_from == \"Delivery - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_invoice_cancel_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Air Shipment\" && frm.doc.department_from == \"Delivery - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Air Shipment Delivery\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if (frm.doc.iom_type == \"Approval for Air Shipment\" && frm.doc.department_from == \"Delivery - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n            \n            \n                    // Step 1: Check workflow state\n                        \n                        let remarks = frm.doc.rejection_remarks || [];\n            \n                        if (remarks.length > 0) {\n                            // Step 2: Get the last row\n                            let last_row = remarks[remarks.length - 1];\n                            if (frm.doc.workflow_state == \"Rejected\"){\n                                last_row.check_reopened = 1\n                            }\n                            else{\n                                last_row.check_reopened = 0\n                            }\n                            // Step 3: Check the checkbox field\n                            if (last_row.check_reopened == 1) {\n                                method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_air_shipment_reopen_html\";\n                            } else {\n                                method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_air_shipment_delivery_html\";\n                            }\n                        } else {\n                            // No remarks found, fallback to default method\n                            method_to_call = \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_air_shipment_delivery_html\";\n                        }\n                    \n            \n                    // Step 4: Call backend method\n                    frappe.call({\n                        method: method_to_call,\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\n            if(frm.doc.iom_type == \"Approval for Tools & Dies Invoice\" && frm.doc.department_from == \"M P L & Purchase - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Tools and Dies Invoice\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if (frm.doc.iom_type == \"Approval for Tools & Dies Invoice\" && frm.doc.department_from == \"M P L & Purchase - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_tools_and_dies_invoice\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Schedule Revised\" && frm.doc.department_from == \"Delivery - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Schedule Increase New\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\nif (frm.doc.iom_type == \"Approval for Schedule Revised\" && frm.doc.department_from == \"M P L & Purchase - WAIP\" && frappe.session.user=='jothi.m@gruoupteampro.com') {\n    frm.add_custom_button(__(\"Report View1\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo_html_view.get_schedule_revise_delivery_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            \n                        if (frm.doc.iom_type == \"Approval for Schedule Revised\" && frm.doc.department_from == \"Delivery - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo_html_view.get_schedule_increase_delivery_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n             if(frm.doc.iom_type == \"Approval for Air Shipment\" && frm.doc.department_from == \"M P L & Purchase - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Air Shipment Material\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                                    if (frm.doc.iom_type == \"Approval for Air Shipment\" && frm.doc.department_from == \"M P L & Purchase - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_schedule_increase.get_air_shipment_material_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Material Request - New Project\" && frm.doc.department_from == \"NPD - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Material Request\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if (frm.doc.iom_type == \"Approval for Material Request - New Project\" && frm.doc.department_from == \"NPD - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_material_request_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Price Revision PO\" && frm.doc.department_from == \"Raw Material - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user == frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Price Revision PO Material\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                        if (frm.doc.iom_type == \"Approval for Price Revision PO\" && frm.doc.department_from == \"Raw Material - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_price_revision_material_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n                if(frm.doc.iom_type == \"Approval for Product Conversion\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Product Conversion\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                 if(frm.doc.iom_type == \"Approval for Vendor Split order\" && frm.doc.department_from == \"Raw Material - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Vendor Split order\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if (frm.doc.iom_type == \"Approval for Vendor Split order\" && frm.doc.department_from == \"Raw Material - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_vendor_split_order_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n if(frm.doc.iom_type == \"Approval for Debit Note\" && frm.doc.department_from == \"M P L & Purchase - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Debit Note Material\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n                        if (frm.doc.iom_type == \"Approval for Debit Note\" && frm.doc.department_from == \"Raw Material - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo.get_debit_note_materail_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            \t\t   if (frm.doc.iom_type == \"Approval for New Business JO\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_schedule_increase.get_new_business_jo_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Price Revision PO\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Price Revision PO\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n            if(frm.doc.iom_type == \"Approval for New Business JO\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"New Business JO\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\n            \t\t   if (frm.doc.iom_type == \"Approval for Price Revision JO\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_schedule_increase.get_price_revision_jo_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\nif(frm.doc.iom_type == \"Approval for Price Revision JO\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Price Revision JO\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\t\n\t\t                \t\t   if (frm.doc.iom_type == \"Approval for Schedule Revised\" && frm.doc.department_from==\"M P L & Purchase - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.inter_office_memo_html_view.get_schedule_revise_delivery_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n            if(frm.doc.iom_type == \"Approval for Schedule Revised\" && frm.doc.workflow_state==\"Approved\" && frm.doc.department_from==\"M P L & Purchase - WAIP\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                            frm.add_custom_button(__(\"Print\"), function () {\n                \t\t\tvar f_name = frm.doc.name\n                \t\t\tvar print_format = \"Approval for Schedule Revised\";\n                \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                \t\t\t\t+ \"&trigger_print=1\"\n                \t\t\t\t+ \"&format=\" + print_format\n                \t\t\t\t+ \"&no_letterhead=0\"\n                \t\t\t));\n    \t\t});\n            }\n\t\t                \t\t   if (frm.doc.iom_type == \"Approval for Product Conversion\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_schedule_increase.get_product_conversion_material_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n if (frm.doc.iom_type == \"Approval for Proto Sample PO\" && frm.doc.department_from==\"M P L & Purchase - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_schedule_increase.get_proto_sample_material_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n    if(frm.doc.iom_type == \"Approval for Proto Sample PO\" && frm.doc.department_from==\"M P L & Purchase - WAIP\" && frm.doc.workflow_state==\"Approved\" && (frappe.session.user==frm.doc.owner || frappe.user.has_role('ERP Team'))){\n                                frm.add_custom_button(__(\"Print\"), function () {\n                    \t\t\tvar f_name = frm.doc.name\n                    \t\t\tvar print_format = \"Approval for Proto Sample PO Material\";\n                    \t\t\twindow.open(frappe.urllib.get_full_url(\"/api/method/frappe.utils.print_format.download_pdf?\"\n                    \t\t\t\t+ \"doctype=\" + encodeURIComponent(\"Inter Office Memo\")\n                    \t\t\t\t+ \"&name=\" + encodeURIComponent(f_name)\n                    \t\t\t\t+ \"&trigger_print=1\"\n                    \t\t\t\t+ \"&format=\" + print_format\n                    \t\t\t\t+ \"&no_letterhead=0\"\n                    \t\t\t));\n        \t\t});\n                }\n\t if (frm.doc.iom_type == \"Approval for Debit Note\" && frm.doc.department_from==\"M P L & Purchase - WAIP\") {\n                frm.add_custom_button(__(\"Report View\"), function () {\n                    frappe.call({\n                        method: \"onegene.onegene.doctype.inter_office_memo.approval_schedule_increase.get_debit_material_html\",\n                        args: {\n                            doc: frm.doc\n                        },\n                        callback: function (r) {\n                            if (r.message && r.message.html) {\n                                let d = new frappe.ui.Dialog({\n                                    \n                                    size: \"extra-large\",\n                                    primary_action_label: __(\"Close\"),\n                                    primary_action: function () {\n                                        d.hide();\n                                    }\n                                });\n            \n                                d.$body.html(r.message.html);\n                                d.show();\n                            } else {\n                                frappe.msgprint(__(\"Unable to load preview\"));\n                            }\n                        }\n                    });\n                });\n            }\n\n\t\t}\n\t\tfrm.trigger('toggle_customer_visibility');\n\t\t\n\n// \t\tif (frm.doc.department_from === \"Delivery - WAIP\" && frm.doc.iom_type === \"Approval for Schedule Revised\") {\n            \n            \n        // }\n        \n\n\t},\n\t\n\tdepartment_from: function(frm) {\n        $.each(frm.fields_dict, function(fieldname, field) {\n            if (fieldname !== 'department_from' && fieldname!= 'currency' && fieldname!='company' && fieldname!=\"department_to\" && fieldname!=\"reports_to\") {\n                if (frm.doc[fieldname]) {\n                    frm.set_value(fieldname, null);\n                }\n            }\n        });\n        frm.set_value(\"date_time\", frappe.datetime.now_datetime());\n        frm.trigger('toggle_customer_visibility');\n       \n    },\n\n  \n    // instructed_by: function(frm) {\n    //     if (frm.doc.owner) {\n    //         frappe.db.get_value('Employee', frm.doc.owner, 'reports_to')\n    //             .then(r => {\n    //                 if (r && r.message && r.message.reports_to) {\n    //                     frm.set_value('reports_to', r.message.reports_to);\n    //                 } else {\n    //                     frm.set_value('reports_to', '');\n    //                 }\n    //             });\n    //     } else {\n    //         frm.set_value('reports_to', '');\n    //     }\n    // },\n    customer: function(frm) {\n        if (!frm.doc.customer) {\n            frm.clear_table(\"approval_address_change\");\n            frm.refresh_field(\"approval_address_change\");\n        }\n        \n        if(frm.doc.iom_type ==\"Approval for Price Revision PO\"){\n            if(frm.doc.customer){\n                frm.set_value(\"document\",\"Sales Order\")\n            }\n        }\n    },\n    supplier:function(frm){\n        if(frm.doc.iom_type ==\"Approval for Price Revision PO\"){\n            \n            if(frm.doc.supplier){\n                frm.set_value(\"document\",\"Purchase Order\")\n            }\n        }\n    },\n    \n    toggle_customer_visibility: function(frm) {\n        if ((frm.doc.department_from === \"Delivery - WAIP\" && frm.doc.iom_type === \"Approval for Schedule Revised\") || (frm.doc.department_from === \"M P L & Purchase - WAIP\" && frm.doc.iom_type === \"Approval for Schedule Revised\") ) {\n            frm.set_df_property('customer', 'hidden', 1);\n        }\n    },\n    \n    export:function(frm){\n        \n        const name = frm.doc.name;\n        const url = `/api/method/onegene.onegene.doctype.inter_office_memo.export.export_excel_mpl?name=${encodeURIComponent(name)}`;\n        window.open(url);\n        \n        \n    },\n    \n    export_1:function(frm){\n        \n        const name = frm.doc.name;\n        const url = `/api/method/onegene.onegene.doctype.inter_office_memo.export.export_excel?name=${encodeURIComponent(name)}`;\n        window.open(url);\n        \n    }\n        \n    \n    // export_1: function(frm) {\n    //     window.open(\"/api/method/onegene.onegene.doctype.inter_office_memo.export.export_empty_excel\");\n    // },\n    // import_1: function(frm) {\n    //     frappe.call({\n    //         method: \"onegene.onegene.doctype.inter_office_memo.export.import_customer_excel\",\n    //         args: { file_url: frm.doc.import_1 },\n    //         callback: function(r) {\n    //             if (r.message) {\n    //                 frappe.msgprint(r.message);\n    //                 frm.reload_doc(); // refresh child table\n    //             }\n    //         }\n    //     });\n    // }    \n})\n\n\n\nfunction render_approval_grid_buttons(frm) {\n    frappe.after_ajax(() => {\n        const grid = frm.fields_dict[\"approval_schdule_increase\"]?.grid;\n        if (!grid || !grid.wrapper) return;\n\n        setTimeout(() => {\n            const $grid_buttons = $(grid.wrapper).find('.grid-buttons');\n            if (!$grid_buttons.length) return;\n\n            // Remove old buttons to prevent duplicates\n            $grid_buttons.find('.custom-right-btns').remove();\n\n            // Create container for custom buttons\n            const $right_container = $('<div class=\"custom-right-btns\" style=\"display:flex; gap:6px; align-items:center; margin-left:auto;\"></div>');\n\n            // Download button\n            const $download_btn = $('<button class=\"btn btn-xs btn-default\" title=\"Download\"><i class=\"fa fa-download\"></i></button>');\n            $download_btn.on('click', () => {\n                window.open(\"/api/method/onegene.onegene.doctype.inter_office_memo.export.export_empty_excel\");\n            });\n\n            // Upload button\n            const $upload_btn = $('<button class=\"btn btn-xs btn-default\" title=\"Upload\"><i class=\"fa fa-upload\"></i></button>');\n            $upload_btn.on('click', () => {\n                new frappe.ui.FileUploader({\n                    allow_multiple: false,\n                    doctype: frm.doctype,\n                    docname: frm.docname,\n                    folder: 'Home/Attachments',\n                    on_success(file) {\n                        frappe.show_alert({ message: 'File uploaded: ' + file.file_name, indicator: 'green' });\n\n                        frappe.call({\n                            method: \"onegene.onegene.doctype.inter_office_memo.export.process_approval_schedule_sheet\",\n                            args: { docname: frm.doc.name, file_url: file.file_url,month:frm.doc.schedule_month  },\n                            callback(r) {\n                                if (r.message?.status === \"success\") {\n                                    frappe.show_alert({ message: r.message.message, indicator: 'green' });\n\n                                    const data_list = r.message.data;\n                                    data_list.forEach(row => {\n                                        const child = frm.add_child(\"approval_schdule_increase\");\n                                        Object.keys(row).forEach(f => child[f] = row[f]);\n                                    });\n\n                                    frm.refresh_field(\"approval_schdule_increase\");\n\n                                    // Re-render buttons after refresh\n                                    render_approval_grid_buttons(frm);\n                                } else {\n                                    frappe.msgprint(r.message?.message || \"Failed to process sheet\");\n                                }\n                            }\n                        });\n                    }\n                });\n            });\n            \n            \n\n            $right_container.append($download_btn, $upload_btn);\n\n            $grid_buttons.css({\n                display: 'flex',\n                'justify-content': 'space-between',\n                'align-items': 'center'\n            });\n\n            $grid_buttons.append($right_container);\n\n        }, 300);\n    });\n}\n\n\nfunction render_approval_grid_buttons1(frm) {\n    frappe.after_ajax(() => {\n        const grid = frm.fields_dict[\"schedule_revised\"]?.grid;\n        if (!grid || !grid.wrapper) return;\n\n        setTimeout(() => {\n            const $grid_buttons = $(grid.wrapper).find('.grid-buttons');\n            if (!$grid_buttons.length) return;\n\n            $grid_buttons.find('.custom-right-btns').remove();\n\n            const $right_container = $('<div class=\"custom-right-btns\" style=\"display:flex; gap:6px; align-items:center; margin-left:auto;\"></div>');\n\n            const $download_btn1 = $('<button class=\"btn btn-xs btn-default\" title=\"Download\"><i class=\"fa fa-download\"></i></button>');\n            $download_btn1.on('click', () => {\n                window.open(\"/api/method/onegene.onegene.doctype.inter_office_memo.export.export_empty_excel_mpl\");\n            });\n\n            const $upload_btn1 = $('<button class=\"btn btn-xs btn-default\" title=\"Upload\"><i class=\"fa fa-upload\"></i></button>');\n            $upload_btn1.on('click', () => {\n                new frappe.ui.FileUploader({\n                    allow_multiple: false,\n                    doctype: frm.doctype,\n                    docname: frm.docname,\n                    folder: 'Home/Attachments',\n                    on_success(file) {\n                        frappe.show_alert({ message: 'File uploaded: ' + file.file_name, indicator: 'green' });\n\n                        frappe.call({\n                            method: \"onegene.onegene.doctype.inter_office_memo.export.process_approval_schedule_sheet_supplier\",\n                            args: { docname: frm.doc.name, file_url: file.file_url,month:frm.doc.schedule_month },\n                            callback(r) {\n                                if (r.message?.status === \"success\") {\n                                    frappe.show_alert({ message: r.message.message, indicator: 'green' });\n\n                                    const data_list = r.message.data;\n                                    data_list.forEach(row => {\n                                        const child = frm.add_child(\"schedule_revised\");\n                                        Object.keys(row).forEach(f => child[f] = row[f]);\n                                    });\n\n                                    frm.refresh_field(\"schedule_revised\");\n                                    render_approval_grid_buttons1(frm);\n                                } else {\n                                    frappe.msgprint(r.message?.message || \"Failed to process sheet\");\n                                }\n                            }\n                        });\n                    }\n                });\n            });\n\n            $right_container.append($download_btn1, $upload_btn1);\n            $grid_buttons.css({\n                display: 'flex',\n                'justify-content': 'space-between',\n                'align-items': 'center'\n            });\n\n            $grid_buttons.append($right_container);\n\n        }, 300);\n    });\n}\n\n\n",
  "view": "Form"
 }
]